/*! @name @videojs/http-streaming @version 2.15.1 @license Apache-2.0 */
(function(global,factory){typeof exports==='object'&&typeof module!=='undefined'?factory(exports,require('video.js'),require('@xmldom/xmldom')):typeof define==='function'&&define.amd?define(['exports','video.js','@xmldom/xmldom'],factory):(global=typeof globalThis!=='undefined'?globalThis:global||self,factory(global.httpStreaming={},global.videojs,global.window))})(this,(function(exports,videojs,xmldom){'use strict';function _interopDefaultLegacy(e){return e&&typeof e==='object'&&'default' in e?e:{'default':e}}
var videojs__default=_interopDefaultLegacy(videojs);function createCommonjsModule(fn,basedir,module){return module={path:basedir,exports:{},require:function(path,base){return commonjsRequire(path,(base===undefined||base===null)?module.path:base)}},fn(module,module.exports),module.exports}
function commonjsRequire(){throw new Error('Dynamic requires are not currently supported by @rollup/plugin-commonjs')}
var assertThisInitialized=createCommonjsModule(function(module){function _assertThisInitialized(self){if(self===void 0){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}
return self}
module.exports=_assertThisInitialized;module.exports["default"]=module.exports,module.exports.__esModule=!0});var setPrototypeOf=createCommonjsModule(function(module){function _setPrototypeOf(o,p){module.exports=_setPrototypeOf=Object.setPrototypeOf||function _setPrototypeOf(o,p){o.__proto__=p;return o};module.exports["default"]=module.exports,module.exports.__esModule=!0;return _setPrototypeOf(o,p)}
module.exports=_setPrototypeOf;module.exports["default"]=module.exports,module.exports.__esModule=!0});var inheritsLoose=createCommonjsModule(function(module){function _inheritsLoose(subClass,superClass){subClass.prototype=Object.create(superClass.prototype);subClass.prototype.constructor=subClass;setPrototypeOf(subClass,superClass)}
module.exports=_inheritsLoose;module.exports["default"]=module.exports,module.exports.__esModule=!0});var urlToolkit=createCommonjsModule(function(module,exports){(function(root){var URL_REGEX=/^((?:[a-zA-Z0-9+\-.]+:)?)(\/\/[^\/?#]*)?((?:[^\/?#]*\/)*[^;?#]*)?(;[^?#]*)?(\?[^#]*)?(#[^]*)?$/;var FIRST_SEGMENT_REGEX=/^([^\/?#]*)([^]*)$/;var SLASH_DOT_REGEX=/(?:\/|^)\.(?=\/)/g;var SLASH_DOT_DOT_REGEX=/(?:\/|^)\.\.\/(?!\.\.\/)[^\/]*(?=\/)/g;var URLToolkit={buildAbsoluteURL:function buildAbsoluteURL(baseURL,relativeURL,opts){opts=opts||{};baseURL=baseURL.trim();relativeURL=relativeURL.trim();if(!relativeURL){if(!opts.alwaysNormalize){return baseURL}
var basePartsForNormalise=URLToolkit.parseURL(baseURL);if(!basePartsForNormalise){throw new Error('Error trying to parse base URL.')}
basePartsForNormalise.path=URLToolkit.normalizePath(basePartsForNormalise.path);return URLToolkit.buildURLFromParts(basePartsForNormalise)}
var relativeParts=URLToolkit.parseURL(relativeURL);if(!relativeParts){throw new Error('Error trying to parse relative URL.')}
if(relativeParts.scheme){if(!opts.alwaysNormalize){return relativeURL}
relativeParts.path=URLToolkit.normalizePath(relativeParts.path);return URLToolkit.buildURLFromParts(relativeParts)}
var baseParts=URLToolkit.parseURL(baseURL);if(!baseParts){throw new Error('Error trying to parse base URL.')}
if(!baseParts.netLoc&&baseParts.path&&baseParts.path[0]!=='/'){var pathParts=FIRST_SEGMENT_REGEX.exec(baseParts.path);baseParts.netLoc=pathParts[1];baseParts.path=pathParts[2]}
if(baseParts.netLoc&&!baseParts.path){baseParts.path='/'}
var builtParts={scheme:baseParts.scheme,netLoc:relativeParts.netLoc,path:null,params:relativeParts.params,query:relativeParts.query,fragment:relativeParts.fragment};if(!relativeParts.netLoc){builtParts.netLoc=baseParts.netLoc;if(relativeParts.path[0]!=='/'){if(!relativeParts.path){builtParts.path=baseParts.path;if(!relativeParts.params){builtParts.params=baseParts.params;if(!relativeParts.query){builtParts.query=baseParts.query}}}else{var baseURLPath=baseParts.path;var newPath=baseURLPath.substring(0,baseURLPath.lastIndexOf('/')+1)+relativeParts.path;builtParts.path=URLToolkit.normalizePath(newPath)}}}
if(builtParts.path===null){builtParts.path=opts.alwaysNormalize?URLToolkit.normalizePath(relativeParts.path):relativeParts.path}
return URLToolkit.buildURLFromParts(builtParts)},parseURL:function parseURL(url){var parts=URL_REGEX.exec(url);if(!parts){return null}
return{scheme:parts[1]||'',netLoc:parts[2]||'',path:parts[3]||'',params:parts[4]||'',query:parts[5]||'',fragment:parts[6]||''}},normalizePath:function normalizePath(path){path=path.split('').reverse().join('').replace(SLASH_DOT_REGEX,'');while(path.length!==(path=path.replace(SLASH_DOT_DOT_REGEX,'')).length){}
return path.split('').reverse().join('')},buildURLFromParts:function buildURLFromParts(parts){return parts.scheme+parts.netLoc+parts.path+parts.params+parts.query+parts.fragment}};module.exports=URLToolkit})()});var DEFAULT_LOCATION='http://example.com';var resolveUrl$1=function resolveUrl(baseUrl,relativeUrl){if(/^[a-z]+:/i.test(relativeUrl)){return relativeUrl}
if(/^data:/.test(baseUrl)){baseUrl=window.location&&window.location.href||''}
var nativeURL=typeof window.URL==='function';var protocolLess=/^\/\//.test(baseUrl);var removeLocation=!window.location&&!/\/\//i.test(baseUrl);if(nativeURL){baseUrl=new window.URL(baseUrl,window.location||DEFAULT_LOCATION)}else if(!/\/\//i.test(baseUrl)){baseUrl=urlToolkit.buildAbsoluteURL(window.location&&window.location.href||'',baseUrl)}
if(nativeURL){var newUrl=new URL(relativeUrl,baseUrl);if(removeLocation){return newUrl.href.slice(DEFAULT_LOCATION.length)}else if(protocolLess){return newUrl.href.slice(newUrl.protocol.length)}
return newUrl.href}
return urlToolkit.buildAbsoluteURL(baseUrl,relativeUrl)};var resolveUrl=resolveUrl$1;var resolveManifestRedirect=function resolveManifestRedirect(handleManifestRedirect,url,req){if(handleManifestRedirect&&req&&req.responseURL&&url!==req.responseURL){return req.responseURL}
return url};var logger=function logger(source){if(videojs__default["default"].log.debug){return videojs__default["default"].log.debug.bind(videojs__default["default"],'VHS:',source+" >")}
return function(){}};var _extends_1=createCommonjsModule(function(module){function _extends(){module.exports=_extends=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source){if(Object.prototype.hasOwnProperty.call(source,key)){target[key]=source[key]}}}
return target};module.exports["default"]=module.exports,module.exports.__esModule=!0;return _extends.apply(this,arguments)}
module.exports=_extends;module.exports["default"]=module.exports,module.exports.__esModule=!0});var Stream=function(){function Stream(){this.listeners={}}
var _proto=Stream.prototype;_proto.on=function on(type,listener){if(!this.listeners[type]){this.listeners[type]=[]}
this.listeners[type].push(listener)};_proto.off=function off(type,listener){if(!this.listeners[type]){return!1}
var index=this.listeners[type].indexOf(listener);this.listeners[type]=this.listeners[type].slice(0);this.listeners[type].splice(index,1);return index>-1};_proto.trigger=function trigger(type){var callbacks=this.listeners[type];if(!callbacks){return}
if(arguments.length===2){var length=callbacks.length;for(var i=0;i<length;++i){callbacks[i].call(this,arguments[1])}}else{var args=Array.prototype.slice.call(arguments,1);var _length=callbacks.length;for(var _i=0;_i<_length;++_i){callbacks[_i].apply(this,args)}}};_proto.dispose=function dispose(){this.listeners={}};_proto.pipe=function pipe(destination){this.on('data',function(data){destination.push(data)})};return Stream}();var atob=function atob(s){return window.atob?window.atob(s):Buffer.from(s,'base64').toString('binary')};function decodeB64ToUint8Array(b64Text){var decodedString=atob(b64Text);var array=new Uint8Array(decodedString.length);for(var i=0;i<decodedString.length;i++){array[i]=decodedString.charCodeAt(i)}
return array}/*! @name m3u8-parser @version 4.8.0 @license Apache-2.0 */
var LineStream=function(_Stream){inheritsLoose(LineStream,_Stream);function LineStream(){var _this;_this=_Stream.call(this)||this;_this.buffer='';return _this}
var _proto=LineStream.prototype;_proto.push=function push(data){var nextNewline;this.buffer+=data;nextNewline=this.buffer.indexOf('\n');for(;nextNewline>-1;nextNewline=this.buffer.indexOf('\n')){this.trigger('data',this.buffer.substring(0,nextNewline));this.buffer=this.buffer.substring(nextNewline+1)}};return LineStream}(Stream);var TAB=String.fromCharCode(0x09);var parseByterange=function parseByterange(byterangeString){var match=/([0-9.]*)?@?([0-9.]*)?/.exec(byterangeString||'');var result={};if(match[1]){result.length=parseInt(match[1],10)}
if(match[2]){result.offset=parseInt(match[2],10)}
return result};var attributeSeparator=function attributeSeparator(){var key='[^=]*';var value='"[^"]*"|[^,]*';var keyvalue='(?:'+key+')=(?:'+value+')';return new RegExp('(?:^|,)('+keyvalue+')')};var parseAttributes$1=function parseAttributes(attributes){var attrs=attributes.split(attributeSeparator());var result={};var i=attrs.length;var attr;while(i--){if(attrs[i]===''){continue}
attr=/([^=]*)=(.*)/.exec(attrs[i]).slice(1);attr[0]=attr[0].replace(/^\s+|\s+$/g,'');attr[1]=attr[1].replace(/^\s+|\s+$/g,'');attr[1]=attr[1].replace(/^['"](.*)['"]$/g,'$1');result[attr[0]]=attr[1]}
return result};var ParseStream=function(_Stream){inheritsLoose(ParseStream,_Stream);function ParseStream(){var _this;_this=_Stream.call(this)||this;_this.customParsers=[];_this.tagMappers=[];return _this}
var _proto=ParseStream.prototype;_proto.push=function push(line){var _this2=this;var match;var event;line=line.trim();if(line.length===0){return}
if(line[0]!=='#'){this.trigger('data',{type:'uri',uri:line});return}
var newLines=this.tagMappers.reduce(function(acc,mapper){var mappedLine=mapper(line);if(mappedLine===line){return acc}
return acc.concat([mappedLine])},[line]);newLines.forEach(function(newLine){for(var i=0;i<_this2.customParsers.length;i++){if(_this2.customParsers[i].call(_this2,newLine)){return}}
if(newLine.indexOf('#EXT')!==0){_this2.trigger('data',{type:'comment',text:newLine.slice(1)});return}
newLine=newLine.replace('\r','');match=/^#EXTM3U/.exec(newLine);if(match){_this2.trigger('data',{type:'tag',tagType:'m3u'});return}
match=/^#EXTINF:?([0-9\.]*)?,?(.*)?$/.exec(newLine);if(match){event={type:'tag',tagType:'inf'};if(match[1]){event.duration=parseFloat(match[1])}
if(match[2]){event.title=match[2]}
_this2.trigger('data',event);return}
match=/^#EXT-X-TARGETDURATION:?([0-9.]*)?/.exec(newLine);if(match){event={type:'tag',tagType:'targetduration'};if(match[1]){event.duration=parseInt(match[1],10)}
_this2.trigger('data',event);return}
match=/^#EXT-X-VERSION:?([0-9.]*)?/.exec(newLine);if(match){event={type:'tag',tagType:'version'};if(match[1]){event.version=parseInt(match[1],10)}
_this2.trigger('data',event);return}
match=/^#EXT-X-MEDIA-SEQUENCE:?(\-?[0-9.]*)?/.exec(newLine);if(match){event={type:'tag',tagType:'media-sequence'};if(match[1]){event.number=parseInt(match[1],10)}
_this2.trigger('data',event);return}
match=/^#EXT-X-DISCONTINUITY-SEQUENCE:?(\-?[0-9.]*)?/.exec(newLine);if(match){event={type:'tag',tagType:'discontinuity-sequence'};if(match[1]){event.number=parseInt(match[1],10)}
_this2.trigger('data',event);return}
match=/^#EXT-X-PLAYLIST-TYPE:?(.*)?$/.exec(newLine);if(match){event={type:'tag',tagType:'playlist-type'};if(match[1]){event.playlistType=match[1]}
_this2.trigger('data',event);return}
match=/^#EXT-X-BYTERANGE:?(.*)?$/.exec(newLine);if(match){event=_extends_1(parseByterange(match[1]),{type:'tag',tagType:'byterange'});_this2.trigger('data',event);return}
match=/^#EXT-X-ALLOW-CACHE:?(YES|NO)?/.exec(newLine);if(match){event={type:'tag',tagType:'allow-cache'};if(match[1]){event.allowed=!/NO/.test(match[1])}
_this2.trigger('data',event);return}
match=/^#EXT-X-MAP:?(.*)$/.exec(newLine);if(match){event={type:'tag',tagType:'map'};if(match[1]){var attributes=parseAttributes$1(match[1]);if(attributes.URI){event.uri=attributes.URI}
if(attributes.BYTERANGE){event.byterange=parseByterange(attributes.BYTERANGE)}}
_this2.trigger('data',event);return}
match=/^#EXT-X-STREAM-INF:?(.*)$/.exec(newLine);if(match){event={type:'tag',tagType:'stream-inf'};if(match[1]){event.attributes=parseAttributes$1(match[1]);if(event.attributes.RESOLUTION){var split=event.attributes.RESOLUTION.split('x');var resolution={};if(split[0]){resolution.width=parseInt(split[0],10)}
if(split[1]){resolution.height=parseInt(split[1],10)}
event.attributes.RESOLUTION=resolution}
if(event.attributes.BANDWIDTH){event.attributes.BANDWIDTH=parseInt(event.attributes.BANDWIDTH,10)}
if(event.attributes['FRAME-RATE']){event.attributes['FRAME-RATE']=parseFloat(event.attributes['FRAME-RATE'])}
if(event.attributes['PROGRAM-ID']){event.attributes['PROGRAM-ID']=parseInt(event.attributes['PROGRAM-ID'],10)}}
_this2.trigger('data',event);return}
match=/^#EXT-X-MEDIA:?(.*)$/.exec(newLine);if(match){event={type:'tag',tagType:'media'};if(match[1]){event.attributes=parseAttributes$1(match[1])}
_this2.trigger('data',event);return}
match=/^#EXT-X-ENDLIST/.exec(newLine);if(match){_this2.trigger('data',{type:'tag',tagType:'endlist'});return}
match=/^#EXT-X-DISCONTINUITY/.exec(newLine);if(match){_this2.trigger('data',{type:'tag',tagType:'discontinuity'});return}
match=/^#EXT-X-PROGRAM-DATE-TIME:?(.*)$/.exec(newLine);if(match){event={type:'tag',tagType:'program-date-time'};if(match[1]){event.dateTimeString=match[1];event.dateTimeObject=new Date(match[1])}
_this2.trigger('data',event);return}
match=/^#EXT-X-KEY:?(.*)$/.exec(newLine);if(match){event={type:'tag',tagType:'key'};if(match[1]){event.attributes=parseAttributes$1(match[1]);if(event.attributes.IV){if(event.attributes.IV.substring(0,2).toLowerCase()==='0x'){event.attributes.IV=event.attributes.IV.substring(2)}
event.attributes.IV=event.attributes.IV.match(/.{8}/g);event.attributes.IV[0]=parseInt(event.attributes.IV[0],16);event.attributes.IV[1]=parseInt(event.attributes.IV[1],16);event.attributes.IV[2]=parseInt(event.attributes.IV[2],16);event.attributes.IV[3]=parseInt(event.attributes.IV[3],16);event.attributes.IV=new Uint32Array(event.attributes.IV)}}
_this2.trigger('data',event);return}
match=/^#EXT-X-START:?(.*)$/.exec(newLine);if(match){event={type:'tag',tagType:'start'};if(match[1]){event.attributes=parseAttributes$1(match[1]);event.attributes['TIME-OFFSET']=parseFloat(event.attributes['TIME-OFFSET']);event.attributes.PRECISE=/YES/.test(event.attributes.PRECISE)}
_this2.trigger('data',event);return}
match=/^#EXT-X-CUE-OUT-CONT:?(.*)?$/.exec(newLine);if(match){event={type:'tag',tagType:'cue-out-cont'};if(match[1]){event.data=match[1]}else{event.data=''}
_this2.trigger('data',event);return}
match=/^#EXT-X-CUE-OUT:?(.*)?$/.exec(newLine);if(match){event={type:'tag',tagType:'cue-out'};if(match[1]){event.data=match[1]}else{event.data=''}
_this2.trigger('data',event);return}
match=/^#EXT-X-CUE-IN:?(.*)?$/.exec(newLine);if(match){event={type:'tag',tagType:'cue-in'};if(match[1]){event.data=match[1]}else{event.data=''}
_this2.trigger('data',event);return}
match=/^#EXT-X-SKIP:(.*)$/.exec(newLine);if(match&&match[1]){event={type:'tag',tagType:'skip'};event.attributes=parseAttributes$1(match[1]);if(event.attributes.hasOwnProperty('SKIPPED-SEGMENTS')){event.attributes['SKIPPED-SEGMENTS']=parseInt(event.attributes['SKIPPED-SEGMENTS'],10)}
if(event.attributes.hasOwnProperty('RECENTLY-REMOVED-DATERANGES')){event.attributes['RECENTLY-REMOVED-DATERANGES']=event.attributes['RECENTLY-REMOVED-DATERANGES'].split(TAB)}
_this2.trigger('data',event);return}
match=/^#EXT-X-PART:(.*)$/.exec(newLine);if(match&&match[1]){event={type:'tag',tagType:'part'};event.attributes=parseAttributes$1(match[1]);['DURATION'].forEach(function(key){if(event.attributes.hasOwnProperty(key)){event.attributes[key]=parseFloat(event.attributes[key])}});['INDEPENDENT','GAP'].forEach(function(key){if(event.attributes.hasOwnProperty(key)){event.attributes[key]=/YES/.test(event.attributes[key])}});if(event.attributes.hasOwnProperty('BYTERANGE')){event.attributes.byterange=parseByterange(event.attributes.BYTERANGE)}
_this2.trigger('data',event);return}
match=/^#EXT-X-SERVER-CONTROL:(.*)$/.exec(newLine);if(match&&match[1]){event={type:'tag',tagType:'server-control'};event.attributes=parseAttributes$1(match[1]);['CAN-SKIP-UNTIL','PART-HOLD-BACK','HOLD-BACK'].forEach(function(key){if(event.attributes.hasOwnProperty(key)){event.attributes[key]=parseFloat(event.attributes[key])}});['CAN-SKIP-DATERANGES','CAN-BLOCK-RELOAD'].forEach(function(key){if(event.attributes.hasOwnProperty(key)){event.attributes[key]=/YES/.test(event.attributes[key])}});_this2.trigger('data',event);return}
match=/^#EXT-X-PART-INF:(.*)$/.exec(newLine);if(match&&match[1]){event={type:'tag',tagType:'part-inf'};event.attributes=parseAttributes$1(match[1]);['PART-TARGET'].forEach(function(key){if(event.attributes.hasOwnProperty(key)){event.attributes[key]=parseFloat(event.attributes[key])}});_this2.trigger('data',event);return}
match=/^#EXT-X-PRELOAD-HINT:(.*)$/.exec(newLine);if(match&&match[1]){event={type:'tag',tagType:'preload-hint'};event.attributes=parseAttributes$1(match[1]);['BYTERANGE-START','BYTERANGE-LENGTH'].forEach(function(key){if(event.attributes.hasOwnProperty(key)){event.attributes[key]=parseInt(event.attributes[key],10);var subkey=key==='BYTERANGE-LENGTH'?'length':'offset';event.attributes.byterange=event.attributes.byterange||{};event.attributes.byterange[subkey]=event.attributes[key];delete event.attributes[key]}});_this2.trigger('data',event);return}
match=/^#EXT-X-RENDITION-REPORT:(.*)$/.exec(newLine);if(match&&match[1]){event={type:'tag',tagType:'rendition-report'};event.attributes=parseAttributes$1(match[1]);['LAST-MSN','LAST-PART'].forEach(function(key){if(event.attributes.hasOwnProperty(key)){event.attributes[key]=parseInt(event.attributes[key],10)}});_this2.trigger('data',event);return}
_this2.trigger('data',{type:'tag',data:newLine.slice(4)})})};_proto.addParser=function addParser(_ref){var _this3=this;var expression=_ref.expression,customType=_ref.customType,dataParser=_ref.dataParser,segment=_ref.segment;if(typeof dataParser!=='function'){dataParser=function dataParser(line){return line}}
this.customParsers.push(function(line){var match=expression.exec(line);if(match){_this3.trigger('data',{type:'custom',data:dataParser(line),customType:customType,segment:segment});return!0}})};_proto.addTagMapper=function addTagMapper(_ref2){var expression=_ref2.expression,map=_ref2.map;var mapFn=function mapFn(line){if(expression.test(line)){return map(line)}
return line};this.tagMappers.push(mapFn)};return ParseStream}(Stream);var camelCase=function camelCase(str){return str.toLowerCase().replace(/-(\w)/g,function(a){return a[1].toUpperCase()})};var camelCaseKeys=function camelCaseKeys(attributes){var result={};Object.keys(attributes).forEach(function(key){result[camelCase(key)]=attributes[key]});return result};var setHoldBack=function setHoldBack(manifest){var serverControl=manifest.serverControl,targetDuration=manifest.targetDuration,partTargetDuration=manifest.partTargetDuration;if(!serverControl){return}
var tag='#EXT-X-SERVER-CONTROL';var hb='holdBack';var phb='partHoldBack';var minTargetDuration=targetDuration&&targetDuration*3;var minPartDuration=partTargetDuration&&partTargetDuration*2;if(targetDuration&&!serverControl.hasOwnProperty(hb)){serverControl[hb]=minTargetDuration;this.trigger('info',{message:tag+" defaulting HOLD-BACK to targetDuration * 3 ("+minTargetDuration+")."})}
if(minTargetDuration&&serverControl[hb]<minTargetDuration){this.trigger('warn',{message:tag+" clamping HOLD-BACK ("+serverControl[hb]+") to targetDuration * 3 ("+minTargetDuration+")"});serverControl[hb]=minTargetDuration}
if(partTargetDuration&&!serverControl.hasOwnProperty(phb)){serverControl[phb]=partTargetDuration*3;this.trigger('info',{message:tag+" defaulting PART-HOLD-BACK to partTargetDuration * 3 ("+serverControl[phb]+")."})}
if(partTargetDuration&&serverControl[phb]<minPartDuration){this.trigger('warn',{message:tag+" clamping PART-HOLD-BACK ("+serverControl[phb]+") to partTargetDuration * 2 ("+minPartDuration+")."});serverControl[phb]=minPartDuration}};var Parser=function(_Stream){inheritsLoose(Parser,_Stream);function Parser(){var _this;_this=_Stream.call(this)||this;_this.lineStream=new LineStream();_this.parseStream=new ParseStream();_this.lineStream.pipe(_this.parseStream);var self=assertThisInitialized(_this);var uris=[];var currentUri={};var currentMap;var _key;var hasParts=!1;var noop=function noop(){};var defaultMediaGroups={'AUDIO':{},'VIDEO':{},'CLOSED-CAPTIONS':{},'SUBTITLES':{}};var widevineUuid='urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed';var currentTimeline=0;_this.manifest={allowCache:!0,discontinuityStarts:[],segments:[]};var lastByterangeEnd=0;var lastPartByterangeEnd=0;_this.on('end',function(){if(currentUri.uri||!currentUri.parts&&!currentUri.preloadHints){return}
if(!currentUri.map&&currentMap){currentUri.map=currentMap}
if(!currentUri.key&&_key){currentUri.key=_key}
if(!currentUri.timeline&&typeof currentTimeline==='number'){currentUri.timeline=currentTimeline}
_this.manifest.preloadSegment=currentUri});_this.parseStream.on('data',function(entry){var mediaGroup;var rendition;({tag:function tag(){(({version:function version(){if(entry.version){this.manifest.version=entry.version}},'allow-cache':function allowCache(){this.manifest.allowCache=entry.allowed;if(!('allowed' in entry)){this.trigger('info',{message:'defaulting allowCache to YES'});this.manifest.allowCache=!0}},byterange:function byterange(){var byterange={};if('length' in entry){currentUri.byterange=byterange;byterange.length=entry.length;if(!('offset' in entry)){entry.offset=lastByterangeEnd}}
if('offset' in entry){currentUri.byterange=byterange;byterange.offset=entry.offset}
lastByterangeEnd=byterange.offset+byterange.length},endlist:function endlist(){this.manifest.endList=!0},inf:function inf(){if(!('mediaSequence' in this.manifest)){this.manifest.mediaSequence=0;this.trigger('info',{message:'defaulting media sequence to zero'})}
if(!('discontinuitySequence' in this.manifest)){this.manifest.discontinuitySequence=0;this.trigger('info',{message:'defaulting discontinuity sequence to zero'})}
if(entry.duration>0){currentUri.duration=entry.duration}
if(entry.duration===0){currentUri.duration=0.01;this.trigger('info',{message:'updating zero segment duration to a small value'})}
this.manifest.segments=uris},key:function key(){if(!entry.attributes){this.trigger('warn',{message:'ignoring key declaration without attribute list'});return}
if(entry.attributes.METHOD==='NONE'){_key=null;return}
if(!entry.attributes.URI){this.trigger('warn',{message:'ignoring key declaration without URI'});return}
if(entry.attributes.KEYFORMAT==='com.apple.streamingkeydelivery'){this.manifest.contentProtection=this.manifest.contentProtection||{};this.manifest.contentProtection['com.apple.fps.1_0']={attributes:entry.attributes};return}
if(entry.attributes.KEYFORMAT==='com.microsoft.playready'){this.manifest.contentProtection=this.manifest.contentProtection||{};this.manifest.contentProtection['com.microsoft.playready']={uri:entry.attributes.URI};return}
if(entry.attributes.KEYFORMAT===widevineUuid){var VALID_METHODS=['SAMPLE-AES','SAMPLE-AES-CTR','SAMPLE-AES-CENC'];if(VALID_METHODS.indexOf(entry.attributes.METHOD)===-1){this.trigger('warn',{message:'invalid key method provided for Widevine'});return}
if(entry.attributes.METHOD==='SAMPLE-AES-CENC'){this.trigger('warn',{message:'SAMPLE-AES-CENC is deprecated, please use SAMPLE-AES-CTR instead'})}
if(entry.attributes.URI.substring(0,23)!=='data:text/plain;base64,'){this.trigger('warn',{message:'invalid key URI provided for Widevine'});return}
if(!(entry.attributes.KEYID&&entry.attributes.KEYID.substring(0,2)==='0x')){this.trigger('warn',{message:'invalid key ID provided for Widevine'});return}
this.manifest.contentProtection=this.manifest.contentProtection||{};this.manifest.contentProtection['com.widevine.alpha']={attributes:{schemeIdUri:entry.attributes.KEYFORMAT,keyId:entry.attributes.KEYID.substring(2)},pssh:decodeB64ToUint8Array(entry.attributes.URI.split(',')[1])};return}
if(!entry.attributes.METHOD){this.trigger('warn',{message:'defaulting key method to AES-128'})}
_key={method:entry.attributes.METHOD||'AES-128',uri:entry.attributes.URI};if(typeof entry.attributes.IV!=='undefined'){_key.iv=entry.attributes.IV}},'media-sequence':function mediaSequence(){if(!isFinite(entry.number)){this.trigger('warn',{message:'ignoring invalid media sequence: '+entry.number});return}
this.manifest.mediaSequence=entry.number},'discontinuity-sequence':function discontinuitySequence(){if(!isFinite(entry.number)){this.trigger('warn',{message:'ignoring invalid discontinuity sequence: '+entry.number});return}
this.manifest.discontinuitySequence=entry.number;currentTimeline=entry.number},'playlist-type':function playlistType(){if(!/VOD|EVENT/.test(entry.playlistType)){this.trigger('warn',{message:'ignoring unknown playlist type: '+entry.playlist});return}
this.manifest.playlistType=entry.playlistType},map:function map(){currentMap={};if(entry.uri){currentMap.uri=entry.uri}
if(entry.byterange){currentMap.byterange=entry.byterange}
if(_key){currentMap.key=_key}},'stream-inf':function streamInf(){this.manifest.playlists=uris;this.manifest.mediaGroups=this.manifest.mediaGroups||defaultMediaGroups;if(!entry.attributes){this.trigger('warn',{message:'ignoring empty stream-inf attributes'});return}
if(!currentUri.attributes){currentUri.attributes={}}
_extends_1(currentUri.attributes,entry.attributes)},media:function media(){this.manifest.mediaGroups=this.manifest.mediaGroups||defaultMediaGroups;if(!(entry.attributes&&entry.attributes.TYPE&&entry.attributes['GROUP-ID']&&entry.attributes.NAME)){this.trigger('warn',{message:'ignoring incomplete or missing media group'});return}
var mediaGroupType=this.manifest.mediaGroups[entry.attributes.TYPE];mediaGroupType[entry.attributes['GROUP-ID']]=mediaGroupType[entry.attributes['GROUP-ID']]||{};mediaGroup=mediaGroupType[entry.attributes['GROUP-ID']];rendition={default:/yes/i.test(entry.attributes.DEFAULT)};if(rendition.default){rendition.autoselect=!0}else{rendition.autoselect=/yes/i.test(entry.attributes.AUTOSELECT)}
if(entry.attributes.LANGUAGE){rendition.language=entry.attributes.LANGUAGE}
if(entry.attributes.URI){rendition.uri=entry.attributes.URI}
if(entry.attributes['INSTREAM-ID']){rendition.instreamId=entry.attributes['INSTREAM-ID']}
if(entry.attributes.CHARACTERISTICS){rendition.characteristics=entry.attributes.CHARACTERISTICS}
if(entry.attributes.FORCED){rendition.forced=/yes/i.test(entry.attributes.FORCED)}
mediaGroup[entry.attributes.NAME]=rendition},discontinuity:function discontinuity(){currentTimeline+=1;currentUri.discontinuity=!0;this.manifest.discontinuityStarts.push(uris.length)},'program-date-time':function programDateTime(){if(typeof this.manifest.dateTimeString==='undefined'){this.manifest.dateTimeString=entry.dateTimeString;this.manifest.dateTimeObject=entry.dateTimeObject}
currentUri.dateTimeString=entry.dateTimeString;currentUri.dateTimeObject=entry.dateTimeObject},targetduration:function targetduration(){if(!isFinite(entry.duration)||entry.duration<0){this.trigger('warn',{message:'ignoring invalid target duration: '+entry.duration});return}
this.manifest.targetDuration=entry.duration;setHoldBack.call(this,this.manifest)},start:function start(){if(!entry.attributes||isNaN(entry.attributes['TIME-OFFSET'])){this.trigger('warn',{message:'ignoring start declaration without appropriate attribute list'});return}
this.manifest.start={timeOffset:entry.attributes['TIME-OFFSET'],precise:entry.attributes.PRECISE}},'cue-out':function cueOut(){currentUri.cueOut=entry.data},'cue-out-cont':function cueOutCont(){currentUri.cueOutCont=entry.data},'cue-in':function cueIn(){currentUri.cueIn=entry.data},'skip':function skip(){this.manifest.skip=camelCaseKeys(entry.attributes);this.warnOnMissingAttributes_('#EXT-X-SKIP',entry.attributes,['SKIPPED-SEGMENTS'])},'part':function part(){var _this2=this;hasParts=!0;var segmentIndex=this.manifest.segments.length;var part=camelCaseKeys(entry.attributes);currentUri.parts=currentUri.parts||[];currentUri.parts.push(part);if(part.byterange){if(!part.byterange.hasOwnProperty('offset')){part.byterange.offset=lastPartByterangeEnd}
lastPartByterangeEnd=part.byterange.offset+part.byterange.length}
var partIndex=currentUri.parts.length-1;this.warnOnMissingAttributes_("#EXT-X-PART #"+partIndex+" for segment #"+segmentIndex,entry.attributes,['URI','DURATION']);if(this.manifest.renditionReports){this.manifest.renditionReports.forEach(function(r,i){if(!r.hasOwnProperty('lastPart')){_this2.trigger('warn',{message:"#EXT-X-RENDITION-REPORT #"+i+" lacks required attribute(s): LAST-PART"})}})}},'server-control':function serverControl(){var attrs=this.manifest.serverControl=camelCaseKeys(entry.attributes);if(!attrs.hasOwnProperty('canBlockReload')){attrs.canBlockReload=!1;this.trigger('info',{message:'#EXT-X-SERVER-CONTROL defaulting CAN-BLOCK-RELOAD to false'})}
setHoldBack.call(this,this.manifest);if(attrs.canSkipDateranges&&!attrs.hasOwnProperty('canSkipUntil')){this.trigger('warn',{message:'#EXT-X-SERVER-CONTROL lacks required attribute CAN-SKIP-UNTIL which is required when CAN-SKIP-DATERANGES is set'})}},'preload-hint':function preloadHint(){var segmentIndex=this.manifest.segments.length;var hint=camelCaseKeys(entry.attributes);var isPart=hint.type&&hint.type==='PART';currentUri.preloadHints=currentUri.preloadHints||[];currentUri.preloadHints.push(hint);if(hint.byterange){if(!hint.byterange.hasOwnProperty('offset')){hint.byterange.offset=isPart?lastPartByterangeEnd:0;if(isPart){lastPartByterangeEnd=hint.byterange.offset+hint.byterange.length}}}
var index=currentUri.preloadHints.length-1;this.warnOnMissingAttributes_("#EXT-X-PRELOAD-HINT #"+index+" for segment #"+segmentIndex,entry.attributes,['TYPE','URI']);if(!hint.type){return}
for(var i=0;i<currentUri.preloadHints.length-1;i++){var otherHint=currentUri.preloadHints[i];if(!otherHint.type){continue}
if(otherHint.type===hint.type){this.trigger('warn',{message:"#EXT-X-PRELOAD-HINT #"+index+" for segment #"+segmentIndex+" has the same TYPE "+hint.type+" as preload hint #"+i})}}},'rendition-report':function renditionReport(){var report=camelCaseKeys(entry.attributes);this.manifest.renditionReports=this.manifest.renditionReports||[];this.manifest.renditionReports.push(report);var index=this.manifest.renditionReports.length-1;var required=['LAST-MSN','URI'];if(hasParts){required.push('LAST-PART')}
this.warnOnMissingAttributes_("#EXT-X-RENDITION-REPORT #"+index,entry.attributes,required)},'part-inf':function partInf(){this.manifest.partInf=camelCaseKeys(entry.attributes);this.warnOnMissingAttributes_('#EXT-X-PART-INF',entry.attributes,['PART-TARGET']);if(this.manifest.partInf.partTarget){this.manifest.partTargetDuration=this.manifest.partInf.partTarget}
setHoldBack.call(this,this.manifest)}})[entry.tagType]||noop).call(self)},uri:function uri(){currentUri.uri=entry.uri;uris.push(currentUri);if(this.manifest.targetDuration&&!('duration' in currentUri)){this.trigger('warn',{message:'defaulting segment duration to the target duration'});currentUri.duration=this.manifest.targetDuration}
if(_key){currentUri.key=_key}
currentUri.timeline=currentTimeline;if(currentMap){currentUri.map=currentMap}
lastPartByterangeEnd=0;currentUri={}},comment:function comment(){},custom:function custom(){if(entry.segment){currentUri.custom=currentUri.custom||{};currentUri.custom[entry.customType]=entry.data}else{this.manifest.custom=this.manifest.custom||{};this.manifest.custom[entry.customType]=entry.data}}})[entry.type].call(self)});return _this}
var _proto=Parser.prototype;_proto.warnOnMissingAttributes_=function warnOnMissingAttributes_(identifier,attributes,required){var missing=[];required.forEach(function(key){if(!attributes.hasOwnProperty(key)){missing.push(key)}});if(missing.length){this.trigger('warn',{message:identifier+" lacks required attribute(s): "+missing.join(', ')})}};_proto.push=function push(chunk){this.lineStream.push(chunk)};_proto.end=function end(){this.lineStream.push('\n');this.trigger('end')};_proto.addParser=function addParser(options){this.parseStream.addParser(options)};_proto.addTagMapper=function addTagMapper(options){this.parseStream.addTagMapper(options)};return Parser}(Stream);var regexs={mp4:/^(av0?1|avc0?[1234]|vp0?9|flac|opus|mp3|mp4a|mp4v|stpp.ttml.im1t)/,webm:/^(vp0?[89]|av0?1|opus|vorbis)/,ogg:/^(vp0?[89]|theora|flac|opus|vorbis)/,video:/^(av0?1|avc0?[1234]|vp0?[89]|hvc1|hev1|theora|mp4v)/,audio:/^(mp4a|flac|vorbis|opus|ac-[34]|ec-3|alac|mp3|speex|aac)/,text:/^(stpp.ttml.im1t)/,muxerVideo:/^(avc0?1)/,muxerAudio:/^(mp4a)/,muxerText:/a^/};var mediaTypes=['video','audio','text'];var upperMediaTypes=['Video','Audio','Text'];var translateLegacyCodec=function translateLegacyCodec(codec){if(!codec){return codec}
return codec.replace(/avc1\.(\d+)\.(\d+)/i,function(orig,profile,avcLevel){var profileHex=('00'+Number(profile).toString(16)).slice(-2);var avcLevelHex=('00'+Number(avcLevel).toString(16)).slice(-2);return'avc1.'+profileHex+'00'+avcLevelHex})};var parseCodecs=function parseCodecs(codecString){if(codecString===void 0){codecString=''}
var codecs=codecString.split(',');var result=[];codecs.forEach(function(codec){codec=codec.trim();var codecType;mediaTypes.forEach(function(name){var match=regexs[name].exec(codec.toLowerCase());if(!match||match.length<=1){return}
codecType=name;var type=codec.substring(0,match[1].length);var details=codec.replace(type,'');result.push({type:type,details:details,mediaType:name})});if(!codecType){result.push({type:codec,details:'',mediaType:'unknown'})}});return result};var codecsFromDefault=function codecsFromDefault(master,audioGroupId){if(!master.mediaGroups.AUDIO||!audioGroupId){return null}
var audioGroup=master.mediaGroups.AUDIO[audioGroupId];if(!audioGroup){return null}
for(var name in audioGroup){var audioType=audioGroup[name];if(audioType.default&&audioType.playlists){return parseCodecs(audioType.playlists[0].attributes.CODECS)}}
return null};var isAudioCodec=function isAudioCodec(codec){if(codec===void 0){codec=''}
return regexs.audio.test(codec.trim().toLowerCase())};var isTextCodec=function isTextCodec(codec){if(codec===void 0){codec=''}
return regexs.text.test(codec.trim().toLowerCase())};var getMimeForCodec=function getMimeForCodec(codecString){if(!codecString||typeof codecString!=='string'){return}
var codecs=codecString.toLowerCase().split(',').map(function(c){return translateLegacyCodec(c.trim())});var type='video';if(codecs.length===1&&isAudioCodec(codecs[0])){type='audio'}else if(codecs.length===1&&isTextCodec(codecs[0])){type='application'}
var container='mp4';if(codecs.every(function(c){return regexs.mp4.test(c)})){container='mp4'}else if(codecs.every(function(c){return regexs.webm.test(c)})){container='webm'}else if(codecs.every(function(c){return regexs.ogg.test(c)})){container='ogg'}
return type+"/"+container+";codecs=\""+codecString+"\""};var browserSupportsCodec=function browserSupportsCodec(codecString){if(codecString===void 0){codecString=''}
return window.MediaSource&&window.MediaSource.isTypeSupported&&window.MediaSource.isTypeSupported(getMimeForCodec(codecString))||!1};var muxerSupportsCodec=function muxerSupportsCodec(codecString){if(codecString===void 0){codecString=''}
return codecString.toLowerCase().split(',').every(function(codec){codec=codec.trim();for(var i=0;i<upperMediaTypes.length;i++){var type=upperMediaTypes[i];if(regexs["muxer"+type].test(codec)){return!0}}
return!1})};var DEFAULT_AUDIO_CODEC='mp4a.40.2';var DEFAULT_VIDEO_CODEC='avc1.4d400d';var TIME_FUDGE_FACTOR=1/30;var SAFE_TIME_DELTA=TIME_FUDGE_FACTOR*3;var filterRanges=function filterRanges(timeRanges,predicate){var results=[];var i;if(timeRanges&&timeRanges.length){for(i=0;i<timeRanges.length;i++){if(predicate(timeRanges.start(i),timeRanges.end(i))){results.push([timeRanges.start(i),timeRanges.end(i)])}}}
return videojs__default["default"].createTimeRanges(results)};var findRange=function findRange(buffered,time){return filterRanges(buffered,function(start,end){return start-SAFE_TIME_DELTA<=time&&end+SAFE_TIME_DELTA>=time})};var findNextRange=function findNextRange(timeRanges,time){return filterRanges(timeRanges,function(start){return start-TIME_FUDGE_FACTOR>=time})};var findGaps=function findGaps(buffered){if(buffered.length<2){return videojs__default["default"].createTimeRanges()}
var ranges=[];for(var i=1;i<buffered.length;i++){var start=buffered.end(i-1);var end=buffered.start(i);ranges.push([start,end])}
return videojs__default["default"].createTimeRanges(ranges)};var bufferIntersection=function bufferIntersection(bufferA,bufferB){var start=null;var end=null;var arity=0;var extents=[];var ranges=[];if(!bufferA||!bufferA.length||!bufferB||!bufferB.length){return videojs__default["default"].createTimeRange()}
var count=bufferA.length;while(count--){extents.push({time:bufferA.start(count),type:'start'});extents.push({time:bufferA.end(count),type:'end'})}
count=bufferB.length;while(count--){extents.push({time:bufferB.start(count),type:'start'});extents.push({time:bufferB.end(count),type:'end'})}
extents.sort(function(a,b){return a.time-b.time});for(count=0;count<extents.length;count++){if(extents[count].type==='start'){arity++;if(arity===2){start=extents[count].time}}else if(extents[count].type==='end'){arity--;if(arity===1){end=extents[count].time}}
if(start!==null&&end!==null){ranges.push([start,end]);start=null;end=null}}
return videojs__default["default"].createTimeRanges(ranges)};var printableRange=function printableRange(range){var strArr=[];if(!range||!range.length){return''}
for(var i=0;i<range.length;i++){strArr.push(range.start(i)+' => '+range.end(i))}
return strArr.join(', ')};var timeUntilRebuffer=function timeUntilRebuffer(buffered,currentTime,playbackRate){if(playbackRate===void 0){playbackRate=1}
var bufferedEnd=buffered.length?buffered.end(buffered.length-1):0;return(bufferedEnd-currentTime)/playbackRate};var timeRangesToArray=function timeRangesToArray(timeRanges){var timeRangesList=[];for(var i=0;i<timeRanges.length;i++){timeRangesList.push({start:timeRanges.start(i),end:timeRanges.end(i)})}
return timeRangesList};var isRangeDifferent=function isRangeDifferent(a,b){if(a===b){return!1}
if(!a&&b||!b&&a){return!0}
if(a.length!==b.length){return!0}
for(var i=0;i<a.length;i++){if(a.start(i)!==b.start(i)||a.end(i)!==b.end(i)){return!0}}
return!1};var lastBufferedEnd=function lastBufferedEnd(a){if(!a||!a.length||!a.end){return}
return a.end(a.length-1)};var timeAheadOf=function timeAheadOf(range,startTime){var time=0;if(!range||!range.length){return time}
for(var i=0;i<range.length;i++){var start=range.start(i);var end=range.end(i);if(startTime>end){continue}
if(startTime>start&&startTime<=end){time+=end-startTime;continue}
time+=end-start}
return time};var createTimeRange=videojs__default["default"].createTimeRange;var segmentDurationWithParts=function segmentDurationWithParts(playlist,segment){if(!segment.preload){return segment.duration}
var result=0;(segment.parts||[]).forEach(function(p){result+=p.duration});(segment.preloadHints||[]).forEach(function(p){if(p.type==='PART'){result+=playlist.partTargetDuration}});return result};var getPartsAndSegments=function getPartsAndSegments(playlist){return(playlist.segments||[]).reduce(function(acc,segment,si){if(segment.parts){segment.parts.forEach(function(part,pi){acc.push({duration:part.duration,segmentIndex:si,partIndex:pi,part:part,segment:segment})})}else{acc.push({duration:segment.duration,segmentIndex:si,partIndex:null,segment:segment,part:null})}
return acc},[])};var getLastParts=function getLastParts(media){var lastSegment=media.segments&&media.segments.length&&media.segments[media.segments.length-1];return lastSegment&&lastSegment.parts||[]};var getKnownPartCount=function getKnownPartCount(_ref){var preloadSegment=_ref.preloadSegment;if(!preloadSegment){return}
var parts=preloadSegment.parts,preloadHints=preloadSegment.preloadHints;var partCount=(preloadHints||[]).reduce(function(count,hint){return count+(hint.type==='PART'?1:0)},0);partCount+=parts&&parts.length?parts.length:0;return partCount};var liveEdgeDelay=function liveEdgeDelay(master,media){if(media.endList){return 0}
if(master&&master.suggestedPresentationDelay){return master.suggestedPresentationDelay}
var hasParts=getLastParts(media).length>0;if(hasParts&&media.serverControl&&media.serverControl.partHoldBack){return media.serverControl.partHoldBack}else if(hasParts&&media.partTargetDuration){return media.partTargetDuration*3}else if(media.serverControl&&media.serverControl.holdBack){return media.serverControl.holdBack}else if(media.targetDuration){return media.targetDuration*3}
return 0};var backwardDuration=function backwardDuration(playlist,endSequence){var result=0;var i=endSequence-playlist.mediaSequence;var segment=playlist.segments[i];if(segment){if(typeof segment.start!=='undefined'){return{result:segment.start,precise:!0}}
if(typeof segment.end!=='undefined'){return{result:segment.end-segment.duration,precise:!0}}}
while(i--){segment=playlist.segments[i];if(typeof segment.end!=='undefined'){return{result:result+segment.end,precise:!0}}
result+=segmentDurationWithParts(playlist,segment);if(typeof segment.start!=='undefined'){return{result:result+segment.start,precise:!0}}}
return{result:result,precise:!1}};var forwardDuration=function forwardDuration(playlist,endSequence){var result=0;var segment;var i=endSequence-playlist.mediaSequence;for(;i<playlist.segments.length;i++){segment=playlist.segments[i];if(typeof segment.start!=='undefined'){return{result:segment.start-result,precise:!0}}
result+=segmentDurationWithParts(playlist,segment);if(typeof segment.end!=='undefined'){return{result:segment.end-result,precise:!0}}}
return{result:-1,precise:!1}};var intervalDuration=function intervalDuration(playlist,endSequence,expired){if(typeof endSequence==='undefined'){endSequence=playlist.mediaSequence+playlist.segments.length}
if(endSequence<playlist.mediaSequence){return 0}
var backward=backwardDuration(playlist,endSequence);if(backward.precise){return backward.result}
var forward=forwardDuration(playlist,endSequence);if(forward.precise){return forward.result}
return backward.result+expired};var duration=function duration(playlist,endSequence,expired){if(!playlist){return 0}
if(typeof expired!=='number'){expired=0}
if(typeof endSequence==='undefined'){if(playlist.totalDuration){return playlist.totalDuration}
if(!playlist.endList){return window.Infinity}}
return intervalDuration(playlist,endSequence,expired)};var sumDurations=function sumDurations(_ref2){var defaultDuration=_ref2.defaultDuration,durationList=_ref2.durationList,startIndex=_ref2.startIndex,endIndex=_ref2.endIndex;var durations=0;if(startIndex>endIndex){var _ref3=[endIndex,startIndex];startIndex=_ref3[0];endIndex=_ref3[1]}
if(startIndex<0){for(var i=startIndex;i<Math.min(0,endIndex);i++){durations+=defaultDuration}
startIndex=0}
for(var _i=startIndex;_i<endIndex;_i++){durations+=durationList[_i].duration}
return durations};var playlistEnd=function playlistEnd(playlist,expired,useSafeLiveEnd,liveEdgePadding){if(!playlist||!playlist.segments){return null}
if(playlist.endList){return duration(playlist)}
if(expired===null){return null}
expired=expired||0;var lastSegmentEndTime=intervalDuration(playlist,playlist.mediaSequence+playlist.segments.length,expired);if(useSafeLiveEnd){liveEdgePadding=typeof liveEdgePadding==='number'?liveEdgePadding:liveEdgeDelay(null,playlist);lastSegmentEndTime-=liveEdgePadding}
return Math.max(0,lastSegmentEndTime)};var seekable=function seekable(playlist,expired,liveEdgePadding){var useSafeLiveEnd=!0;var seekableStart=expired||0;var seekableEnd=playlistEnd(playlist,expired,useSafeLiveEnd,liveEdgePadding);if(seekableEnd===null){return createTimeRange()}
return createTimeRange(seekableStart,seekableEnd)};var getMediaInfoForTime=function getMediaInfoForTime(_ref4){var playlist=_ref4.playlist,currentTime=_ref4.currentTime,startingSegmentIndex=_ref4.startingSegmentIndex,startingPartIndex=_ref4.startingPartIndex,startTime=_ref4.startTime,experimentalExactManifestTimings=_ref4.experimentalExactManifestTimings;var time=currentTime-startTime;var partsAndSegments=getPartsAndSegments(playlist);var startIndex=0;for(var i=0;i<partsAndSegments.length;i++){var partAndSegment=partsAndSegments[i];if(startingSegmentIndex!==partAndSegment.segmentIndex){continue}
if(typeof startingPartIndex==='number'&&typeof partAndSegment.partIndex==='number'&&startingPartIndex!==partAndSegment.partIndex){continue}
startIndex=i;break}
if(time<0){if(startIndex>0){for(var _i2=startIndex-1;_i2>=0;_i2--){var _partAndSegment=partsAndSegments[_i2];time+=_partAndSegment.duration;if(experimentalExactManifestTimings){if(time<0){continue}}else if(time+TIME_FUDGE_FACTOR<=0){continue}
return{partIndex:_partAndSegment.partIndex,segmentIndex:_partAndSegment.segmentIndex,startTime:startTime-sumDurations({defaultDuration:playlist.targetDuration,durationList:partsAndSegments,startIndex:startIndex,endIndex:_i2})}}}
return{partIndex:partsAndSegments[0]&&partsAndSegments[0].partIndex||null,segmentIndex:partsAndSegments[0]&&partsAndSegments[0].segmentIndex||0,startTime:currentTime}}
if(startIndex<0){for(var _i3=startIndex;_i3<0;_i3++){time-=playlist.targetDuration;if(time<0){return{partIndex:partsAndSegments[0]&&partsAndSegments[0].partIndex||null,segmentIndex:partsAndSegments[0]&&partsAndSegments[0].segmentIndex||0,startTime:currentTime}}}
startIndex=0}
for(var _i4=startIndex;_i4<partsAndSegments.length;_i4++){var _partAndSegment2=partsAndSegments[_i4];time-=_partAndSegment2.duration;if(experimentalExactManifestTimings){if(time>0){continue}}else if(time-TIME_FUDGE_FACTOR>=0){continue}
return{partIndex:_partAndSegment2.partIndex,segmentIndex:_partAndSegment2.segmentIndex,startTime:startTime+sumDurations({defaultDuration:playlist.targetDuration,durationList:partsAndSegments,startIndex:startIndex,endIndex:_i4})}}
return{segmentIndex:partsAndSegments[partsAndSegments.length-1].segmentIndex,partIndex:partsAndSegments[partsAndSegments.length-1].partIndex,startTime:currentTime}};var isBlacklisted=function isBlacklisted(playlist){return playlist.excludeUntil&&playlist.excludeUntil>Date.now()};var isIncompatible=function isIncompatible(playlist){return playlist.excludeUntil&&playlist.excludeUntil===Infinity};var isEnabled=function isEnabled(playlist){var blacklisted=isBlacklisted(playlist);return!playlist.disabled&&!blacklisted};var isDisabled=function isDisabled(playlist){return playlist.disabled};var isAes=function isAes(media){for(var i=0;i<media.segments.length;i++){if(media.segments[i].key){return!0}}
return!1};var hasAttribute=function hasAttribute(attr,playlist){return playlist.attributes&&playlist.attributes[attr]};var estimateSegmentRequestTime=function estimateSegmentRequestTime(segmentDuration,bandwidth,playlist,bytesReceived){if(bytesReceived===void 0){bytesReceived=0}
if(!hasAttribute('BANDWIDTH',playlist)){return NaN}
var size=segmentDuration*playlist.attributes.BANDWIDTH;return(size-bytesReceived*8)/bandwidth};var isLowestEnabledRendition=function isLowestEnabledRendition(master,media){if(master.playlists.length===1){return!0}
var currentBandwidth=media.attributes.BANDWIDTH||Number.MAX_VALUE;return master.playlists.filter(function(playlist){if(!isEnabled(playlist)){return!1}
return(playlist.attributes.BANDWIDTH||0)<currentBandwidth}).length===0};var playlistMatch=function playlistMatch(a,b){if(!a&&!b||!a&&b||a&&!b){return!1}
if(a===b){return!0}
if(a.id&&b.id&&a.id===b.id){return!0}
if(a.resolvedUri&&b.resolvedUri&&a.resolvedUri===b.resolvedUri){return!0}
if(a.uri&&b.uri&&a.uri===b.uri){return!0}
return!1};var someAudioVariant=function someAudioVariant(master,callback){var AUDIO=master&&master.mediaGroups&&master.mediaGroups.AUDIO||{};var found=!1;for(var groupName in AUDIO){for(var label in AUDIO[groupName]){found=callback(AUDIO[groupName][label]);if(found){break}}
if(found){break}}
return!!found};var isAudioOnly=function isAudioOnly(master){if(!master||!master.playlists||!master.playlists.length){var found=someAudioVariant(master,function(variant){return variant.playlists&&variant.playlists.length||variant.uri});return found}
var _loop=function _loop(i){var playlist=master.playlists[i];var CODECS=playlist.attributes&&playlist.attributes.CODECS;if(CODECS&&CODECS.split(',').every(function(c){return isAudioCodec(c)})){return"continue"}
var found=someAudioVariant(master,function(variant){return playlistMatch(playlist,variant)});if(found){return"continue"}
return{v:!1}};for(var i=0;i<master.playlists.length;i++){var _ret=_loop(i);if(_ret==="continue")continue;if(typeof _ret==="object")return _ret.v}
return!0};var Playlist={liveEdgeDelay:liveEdgeDelay,duration:duration,seekable:seekable,getMediaInfoForTime:getMediaInfoForTime,isEnabled:isEnabled,isDisabled:isDisabled,isBlacklisted:isBlacklisted,isIncompatible:isIncompatible,playlistEnd:playlistEnd,isAes:isAes,hasAttribute:hasAttribute,estimateSegmentRequestTime:estimateSegmentRequestTime,isLowestEnabledRendition:isLowestEnabledRendition,isAudioOnly:isAudioOnly,playlistMatch:playlistMatch,segmentDurationWithParts:segmentDurationWithParts};var log=videojs__default["default"].log;var createPlaylistID=function createPlaylistID(index,uri){return index+"-"+uri};var parseManifest=function parseManifest(_ref){var onwarn=_ref.onwarn,oninfo=_ref.oninfo,manifestString=_ref.manifestString,_ref$customTagParsers=_ref.customTagParsers,customTagParsers=_ref$customTagParsers===void 0?[]:_ref$customTagParsers,_ref$customTagMappers=_ref.customTagMappers,customTagMappers=_ref$customTagMappers===void 0?[]:_ref$customTagMappers,experimentalLLHLS=_ref.experimentalLLHLS;var parser=new Parser();if(onwarn){parser.on('warn',onwarn)}
if(oninfo){parser.on('info',oninfo)}
customTagParsers.forEach(function(customParser){return parser.addParser(customParser)});customTagMappers.forEach(function(mapper){return parser.addTagMapper(mapper)});parser.push(manifestString);parser.end();var manifest=parser.manifest;if(!experimentalLLHLS){['preloadSegment','skip','serverControl','renditionReports','partInf','partTargetDuration'].forEach(function(k){if(manifest.hasOwnProperty(k)){delete manifest[k]}});if(manifest.segments){manifest.segments.forEach(function(segment){['parts','preloadHints'].forEach(function(k){if(segment.hasOwnProperty(k)){delete segment[k]}})})}}
if(!manifest.targetDuration){var targetDuration=10;if(manifest.segments&&manifest.segments.length){targetDuration=manifest.segments.reduce(function(acc,s){return Math.max(acc,s.duration)},0)}
if(onwarn){onwarn("manifest has no targetDuration defaulting to "+targetDuration)}
manifest.targetDuration=targetDuration}
var parts=getLastParts(manifest);if(parts.length&&!manifest.partTargetDuration){var partTargetDuration=parts.reduce(function(acc,p){return Math.max(acc,p.duration)},0);if(onwarn){onwarn("manifest has no partTargetDuration defaulting to "+partTargetDuration);log.error('LL-HLS manifest has parts but lacks required #EXT-X-PART-INF:PART-TARGET value. See https://datatracker.ietf.org/doc/html/draft-pantos-hls-rfc8216bis-09#section-4.4.3.7. Playback is not guaranteed.')}
manifest.partTargetDuration=partTargetDuration}
return manifest};var forEachMediaGroup$1=function forEachMediaGroup(master,callback){if(!master.mediaGroups){return}['AUDIO','SUBTITLES'].forEach(function(mediaType){if(!master.mediaGroups[mediaType]){return}
for(var groupKey in master.mediaGroups[mediaType]){for(var labelKey in master.mediaGroups[mediaType][groupKey]){var mediaProperties=master.mediaGroups[mediaType][groupKey][labelKey];callback(mediaProperties,mediaType,groupKey,labelKey)}}})};var setupMediaPlaylist=function setupMediaPlaylist(_ref2){var playlist=_ref2.playlist,uri=_ref2.uri,id=_ref2.id;playlist.id=id;playlist.playlistErrors_=0;if(uri){playlist.uri=uri}
playlist.attributes=playlist.attributes||{}};var setupMediaPlaylists=function setupMediaPlaylists(master){var i=master.playlists.length;while(i--){var playlist=master.playlists[i];setupMediaPlaylist({playlist:playlist,id:createPlaylistID(i,playlist.uri)});playlist.resolvedUri=resolveUrl(master.uri,playlist.uri);master.playlists[playlist.id]=playlist;master.playlists[playlist.uri]=playlist;if(!playlist.attributes.BANDWIDTH){log.warn('Invalid playlist STREAM-INF detected. Missing BANDWIDTH attribute.')}}};var resolveMediaGroupUris=function resolveMediaGroupUris(master){forEachMediaGroup$1(master,function(properties){if(properties.uri){properties.resolvedUri=resolveUrl(master.uri,properties.uri)}})};var masterForMedia=function masterForMedia(media,uri){var id=createPlaylistID(0,uri);var master={mediaGroups:{'AUDIO':{},'VIDEO':{},'CLOSED-CAPTIONS':{},'SUBTITLES':{}},uri:window.location.href,resolvedUri:window.location.href,playlists:[{uri:uri,id:id,resolvedUri:uri,attributes:{}}]};master.playlists[id]=master.playlists[0];master.playlists[uri]=master.playlists[0];return master};var addPropertiesToMaster=function addPropertiesToMaster(master,uri){master.uri=uri;for(var i=0;i<master.playlists.length;i++){if(!master.playlists[i].uri){var phonyUri="placeholder-uri-"+i;master.playlists[i].uri=phonyUri}}
var audioOnlyMaster=isAudioOnly(master);forEachMediaGroup$1(master,function(properties,mediaType,groupKey,labelKey){var groupId="placeholder-uri-"+mediaType+"-"+groupKey+"-"+labelKey;if(!properties.playlists||!properties.playlists.length){if(audioOnlyMaster&&mediaType==='AUDIO'&&!properties.uri){for(var _i=0;_i<master.playlists.length;_i++){var p=master.playlists[_i];if(p.attributes&&p.attributes.AUDIO&&p.attributes.AUDIO===groupKey){return}}}
properties.playlists=[_extends_1({},properties)]}
properties.playlists.forEach(function(p,i){var id=createPlaylistID(i,groupId);if(p.uri){p.resolvedUri=p.resolvedUri||resolveUrl(master.uri,p.uri)}else{p.uri=i===0?groupId:id;p.resolvedUri=p.uri}
p.id=p.id||id;p.attributes=p.attributes||{};master.playlists[p.id]=p;master.playlists[p.uri]=p})});setupMediaPlaylists(master);resolveMediaGroupUris(master)};var mergeOptions$2=videojs__default["default"].mergeOptions,EventTarget$1=videojs__default["default"].EventTarget;var addLLHLSQueryDirectives=function addLLHLSQueryDirectives(uri,media){if(media.endList||!media.serverControl){return uri}
var parameters={};if(media.serverControl.canBlockReload){var preloadSegment=media.preloadSegment;var nextMSN=media.mediaSequence+media.segments.length;if(preloadSegment){var parts=preloadSegment.parts||[];var nextPart=getKnownPartCount(media)-1;if(nextPart>-1&&nextPart!==parts.length-1){parameters._HLS_part=nextPart}
if(nextPart>-1||parts.length){nextMSN--}}
parameters._HLS_msn=nextMSN}
if(media.serverControl&&media.serverControl.canSkipUntil){parameters._HLS_skip=media.serverControl.canSkipDateranges?'v2':'YES'}
if(Object.keys(parameters).length){var parsedUri=new window.URL(uri);['_HLS_skip','_HLS_msn','_HLS_part'].forEach(function(name){if(!parameters.hasOwnProperty(name)){return}
parsedUri.searchParams.set(name,parameters[name])});uri=parsedUri.toString()}
return uri};var updateSegment=function updateSegment(a,b){if(!a){return b}
var result=mergeOptions$2(a,b);if(a.preloadHints&&!b.preloadHints){delete result.preloadHints}
if(a.parts&&!b.parts){delete result.parts}else if(a.parts&&b.parts){for(var i=0;i<b.parts.length;i++){if(a.parts&&a.parts[i]){result.parts[i]=mergeOptions$2(a.parts[i],b.parts[i])}}}
if(!a.skipped&&b.skipped){result.skipped=!1}
if(a.preload&&!b.preload){result.preload=!1}
return result};var updateSegments=function updateSegments(original,update,offset){var oldSegments=original.slice();var newSegments=update.slice();offset=offset||0;var result=[];var currentMap;for(var newIndex=0;newIndex<newSegments.length;newIndex++){var oldSegment=oldSegments[newIndex+offset];var newSegment=newSegments[newIndex];if(oldSegment){currentMap=oldSegment.map||currentMap;result.push(updateSegment(oldSegment,newSegment))}else{if(currentMap&&!newSegment.map){newSegment.map=currentMap}
result.push(newSegment)}}
return result};var resolveSegmentUris=function resolveSegmentUris(segment,baseUri){if(!segment.resolvedUri&&segment.uri){segment.resolvedUri=resolveUrl(baseUri,segment.uri)}
if(segment.key&&!segment.key.resolvedUri){segment.key.resolvedUri=resolveUrl(baseUri,segment.key.uri)}
if(segment.map&&!segment.map.resolvedUri){segment.map.resolvedUri=resolveUrl(baseUri,segment.map.uri)}
if(segment.map&&segment.map.key&&!segment.map.key.resolvedUri){segment.map.key.resolvedUri=resolveUrl(baseUri,segment.map.key.uri)}
if(segment.parts&&segment.parts.length){segment.parts.forEach(function(p){if(p.resolvedUri){return}
p.resolvedUri=resolveUrl(baseUri,p.uri)})}
if(segment.preloadHints&&segment.preloadHints.length){segment.preloadHints.forEach(function(p){if(p.resolvedUri){return}
p.resolvedUri=resolveUrl(baseUri,p.uri)})}};var getAllSegments=function getAllSegments(media){var segments=media.segments||[];var preloadSegment=media.preloadSegment;if(preloadSegment&&preloadSegment.parts&&preloadSegment.parts.length){if(preloadSegment.preloadHints){for(var i=0;i<preloadSegment.preloadHints.length;i++){if(preloadSegment.preloadHints[i].type==='MAP'){return segments}}}
preloadSegment.duration=media.targetDuration;preloadSegment.preload=!0;segments.push(preloadSegment)}
return segments};var isPlaylistUnchanged=function isPlaylistUnchanged(a,b){return a===b||a.segments&&b.segments&&a.segments.length===b.segments.length&&a.endList===b.endList&&a.mediaSequence===b.mediaSequence&&a.preloadSegment===b.preloadSegment};var updateMaster$1=function updateMaster(master,newMedia,unchangedCheck){if(unchangedCheck===void 0){unchangedCheck=isPlaylistUnchanged}
var result=mergeOptions$2(master,{});var oldMedia=result.playlists[newMedia.id];if(!oldMedia){return null}
if(unchangedCheck(oldMedia,newMedia)){return null}
newMedia.segments=getAllSegments(newMedia);var mergedPlaylist=mergeOptions$2(oldMedia,newMedia);if(mergedPlaylist.preloadSegment&&!newMedia.preloadSegment){delete mergedPlaylist.preloadSegment}
if(oldMedia.segments){if(newMedia.skip){newMedia.segments=newMedia.segments||[];for(var i=0;i<newMedia.skip.skippedSegments;i++){newMedia.segments.unshift({skipped:!0})}}
mergedPlaylist.segments=updateSegments(oldMedia.segments,newMedia.segments,newMedia.mediaSequence-oldMedia.mediaSequence)}
mergedPlaylist.segments.forEach(function(segment){resolveSegmentUris(segment,mergedPlaylist.resolvedUri)});for(var _i=0;_i<result.playlists.length;_i++){if(result.playlists[_i].id===newMedia.id){result.playlists[_i]=mergedPlaylist}}
result.playlists[newMedia.id]=mergedPlaylist;result.playlists[newMedia.uri]=mergedPlaylist;forEachMediaGroup$1(master,function(properties,mediaType,groupKey,labelKey){if(!properties.playlists){return}
for(var _i2=0;_i2<properties.playlists.length;_i2++){if(newMedia.id===properties.playlists[_i2].id){properties.playlists[_i2]=mergedPlaylist}}});return result};var refreshDelay=function refreshDelay(media,update){var segments=media.segments||[];var lastSegment=segments[segments.length-1];var lastPart=lastSegment&&lastSegment.parts&&lastSegment.parts[lastSegment.parts.length-1];var lastDuration=lastPart&&lastPart.duration||lastSegment&&lastSegment.duration;if(update&&lastDuration){return lastDuration*1000}
return(media.partTargetDuration||media.targetDuration||10)*500};var PlaylistLoader=function(_EventTarget){inheritsLoose(PlaylistLoader,_EventTarget);function PlaylistLoader(src,vhs,options){var _this;if(options===void 0){options={}}
_this=_EventTarget.call(this)||this;if(!src){throw new Error('A non-empty playlist URL or object is required')}
_this.logger_=logger('PlaylistLoader');var _options=options,_options$withCredenti=_options.withCredentials,withCredentials=_options$withCredenti===void 0?!1:_options$withCredenti,_options$handleManife=_options.handleManifestRedirects,handleManifestRedirects=_options$handleManife===void 0?!1:_options$handleManife;_this.src=src;_this.vhs_=vhs;_this.withCredentials=withCredentials;_this.handleManifestRedirects=handleManifestRedirects;var vhsOptions=vhs.options_;_this.customTagParsers=vhsOptions&&vhsOptions.customTagParsers||[];_this.customTagMappers=vhsOptions&&vhsOptions.customTagMappers||[];_this.experimentalLLHLS=vhsOptions&&vhsOptions.experimentalLLHLS||!1;if(videojs__default["default"].browser.IE_VERSION){_this.experimentalLLHLS=!1}
_this.state='HAVE_NOTHING';_this.handleMediaupdatetimeout_=_this.handleMediaupdatetimeout_.bind(assertThisInitialized(_this));_this.on('mediaupdatetimeout',_this.handleMediaupdatetimeout_);return _this}
var _proto=PlaylistLoader.prototype;_proto.handleMediaupdatetimeout_=function handleMediaupdatetimeout_(){var _this2=this;if(this.state!=='HAVE_METADATA'){return}
var media=this.media();var uri=resolveUrl(this.master.uri,media.uri);if(this.experimentalLLHLS){uri=addLLHLSQueryDirectives(uri,media)}
this.state='HAVE_CURRENT_METADATA';this.request=this.vhs_.xhr({uri:uri,withCredentials:this.withCredentials},function(error,req){if(!_this2.request){return}
if(error){return _this2.playlistRequestError(_this2.request,_this2.media(),'HAVE_METADATA')}
_this2.haveMetadata({playlistString:_this2.request.responseText,url:_this2.media().uri,id:_this2.media().id})})};_proto.playlistRequestError=function playlistRequestError(xhr,playlist,startingState){var uri=playlist.uri,id=playlist.id;this.request=null;if(startingState){this.state=startingState}
this.error={playlist:this.master.playlists[id],status:xhr.status,message:"HLS playlist request error at URL: "+uri+".",responseText:xhr.responseText,code:xhr.status>=500?4:2};this.trigger('error')};_proto.parseManifest_=function parseManifest_(_ref){var _this3=this;var url=_ref.url,manifestString=_ref.manifestString;return parseManifest({onwarn:function onwarn(_ref2){var message=_ref2.message;return _this3.logger_("m3u8-parser warn for "+url+": "+message)},oninfo:function oninfo(_ref3){var message=_ref3.message;return _this3.logger_("m3u8-parser info for "+url+": "+message)},manifestString:manifestString,customTagParsers:this.customTagParsers,customTagMappers:this.customTagMappers,experimentalLLHLS:this.experimentalLLHLS})};_proto.haveMetadata=function haveMetadata(_ref4){var playlistString=_ref4.playlistString,playlistObject=_ref4.playlistObject,url=_ref4.url,id=_ref4.id;this.request=null;this.state='HAVE_METADATA';var playlist=playlistObject||this.parseManifest_({url:url,manifestString:playlistString});playlist.lastRequest=Date.now();setupMediaPlaylist({playlist:playlist,uri:url,id:id});var update=updateMaster$1(this.master,playlist);this.targetDuration=playlist.partTargetDuration||playlist.targetDuration;this.pendingMedia_=null;if(update){this.master=update;this.media_=this.master.playlists[id]}else{this.trigger('playlistunchanged')}
this.updateMediaUpdateTimeout_(refreshDelay(this.media(),!!update));this.trigger('loadedplaylist')};_proto.dispose=function dispose(){this.trigger('dispose');this.stopRequest();window.clearTimeout(this.mediaUpdateTimeout);window.clearTimeout(this.finalRenditionTimeout);this.off()};_proto.stopRequest=function stopRequest(){if(this.request){var oldRequest=this.request;this.request=null;oldRequest.onreadystatechange=null;oldRequest.abort()}};_proto.media=function media(playlist,shouldDelay){var _this4=this;if(!playlist){return this.media_}
if(this.state==='HAVE_NOTHING'){throw new Error('Cannot switch media playlist from '+this.state)}
if(typeof playlist==='string'){if(!this.master.playlists[playlist]){throw new Error('Unknown playlist URI: '+playlist)}
playlist=this.master.playlists[playlist]}
window.clearTimeout(this.finalRenditionTimeout);if(shouldDelay){var delay=(playlist.partTargetDuration||playlist.targetDuration)/2*1000||5*1000;this.finalRenditionTimeout=window.setTimeout(this.media.bind(this,playlist,!1),delay);return}
var startingState=this.state;var mediaChange=!this.media_||playlist.id!==this.media_.id;var masterPlaylistRef=this.master.playlists[playlist.id];if(masterPlaylistRef&&masterPlaylistRef.endList||playlist.endList&&playlist.segments.length){if(this.request){this.request.onreadystatechange=null;this.request.abort();this.request=null}
this.state='HAVE_METADATA';this.media_=playlist;if(mediaChange){this.trigger('mediachanging');if(startingState==='HAVE_MASTER'){this.trigger('loadedmetadata')}else{this.trigger('mediachange')}}
return}
this.updateMediaUpdateTimeout_(refreshDelay(playlist,!0));if(!mediaChange){return}
this.state='SWITCHING_MEDIA';if(this.request){if(playlist.resolvedUri===this.request.url){return}
this.request.onreadystatechange=null;this.request.abort();this.request=null}
if(this.media_){this.trigger('mediachanging')}
this.pendingMedia_=playlist;this.request=this.vhs_.xhr({uri:playlist.resolvedUri,withCredentials:this.withCredentials},function(error,req){if(!_this4.request){return}
playlist.lastRequest=Date.now();playlist.resolvedUri=resolveManifestRedirect(_this4.handleManifestRedirects,playlist.resolvedUri,req);if(error){return _this4.playlistRequestError(_this4.request,playlist,startingState)}
_this4.haveMetadata({playlistString:req.responseText,url:playlist.uri,id:playlist.id});if(startingState==='HAVE_MASTER'){_this4.trigger('loadedmetadata')}else{_this4.trigger('mediachange')}})};_proto.pause=function pause(){if(this.mediaUpdateTimeout){window.clearTimeout(this.mediaUpdateTimeout);this.mediaUpdateTimeout=null}
this.stopRequest();if(this.state==='HAVE_NOTHING'){this.started=!1}
if(this.state==='SWITCHING_MEDIA'){if(this.media_){this.state='HAVE_METADATA'}else{this.state='HAVE_MASTER'}}else if(this.state==='HAVE_CURRENT_METADATA'){this.state='HAVE_METADATA'}};_proto.load=function load(shouldDelay){var _this5=this;if(this.mediaUpdateTimeout){window.clearTimeout(this.mediaUpdateTimeout);this.mediaUpdateTimeout=null}
var media=this.media();if(shouldDelay){var delay=media?(media.partTargetDuration||media.targetDuration)/2*1000:5*1000;this.mediaUpdateTimeout=window.setTimeout(function(){_this5.mediaUpdateTimeout=null;_this5.load()},delay);return}
if(!this.started){this.start();return}
if(media&&!media.endList){this.trigger('mediaupdatetimeout')}else{this.trigger('loadedplaylist')}};_proto.updateMediaUpdateTimeout_=function updateMediaUpdateTimeout_(delay){var _this6=this;if(this.mediaUpdateTimeout){window.clearTimeout(this.mediaUpdateTimeout);this.mediaUpdateTimeout=null}
if(!this.media()||this.media().endList){return}
this.mediaUpdateTimeout=window.setTimeout(function(){_this6.mediaUpdateTimeout=null;_this6.trigger('mediaupdatetimeout');_this6.updateMediaUpdateTimeout_(delay)},delay)};_proto.start=function start(){var _this7=this;this.started=!0;if(typeof this.src==='object'){if(!this.src.uri){this.src.uri=window.location.href}
this.src.resolvedUri=this.src.uri;setTimeout(function(){_this7.setupInitialPlaylist(_this7.src)},0);return}
this.request=this.vhs_.xhr({uri:this.src,withCredentials:this.withCredentials},function(error,req){if(!_this7.request){return}
_this7.request=null;if(error){_this7.error={status:req.status,message:"HLS playlist request error at URL: "+_this7.src+".",responseText:req.responseText,code:2};if(_this7.state==='HAVE_NOTHING'){_this7.started=!1}
return _this7.trigger('error')}
_this7.src=resolveManifestRedirect(_this7.handleManifestRedirects,_this7.src,req);var manifest=_this7.parseManifest_({manifestString:req.responseText,url:_this7.src});_this7.setupInitialPlaylist(manifest)})};_proto.srcUri=function srcUri(){return typeof this.src==='string'?this.src:this.src.uri};_proto.setupInitialPlaylist=function setupInitialPlaylist(manifest){this.state='HAVE_MASTER';if(manifest.playlists){this.master=manifest;addPropertiesToMaster(this.master,this.srcUri());manifest.playlists.forEach(function(playlist){playlist.segments=getAllSegments(playlist);playlist.segments.forEach(function(segment){resolveSegmentUris(segment,playlist.resolvedUri)})});this.trigger('loadedplaylist');if(!this.request){this.media(this.master.playlists[0])}
return}
var uri=this.srcUri()||window.location.href;this.master=masterForMedia(manifest,uri);this.haveMetadata({playlistObject:manifest,url:uri,id:this.master.playlists[0].id});this.trigger('loadedmetadata')};return PlaylistLoader}(EventTarget$1);var videojsXHR=videojs__default["default"].xhr,mergeOptions$1=videojs__default["default"].mergeOptions;var callbackWrapper=function callbackWrapper(request,error,response,callback){var reqResponse=request.responseType==='arraybuffer'?request.response:request.responseText;if(!error&&reqResponse){request.responseTime=Date.now();request.roundTripTime=request.responseTime-request.requestTime;request.bytesReceived=reqResponse.byteLength||reqResponse.length;if(!request.bandwidth){request.bandwidth=Math.floor(request.bytesReceived/request.roundTripTime*8*1000)}}
if(response.headers){request.responseHeaders=response.headers}
if(error&&error.code==='ETIMEDOUT'){request.timedout=!0}
if(!error&&!request.aborted&&response.statusCode!==200&&response.statusCode!==206&&response.statusCode!==0){error=new Error('XHR Failed with a response of: '+(request&&(reqResponse||request.responseText)))}
callback(error,request)};var xhrFactory=function xhrFactory(){var xhr=function XhrFunction(options,callback){options=mergeOptions$1({timeout:45e3},options);var beforeRequest=XhrFunction.beforeRequest||videojs__default["default"].Vhs.xhr.beforeRequest;if(beforeRequest&&typeof beforeRequest==='function'){var newOptions=beforeRequest(options);if(newOptions){options=newOptions}}
var xhrMethod=videojs__default["default"].Vhs.xhr.original===!0?videojsXHR:videojs__default["default"].Vhs.xhr;var request=xhrMethod(options,function(error,response){return callbackWrapper(request,error,response,callback)});var originalAbort=request.abort;request.abort=function(){request.aborted=!0;return originalAbort.apply(request,arguments)};request.uri=options.uri;request.requestTime=Date.now();return request};xhr.original=!0;return xhr};var byterangeStr=function byterangeStr(byterange){var byterangeEnd;var byterangeStart=byterange.offset;if(typeof byterange.offset==='bigint'||typeof byterange.length==='bigint'){byterangeEnd=window.BigInt(byterange.offset)+window.BigInt(byterange.length)-window.BigInt(1)}else{byterangeEnd=byterange.offset+byterange.length-1}
return'bytes='+byterangeStart+'-'+byterangeEnd};var segmentXhrHeaders=function segmentXhrHeaders(segment){var headers={};if(segment.byterange){headers.Range=byterangeStr(segment.byterange)}
return headers};var MPEGURL_REGEX=/^(audio|video|application)\/(x-|vnd\.apple\.)?mpegurl/i;var DASH_REGEX=/^application\/dash\+xml/i;var simpleTypeFromSourceType=function simpleTypeFromSourceType(type){if(MPEGURL_REGEX.test(type)){return'hls'}
if(DASH_REGEX.test(type)){return'dash'}
if(type==='application/vnd.videojs.vhs+json'){return'vhs-json'}
return null};var countBits=function countBits(x){return x.toString(2).length};var countBytes=function countBytes(x){return Math.ceil(countBits(x)/8)};var isArrayBufferView=function isArrayBufferView(obj){if(ArrayBuffer.isView==='function'){return ArrayBuffer.isView(obj)}
return obj&&obj.buffer instanceof ArrayBuffer};var isTypedArray=function isTypedArray(obj){return isArrayBufferView(obj)};var toUint8=function toUint8(bytes){if(bytes instanceof Uint8Array){return bytes}
if(!Array.isArray(bytes)&&!isTypedArray(bytes)&&!(bytes instanceof ArrayBuffer)){if(typeof bytes!=='number'||typeof bytes==='number'&&bytes!==bytes){bytes=0}else{bytes=[bytes]}}
return new Uint8Array(bytes&&bytes.buffer||bytes,bytes&&bytes.byteOffset||0,bytes&&bytes.byteLength||0)};var BigInt=window.BigInt||Number;var BYTE_TABLE=[BigInt('0x1'),BigInt('0x100'),BigInt('0x10000'),BigInt('0x1000000'),BigInt('0x100000000'),BigInt('0x10000000000'),BigInt('0x1000000000000'),BigInt('0x100000000000000'),BigInt('0x10000000000000000')];(function(){var a=new Uint16Array([0xFFCC]);var b=new Uint8Array(a.buffer,a.byteOffset,a.byteLength);if(b[0]===0xFF){return'big'}
if(b[0]===0xCC){return'little'}
return'unknown'})();var bytesToNumber=function bytesToNumber(bytes,_temp){var _ref=_temp===void 0?{}:_temp,_ref$signed=_ref.signed,signed=_ref$signed===void 0?!1:_ref$signed,_ref$le=_ref.le,le=_ref$le===void 0?!1:_ref$le;bytes=toUint8(bytes);var fn=le?'reduce':'reduceRight';var obj=bytes[fn]?bytes[fn]:Array.prototype[fn];var number=obj.call(bytes,function(total,byte,i){var exponent=le?i:Math.abs(i+1-bytes.length);return total+BigInt(byte)*BYTE_TABLE[exponent]},BigInt(0));if(signed){var max=BYTE_TABLE[bytes.length]/BigInt(2)-BigInt(1);number=BigInt(number);if(number>max){number-=max;number-=max;number-=BigInt(2)}}
return Number(number)};var numberToBytes=function numberToBytes(number,_temp2){var _ref2=_temp2===void 0?{}:_temp2,_ref2$le=_ref2.le,le=_ref2$le===void 0?!1:_ref2$le;if(typeof number!=='bigint'&&typeof number!=='number'||typeof number==='number'&&number!==number){number=0}
number=BigInt(number);var byteCount=countBytes(number);var bytes=new Uint8Array(new ArrayBuffer(byteCount));for(var i=0;i<byteCount;i++){var byteIndex=le?i:Math.abs(i+1-bytes.length);bytes[byteIndex]=Number(number/BYTE_TABLE[i]&BigInt(0xFF));if(number<0){bytes[byteIndex]=Math.abs(~bytes[byteIndex]);bytes[byteIndex]-=i===0?1:2}}
return bytes};var stringToBytes=function stringToBytes(string,stringIsBytes){if(typeof string!=='string'&&string&&typeof string.toString==='function'){string=string.toString()}
if(typeof string!=='string'){return new Uint8Array()}
if(!stringIsBytes){string=unescape(encodeURIComponent(string))}
var view=new Uint8Array(string.length);for(var i=0;i<string.length;i++){view[i]=string.charCodeAt(i)}
return view};var concatTypedArrays=function concatTypedArrays(){for(var _len=arguments.length,buffers=new Array(_len),_key=0;_key<_len;_key++){buffers[_key]=arguments[_key]}
buffers=buffers.filter(function(b){return b&&(b.byteLength||b.length)&&typeof b!=='string'});if(buffers.length<=1){return toUint8(buffers[0])}
var totalLen=buffers.reduce(function(total,buf,i){return total+(buf.byteLength||buf.length)},0);var tempBuffer=new Uint8Array(totalLen);var offset=0;buffers.forEach(function(buf){buf=toUint8(buf);tempBuffer.set(buf,offset);offset+=buf.byteLength});return tempBuffer};var bytesMatch=function bytesMatch(a,b,_temp3){var _ref3=_temp3===void 0?{}:_temp3,_ref3$offset=_ref3.offset,offset=_ref3$offset===void 0?0:_ref3$offset,_ref3$mask=_ref3.mask,mask=_ref3$mask===void 0?[]:_ref3$mask;a=toUint8(a);b=toUint8(b);var fn=b.every?b.every:Array.prototype.every;return b.length&&a.length-offset>=b.length&&fn.call(b,function(bByte,i){var aByte=mask[i]?mask[i]&a[offset+i]:a[offset+i];return bByte===aByte})};var textRange=function textRange(range,i){return range.start(i)+'-'+range.end(i)};var formatHexString=function formatHexString(e,i){var value=e.toString(16);return'00'.substring(0,2-value.length)+value+(i%2?' ':'')};var formatAsciiString=function formatAsciiString(e){if(e>=0x20&&e<0x7e){return String.fromCharCode(e)}
return'.'};var createTransferableMessage=function createTransferableMessage(message){var transferable={};Object.keys(message).forEach(function(key){var value=message[key];if(isArrayBufferView(value)){transferable[key]={bytes:value.buffer,byteOffset:value.byteOffset,byteLength:value.byteLength}}else{transferable[key]=value}});return transferable};var initSegmentId=function initSegmentId(initSegment){var byterange=initSegment.byterange||{length:Infinity,offset:0};return[byterange.length,byterange.offset,initSegment.resolvedUri].join(',')};var segmentKeyId=function segmentKeyId(key){return key.resolvedUri};var hexDump=function hexDump(data){var bytes=Array.prototype.slice.call(data);var step=16;var result='';var hex;var ascii;for(var j=0;j<bytes.length/step;j++){hex=bytes.slice(j*step,j*step+step).map(formatHexString).join('');ascii=bytes.slice(j*step,j*step+step).map(formatAsciiString).join('');result+=hex+' '+ascii+'\n'}
return result};var tagDump=function tagDump(_ref){var bytes=_ref.bytes;return hexDump(bytes)};var textRanges=function textRanges(ranges){var result='';var i;for(i=0;i<ranges.length;i++){result+=textRange(ranges,i)+' '}
return result};var utils=Object.freeze({__proto__:null,createTransferableMessage:createTransferableMessage,initSegmentId:initSegmentId,segmentKeyId:segmentKeyId,hexDump:hexDump,tagDump:tagDump,textRanges:textRanges});var SEGMENT_END_FUDGE_PERCENT=0.25;var playerTimeToProgramTime=function playerTimeToProgramTime(playerTime,segment){if(!segment.dateTimeObject){return null}
var transmuxerPrependedSeconds=segment.videoTimingInfo.transmuxerPrependedSeconds;var transmuxedStart=segment.videoTimingInfo.transmuxedPresentationStart;var startOfSegment=transmuxedStart+transmuxerPrependedSeconds;var offsetFromSegmentStart=playerTime-startOfSegment;return new Date(segment.dateTimeObject.getTime()+offsetFromSegmentStart*1000)};var originalSegmentVideoDuration=function originalSegmentVideoDuration(videoTimingInfo){return videoTimingInfo.transmuxedPresentationEnd-videoTimingInfo.transmuxedPresentationStart-videoTimingInfo.transmuxerPrependedSeconds};var findSegmentForProgramTime=function findSegmentForProgramTime(programTime,playlist){var dateTimeObject;try{dateTimeObject=new Date(programTime)}catch(e){return null}
if(!playlist||!playlist.segments||playlist.segments.length===0){return null}
var segment=playlist.segments[0];if(dateTimeObject<segment.dateTimeObject){return null}
for(var i=0;i<playlist.segments.length-1;i++){segment=playlist.segments[i];var nextSegmentStart=playlist.segments[i+1].dateTimeObject;if(dateTimeObject<nextSegmentStart){break}}
var lastSegment=playlist.segments[playlist.segments.length-1];var lastSegmentStart=lastSegment.dateTimeObject;var lastSegmentDuration=lastSegment.videoTimingInfo?originalSegmentVideoDuration(lastSegment.videoTimingInfo):lastSegment.duration+lastSegment.duration*SEGMENT_END_FUDGE_PERCENT;var lastSegmentEnd=new Date(lastSegmentStart.getTime()+lastSegmentDuration*1000);if(dateTimeObject>lastSegmentEnd){return null}
if(dateTimeObject>lastSegmentStart){segment=lastSegment}
return{segment:segment,estimatedStart:segment.videoTimingInfo?segment.videoTimingInfo.transmuxedPresentationStart:Playlist.duration(playlist,playlist.mediaSequence+playlist.segments.indexOf(segment)),type:segment.videoTimingInfo?'accurate':'estimate'}};var findSegmentForPlayerTime=function findSegmentForPlayerTime(time,playlist){if(!playlist||!playlist.segments||playlist.segments.length===0){return null}
var segmentEnd=0;var segment;for(var i=0;i<playlist.segments.length;i++){segment=playlist.segments[i];segmentEnd=segment.videoTimingInfo?segment.videoTimingInfo.transmuxedPresentationEnd:segmentEnd+segment.duration;if(time<=segmentEnd){break}}
var lastSegment=playlist.segments[playlist.segments.length-1];if(lastSegment.videoTimingInfo&&lastSegment.videoTimingInfo.transmuxedPresentationEnd<time){return null}
if(time>segmentEnd){if(time>segmentEnd+lastSegment.duration*SEGMENT_END_FUDGE_PERCENT){return null}
segment=lastSegment}
return{segment:segment,estimatedStart:segment.videoTimingInfo?segment.videoTimingInfo.transmuxedPresentationStart:segmentEnd-segment.duration,type:segment.videoTimingInfo?'accurate':'estimate'}};var getOffsetFromTimestamp=function getOffsetFromTimestamp(comparisonTimeStamp,programTime){var segmentDateTime;var programDateTime;try{segmentDateTime=new Date(comparisonTimeStamp);programDateTime=new Date(programTime)}catch(e){}
var segmentTimeEpoch=segmentDateTime.getTime();var programTimeEpoch=programDateTime.getTime();return(programTimeEpoch-segmentTimeEpoch)/1000};var verifyProgramDateTimeTags=function verifyProgramDateTimeTags(playlist){if(!playlist.segments||playlist.segments.length===0){return!1}
for(var i=0;i<playlist.segments.length;i++){var segment=playlist.segments[i];if(!segment.dateTimeObject){return!1}}
return!0};var getProgramTime=function getProgramTime(_ref){var playlist=_ref.playlist,_ref$time=_ref.time,time=_ref$time===void 0?undefined:_ref$time,callback=_ref.callback;if(!callback){throw new Error('getProgramTime: callback must be provided')}
if(!playlist||time===undefined){return callback({message:'getProgramTime: playlist and time must be provided'})}
var matchedSegment=findSegmentForPlayerTime(time,playlist);if(!matchedSegment){return callback({message:'valid programTime was not found'})}
if(matchedSegment.type==='estimate'){return callback({message:'Accurate programTime could not be determined.'+' Please seek to e.seekTime and try again',seekTime:matchedSegment.estimatedStart})}
var programTimeObject={mediaSeconds:time};var programTime=playerTimeToProgramTime(time,matchedSegment.segment);if(programTime){programTimeObject.programDateTime=programTime.toISOString()}
return callback(null,programTimeObject)};var seekToProgramTime=function seekToProgramTime(_ref2){var programTime=_ref2.programTime,playlist=_ref2.playlist,_ref2$retryCount=_ref2.retryCount,retryCount=_ref2$retryCount===void 0?2:_ref2$retryCount,seekTo=_ref2.seekTo,_ref2$pauseAfterSeek=_ref2.pauseAfterSeek,pauseAfterSeek=_ref2$pauseAfterSeek===void 0?!0:_ref2$pauseAfterSeek,tech=_ref2.tech,callback=_ref2.callback;if(!callback){throw new Error('seekToProgramTime: callback must be provided')}
if(typeof programTime==='undefined'||!playlist||!seekTo){return callback({message:'seekToProgramTime: programTime, seekTo and playlist must be provided'})}
if(!playlist.endList&&!tech.hasStarted_){return callback({message:'player must be playing a live stream to start buffering'})}
if(!verifyProgramDateTimeTags(playlist)){return callback({message:'programDateTime tags must be provided in the manifest '+playlist.resolvedUri})}
var matchedSegment=findSegmentForProgramTime(programTime,playlist);if(!matchedSegment){return callback({message:programTime+" was not found in the stream"})}
var segment=matchedSegment.segment;var mediaOffset=getOffsetFromTimestamp(segment.dateTimeObject,programTime);if(matchedSegment.type==='estimate'){if(retryCount===0){return callback({message:programTime+" is not buffered yet. Try again"})}
seekTo(matchedSegment.estimatedStart+mediaOffset);tech.one('seeked',function(){seekToProgramTime({programTime:programTime,playlist:playlist,retryCount:retryCount-1,seekTo:seekTo,pauseAfterSeek:pauseAfterSeek,tech:tech,callback:callback})});return}
var seekToTime=segment.start+mediaOffset;var seekedCallback=function seekedCallback(){return callback(null,tech.currentTime())};tech.one('seeked',seekedCallback);if(pauseAfterSeek){tech.pause()}
seekTo(seekToTime)};var forEachMediaGroup=function forEachMediaGroup(master,groups,callback){groups.forEach(function(mediaType){for(var groupKey in master.mediaGroups[mediaType]){for(var labelKey in master.mediaGroups[mediaType][groupKey]){var mediaProperties=master.mediaGroups[mediaType][groupKey][labelKey];callback(mediaProperties,mediaType,groupKey,labelKey)}}})};/*! @name mpd-parser @version 0.22.1 @license Apache-2.0 */
var isObject=function isObject(obj){return!!obj&&typeof obj==='object'};var merge=function merge(){for(var _len=arguments.length,objects=new Array(_len),_key=0;_key<_len;_key++){objects[_key]=arguments[_key]}
return objects.reduce(function(result,source){if(typeof source!=='object'){return result}
Object.keys(source).forEach(function(key){if(Array.isArray(result[key])&&Array.isArray(source[key])){result[key]=result[key].concat(source[key])}else if(isObject(result[key])&&isObject(source[key])){result[key]=merge(result[key],source[key])}else{result[key]=source[key]}});return result},{})};var values=function values(o){return Object.keys(o).map(function(k){return o[k]})};var range=function range(start,end){var result=[];for(var i=start;i<end;i++){result.push(i)}
return result};var flatten=function flatten(lists){return lists.reduce(function(x,y){return x.concat(y)},[])};var from=function from(list){if(!list.length){return[]}
var result=[];for(var i=0;i<list.length;i++){result.push(list[i])}
return result};var findIndexes=function findIndexes(l,key){return l.reduce(function(a,e,i){if(e[key]){a.push(i)}
return a},[])};var findIndex=function findIndex(list,matchingFunction){for(var i=0;i<list.length;i++){if(matchingFunction(list[i])){return i}}
return-1};var union=function union(lists,keyFunction){return values(lists.reduce(function(acc,list){list.forEach(function(el){acc[keyFunction(el)]=el});return acc},{}))};var errors={INVALID_NUMBER_OF_PERIOD:'INVALID_NUMBER_OF_PERIOD',DASH_EMPTY_MANIFEST:'DASH_EMPTY_MANIFEST',DASH_INVALID_XML:'DASH_INVALID_XML',NO_BASE_URL:'NO_BASE_URL',MISSING_SEGMENT_INFORMATION:'MISSING_SEGMENT_INFORMATION',SEGMENT_TIME_UNSPECIFIED:'SEGMENT_TIME_UNSPECIFIED',UNSUPPORTED_UTC_TIMING_SCHEME:'UNSUPPORTED_UTC_TIMING_SCHEME'};var urlTypeToSegment=function urlTypeToSegment(_ref){var _ref$baseUrl=_ref.baseUrl,baseUrl=_ref$baseUrl===void 0?'':_ref$baseUrl,_ref$source=_ref.source,source=_ref$source===void 0?'':_ref$source,_ref$range=_ref.range,range=_ref$range===void 0?'':_ref$range,_ref$indexRange=_ref.indexRange,indexRange=_ref$indexRange===void 0?'':_ref$indexRange;var segment={uri:source,resolvedUri:resolveUrl$1(baseUrl||'',source)};if(range||indexRange){var rangeStr=range?range:indexRange;var ranges=rangeStr.split('-');var startRange=window.BigInt?window.BigInt(ranges[0]):parseInt(ranges[0],10);var endRange=window.BigInt?window.BigInt(ranges[1]):parseInt(ranges[1],10);if(startRange<Number.MAX_SAFE_INTEGER&&typeof startRange==='bigint'){startRange=Number(startRange)}
if(endRange<Number.MAX_SAFE_INTEGER&&typeof endRange==='bigint'){endRange=Number(endRange)}
var length;if(typeof endRange==='bigint'||typeof startRange==='bigint'){length=window.BigInt(endRange)-window.BigInt(startRange)+window.BigInt(1)}else{length=endRange-startRange+1}
if(typeof length==='bigint'&&length<Number.MAX_SAFE_INTEGER){length=Number(length)}
segment.byterange={length:length,offset:startRange}}
return segment};var byteRangeToString=function byteRangeToString(byterange){var endRange;if(typeof byterange.offset==='bigint'||typeof byterange.length==='bigint'){endRange=window.BigInt(byterange.offset)+window.BigInt(byterange.length)-window.BigInt(1)}else{endRange=byterange.offset+byterange.length-1}
return byterange.offset+"-"+endRange};var parseEndNumber=function parseEndNumber(endNumber){if(endNumber&&typeof endNumber!=='number'){endNumber=parseInt(endNumber,10)}
if(isNaN(endNumber)){return null}
return endNumber};var segmentRange={static:function _static(attributes){var duration=attributes.duration,_attributes$timescale=attributes.timescale,timescale=_attributes$timescale===void 0?1:_attributes$timescale,sourceDuration=attributes.sourceDuration,periodDuration=attributes.periodDuration;var endNumber=parseEndNumber(attributes.endNumber);var segmentDuration=duration/timescale;if(typeof endNumber==='number'){return{start:0,end:endNumber}}
if(typeof periodDuration==='number'){return{start:0,end:periodDuration/segmentDuration}}
return{start:0,end:sourceDuration/segmentDuration}},dynamic:function dynamic(attributes){var NOW=attributes.NOW,clientOffset=attributes.clientOffset,availabilityStartTime=attributes.availabilityStartTime,_attributes$timescale2=attributes.timescale,timescale=_attributes$timescale2===void 0?1:_attributes$timescale2,duration=attributes.duration,_attributes$periodSta=attributes.periodStart,periodStart=_attributes$periodSta===void 0?0:_attributes$periodSta,_attributes$minimumUp=attributes.minimumUpdatePeriod,minimumUpdatePeriod=_attributes$minimumUp===void 0?0:_attributes$minimumUp,_attributes$timeShift=attributes.timeShiftBufferDepth,timeShiftBufferDepth=_attributes$timeShift===void 0?Infinity:_attributes$timeShift;var endNumber=parseEndNumber(attributes.endNumber);var now=(NOW+clientOffset)/1000;var periodStartWC=availabilityStartTime+periodStart;var periodEndWC=now+minimumUpdatePeriod;var periodDuration=periodEndWC-periodStartWC;var segmentCount=Math.ceil(periodDuration*timescale/duration);var availableStart=Math.floor((now-periodStartWC-timeShiftBufferDepth)*timescale/duration);var availableEnd=Math.floor((now-periodStartWC)*timescale/duration);return{start:Math.max(0,availableStart),end:typeof endNumber==='number'?endNumber:Math.min(segmentCount,availableEnd)}}};var toSegments=function toSegments(attributes){return function(number){var duration=attributes.duration,_attributes$timescale3=attributes.timescale,timescale=_attributes$timescale3===void 0?1:_attributes$timescale3,periodStart=attributes.periodStart,_attributes$startNumb=attributes.startNumber,startNumber=_attributes$startNumb===void 0?1:_attributes$startNumb;return{number:startNumber+number,duration:duration/timescale,timeline:periodStart,time:number*duration}}};var parseByDuration=function parseByDuration(attributes){var type=attributes.type,duration=attributes.duration,_attributes$timescale4=attributes.timescale,timescale=_attributes$timescale4===void 0?1:_attributes$timescale4,periodDuration=attributes.periodDuration,sourceDuration=attributes.sourceDuration;var _segmentRange$type=segmentRange[type](attributes),start=_segmentRange$type.start,end=_segmentRange$type.end;var segments=range(start,end).map(toSegments(attributes));if(type==='static'){var index=segments.length-1;var sectionDuration=typeof periodDuration==='number'?periodDuration:sourceDuration;segments[index].duration=sectionDuration-duration/timescale*index}
return segments};var segmentsFromBase=function segmentsFromBase(attributes){var baseUrl=attributes.baseUrl,_attributes$initializ=attributes.initialization,initialization=_attributes$initializ===void 0?{}:_attributes$initializ,sourceDuration=attributes.sourceDuration,_attributes$indexRang=attributes.indexRange,indexRange=_attributes$indexRang===void 0?'':_attributes$indexRang,periodStart=attributes.periodStart,presentationTime=attributes.presentationTime,_attributes$number=attributes.number,number=_attributes$number===void 0?0:_attributes$number,duration=attributes.duration;if(!baseUrl){throw new Error(errors.NO_BASE_URL)}
var initSegment=urlTypeToSegment({baseUrl:baseUrl,source:initialization.sourceURL,range:initialization.range});var segment=urlTypeToSegment({baseUrl:baseUrl,source:baseUrl,indexRange:indexRange});segment.map=initSegment;if(duration){var segmentTimeInfo=parseByDuration(attributes);if(segmentTimeInfo.length){segment.duration=segmentTimeInfo[0].duration;segment.timeline=segmentTimeInfo[0].timeline}}else if(sourceDuration){segment.duration=sourceDuration;segment.timeline=periodStart}
segment.presentationTime=presentationTime||periodStart;segment.number=number;return[segment]};var addSidxSegmentsToPlaylist$1=function addSidxSegmentsToPlaylist(playlist,sidx,baseUrl){var initSegment=playlist.sidx.map?playlist.sidx.map:null;var sourceDuration=playlist.sidx.duration;var timeline=playlist.timeline||0;var sidxByteRange=playlist.sidx.byterange;var sidxEnd=sidxByteRange.offset+sidxByteRange.length;var timescale=sidx.timescale;var mediaReferences=sidx.references.filter(function(r){return r.referenceType!==1});var segments=[];var type=playlist.endList?'static':'dynamic';var periodStart=playlist.sidx.timeline;var presentationTime=periodStart;var number=playlist.mediaSequence||0;var startIndex;if(typeof sidx.firstOffset==='bigint'){startIndex=window.BigInt(sidxEnd)+sidx.firstOffset}else{startIndex=sidxEnd+sidx.firstOffset}
for(var i=0;i<mediaReferences.length;i++){var reference=sidx.references[i];var size=reference.referencedSize;var duration=reference.subsegmentDuration;var endIndex=void 0;if(typeof startIndex==='bigint'){endIndex=startIndex+window.BigInt(size)-window.BigInt(1)}else{endIndex=startIndex+size-1}
var indexRange=startIndex+"-"+endIndex;var attributes={baseUrl:baseUrl,timescale:timescale,timeline:timeline,periodStart:periodStart,presentationTime:presentationTime,number:number,duration:duration,sourceDuration:sourceDuration,indexRange:indexRange,type:type};var segment=segmentsFromBase(attributes)[0];if(initSegment){segment.map=initSegment}
segments.push(segment);if(typeof startIndex==='bigint'){startIndex+=window.BigInt(size)}else{startIndex+=size}
presentationTime+=duration/timescale;number++}
playlist.segments=segments;return playlist};var SUPPORTED_MEDIA_TYPES=['AUDIO','SUBTITLES'];var TIME_FUDGE=1/60;var getUniqueTimelineStarts=function getUniqueTimelineStarts(timelineStarts){return union(timelineStarts,function(_ref){var timeline=_ref.timeline;return timeline}).sort(function(a,b){return a.timeline>b.timeline?1:-1})};var findPlaylistWithName=function findPlaylistWithName(playlists,name){for(var i=0;i<playlists.length;i++){if(playlists[i].attributes.NAME===name){return playlists[i]}}
return null};var getMediaGroupPlaylists=function getMediaGroupPlaylists(manifest){var mediaGroupPlaylists=[];forEachMediaGroup(manifest,SUPPORTED_MEDIA_TYPES,function(properties,type,group,label){mediaGroupPlaylists=mediaGroupPlaylists.concat(properties.playlists||[])});return mediaGroupPlaylists};var updateMediaSequenceForPlaylist=function updateMediaSequenceForPlaylist(_ref2){var playlist=_ref2.playlist,mediaSequence=_ref2.mediaSequence;playlist.mediaSequence=mediaSequence;playlist.segments.forEach(function(segment,index){segment.number=playlist.mediaSequence+index})};var updateSequenceNumbers=function updateSequenceNumbers(_ref3){var oldPlaylists=_ref3.oldPlaylists,newPlaylists=_ref3.newPlaylists,timelineStarts=_ref3.timelineStarts;newPlaylists.forEach(function(playlist){playlist.discontinuitySequence=findIndex(timelineStarts,function(_ref4){var timeline=_ref4.timeline;return timeline===playlist.timeline});var oldPlaylist=findPlaylistWithName(oldPlaylists,playlist.attributes.NAME);if(!oldPlaylist){return}
if(playlist.sidx){return}
var firstNewSegment=playlist.segments[0];var oldMatchingSegmentIndex=findIndex(oldPlaylist.segments,function(oldSegment){return Math.abs(oldSegment.presentationTime-firstNewSegment.presentationTime)<TIME_FUDGE});if(oldMatchingSegmentIndex===-1){updateMediaSequenceForPlaylist({playlist:playlist,mediaSequence:oldPlaylist.mediaSequence+oldPlaylist.segments.length});playlist.segments[0].discontinuity=!0;playlist.discontinuityStarts.unshift(0);if(!oldPlaylist.segments.length&&playlist.timeline>oldPlaylist.timeline||oldPlaylist.segments.length&&playlist.timeline>oldPlaylist.segments[oldPlaylist.segments.length-1].timeline){playlist.discontinuitySequence--}
return}
var oldMatchingSegment=oldPlaylist.segments[oldMatchingSegmentIndex];if(oldMatchingSegment.discontinuity&&!firstNewSegment.discontinuity){firstNewSegment.discontinuity=!0;playlist.discontinuityStarts.unshift(0);playlist.discontinuitySequence--}
updateMediaSequenceForPlaylist({playlist:playlist,mediaSequence:oldPlaylist.segments[oldMatchingSegmentIndex].number})})};var positionManifestOnTimeline=function positionManifestOnTimeline(_ref5){var oldManifest=_ref5.oldManifest,newManifest=_ref5.newManifest;var oldPlaylists=oldManifest.playlists.concat(getMediaGroupPlaylists(oldManifest));var newPlaylists=newManifest.playlists.concat(getMediaGroupPlaylists(newManifest));newManifest.timelineStarts=getUniqueTimelineStarts([oldManifest.timelineStarts,newManifest.timelineStarts]);updateSequenceNumbers({oldPlaylists:oldPlaylists,newPlaylists:newPlaylists,timelineStarts:newManifest.timelineStarts});return newManifest};var generateSidxKey=function generateSidxKey(sidx){return sidx&&sidx.uri+'-'+byteRangeToString(sidx.byterange)};var mergeDiscontiguousPlaylists=function mergeDiscontiguousPlaylists(playlists){var mergedPlaylists=values(playlists.reduce(function(acc,playlist){var name=playlist.attributes.id+(playlist.attributes.lang||'');if(!acc[name]){acc[name]=playlist;acc[name].attributes.timelineStarts=[]}else{if(playlist.segments){var _acc$name$segments;if(playlist.segments[0]){playlist.segments[0].discontinuity=!0}(_acc$name$segments=acc[name].segments).push.apply(_acc$name$segments,playlist.segments)}
if(playlist.attributes.contentProtection){acc[name].attributes.contentProtection=playlist.attributes.contentProtection}}
acc[name].attributes.timelineStarts.push({start:playlist.attributes.periodStart,timeline:playlist.attributes.periodStart});return acc},{}));return mergedPlaylists.map(function(playlist){playlist.discontinuityStarts=findIndexes(playlist.segments||[],'discontinuity');return playlist})};var addSidxSegmentsToPlaylist=function addSidxSegmentsToPlaylist(playlist,sidxMapping){var sidxKey=generateSidxKey(playlist.sidx);var sidxMatch=sidxKey&&sidxMapping[sidxKey]&&sidxMapping[sidxKey].sidx;if(sidxMatch){addSidxSegmentsToPlaylist$1(playlist,sidxMatch,playlist.sidx.resolvedUri)}
return playlist};var addSidxSegmentsToPlaylists=function addSidxSegmentsToPlaylists(playlists,sidxMapping){if(sidxMapping===void 0){sidxMapping={}}
if(!Object.keys(sidxMapping).length){return playlists}
for(var i in playlists){playlists[i]=addSidxSegmentsToPlaylist(playlists[i],sidxMapping)}
return playlists};var formatAudioPlaylist=function formatAudioPlaylist(_ref,isAudioOnly){var _attributes;var attributes=_ref.attributes,segments=_ref.segments,sidx=_ref.sidx,mediaSequence=_ref.mediaSequence,discontinuitySequence=_ref.discontinuitySequence,discontinuityStarts=_ref.discontinuityStarts;var playlist={attributes:(_attributes={NAME:attributes.id,BANDWIDTH:attributes.bandwidth,CODECS:attributes.codecs},_attributes['PROGRAM-ID']=1,_attributes),uri:'',endList:attributes.type==='static',timeline:attributes.periodStart,resolvedUri:'',targetDuration:attributes.duration,discontinuitySequence:discontinuitySequence,discontinuityStarts:discontinuityStarts,timelineStarts:attributes.timelineStarts,mediaSequence:mediaSequence,segments:segments};if(attributes.contentProtection){playlist.contentProtection=attributes.contentProtection}
if(sidx){playlist.sidx=sidx}
if(isAudioOnly){playlist.attributes.AUDIO='audio';playlist.attributes.SUBTITLES='subs'}
return playlist};var formatVttPlaylist=function formatVttPlaylist(_ref2){var _m3u8Attributes;var attributes=_ref2.attributes,segments=_ref2.segments,mediaSequence=_ref2.mediaSequence,discontinuityStarts=_ref2.discontinuityStarts,discontinuitySequence=_ref2.discontinuitySequence;if(typeof segments==='undefined'){segments=[{uri:attributes.baseUrl,timeline:attributes.periodStart,resolvedUri:attributes.baseUrl||'',duration:attributes.sourceDuration,number:0}];attributes.duration=attributes.sourceDuration}
var m3u8Attributes=(_m3u8Attributes={NAME:attributes.id,BANDWIDTH:attributes.bandwidth},_m3u8Attributes['PROGRAM-ID']=1,_m3u8Attributes);if(attributes.codecs){m3u8Attributes.CODECS=attributes.codecs}
return{attributes:m3u8Attributes,uri:'',endList:attributes.type==='static',timeline:attributes.periodStart,resolvedUri:attributes.baseUrl||'',targetDuration:attributes.duration,timelineStarts:attributes.timelineStarts,discontinuityStarts:discontinuityStarts,discontinuitySequence:discontinuitySequence,mediaSequence:mediaSequence,segments:segments}};var organizeAudioPlaylists=function organizeAudioPlaylists(playlists,sidxMapping,isAudioOnly){if(sidxMapping===void 0){sidxMapping={}}
if(isAudioOnly===void 0){isAudioOnly=!1}
var mainPlaylist;var formattedPlaylists=playlists.reduce(function(a,playlist){var role=playlist.attributes.role&&playlist.attributes.role.value||'';var language=playlist.attributes.lang||'';var label=playlist.attributes.label||'main';if(language&&!playlist.attributes.label){var roleLabel=role?" ("+role+")":'';label=""+playlist.attributes.lang+roleLabel}
if(!a[label]){a[label]={language:language,autoselect:!0,default:role==='main',playlists:[],uri:''}}
var formatted=addSidxSegmentsToPlaylist(formatAudioPlaylist(playlist,isAudioOnly),sidxMapping);a[label].playlists.push(formatted);if(typeof mainPlaylist==='undefined'&&role==='main'){mainPlaylist=playlist;mainPlaylist.default=!0}
return a},{});if(!mainPlaylist){var firstLabel=Object.keys(formattedPlaylists)[0];formattedPlaylists[firstLabel].default=!0}
return formattedPlaylists};var organizeVttPlaylists=function organizeVttPlaylists(playlists,sidxMapping){if(sidxMapping===void 0){sidxMapping={}}
return playlists.reduce(function(a,playlist){var label=playlist.attributes.lang||'text';if(!a[label]){a[label]={language:label,default:!1,autoselect:!1,playlists:[],uri:''}}
a[label].playlists.push(addSidxSegmentsToPlaylist(formatVttPlaylist(playlist),sidxMapping));return a},{})};var organizeCaptionServices=function organizeCaptionServices(captionServices){return captionServices.reduce(function(svcObj,svc){if(!svc){return svcObj}
svc.forEach(function(service){var channel=service.channel,language=service.language;svcObj[language]={autoselect:!1,default:!1,instreamId:channel,language:language};if(service.hasOwnProperty('aspectRatio')){svcObj[language].aspectRatio=service.aspectRatio}
if(service.hasOwnProperty('easyReader')){svcObj[language].easyReader=service.easyReader}
if(service.hasOwnProperty('3D')){svcObj[language]['3D']=service['3D']}});return svcObj},{})};var formatVideoPlaylist=function formatVideoPlaylist(_ref3){var _attributes2;var attributes=_ref3.attributes,segments=_ref3.segments,sidx=_ref3.sidx,discontinuityStarts=_ref3.discontinuityStarts;var playlist={attributes:(_attributes2={NAME:attributes.id,AUDIO:'audio',SUBTITLES:'subs',RESOLUTION:{width:attributes.width,height:attributes.height},CODECS:attributes.codecs,BANDWIDTH:attributes.bandwidth},_attributes2['PROGRAM-ID']=1,_attributes2),uri:'',endList:attributes.type==='static',timeline:attributes.periodStart,resolvedUri:'',targetDuration:attributes.duration,discontinuityStarts:discontinuityStarts,timelineStarts:attributes.timelineStarts,segments:segments};if(attributes.frameRate){playlist.attributes['FRAME-RATE']=attributes.frameRate}
if(attributes.contentProtection){playlist.contentProtection=attributes.contentProtection}
if(sidx){playlist.sidx=sidx}
return playlist};var videoOnly=function videoOnly(_ref4){var attributes=_ref4.attributes;return attributes.mimeType==='video/mp4'||attributes.mimeType==='video/webm'||attributes.contentType==='video'};var audioOnly=function audioOnly(_ref5){var attributes=_ref5.attributes;return attributes.mimeType==='audio/mp4'||attributes.mimeType==='audio/webm'||attributes.contentType==='audio'};var vttOnly=function vttOnly(_ref6){var attributes=_ref6.attributes;return attributes.mimeType==='text/vtt'||attributes.contentType==='text'};var addMediaSequenceValues=function addMediaSequenceValues(playlists,timelineStarts){playlists.forEach(function(playlist){playlist.mediaSequence=0;playlist.discontinuitySequence=findIndex(timelineStarts,function(_ref7){var timeline=_ref7.timeline;return timeline===playlist.timeline});if(!playlist.segments){return}
playlist.segments.forEach(function(segment,index){segment.number=index})})};var flattenMediaGroupPlaylists=function flattenMediaGroupPlaylists(mediaGroupObject){if(!mediaGroupObject){return[]}
return Object.keys(mediaGroupObject).reduce(function(acc,label){var labelContents=mediaGroupObject[label];return acc.concat(labelContents.playlists)},[])};var toM3u8=function toM3u8(_ref8){var _mediaGroups;var dashPlaylists=_ref8.dashPlaylists,locations=_ref8.locations,_ref8$sidxMapping=_ref8.sidxMapping,sidxMapping=_ref8$sidxMapping===void 0?{}:_ref8$sidxMapping,previousManifest=_ref8.previousManifest;if(!dashPlaylists.length){return{}}
var _dashPlaylists$0$attr=dashPlaylists[0].attributes,duration=_dashPlaylists$0$attr.sourceDuration,type=_dashPlaylists$0$attr.type,suggestedPresentationDelay=_dashPlaylists$0$attr.suggestedPresentationDelay,minimumUpdatePeriod=_dashPlaylists$0$attr.minimumUpdatePeriod;var videoPlaylists=mergeDiscontiguousPlaylists(dashPlaylists.filter(videoOnly)).map(formatVideoPlaylist);var audioPlaylists=mergeDiscontiguousPlaylists(dashPlaylists.filter(audioOnly));var vttPlaylists=mergeDiscontiguousPlaylists(dashPlaylists.filter(vttOnly));var captions=dashPlaylists.map(function(playlist){return playlist.attributes.captionServices}).filter(Boolean);var manifest={allowCache:!0,discontinuityStarts:[],segments:[],endList:!0,mediaGroups:(_mediaGroups={AUDIO:{},VIDEO:{}},_mediaGroups['CLOSED-CAPTIONS']={},_mediaGroups.SUBTITLES={},_mediaGroups),uri:'',duration:duration,playlists:addSidxSegmentsToPlaylists(videoPlaylists,sidxMapping)};if(minimumUpdatePeriod>=0){manifest.minimumUpdatePeriod=minimumUpdatePeriod*1000}
if(locations){manifest.locations=locations}
if(type==='dynamic'){manifest.suggestedPresentationDelay=suggestedPresentationDelay}
var isAudioOnly=manifest.playlists.length===0;var organizedAudioGroup=audioPlaylists.length?organizeAudioPlaylists(audioPlaylists,sidxMapping,isAudioOnly):null;var organizedVttGroup=vttPlaylists.length?organizeVttPlaylists(vttPlaylists,sidxMapping):null;var formattedPlaylists=videoPlaylists.concat(flattenMediaGroupPlaylists(organizedAudioGroup),flattenMediaGroupPlaylists(organizedVttGroup));var playlistTimelineStarts=formattedPlaylists.map(function(_ref9){var timelineStarts=_ref9.timelineStarts;return timelineStarts});manifest.timelineStarts=getUniqueTimelineStarts(playlistTimelineStarts);addMediaSequenceValues(formattedPlaylists,manifest.timelineStarts);if(organizedAudioGroup){manifest.mediaGroups.AUDIO.audio=organizedAudioGroup}
if(organizedVttGroup){manifest.mediaGroups.SUBTITLES.subs=organizedVttGroup}
if(captions.length){manifest.mediaGroups['CLOSED-CAPTIONS'].cc=organizeCaptionServices(captions)}
if(previousManifest){return positionManifestOnTimeline({oldManifest:previousManifest,newManifest:manifest})}
return manifest};var getLiveRValue=function getLiveRValue(attributes,time,duration){var NOW=attributes.NOW,clientOffset=attributes.clientOffset,availabilityStartTime=attributes.availabilityStartTime,_attributes$timescale=attributes.timescale,timescale=_attributes$timescale===void 0?1:_attributes$timescale,_attributes$periodSta=attributes.periodStart,periodStart=_attributes$periodSta===void 0?0:_attributes$periodSta,_attributes$minimumUp=attributes.minimumUpdatePeriod,minimumUpdatePeriod=_attributes$minimumUp===void 0?0:_attributes$minimumUp;var now=(NOW+clientOffset)/1000;var periodStartWC=availabilityStartTime+periodStart;var periodEndWC=now+minimumUpdatePeriod;var periodDuration=periodEndWC-periodStartWC;return Math.ceil((periodDuration*timescale-time)/duration)};var parseByTimeline=function parseByTimeline(attributes,segmentTimeline){var type=attributes.type,_attributes$minimumUp2=attributes.minimumUpdatePeriod,minimumUpdatePeriod=_attributes$minimumUp2===void 0?0:_attributes$minimumUp2,_attributes$media=attributes.media,media=_attributes$media===void 0?'':_attributes$media,sourceDuration=attributes.sourceDuration,_attributes$timescale2=attributes.timescale,timescale=_attributes$timescale2===void 0?1:_attributes$timescale2,_attributes$startNumb=attributes.startNumber,startNumber=_attributes$startNumb===void 0?1:_attributes$startNumb,timeline=attributes.periodStart;var segments=[];var time=-1;for(var sIndex=0;sIndex<segmentTimeline.length;sIndex++){var S=segmentTimeline[sIndex];var duration=S.d;var repeat=S.r||0;var segmentTime=S.t||0;if(time<0){time=segmentTime}
if(segmentTime&&segmentTime>time){time=segmentTime}
var count=void 0;if(repeat<0){var nextS=sIndex+1;if(nextS===segmentTimeline.length){if(type==='dynamic'&&minimumUpdatePeriod>0&&media.indexOf('$Number$')>0){count=getLiveRValue(attributes,time,duration)}else{count=(sourceDuration*timescale-time)/duration}}else{count=(segmentTimeline[nextS].t-time)/duration}}else{count=repeat+1}
var end=startNumber+segments.length+count;var number=startNumber+segments.length;while(number<end){segments.push({number:number,duration:duration/timescale,time:time,timeline:timeline});time+=duration;number++}}
return segments};var identifierPattern=/\$([A-z]*)(?:(%0)([0-9]+)d)?\$/g;var identifierReplacement=function identifierReplacement(values){return function(match,identifier,format,width){if(match==='$$'){return'$'}
if(typeof values[identifier]==='undefined'){return match}
var value=''+values[identifier];if(identifier==='RepresentationID'){return value}
if(!format){width=1}else{width=parseInt(width,10)}
if(value.length>=width){return value}
return""+new Array(width-value.length+1).join('0')+value}};var constructTemplateUrl=function constructTemplateUrl(url,values){return url.replace(identifierPattern,identifierReplacement(values))};var parseTemplateInfo=function parseTemplateInfo(attributes,segmentTimeline){if(!attributes.duration&&!segmentTimeline){return[{number:attributes.startNumber||1,duration:attributes.sourceDuration,time:0,timeline:attributes.periodStart}]}
if(attributes.duration){return parseByDuration(attributes)}
return parseByTimeline(attributes,segmentTimeline)};var segmentsFromTemplate=function segmentsFromTemplate(attributes,segmentTimeline){var templateValues={RepresentationID:attributes.id,Bandwidth:attributes.bandwidth||0};var _attributes$initializ=attributes.initialization,initialization=_attributes$initializ===void 0?{sourceURL:'',range:''}:_attributes$initializ;var mapSegment=urlTypeToSegment({baseUrl:attributes.baseUrl,source:constructTemplateUrl(initialization.sourceURL,templateValues),range:initialization.range});var segments=parseTemplateInfo(attributes,segmentTimeline);return segments.map(function(segment){templateValues.Number=segment.number;templateValues.Time=segment.time;var uri=constructTemplateUrl(attributes.media||'',templateValues);var timescale=attributes.timescale||1;var presentationTimeOffset=attributes.presentationTimeOffset||0;var presentationTime=attributes.periodStart+(segment.time-presentationTimeOffset)/timescale;var map={uri:uri,timeline:segment.timeline,duration:segment.duration,resolvedUri:resolveUrl$1(attributes.baseUrl||'',uri),map:mapSegment,number:segment.number,presentationTime:presentationTime};return map})};var SegmentURLToSegmentObject=function SegmentURLToSegmentObject(attributes,segmentUrl){var baseUrl=attributes.baseUrl,_attributes$initializ=attributes.initialization,initialization=_attributes$initializ===void 0?{}:_attributes$initializ;var initSegment=urlTypeToSegment({baseUrl:baseUrl,source:initialization.sourceURL,range:initialization.range});var segment=urlTypeToSegment({baseUrl:baseUrl,source:segmentUrl.media,range:segmentUrl.mediaRange});segment.map=initSegment;return segment};var segmentsFromList=function segmentsFromList(attributes,segmentTimeline){var duration=attributes.duration,_attributes$segmentUr=attributes.segmentUrls,segmentUrls=_attributes$segmentUr===void 0?[]:_attributes$segmentUr,periodStart=attributes.periodStart;if(!duration&&!segmentTimeline||duration&&segmentTimeline){throw new Error(errors.SEGMENT_TIME_UNSPECIFIED)}
var segmentUrlMap=segmentUrls.map(function(segmentUrlObject){return SegmentURLToSegmentObject(attributes,segmentUrlObject)});var segmentTimeInfo;if(duration){segmentTimeInfo=parseByDuration(attributes)}
if(segmentTimeline){segmentTimeInfo=parseByTimeline(attributes,segmentTimeline)}
var segments=segmentTimeInfo.map(function(segmentTime,index){if(segmentUrlMap[index]){var segment=segmentUrlMap[index];var timescale=attributes.timescale||1;var presentationTimeOffset=attributes.presentationTimeOffset||0;segment.timeline=segmentTime.timeline;segment.duration=segmentTime.duration;segment.number=segmentTime.number;segment.presentationTime=periodStart+(segmentTime.time-presentationTimeOffset)/timescale;return segment}}).filter(function(segment){return segment});return segments};var generateSegments=function generateSegments(_ref){var attributes=_ref.attributes,segmentInfo=_ref.segmentInfo;var segmentAttributes;var segmentsFn;if(segmentInfo.template){segmentsFn=segmentsFromTemplate;segmentAttributes=merge(attributes,segmentInfo.template)}else if(segmentInfo.base){segmentsFn=segmentsFromBase;segmentAttributes=merge(attributes,segmentInfo.base)}else if(segmentInfo.list){segmentsFn=segmentsFromList;segmentAttributes=merge(attributes,segmentInfo.list)}
var segmentsInfo={attributes:attributes};if(!segmentsFn){return segmentsInfo}
var segments=segmentsFn(segmentAttributes,segmentInfo.segmentTimeline);if(segmentAttributes.duration){var _segmentAttributes=segmentAttributes,duration=_segmentAttributes.duration,_segmentAttributes$ti=_segmentAttributes.timescale,timescale=_segmentAttributes$ti===void 0?1:_segmentAttributes$ti;segmentAttributes.duration=duration/timescale}else if(segments.length){segmentAttributes.duration=segments.reduce(function(max,segment){return Math.max(max,Math.ceil(segment.duration))},0)}else{segmentAttributes.duration=0}
segmentsInfo.attributes=segmentAttributes;segmentsInfo.segments=segments;if(segmentInfo.base&&segmentAttributes.indexRange){segmentsInfo.sidx=segments[0];segmentsInfo.segments=[]}
return segmentsInfo};var toPlaylists=function toPlaylists(representations){return representations.map(generateSegments)};var findChildren=function findChildren(element,name){return from(element.childNodes).filter(function(_ref){var tagName=_ref.tagName;return tagName===name})};var getContent=function getContent(element){return element.textContent.trim()};var parseDivisionValue=function parseDivisionValue(value){return parseFloat(value.split('/').reduce(function(prev,current){return prev/current}))};var parseDuration=function parseDuration(str){var SECONDS_IN_YEAR=365*24*60*60;var SECONDS_IN_MONTH=30*24*60*60;var SECONDS_IN_DAY=24*60*60;var SECONDS_IN_HOUR=60*60;var SECONDS_IN_MIN=60;var durationRegex=/P(?:(\d*)Y)?(?:(\d*)M)?(?:(\d*)D)?(?:T(?:(\d*)H)?(?:(\d*)M)?(?:([\d.]*)S)?)?/;var match=durationRegex.exec(str);if(!match){return 0}
var _match$slice=match.slice(1),year=_match$slice[0],month=_match$slice[1],day=_match$slice[2],hour=_match$slice[3],minute=_match$slice[4],second=_match$slice[5];return parseFloat(year||0)*SECONDS_IN_YEAR+parseFloat(month||0)*SECONDS_IN_MONTH+parseFloat(day||0)*SECONDS_IN_DAY+parseFloat(hour||0)*SECONDS_IN_HOUR+parseFloat(minute||0)*SECONDS_IN_MIN+parseFloat(second||0)};var parseDate=function parseDate(str){var dateRegex=/^\d+-\d+-\d+T\d+:\d+:\d+(\.\d+)?$/;if(dateRegex.test(str)){str+='Z'}
return Date.parse(str)};var parsers={mediaPresentationDuration:function mediaPresentationDuration(value){return parseDuration(value)},availabilityStartTime:function availabilityStartTime(value){return parseDate(value)/1000},minimumUpdatePeriod:function minimumUpdatePeriod(value){return parseDuration(value)},suggestedPresentationDelay:function suggestedPresentationDelay(value){return parseDuration(value)},type:function type(value){return value},timeShiftBufferDepth:function timeShiftBufferDepth(value){return parseDuration(value)},start:function start(value){return parseDuration(value)},width:function width(value){return parseInt(value,10)},height:function height(value){return parseInt(value,10)},bandwidth:function bandwidth(value){return parseInt(value,10)},frameRate:function frameRate(value){return parseDivisionValue(value)},startNumber:function startNumber(value){return parseInt(value,10)},timescale:function timescale(value){return parseInt(value,10)},presentationTimeOffset:function presentationTimeOffset(value){return parseInt(value,10)},duration:function duration(value){var parsedValue=parseInt(value,10);if(isNaN(parsedValue)){return parseDuration(value)}
return parsedValue},d:function d(value){return parseInt(value,10)},t:function t(value){return parseInt(value,10)},r:function r(value){return parseInt(value,10)},DEFAULT:function DEFAULT(value){return value}};var parseAttributes=function parseAttributes(el){if(!(el&&el.attributes)){return{}}
return from(el.attributes).reduce(function(a,e){var parseFn=parsers[e.name]||parsers.DEFAULT;a[e.name]=parseFn(e.value);return a},{})};var keySystemsMap={'urn:uuid:1077efec-c0b2-4d02-ace3-3c1e52e2fb4b':'org.w3.clearkey','urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed':'com.widevine.alpha','urn:uuid:9a04f079-9840-4286-ab92-e65be0885f95':'com.microsoft.playready','urn:uuid:f239e769-efa3-4850-9c16-a903c6932efb':'com.adobe.primetime'};var buildBaseUrls=function buildBaseUrls(referenceUrls,baseUrlElements){if(!baseUrlElements.length){return referenceUrls}
return flatten(referenceUrls.map(function(reference){return baseUrlElements.map(function(baseUrlElement){return resolveUrl$1(reference,getContent(baseUrlElement))})}))};var getSegmentInformation=function getSegmentInformation(adaptationSet){var segmentTemplate=findChildren(adaptationSet,'SegmentTemplate')[0];var segmentList=findChildren(adaptationSet,'SegmentList')[0];var segmentUrls=segmentList&&findChildren(segmentList,'SegmentURL').map(function(s){return merge({tag:'SegmentURL'},parseAttributes(s))});var segmentBase=findChildren(adaptationSet,'SegmentBase')[0];var segmentTimelineParentNode=segmentList||segmentTemplate;var segmentTimeline=segmentTimelineParentNode&&findChildren(segmentTimelineParentNode,'SegmentTimeline')[0];var segmentInitializationParentNode=segmentList||segmentBase||segmentTemplate;var segmentInitialization=segmentInitializationParentNode&&findChildren(segmentInitializationParentNode,'Initialization')[0];var template=segmentTemplate&&parseAttributes(segmentTemplate);if(template&&segmentInitialization){template.initialization=segmentInitialization&&parseAttributes(segmentInitialization)}else if(template&&template.initialization){template.initialization={sourceURL:template.initialization}}
var segmentInfo={template:template,segmentTimeline:segmentTimeline&&findChildren(segmentTimeline,'S').map(function(s){return parseAttributes(s)}),list:segmentList&&merge(parseAttributes(segmentList),{segmentUrls:segmentUrls,initialization:parseAttributes(segmentInitialization)}),base:segmentBase&&merge(parseAttributes(segmentBase),{initialization:parseAttributes(segmentInitialization)})};Object.keys(segmentInfo).forEach(function(key){if(!segmentInfo[key]){delete segmentInfo[key]}});return segmentInfo};var inheritBaseUrls=function inheritBaseUrls(adaptationSetAttributes,adaptationSetBaseUrls,adaptationSetSegmentInfo){return function(representation){var repBaseUrlElements=findChildren(representation,'BaseURL');var repBaseUrls=buildBaseUrls(adaptationSetBaseUrls,repBaseUrlElements);var attributes=merge(adaptationSetAttributes,parseAttributes(representation));var representationSegmentInfo=getSegmentInformation(representation);return repBaseUrls.map(function(baseUrl){return{segmentInfo:merge(adaptationSetSegmentInfo,representationSegmentInfo),attributes:merge(attributes,{baseUrl:baseUrl})}})}};var generateKeySystemInformation=function generateKeySystemInformation(contentProtectionNodes){return contentProtectionNodes.reduce(function(acc,node){var attributes=parseAttributes(node);if(attributes.schemeIdUri){attributes.schemeIdUri=attributes.schemeIdUri.toLowerCase()}
var keySystem=keySystemsMap[attributes.schemeIdUri];if(keySystem){acc[keySystem]={attributes:attributes};var psshNode=findChildren(node,'cenc:pssh')[0];if(psshNode){var pssh=getContent(psshNode);acc[keySystem].pssh=pssh&&decodeB64ToUint8Array(pssh)}}
return acc},{})};var parseCaptionServiceMetadata=function parseCaptionServiceMetadata(service){if(service.schemeIdUri==='urn:scte:dash:cc:cea-608:2015'){var values=typeof service.value!=='string'?[]:service.value.split(';');return values.map(function(value){var channel;var language;language=value;if(/^CC\d=/.test(value)){var _value$split=value.split('=');channel=_value$split[0];language=_value$split[1]}else if(/^CC\d$/.test(value)){channel=value}
return{channel:channel,language:language}})}else if(service.schemeIdUri==='urn:scte:dash:cc:cea-708:2015'){var _values=typeof service.value!=='string'?[]:service.value.split(';');return _values.map(function(value){var flags={'channel':undefined,'language':undefined,'aspectRatio':1,'easyReader':0,'3D':0};if(/=/.test(value)){var _value$split2=value.split('='),channel=_value$split2[0],_value$split2$=_value$split2[1],opts=_value$split2$===void 0?'':_value$split2$;flags.channel=channel;flags.language=value;opts.split(',').forEach(function(opt){var _opt$split=opt.split(':'),name=_opt$split[0],val=_opt$split[1];if(name==='lang'){flags.language=val}else if(name==='er'){flags.easyReader=Number(val)}else if(name==='war'){flags.aspectRatio=Number(val)}else if(name==='3D'){flags['3D']=Number(val)}})}else{flags.language=value}
if(flags.channel){flags.channel='SERVICE'+flags.channel}
return flags})}};var toRepresentations=function toRepresentations(periodAttributes,periodBaseUrls,periodSegmentInfo){return function(adaptationSet){var adaptationSetAttributes=parseAttributes(adaptationSet);var adaptationSetBaseUrls=buildBaseUrls(periodBaseUrls,findChildren(adaptationSet,'BaseURL'));var role=findChildren(adaptationSet,'Role')[0];var roleAttributes={role:parseAttributes(role)};var attrs=merge(periodAttributes,adaptationSetAttributes,roleAttributes);var accessibility=findChildren(adaptationSet,'Accessibility')[0];var captionServices=parseCaptionServiceMetadata(parseAttributes(accessibility));if(captionServices){attrs=merge(attrs,{captionServices:captionServices})}
var label=findChildren(adaptationSet,'Label')[0];if(label&&label.childNodes.length){var labelVal=label.childNodes[0].nodeValue.trim();attrs=merge(attrs,{label:labelVal})}
var contentProtection=generateKeySystemInformation(findChildren(adaptationSet,'ContentProtection'));if(Object.keys(contentProtection).length){attrs=merge(attrs,{contentProtection:contentProtection})}
var segmentInfo=getSegmentInformation(adaptationSet);var representations=findChildren(adaptationSet,'Representation');var adaptationSetSegmentInfo=merge(periodSegmentInfo,segmentInfo);return flatten(representations.map(inheritBaseUrls(attrs,adaptationSetBaseUrls,adaptationSetSegmentInfo)))}};var toAdaptationSets=function toAdaptationSets(mpdAttributes,mpdBaseUrls){return function(period,index){var periodBaseUrls=buildBaseUrls(mpdBaseUrls,findChildren(period.node,'BaseURL'));var periodAttributes=merge(mpdAttributes,{periodStart:period.attributes.start});if(typeof period.attributes.duration==='number'){periodAttributes.periodDuration=period.attributes.duration}
var adaptationSets=findChildren(period.node,'AdaptationSet');var periodSegmentInfo=getSegmentInformation(period.node);return flatten(adaptationSets.map(toRepresentations(periodAttributes,periodBaseUrls,periodSegmentInfo)))}};var getPeriodStart=function getPeriodStart(_ref){var attributes=_ref.attributes,priorPeriodAttributes=_ref.priorPeriodAttributes,mpdType=_ref.mpdType;if(typeof attributes.start==='number'){return attributes.start}
if(priorPeriodAttributes&&typeof priorPeriodAttributes.start==='number'&&typeof priorPeriodAttributes.duration==='number'){return priorPeriodAttributes.start+priorPeriodAttributes.duration}
if(!priorPeriodAttributes&&mpdType==='static'){return 0}
return null};var inheritAttributes=function inheritAttributes(mpd,options){if(options===void 0){options={}}
var _options=options,_options$manifestUri=_options.manifestUri,manifestUri=_options$manifestUri===void 0?'':_options$manifestUri,_options$NOW=_options.NOW,NOW=_options$NOW===void 0?Date.now():_options$NOW,_options$clientOffset=_options.clientOffset,clientOffset=_options$clientOffset===void 0?0:_options$clientOffset;var periodNodes=findChildren(mpd,'Period');if(!periodNodes.length){throw new Error(errors.INVALID_NUMBER_OF_PERIOD)}
var locations=findChildren(mpd,'Location');var mpdAttributes=parseAttributes(mpd);var mpdBaseUrls=buildBaseUrls([manifestUri],findChildren(mpd,'BaseURL'));mpdAttributes.type=mpdAttributes.type||'static';mpdAttributes.sourceDuration=mpdAttributes.mediaPresentationDuration||0;mpdAttributes.NOW=NOW;mpdAttributes.clientOffset=clientOffset;if(locations.length){mpdAttributes.locations=locations.map(getContent)}
var periods=[];periodNodes.forEach(function(node,index){var attributes=parseAttributes(node);var priorPeriod=periods[index-1];attributes.start=getPeriodStart({attributes:attributes,priorPeriodAttributes:priorPeriod?priorPeriod.attributes:null,mpdType:mpdAttributes.type});periods.push({node:node,attributes:attributes})});return{locations:mpdAttributes.locations,representationInfo:flatten(periods.map(toAdaptationSets(mpdAttributes,mpdBaseUrls)))}};var stringToMpdXml=function stringToMpdXml(manifestString){if(manifestString===''){throw new Error(errors.DASH_EMPTY_MANIFEST)}
var parser=new xmldom.DOMParser();var xml;var mpd;try{xml=parser.parseFromString(manifestString,'application/xml');mpd=xml&&xml.documentElement.tagName==='MPD'?xml.documentElement:null}catch(e){}
if(!mpd||mpd&&mpd.getElementsByTagName('parsererror').length>0){throw new Error(errors.DASH_INVALID_XML)}
return mpd};var parseUTCTimingScheme=function parseUTCTimingScheme(mpd){var UTCTimingNode=findChildren(mpd,'UTCTiming')[0];if(!UTCTimingNode){return null}
var attributes=parseAttributes(UTCTimingNode);switch(attributes.schemeIdUri){case 'urn:mpeg:dash:utc:http-head:2014':case 'urn:mpeg:dash:utc:http-head:2012':attributes.method='HEAD';break;case 'urn:mpeg:dash:utc:http-xsdate:2014':case 'urn:mpeg:dash:utc:http-iso:2014':case 'urn:mpeg:dash:utc:http-xsdate:2012':case 'urn:mpeg:dash:utc:http-iso:2012':attributes.method='GET';break;case 'urn:mpeg:dash:utc:direct:2014':case 'urn:mpeg:dash:utc:direct:2012':attributes.method='DIRECT';attributes.value=Date.parse(attributes.value);break;case 'urn:mpeg:dash:utc:http-ntp:2014':case 'urn:mpeg:dash:utc:ntp:2014':case 'urn:mpeg:dash:utc:sntp:2014':default:throw new Error(errors.UNSUPPORTED_UTC_TIMING_SCHEME)}
return attributes};var parse=function parse(manifestString,options){if(options===void 0){options={}}
var parsedManifestInfo=inheritAttributes(stringToMpdXml(manifestString),options);var playlists=toPlaylists(parsedManifestInfo.representationInfo);return toM3u8({dashPlaylists:playlists,locations:parsedManifestInfo.locations,sidxMapping:options.sidxMapping,previousManifest:options.previousManifest})};var parseUTCTiming=function parseUTCTiming(manifestString){return parseUTCTimingScheme(stringToMpdXml(manifestString))};var MAX_UINT32=Math.pow(2,32);var getUint64$1=function getUint64(uint8){var dv=new DataView(uint8.buffer,uint8.byteOffset,uint8.byteLength);var value;if(dv.getBigUint64){value=dv.getBigUint64(0);if(value<Number.MAX_SAFE_INTEGER){return Number(value)}
return value}
return dv.getUint32(0)*MAX_UINT32+dv.getUint32(4)};var numbers={getUint64:getUint64$1,MAX_UINT32:MAX_UINT32};var getUint64=numbers.getUint64;var parseSidx=function parseSidx(data){var view=new DataView(data.buffer,data.byteOffset,data.byteLength),result={version:data[0],flags:new Uint8Array(data.subarray(1,4)),references:[],referenceId:view.getUint32(4),timescale:view.getUint32(8)},i=12;if(result.version===0){result.earliestPresentationTime=view.getUint32(i);result.firstOffset=view.getUint32(i+4);i+=8}else{result.earliestPresentationTime=getUint64(data.subarray(i));result.firstOffset=getUint64(data.subarray(i+8));i+=16}
i+=2;var referenceCount=view.getUint16(i);i+=2;for(;referenceCount>0;i+=12,referenceCount--){result.references.push({referenceType:(data[i]&0x80)>>>7,referencedSize:view.getUint32(i)&0x7FFFFFFF,subsegmentDuration:view.getUint32(i+4),startsWithSap:!!(data[i+8]&0x80),sapType:(data[i+8]&0x70)>>>4,sapDeltaTime:view.getUint32(i+8)&0x0FFFFFFF})}
return result};var parseSidx_1=parseSidx;var ID3=toUint8([0x49,0x44,0x33]);var getId3Size=function getId3Size(bytes,offset){if(offset===void 0){offset=0}
bytes=toUint8(bytes);var flags=bytes[offset+5];var returnSize=bytes[offset+6]<<21|bytes[offset+7]<<14|bytes[offset+8]<<7|bytes[offset+9];var footerPresent=(flags&16)>>4;if(footerPresent){return returnSize+20}
return returnSize+10};var getId3Offset=function getId3Offset(bytes,offset){if(offset===void 0){offset=0}
bytes=toUint8(bytes);if(bytes.length-offset<10||!bytesMatch(bytes,ID3,{offset:offset})){return offset}
offset+=getId3Size(bytes,offset);return getId3Offset(bytes,offset)};var normalizePath$1=function normalizePath(path){if(typeof path==='string'){return stringToBytes(path)}
if(typeof path==='number'){return path}
return path};var normalizePaths$1=function normalizePaths(paths){if(!Array.isArray(paths)){return[normalizePath$1(paths)]}
return paths.map(function(p){return normalizePath$1(p)})};var findBox=function findBox(bytes,paths,complete){if(complete===void 0){complete=!1}
paths=normalizePaths$1(paths);bytes=toUint8(bytes);var results=[];if(!paths.length){return results}
var i=0;while(i<bytes.length){var size=(bytes[i]<<24|bytes[i+1]<<16|bytes[i+2]<<8|bytes[i+3])>>>0;var type=bytes.subarray(i+4,i+8);if(size===0){break}
var end=i+size;if(end>bytes.length){if(complete){break}
end=bytes.length}
var data=bytes.subarray(i+8,end);if(bytesMatch(type,paths[0])){if(paths.length===1){results.push(data)}else{results.push.apply(results,findBox(data,paths.slice(1),complete))}}
i=end}
return results};var EBML_TAGS={EBML:toUint8([0x1A,0x45,0xDF,0xA3]),DocType:toUint8([0x42,0x82]),Segment:toUint8([0x18,0x53,0x80,0x67]),SegmentInfo:toUint8([0x15,0x49,0xA9,0x66]),Tracks:toUint8([0x16,0x54,0xAE,0x6B]),Track:toUint8([0xAE]),TrackNumber:toUint8([0xd7]),DefaultDuration:toUint8([0x23,0xe3,0x83]),TrackEntry:toUint8([0xAE]),TrackType:toUint8([0x83]),FlagDefault:toUint8([0x88]),CodecID:toUint8([0x86]),CodecPrivate:toUint8([0x63,0xA2]),VideoTrack:toUint8([0xe0]),AudioTrack:toUint8([0xe1]),Cluster:toUint8([0x1F,0x43,0xB6,0x75]),Timestamp:toUint8([0xE7]),TimestampScale:toUint8([0x2A,0xD7,0xB1]),BlockGroup:toUint8([0xA0]),BlockDuration:toUint8([0x9B]),Block:toUint8([0xA1]),SimpleBlock:toUint8([0xA3])};var LENGTH_TABLE=[128,64,32,16,8,4,2,1];var getLength=function getLength(byte){var len=1;for(var i=0;i<LENGTH_TABLE.length;i++){if(byte&LENGTH_TABLE[i]){break}
len++}
return len};var getvint=function getvint(bytes,offset,removeLength,signed){if(removeLength===void 0){removeLength=!0}
if(signed===void 0){signed=!1}
var length=getLength(bytes[offset]);var valueBytes=bytes.subarray(offset,offset+length);if(removeLength){valueBytes=Array.prototype.slice.call(bytes,offset,offset+length);valueBytes[0]^=LENGTH_TABLE[length-1]}
return{length:length,value:bytesToNumber(valueBytes,{signed:signed}),bytes:valueBytes}};var normalizePath=function normalizePath(path){if(typeof path==='string'){return path.match(/.{1,2}/g).map(function(p){return normalizePath(p)})}
if(typeof path==='number'){return numberToBytes(path)}
return path};var normalizePaths=function normalizePaths(paths){if(!Array.isArray(paths)){return[normalizePath(paths)]}
return paths.map(function(p){return normalizePath(p)})};var getInfinityDataSize=function getInfinityDataSize(id,bytes,offset){if(offset>=bytes.length){return bytes.length}
var innerid=getvint(bytes,offset,!1);if(bytesMatch(id.bytes,innerid.bytes)){return offset}
var dataHeader=getvint(bytes,offset+innerid.length);return getInfinityDataSize(id,bytes,offset+dataHeader.length+dataHeader.value+innerid.length)};var findEbml=function findEbml(bytes,paths){paths=normalizePaths(paths);bytes=toUint8(bytes);var results=[];if(!paths.length){return results}
var i=0;while(i<bytes.length){var id=getvint(bytes,i,!1);var dataHeader=getvint(bytes,i+id.length);var dataStart=i+id.length+dataHeader.length;if(dataHeader.value===0x7f){dataHeader.value=getInfinityDataSize(id,bytes,dataStart);if(dataHeader.value!==bytes.length){dataHeader.value-=dataStart}}
var dataEnd=dataStart+dataHeader.value>bytes.length?bytes.length:dataStart+dataHeader.value;var data=bytes.subarray(dataStart,dataEnd);if(bytesMatch(paths[0],id.bytes)){if(paths.length===1){results.push(data)}else{results=results.concat(findEbml(data,paths.slice(1)))}}
var totalLength=id.length+dataHeader.length+data.length;i+=totalLength}
return results};var NAL_TYPE_ONE=toUint8([0x00,0x00,0x00,0x01]);var NAL_TYPE_TWO=toUint8([0x00,0x00,0x01]);var EMULATION_PREVENTION=toUint8([0x00,0x00,0x03]);var discardEmulationPreventionBytes=function discardEmulationPreventionBytes(bytes){var positions=[];var i=1;while(i<bytes.length-2){if(bytesMatch(bytes.subarray(i,i+3),EMULATION_PREVENTION)){positions.push(i+2);i++}
i++}
if(positions.length===0){return bytes}
var newLength=bytes.length-positions.length;var newData=new Uint8Array(newLength);var sourceIndex=0;for(i=0;i<newLength;sourceIndex++,i++){if(sourceIndex===positions[0]){sourceIndex++;positions.shift()}
newData[i]=bytes[sourceIndex]}
return newData};var findNal=function findNal(bytes,dataType,types,nalLimit){if(nalLimit===void 0){nalLimit=Infinity}
bytes=toUint8(bytes);types=[].concat(types);var i=0;var nalStart;var nalsFound=0;while(i<bytes.length&&(nalsFound<nalLimit||nalStart)){var nalOffset=void 0;if(bytesMatch(bytes.subarray(i),NAL_TYPE_ONE)){nalOffset=4}else if(bytesMatch(bytes.subarray(i),NAL_TYPE_TWO)){nalOffset=3}
if(!nalOffset){i++;continue}
nalsFound++;if(nalStart){return discardEmulationPreventionBytes(bytes.subarray(nalStart,i))}
var nalType=void 0;if(dataType==='h264'){nalType=bytes[i+nalOffset]&0x1f}else if(dataType==='h265'){nalType=bytes[i+nalOffset]>>1&0x3f}
if(types.indexOf(nalType)!==-1){nalStart=i+nalOffset}
i+=nalOffset+(dataType==='h264'?1:2)}
return bytes.subarray(0,0)};var findH264Nal=function findH264Nal(bytes,type,nalLimit){return findNal(bytes,'h264',type,nalLimit)};var findH265Nal=function findH265Nal(bytes,type,nalLimit){return findNal(bytes,'h265',type,nalLimit)};var CONSTANTS={'webm':toUint8([0x77,0x65,0x62,0x6d]),'matroska':toUint8([0x6d,0x61,0x74,0x72,0x6f,0x73,0x6b,0x61]),'flac':toUint8([0x66,0x4c,0x61,0x43]),'ogg':toUint8([0x4f,0x67,0x67,0x53]),'ac3':toUint8([0x0b,0x77]),'riff':toUint8([0x52,0x49,0x46,0x46]),'avi':toUint8([0x41,0x56,0x49]),'wav':toUint8([0x57,0x41,0x56,0x45]),'3gp':toUint8([0x66,0x74,0x79,0x70,0x33,0x67]),'mp4':toUint8([0x66,0x74,0x79,0x70]),'fmp4':toUint8([0x73,0x74,0x79,0x70]),'mov':toUint8([0x66,0x74,0x79,0x70,0x71,0x74]),'moov':toUint8([0x6D,0x6F,0x6F,0x76]),'moof':toUint8([0x6D,0x6F,0x6F,0x66])};var _isLikely={aac:function aac(bytes){var offset=getId3Offset(bytes);return bytesMatch(bytes,[0xFF,0x10],{offset:offset,mask:[0xFF,0x16]})},mp3:function mp3(bytes){var offset=getId3Offset(bytes);return bytesMatch(bytes,[0xFF,0x02],{offset:offset,mask:[0xFF,0x06]})},webm:function webm(bytes){var docType=findEbml(bytes,[EBML_TAGS.EBML,EBML_TAGS.DocType])[0];return bytesMatch(docType,CONSTANTS.webm)},mkv:function mkv(bytes){var docType=findEbml(bytes,[EBML_TAGS.EBML,EBML_TAGS.DocType])[0];return bytesMatch(docType,CONSTANTS.matroska)},mp4:function mp4(bytes){if(_isLikely['3gp'](bytes)||_isLikely.mov(bytes)){return!1}
if(bytesMatch(bytes,CONSTANTS.mp4,{offset:4})||bytesMatch(bytes,CONSTANTS.fmp4,{offset:4})){return!0}
if(bytesMatch(bytes,CONSTANTS.moof,{offset:4})||bytesMatch(bytes,CONSTANTS.moov,{offset:4})){return!0}},mov:function mov(bytes){return bytesMatch(bytes,CONSTANTS.mov,{offset:4})},'3gp':function gp(bytes){return bytesMatch(bytes,CONSTANTS['3gp'],{offset:4})},ac3:function ac3(bytes){var offset=getId3Offset(bytes);return bytesMatch(bytes,CONSTANTS.ac3,{offset:offset})},ts:function ts(bytes){if(bytes.length<189&&bytes.length>=1){return bytes[0]===0x47}
var i=0;while(i+188<bytes.length&&i<188){if(bytes[i]===0x47&&bytes[i+188]===0x47){return!0}
i+=1}
return!1},flac:function flac(bytes){var offset=getId3Offset(bytes);return bytesMatch(bytes,CONSTANTS.flac,{offset:offset})},ogg:function ogg(bytes){return bytesMatch(bytes,CONSTANTS.ogg)},avi:function avi(bytes){return bytesMatch(bytes,CONSTANTS.riff)&&bytesMatch(bytes,CONSTANTS.avi,{offset:8})},wav:function wav(bytes){return bytesMatch(bytes,CONSTANTS.riff)&&bytesMatch(bytes,CONSTANTS.wav,{offset:8})},'h264':function h264(bytes){return findH264Nal(bytes,7,3).length},'h265':function h265(bytes){return findH265Nal(bytes,[32,33],3).length}};var isLikelyTypes=Object.keys(_isLikely).filter(function(t){return t!=='ts'&&t!=='h264'&&t!=='h265'}).concat(['ts','h264','h265']);isLikelyTypes.forEach(function(type){var isLikelyFn=_isLikely[type];_isLikely[type]=function(bytes){return isLikelyFn(toUint8(bytes))}});var isLikely=_isLikely;var detectContainerForBytes=function detectContainerForBytes(bytes){bytes=toUint8(bytes);for(var i=0;i<isLikelyTypes.length;i++){var type=isLikelyTypes[i];if(isLikely[type](bytes)){return type}}
return''};var isLikelyFmp4MediaSegment=function isLikelyFmp4MediaSegment(bytes){return findBox(bytes,['moof']).length>0};var callbackOnCompleted=function callbackOnCompleted(request,cb){if(request.readyState===4){return cb()}
return};var containerRequest=function containerRequest(uri,xhr,cb){var bytes=[];var id3Offset;var finished=!1;var endRequestAndCallback=function endRequestAndCallback(err,req,type,_bytes){req.abort();finished=!0;return cb(err,req,type,_bytes)};var progressListener=function progressListener(error,request){if(finished){return}
if(error){return endRequestAndCallback(error,request,'',bytes)}
var newPart=request.responseText.substring(bytes&&bytes.byteLength||0,request.responseText.length);bytes=concatTypedArrays(bytes,stringToBytes(newPart,!0));id3Offset=id3Offset||getId3Offset(bytes);if(bytes.length<10||id3Offset&&bytes.length<id3Offset+2){return callbackOnCompleted(request,function(){return endRequestAndCallback(error,request,'',bytes)})}
var type=detectContainerForBytes(bytes);if(type==='ts'&&bytes.length<188){return callbackOnCompleted(request,function(){return endRequestAndCallback(error,request,'',bytes)})}
if(!type&&bytes.length<376){return callbackOnCompleted(request,function(){return endRequestAndCallback(error,request,'',bytes)})}
return endRequestAndCallback(null,request,type,bytes)};var options={uri:uri,beforeSend:function beforeSend(request){request.overrideMimeType('text/plain; charset=x-user-defined');request.addEventListener('progress',function(_ref){_ref.total;_ref.loaded;return callbackWrapper(request,null,{statusCode:request.status},progressListener)})}};var request=xhr(options,function(error,response){return callbackWrapper(request,error,response,progressListener)});return request};var EventTarget=videojs__default["default"].EventTarget,mergeOptions=videojs__default["default"].mergeOptions;var dashPlaylistUnchanged=function dashPlaylistUnchanged(a,b){if(!isPlaylistUnchanged(a,b)){return!1}
if(a.sidx&&b.sidx&&(a.sidx.offset!==b.sidx.offset||a.sidx.length!==b.sidx.length)){return!1}else if(!a.sidx&&b.sidx||a.sidx&&!b.sidx){return!1}
if(a.segments&&!b.segments||!a.segments&&b.segments){return!1}
if(!a.segments&&!b.segments){return!0}
for(var i=0;i<a.segments.length;i++){var aSegment=a.segments[i];var bSegment=b.segments[i];if(aSegment.uri!==bSegment.uri){return!1}
if(!aSegment.byterange&&!bSegment.byterange){continue}
var aByterange=aSegment.byterange;var bByterange=bSegment.byterange;if(aByterange&&!bByterange||!aByterange&&bByterange){return!1}
if(aByterange.offset!==bByterange.offset||aByterange.length!==bByterange.length){return!1}}
return!0};var parseMasterXml=function parseMasterXml(_ref){var masterXml=_ref.masterXml,srcUrl=_ref.srcUrl,clientOffset=_ref.clientOffset,sidxMapping=_ref.sidxMapping,previousManifest=_ref.previousManifest;var manifest=parse(masterXml,{manifestUri:srcUrl,clientOffset:clientOffset,sidxMapping:sidxMapping,previousManifest:previousManifest});addPropertiesToMaster(manifest,srcUrl);return manifest};var updateMaster=function updateMaster(oldMaster,newMaster,sidxMapping){var noChanges=!0;var update=mergeOptions(oldMaster,{duration:newMaster.duration,minimumUpdatePeriod:newMaster.minimumUpdatePeriod,timelineStarts:newMaster.timelineStarts});for(var i=0;i<newMaster.playlists.length;i++){var playlist=newMaster.playlists[i];if(playlist.sidx){var sidxKey=generateSidxKey(playlist.sidx);if(sidxMapping&&sidxMapping[sidxKey]&&sidxMapping[sidxKey].sidx){addSidxSegmentsToPlaylist$1(playlist,sidxMapping[sidxKey].sidx,playlist.sidx.resolvedUri)}}
var playlistUpdate=updateMaster$1(update,playlist,dashPlaylistUnchanged);if(playlistUpdate){update=playlistUpdate;noChanges=!1}}
forEachMediaGroup$1(newMaster,function(properties,type,group,label){if(properties.playlists&&properties.playlists.length){var id=properties.playlists[0].id;var _playlistUpdate=updateMaster$1(update,properties.playlists[0],dashPlaylistUnchanged);if(_playlistUpdate){update=_playlistUpdate;update.mediaGroups[type][group][label].playlists[0]=update.playlists[id];noChanges=!1}}});if(newMaster.minimumUpdatePeriod!==oldMaster.minimumUpdatePeriod){noChanges=!1}
if(noChanges){return null}
return update};var equivalentSidx=function equivalentSidx(a,b){var neitherMap=Boolean(!a.map&&!b.map);var equivalentMap=neitherMap||Boolean(a.map&&b.map&&a.map.byterange.offset===b.map.byterange.offset&&a.map.byterange.length===b.map.byterange.length);return equivalentMap&&a.uri===b.uri&&a.byterange.offset===b.byterange.offset&&a.byterange.length===b.byterange.length};var compareSidxEntry=function compareSidxEntry(playlists,oldSidxMapping){var newSidxMapping={};for(var id in playlists){var playlist=playlists[id];var currentSidxInfo=playlist.sidx;if(currentSidxInfo){var key=generateSidxKey(currentSidxInfo);if(!oldSidxMapping[key]){break}
var savedSidxInfo=oldSidxMapping[key].sidxInfo;if(equivalentSidx(savedSidxInfo,currentSidxInfo)){newSidxMapping[key]=oldSidxMapping[key]}}}
return newSidxMapping};var filterChangedSidxMappings=function filterChangedSidxMappings(master,oldSidxMapping){var videoSidx=compareSidxEntry(master.playlists,oldSidxMapping);var mediaGroupSidx=videoSidx;forEachMediaGroup$1(master,function(properties,mediaType,groupKey,labelKey){if(properties.playlists&&properties.playlists.length){var playlists=properties.playlists;mediaGroupSidx=mergeOptions(mediaGroupSidx,compareSidxEntry(playlists,oldSidxMapping))}});return mediaGroupSidx};var DashPlaylistLoader=function(_EventTarget){inheritsLoose(DashPlaylistLoader,_EventTarget);function DashPlaylistLoader(srcUrlOrPlaylist,vhs,options,masterPlaylistLoader){var _this;if(options===void 0){options={}}
_this=_EventTarget.call(this)||this;_this.masterPlaylistLoader_=masterPlaylistLoader||assertThisInitialized(_this);if(!masterPlaylistLoader){_this.isMaster_=!0}
var _options=options,_options$withCredenti=_options.withCredentials,withCredentials=_options$withCredenti===void 0?!1:_options$withCredenti,_options$handleManife=_options.handleManifestRedirects,handleManifestRedirects=_options$handleManife===void 0?!1:_options$handleManife;_this.vhs_=vhs;_this.withCredentials=withCredentials;_this.handleManifestRedirects=handleManifestRedirects;if(!srcUrlOrPlaylist){throw new Error('A non-empty playlist URL or object is required')}
_this.on('minimumUpdatePeriod',function(){_this.refreshXml_()});_this.on('mediaupdatetimeout',function(){_this.refreshMedia_(_this.media().id)});_this.state='HAVE_NOTHING';_this.loadedPlaylists_={};_this.logger_=logger('DashPlaylistLoader');if(_this.isMaster_){_this.masterPlaylistLoader_.srcUrl=srcUrlOrPlaylist;_this.masterPlaylistLoader_.sidxMapping_={}}else{_this.childPlaylist_=srcUrlOrPlaylist}
return _this}
var _proto=DashPlaylistLoader.prototype;_proto.requestErrored_=function requestErrored_(err,request,startingState){if(!this.request){return!0}
this.request=null;if(err){this.error=typeof err==='object'&&!(err instanceof Error)?err:{status:request.status,message:'DASH request error at URL: '+request.uri,response:request.response,code:2};if(startingState){this.state=startingState}
this.trigger('error');return!0}};_proto.addSidxSegments_=function addSidxSegments_(playlist,startingState,cb){var _this2=this;var sidxKey=playlist.sidx&&generateSidxKey(playlist.sidx);if(!playlist.sidx||!sidxKey||this.masterPlaylistLoader_.sidxMapping_[sidxKey]){this.mediaRequest_=window.setTimeout(function(){return cb(!1)},0);return}
var uri=resolveManifestRedirect(this.handleManifestRedirects,playlist.sidx.resolvedUri);var fin=function fin(err,request){if(_this2.requestErrored_(err,request,startingState)){return}
var sidxMapping=_this2.masterPlaylistLoader_.sidxMapping_;var sidx;try{sidx=parseSidx_1(toUint8(request.response).subarray(8))}catch(e){_this2.requestErrored_(e,request,startingState);return}
sidxMapping[sidxKey]={sidxInfo:playlist.sidx,sidx:sidx};addSidxSegmentsToPlaylist$1(playlist,sidx,playlist.sidx.resolvedUri);return cb(!0)};this.request=containerRequest(uri,this.vhs_.xhr,function(err,request,container,bytes){if(err){return fin(err,request)}
if(!container||container!=='mp4'){return fin({status:request.status,message:"Unsupported "+(container||'unknown')+" container type for sidx segment at URL: "+uri,response:'',playlist:playlist,internal:!0,blacklistDuration:Infinity,code:2},request)}
var _playlist$sidx$bytera=playlist.sidx.byterange,offset=_playlist$sidx$bytera.offset,length=_playlist$sidx$bytera.length;if(bytes.length>=length+offset){return fin(err,{response:bytes.subarray(offset,offset+length),status:request.status,uri:request.uri})}
_this2.request=_this2.vhs_.xhr({uri:uri,responseType:'arraybuffer',headers:segmentXhrHeaders({byterange:playlist.sidx.byterange})},fin)})};_proto.dispose=function dispose(){this.trigger('dispose');this.stopRequest();this.loadedPlaylists_={};window.clearTimeout(this.minimumUpdatePeriodTimeout_);window.clearTimeout(this.mediaRequest_);window.clearTimeout(this.mediaUpdateTimeout);this.mediaUpdateTimeout=null;this.mediaRequest_=null;this.minimumUpdatePeriodTimeout_=null;if(this.masterPlaylistLoader_.createMupOnMedia_){this.off('loadedmetadata',this.masterPlaylistLoader_.createMupOnMedia_);this.masterPlaylistLoader_.createMupOnMedia_=null}
this.off()};_proto.hasPendingRequest=function hasPendingRequest(){return this.request||this.mediaRequest_};_proto.stopRequest=function stopRequest(){if(this.request){var oldRequest=this.request;this.request=null;oldRequest.onreadystatechange=null;oldRequest.abort()}};_proto.media=function media(playlist){var _this3=this;if(!playlist){return this.media_}
if(this.state==='HAVE_NOTHING'){throw new Error('Cannot switch media playlist from '+this.state)}
var startingState=this.state;if(typeof playlist==='string'){if(!this.masterPlaylistLoader_.master.playlists[playlist]){throw new Error('Unknown playlist URI: '+playlist)}
playlist=this.masterPlaylistLoader_.master.playlists[playlist]}
var mediaChange=!this.media_||playlist.id!==this.media_.id;if(mediaChange&&this.loadedPlaylists_[playlist.id]&&this.loadedPlaylists_[playlist.id].endList){this.state='HAVE_METADATA';this.media_=playlist;if(mediaChange){this.trigger('mediachanging');this.trigger('mediachange')}
return}
if(!mediaChange){return}
if(this.media_){this.trigger('mediachanging')}
this.addSidxSegments_(playlist,startingState,function(sidxChanged){_this3.haveMetadata({startingState:startingState,playlist:playlist})})};_proto.haveMetadata=function haveMetadata(_ref2){var startingState=_ref2.startingState,playlist=_ref2.playlist;this.state='HAVE_METADATA';this.loadedPlaylists_[playlist.id]=playlist;this.mediaRequest_=null;this.refreshMedia_(playlist.id);if(startingState==='HAVE_MASTER'){this.trigger('loadedmetadata')}else{this.trigger('mediachange')}};_proto.pause=function pause(){if(this.masterPlaylistLoader_.createMupOnMedia_){this.off('loadedmetadata',this.masterPlaylistLoader_.createMupOnMedia_);this.masterPlaylistLoader_.createMupOnMedia_=null}
this.stopRequest();window.clearTimeout(this.mediaUpdateTimeout);this.mediaUpdateTimeout=null;if(this.isMaster_){window.clearTimeout(this.masterPlaylistLoader_.minimumUpdatePeriodTimeout_);this.masterPlaylistLoader_.minimumUpdatePeriodTimeout_=null}
if(this.state==='HAVE_NOTHING'){this.started=!1}};_proto.load=function load(isFinalRendition){var _this4=this;window.clearTimeout(this.mediaUpdateTimeout);this.mediaUpdateTimeout=null;var media=this.media();if(isFinalRendition){var delay=media?media.targetDuration/2*1000:5*1000;this.mediaUpdateTimeout=window.setTimeout(function(){return _this4.load()},delay);return}
if(!this.started){this.start();return}
if(media&&!media.endList){if(this.isMaster_&&!this.minimumUpdatePeriodTimeout_){this.trigger('minimumUpdatePeriod');this.updateMinimumUpdatePeriodTimeout_()}
this.trigger('mediaupdatetimeout')}else{this.trigger('loadedplaylist')}};_proto.start=function start(){var _this5=this;this.started=!0;if(!this.isMaster_){this.mediaRequest_=window.setTimeout(function(){return _this5.haveMaster_()},0);return}
this.requestMaster_(function(req,masterChanged){_this5.haveMaster_();if(!_this5.hasPendingRequest()&&!_this5.media_){_this5.media(_this5.masterPlaylistLoader_.master.playlists[0])}})};_proto.requestMaster_=function requestMaster_(cb){var _this6=this;this.request=this.vhs_.xhr({uri:this.masterPlaylistLoader_.srcUrl,withCredentials:this.withCredentials},function(error,req){if(_this6.requestErrored_(error,req)){if(_this6.state==='HAVE_NOTHING'){_this6.started=!1}
return}
var masterChanged=req.responseText!==_this6.masterPlaylistLoader_.masterXml_;_this6.masterPlaylistLoader_.masterXml_=req.responseText;if(req.responseHeaders&&req.responseHeaders.date){_this6.masterLoaded_=Date.parse(req.responseHeaders.date)}else{_this6.masterLoaded_=Date.now()}
_this6.masterPlaylistLoader_.srcUrl=resolveManifestRedirect(_this6.handleManifestRedirects,_this6.masterPlaylistLoader_.srcUrl,req);if(masterChanged){_this6.handleMaster_();_this6.syncClientServerClock_(function(){return cb(req,masterChanged)});return}
return cb(req,masterChanged)})};_proto.syncClientServerClock_=function syncClientServerClock_(done){var _this7=this;var utcTiming=parseUTCTiming(this.masterPlaylistLoader_.masterXml_);if(utcTiming===null){this.masterPlaylistLoader_.clientOffset_=this.masterLoaded_-Date.now();return done()}
if(utcTiming.method==='DIRECT'){this.masterPlaylistLoader_.clientOffset_=utcTiming.value-Date.now();return done()}
this.request=this.vhs_.xhr({uri:resolveUrl(this.masterPlaylistLoader_.srcUrl,utcTiming.value),method:utcTiming.method,withCredentials:this.withCredentials},function(error,req){if(!_this7.request){return}
if(error){_this7.masterPlaylistLoader_.clientOffset_=_this7.masterLoaded_-Date.now();return done()}
var serverTime;if(utcTiming.method==='HEAD'){if(!req.responseHeaders||!req.responseHeaders.date){serverTime=_this7.masterLoaded_}else{serverTime=Date.parse(req.responseHeaders.date)}}else{serverTime=Date.parse(req.responseText)}
_this7.masterPlaylistLoader_.clientOffset_=serverTime-Date.now();done()})};_proto.haveMaster_=function haveMaster_(){this.state='HAVE_MASTER';if(this.isMaster_){this.trigger('loadedplaylist')}else if(!this.media_){this.media(this.childPlaylist_)}};_proto.handleMaster_=function handleMaster_(){this.mediaRequest_=null;var oldMaster=this.masterPlaylistLoader_.master;var newMaster=parseMasterXml({masterXml:this.masterPlaylistLoader_.masterXml_,srcUrl:this.masterPlaylistLoader_.srcUrl,clientOffset:this.masterPlaylistLoader_.clientOffset_,sidxMapping:this.masterPlaylistLoader_.sidxMapping_,previousManifest:oldMaster});if(oldMaster){newMaster=updateMaster(oldMaster,newMaster,this.masterPlaylistLoader_.sidxMapping_)}
this.masterPlaylistLoader_.master=newMaster?newMaster:oldMaster;var location=this.masterPlaylistLoader_.master.locations&&this.masterPlaylistLoader_.master.locations[0];if(location&&location!==this.masterPlaylistLoader_.srcUrl){this.masterPlaylistLoader_.srcUrl=location}
if(!oldMaster||newMaster&&newMaster.minimumUpdatePeriod!==oldMaster.minimumUpdatePeriod){this.updateMinimumUpdatePeriodTimeout_()}
return Boolean(newMaster)};_proto.updateMinimumUpdatePeriodTimeout_=function updateMinimumUpdatePeriodTimeout_(){var mpl=this.masterPlaylistLoader_;if(mpl.createMupOnMedia_){mpl.off('loadedmetadata',mpl.createMupOnMedia_);mpl.createMupOnMedia_=null}
if(mpl.minimumUpdatePeriodTimeout_){window.clearTimeout(mpl.minimumUpdatePeriodTimeout_);mpl.minimumUpdatePeriodTimeout_=null}
var mup=mpl.master&&mpl.master.minimumUpdatePeriod;if(mup===0){if(mpl.media()){mup=mpl.media().targetDuration*1000}else{mpl.createMupOnMedia_=mpl.updateMinimumUpdatePeriodTimeout_;mpl.one('loadedmetadata',mpl.createMupOnMedia_)}}
if(typeof mup!=='number'||mup<=0){if(mup<0){this.logger_("found invalid minimumUpdatePeriod of "+mup+", not setting a timeout")}
return}
this.createMUPTimeout_(mup)};_proto.createMUPTimeout_=function createMUPTimeout_(mup){var mpl=this.masterPlaylistLoader_;mpl.minimumUpdatePeriodTimeout_=window.setTimeout(function(){mpl.minimumUpdatePeriodTimeout_=null;mpl.trigger('minimumUpdatePeriod');mpl.createMUPTimeout_(mup)},mup)};_proto.refreshXml_=function refreshXml_(){var _this8=this;this.requestMaster_(function(req,masterChanged){if(!masterChanged){return}
if(_this8.media_){_this8.media_=_this8.masterPlaylistLoader_.master.playlists[_this8.media_.id]}
_this8.masterPlaylistLoader_.sidxMapping_=filterChangedSidxMappings(_this8.masterPlaylistLoader_.master,_this8.masterPlaylistLoader_.sidxMapping_);_this8.addSidxSegments_(_this8.media(),_this8.state,function(sidxChanged){_this8.refreshMedia_(_this8.media().id)})})};_proto.refreshMedia_=function refreshMedia_(mediaID){var _this9=this;if(!mediaID){throw new Error('refreshMedia_ must take a media id')}
if(this.media_&&this.isMaster_){this.handleMaster_()}
var playlists=this.masterPlaylistLoader_.master.playlists;var mediaChanged=!this.media_||this.media_!==playlists[mediaID];if(mediaChanged){this.media_=playlists[mediaID]}else{this.trigger('playlistunchanged')}
if(!this.mediaUpdateTimeout){var createMediaUpdateTimeout=function createMediaUpdateTimeout(){if(_this9.media().endList){return}
_this9.mediaUpdateTimeout=window.setTimeout(function(){_this9.trigger('mediaupdatetimeout');createMediaUpdateTimeout()},refreshDelay(_this9.media(),Boolean(mediaChanged)))};createMediaUpdateTimeout()}
this.trigger('loadedplaylist')};return DashPlaylistLoader}(EventTarget);var Config={GOAL_BUFFER_LENGTH:30,MAX_GOAL_BUFFER_LENGTH:60,BACK_BUFFER_LENGTH:30,GOAL_BUFFER_LENGTH_RATE:1,INITIAL_BANDWIDTH:4194304,BANDWIDTH_VARIANCE:1.2,BUFFER_LOW_WATER_LINE:0,MAX_BUFFER_LOW_WATER_LINE:30,EXPERIMENTAL_MAX_BUFFER_LOW_WATER_LINE:16,BUFFER_LOW_WATER_LINE_RATE:1,BUFFER_HIGH_WATER_LINE:30};var stringToArrayBuffer=function stringToArrayBuffer(string){var view=new Uint8Array(new ArrayBuffer(string.length));for(var i=0;i<string.length;i++){view[i]=string.charCodeAt(i)}
return view.buffer};var browserWorkerPolyFill=function browserWorkerPolyFill(workerObj){workerObj.on=workerObj.addEventListener;workerObj.off=workerObj.removeEventListener;return workerObj};var createObjectURL=function createObjectURL(str){try{return URL.createObjectURL(new Blob([str],{type:'application/javascript'}))}catch(e){var blob=new BlobBuilder();blob.append(str);return URL.createObjectURL(blob.getBlob())}};var factory=function factory(code){return function(){var objectUrl=createObjectURL(code);var worker=browserWorkerPolyFill(new Worker(objectUrl));worker.objURL=objectUrl;var terminate=worker.terminate;worker.on=worker.addEventListener;worker.off=worker.removeEventListener;worker.terminate=function(){URL.revokeObjectURL(objectUrl);return terminate.call(this)};return worker}};var transform=function transform(code){return"var browserWorkerPolyFill = "+browserWorkerPolyFill.toString()+";\n"+'browserWorkerPolyFill(self);\n'+code};var getWorkerString=function getWorkerString(fn){return fn.toString().replace(/^function.+?{/,'').slice(0,-1)};var workerCode$1=transform(getWorkerString(function(){var Stream=function Stream(){this.init=function(){var listeners={};this.on=function(type,listener){if(!listeners[type]){listeners[type]=[]}
listeners[type]=listeners[type].concat(listener)};this.off=function(type,listener){var index;if(!listeners[type]){return!1}
index=listeners[type].indexOf(listener);listeners[type]=listeners[type].slice();listeners[type].splice(index,1);return index>-1};this.trigger=function(type){var callbacks,i,length,args;callbacks=listeners[type];if(!callbacks){return}
if(arguments.length===2){length=callbacks.length;for(i=0;i<length;++i){callbacks[i].call(this,arguments[1])}}else{args=[];i=arguments.length;for(i=1;i<arguments.length;++i){args.push(arguments[i])}
length=callbacks.length;for(i=0;i<length;++i){callbacks[i].apply(this,args)}}};this.dispose=function(){listeners={}}}};Stream.prototype.pipe=function(destination){this.on('data',function(data){destination.push(data)});this.on('done',function(flushSource){destination.flush(flushSource)});this.on('partialdone',function(flushSource){destination.partialFlush(flushSource)});this.on('endedtimeline',function(flushSource){destination.endTimeline(flushSource)});this.on('reset',function(flushSource){destination.reset(flushSource)});return destination};Stream.prototype.push=function(data){this.trigger('data',data)};Stream.prototype.flush=function(flushSource){this.trigger('done',flushSource)};Stream.prototype.partialFlush=function(flushSource){this.trigger('partialdone',flushSource)};Stream.prototype.endTimeline=function(flushSource){this.trigger('endedtimeline',flushSource)};Stream.prototype.reset=function(flushSource){this.trigger('reset',flushSource)};var stream=Stream;var MAX_UINT32$1=Math.pow(2,32);var getUint64$2=function getUint64(uint8){var dv=new DataView(uint8.buffer,uint8.byteOffset,uint8.byteLength);var value;if(dv.getBigUint64){value=dv.getBigUint64(0);if(value<Number.MAX_SAFE_INTEGER){return Number(value)}
return value}
return dv.getUint32(0)*MAX_UINT32$1+dv.getUint32(4)};var numbers={getUint64:getUint64$2,MAX_UINT32:MAX_UINT32$1};var MAX_UINT32=numbers.MAX_UINT32;var box,dinf,esds,ftyp,mdat,mfhd,minf,moof,moov,mvex,mvhd,trak,tkhd,mdia,mdhd,hdlr,sdtp,stbl,stsd,traf,trex,trun$1,types,MAJOR_BRAND,MINOR_VERSION,AVC1_BRAND,VIDEO_HDLR,AUDIO_HDLR,HDLR_TYPES,VMHD,SMHD,DREF,STCO,STSC,STSZ,STTS;(function(){var i;types={avc1:[],avcC:[],btrt:[],dinf:[],dref:[],esds:[],ftyp:[],hdlr:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],mvex:[],mvhd:[],pasp:[],sdtp:[],smhd:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],styp:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trex:[],tkhd:[],vmhd:[]};if(typeof Uint8Array==='undefined'){return}
for(i in types){if(types.hasOwnProperty(i)){types[i]=[i.charCodeAt(0),i.charCodeAt(1),i.charCodeAt(2),i.charCodeAt(3)]}}
MAJOR_BRAND=new Uint8Array(['i'.charCodeAt(0),'s'.charCodeAt(0),'o'.charCodeAt(0),'m'.charCodeAt(0)]);AVC1_BRAND=new Uint8Array(['a'.charCodeAt(0),'v'.charCodeAt(0),'c'.charCodeAt(0),'1'.charCodeAt(0)]);MINOR_VERSION=new Uint8Array([0,0,0,1]);VIDEO_HDLR=new Uint8Array([0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x76,0x69,0x64,0x65,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x56,0x69,0x64,0x65,0x6f,0x48,0x61,0x6e,0x64,0x6c,0x65,0x72,0x00]);AUDIO_HDLR=new Uint8Array([0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x73,0x6f,0x75,0x6e,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x53,0x6f,0x75,0x6e,0x64,0x48,0x61,0x6e,0x64,0x6c,0x65,0x72,0x00]);HDLR_TYPES={video:VIDEO_HDLR,audio:AUDIO_HDLR};DREF=new Uint8Array([0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x0c,0x75,0x72,0x6c,0x20,0x00,0x00,0x00,0x01]);SMHD=new Uint8Array([0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00]);STCO=new Uint8Array([0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00]);STSC=STCO;STSZ=new Uint8Array([0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00]);STTS=STCO;VMHD=new Uint8Array([0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00])})();box=function box(type){var payload=[],size=0,i,result,view;for(i=1;i<arguments.length;i++){payload.push(arguments[i])}
i=payload.length;while(i--){size+=payload[i].byteLength}
result=new Uint8Array(size+8);view=new DataView(result.buffer,result.byteOffset,result.byteLength);view.setUint32(0,result.byteLength);result.set(type,4);for(i=0,size=8;i<payload.length;i++){result.set(payload[i],size);size+=payload[i].byteLength}
return result};dinf=function dinf(){return box(types.dinf,box(types.dref,DREF))};esds=function esds(track){return box(types.esds,new Uint8Array([0x00,0x00,0x00,0x00,0x03,0x19,0x00,0x00,0x00,0x04,0x11,0x40,0x15,0x00,0x06,0x00,0x00,0x00,0xda,0xc0,0x00,0x00,0xda,0xc0,0x05,0x02,track.audioobjecttype<<3|track.samplingfrequencyindex>>>1,track.samplingfrequencyindex<<7|track.channelcount<<3,0x06,0x01,0x02]))};ftyp=function ftyp(){return box(types.ftyp,MAJOR_BRAND,MINOR_VERSION,MAJOR_BRAND,AVC1_BRAND)};hdlr=function hdlr(type){return box(types.hdlr,HDLR_TYPES[type])};mdat=function mdat(data){return box(types.mdat,data)};mdhd=function mdhd(track){var result=new Uint8Array([0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x00,0x00,0x00,0x03,0x00,0x01,0x5f,0x90,track.duration>>>24&0xFF,track.duration>>>16&0xFF,track.duration>>>8&0xFF,track.duration&0xFF,0x55,0xc4,0x00,0x00]);if(track.samplerate){result[12]=track.samplerate>>>24&0xFF;result[13]=track.samplerate>>>16&0xFF;result[14]=track.samplerate>>>8&0xFF;result[15]=track.samplerate&0xFF}
return box(types.mdhd,result)};mdia=function mdia(track){return box(types.mdia,mdhd(track),hdlr(track.type),minf(track))};mfhd=function mfhd(sequenceNumber){return box(types.mfhd,new Uint8Array([0x00,0x00,0x00,0x00,(sequenceNumber&0xFF000000)>>24,(sequenceNumber&0xFF0000)>>16,(sequenceNumber&0xFF00)>>8,sequenceNumber&0xFF]))};minf=function minf(track){return box(types.minf,track.type==='video'?box(types.vmhd,VMHD):box(types.smhd,SMHD),dinf(),stbl(track))};moof=function moof(sequenceNumber,tracks){var trackFragments=[],i=tracks.length;while(i--){trackFragments[i]=traf(tracks[i])}
return box.apply(null,[types.moof,mfhd(sequenceNumber)].concat(trackFragments))};moov=function moov(tracks){var i=tracks.length,boxes=[];while(i--){boxes[i]=trak(tracks[i])}
return box.apply(null,[types.moov,mvhd(0xffffffff)].concat(boxes).concat(mvex(tracks)))};mvex=function mvex(tracks){var i=tracks.length,boxes=[];while(i--){boxes[i]=trex(tracks[i])}
return box.apply(null,[types.mvex].concat(boxes))};mvhd=function mvhd(duration){var bytes=new Uint8Array([0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x02,0x00,0x01,0x5f,0x90,(duration&0xFF000000)>>24,(duration&0xFF0000)>>16,(duration&0xFF00)>>8,duration&0xFF,0x00,0x01,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xff,0xff,0xff,0xff]);return box(types.mvhd,bytes)};sdtp=function sdtp(track){var samples=track.samples||[],bytes=new Uint8Array(4+samples.length),flags,i;for(i=0;i<samples.length;i++){flags=samples[i].flags;bytes[i+4]=flags.dependsOn<<4|flags.isDependedOn<<2|flags.hasRedundancy}
return box(types.sdtp,bytes)};stbl=function stbl(track){return box(types.stbl,stsd(track),box(types.stts,STTS),box(types.stsc,STSC),box(types.stsz,STSZ),box(types.stco,STCO))};(function(){var videoSample,audioSample;stsd=function stsd(track){return box(types.stsd,new Uint8Array([0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01]),track.type==='video'?videoSample(track):audioSample(track))};videoSample=function videoSample(track){var sps=track.sps||[],pps=track.pps||[],sequenceParameterSets=[],pictureParameterSets=[],i,avc1Box;for(i=0;i<sps.length;i++){sequenceParameterSets.push((sps[i].byteLength&0xFF00)>>>8);sequenceParameterSets.push(sps[i].byteLength&0xFF);sequenceParameterSets=sequenceParameterSets.concat(Array.prototype.slice.call(sps[i]))}
for(i=0;i<pps.length;i++){pictureParameterSets.push((pps[i].byteLength&0xFF00)>>>8);pictureParameterSets.push(pps[i].byteLength&0xFF);pictureParameterSets=pictureParameterSets.concat(Array.prototype.slice.call(pps[i]))}
avc1Box=[types.avc1,new Uint8Array([0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,(track.width&0xff00)>>8,track.width&0xff,(track.height&0xff00)>>8,track.height&0xff,0x00,0x48,0x00,0x00,0x00,0x48,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x13,0x76,0x69,0x64,0x65,0x6f,0x6a,0x73,0x2d,0x63,0x6f,0x6e,0x74,0x72,0x69,0x62,0x2d,0x68,0x6c,0x73,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x18,0x11,0x11]),box(types.avcC,new Uint8Array([0x01,track.profileIdc,track.profileCompatibility,track.levelIdc,0xff].concat([sps.length],sequenceParameterSets,[pps.length],pictureParameterSets))),box(types.btrt,new Uint8Array([0x00,0x1c,0x9c,0x80,0x00,0x2d,0xc6,0xc0,0x00,0x2d,0xc6,0xc0]))];if(track.sarRatio){var hSpacing=track.sarRatio[0],vSpacing=track.sarRatio[1];avc1Box.push(box(types.pasp,new Uint8Array([(hSpacing&0xFF000000)>>24,(hSpacing&0xFF0000)>>16,(hSpacing&0xFF00)>>8,hSpacing&0xFF,(vSpacing&0xFF000000)>>24,(vSpacing&0xFF0000)>>16,(vSpacing&0xFF00)>>8,vSpacing&0xFF])))}
return box.apply(null,avc1Box)};audioSample=function audioSample(track){return box(types.mp4a,new Uint8Array([0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,(track.channelcount&0xff00)>>8,track.channelcount&0xff,(track.samplesize&0xff00)>>8,track.samplesize&0xff,0x00,0x00,0x00,0x00,(track.samplerate&0xff00)>>8,track.samplerate&0xff,0x00,0x00]),esds(track))}})();tkhd=function tkhd(track){var result=new Uint8Array([0x00,0x00,0x00,0x07,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,(track.id&0xFF000000)>>24,(track.id&0xFF0000)>>16,(track.id&0xFF00)>>8,track.id&0xFF,0x00,0x00,0x00,0x00,(track.duration&0xFF000000)>>24,(track.duration&0xFF0000)>>16,(track.duration&0xFF00)>>8,track.duration&0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x40,0x00,0x00,0x00,(track.width&0xFF00)>>8,track.width&0xFF,0x00,0x00,(track.height&0xFF00)>>8,track.height&0xFF,0x00,0x00]);return box(types.tkhd,result)};traf=function traf(track){var trackFragmentHeader,trackFragmentDecodeTime,trackFragmentRun,sampleDependencyTable,dataOffset,upperWordBaseMediaDecodeTime,lowerWordBaseMediaDecodeTime;trackFragmentHeader=box(types.tfhd,new Uint8Array([0x00,0x00,0x00,0x3a,(track.id&0xFF000000)>>24,(track.id&0xFF0000)>>16,(track.id&0xFF00)>>8,track.id&0xFF,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00]));upperWordBaseMediaDecodeTime=Math.floor(track.baseMediaDecodeTime/MAX_UINT32);lowerWordBaseMediaDecodeTime=Math.floor(track.baseMediaDecodeTime%MAX_UINT32);trackFragmentDecodeTime=box(types.tfdt,new Uint8Array([0x01,0x00,0x00,0x00,upperWordBaseMediaDecodeTime>>>24&0xFF,upperWordBaseMediaDecodeTime>>>16&0xFF,upperWordBaseMediaDecodeTime>>>8&0xFF,upperWordBaseMediaDecodeTime&0xFF,lowerWordBaseMediaDecodeTime>>>24&0xFF,lowerWordBaseMediaDecodeTime>>>16&0xFF,lowerWordBaseMediaDecodeTime>>>8&0xFF,lowerWordBaseMediaDecodeTime&0xFF]));dataOffset=32+20+8+16+8+8;if(track.type==='audio'){trackFragmentRun=trun$1(track,dataOffset);return box(types.traf,trackFragmentHeader,trackFragmentDecodeTime,trackFragmentRun)}
sampleDependencyTable=sdtp(track);trackFragmentRun=trun$1(track,sampleDependencyTable.length+dataOffset);return box(types.traf,trackFragmentHeader,trackFragmentDecodeTime,trackFragmentRun,sampleDependencyTable)};trak=function trak(track){track.duration=track.duration||0xffffffff;return box(types.trak,tkhd(track),mdia(track))};trex=function trex(track){var result=new Uint8Array([0x00,0x00,0x00,0x00,(track.id&0xFF000000)>>24,(track.id&0xFF0000)>>16,(track.id&0xFF00)>>8,track.id&0xFF,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x01]);if(track.type!=='video'){result[result.length-1]=0x00}
return box(types.trex,result)};(function(){var audioTrun,videoTrun,trunHeader;trunHeader=function trunHeader(samples,offset){var durationPresent=0,sizePresent=0,flagsPresent=0,compositionTimeOffset=0;if(samples.length){if(samples[0].duration!==undefined){durationPresent=0x1}
if(samples[0].size!==undefined){sizePresent=0x2}
if(samples[0].flags!==undefined){flagsPresent=0x4}
if(samples[0].compositionTimeOffset!==undefined){compositionTimeOffset=0x8}}
return[0x00,0x00,durationPresent|sizePresent|flagsPresent|compositionTimeOffset,0x01,(samples.length&0xFF000000)>>>24,(samples.length&0xFF0000)>>>16,(samples.length&0xFF00)>>>8,samples.length&0xFF,(offset&0xFF000000)>>>24,(offset&0xFF0000)>>>16,(offset&0xFF00)>>>8,offset&0xFF]};videoTrun=function videoTrun(track,offset){var bytesOffest,bytes,header,samples,sample,i;samples=track.samples||[];offset+=8+12+16*samples.length;header=trunHeader(samples,offset);bytes=new Uint8Array(header.length+samples.length*16);bytes.set(header);bytesOffest=header.length;for(i=0;i<samples.length;i++){sample=samples[i];bytes[bytesOffest++]=(sample.duration&0xFF000000)>>>24;bytes[bytesOffest++]=(sample.duration&0xFF0000)>>>16;bytes[bytesOffest++]=(sample.duration&0xFF00)>>>8;bytes[bytesOffest++]=sample.duration&0xFF;bytes[bytesOffest++]=(sample.size&0xFF000000)>>>24;bytes[bytesOffest++]=(sample.size&0xFF0000)>>>16;bytes[bytesOffest++]=(sample.size&0xFF00)>>>8;bytes[bytesOffest++]=sample.size&0xFF;bytes[bytesOffest++]=sample.flags.isLeading<<2|sample.flags.dependsOn;bytes[bytesOffest++]=sample.flags.isDependedOn<<6|sample.flags.hasRedundancy<<4|sample.flags.paddingValue<<1|sample.flags.isNonSyncSample;bytes[bytesOffest++]=sample.flags.degradationPriority&0xF0<<8;bytes[bytesOffest++]=sample.flags.degradationPriority&0x0F;bytes[bytesOffest++]=(sample.compositionTimeOffset&0xFF000000)>>>24;bytes[bytesOffest++]=(sample.compositionTimeOffset&0xFF0000)>>>16;bytes[bytesOffest++]=(sample.compositionTimeOffset&0xFF00)>>>8;bytes[bytesOffest++]=sample.compositionTimeOffset&0xFF}
return box(types.trun,bytes)};audioTrun=function audioTrun(track,offset){var bytes,bytesOffest,header,samples,sample,i;samples=track.samples||[];offset+=8+12+8*samples.length;header=trunHeader(samples,offset);bytes=new Uint8Array(header.length+samples.length*8);bytes.set(header);bytesOffest=header.length;for(i=0;i<samples.length;i++){sample=samples[i];bytes[bytesOffest++]=(sample.duration&0xFF000000)>>>24;bytes[bytesOffest++]=(sample.duration&0xFF0000)>>>16;bytes[bytesOffest++]=(sample.duration&0xFF00)>>>8;bytes[bytesOffest++]=sample.duration&0xFF;bytes[bytesOffest++]=(sample.size&0xFF000000)>>>24;bytes[bytesOffest++]=(sample.size&0xFF0000)>>>16;bytes[bytesOffest++]=(sample.size&0xFF00)>>>8;bytes[bytesOffest++]=sample.size&0xFF}
return box(types.trun,bytes)};trun$1=function trun(track,offset){if(track.type==='audio'){return audioTrun(track,offset)}
return videoTrun(track,offset)}})();var mp4Generator={ftyp:ftyp,mdat:mdat,moof:moof,moov:moov,initSegment:function initSegment(tracks){var fileType=ftyp(),movie=moov(tracks),result;result=new Uint8Array(fileType.byteLength+movie.byteLength);result.set(fileType);result.set(movie,fileType.byteLength);return result}};var groupNalsIntoFrames=function groupNalsIntoFrames(nalUnits){var i,currentNal,currentFrame=[],frames=[];frames.byteLength=0;frames.nalCount=0;frames.duration=0;currentFrame.byteLength=0;for(i=0;i<nalUnits.length;i++){currentNal=nalUnits[i];if(currentNal.nalUnitType==='access_unit_delimiter_rbsp'){if(currentFrame.length){currentFrame.duration=currentNal.dts-currentFrame.dts;frames.byteLength+=currentFrame.byteLength;frames.nalCount+=currentFrame.length;frames.duration+=currentFrame.duration;frames.push(currentFrame)}
currentFrame=[currentNal];currentFrame.byteLength=currentNal.data.byteLength;currentFrame.pts=currentNal.pts;currentFrame.dts=currentNal.dts}else{if(currentNal.nalUnitType==='slice_layer_without_partitioning_rbsp_idr'){currentFrame.keyFrame=!0}
currentFrame.duration=currentNal.dts-currentFrame.dts;currentFrame.byteLength+=currentNal.data.byteLength;currentFrame.push(currentNal)}}
if(frames.length&&(!currentFrame.duration||currentFrame.duration<=0)){currentFrame.duration=frames[frames.length-1].duration}
frames.byteLength+=currentFrame.byteLength;frames.nalCount+=currentFrame.length;frames.duration+=currentFrame.duration;frames.push(currentFrame);return frames};var groupFramesIntoGops=function groupFramesIntoGops(frames){var i,currentFrame,currentGop=[],gops=[];currentGop.byteLength=0;currentGop.nalCount=0;currentGop.duration=0;currentGop.pts=frames[0].pts;currentGop.dts=frames[0].dts;gops.byteLength=0;gops.nalCount=0;gops.duration=0;gops.pts=frames[0].pts;gops.dts=frames[0].dts;for(i=0;i<frames.length;i++){currentFrame=frames[i];if(currentFrame.keyFrame){if(currentGop.length){gops.push(currentGop);gops.byteLength+=currentGop.byteLength;gops.nalCount+=currentGop.nalCount;gops.duration+=currentGop.duration}
currentGop=[currentFrame];currentGop.nalCount=currentFrame.length;currentGop.byteLength=currentFrame.byteLength;currentGop.pts=currentFrame.pts;currentGop.dts=currentFrame.dts;currentGop.duration=currentFrame.duration}else{currentGop.duration+=currentFrame.duration;currentGop.nalCount+=currentFrame.length;currentGop.byteLength+=currentFrame.byteLength;currentGop.push(currentFrame)}}
if(gops.length&&currentGop.duration<=0){currentGop.duration=gops[gops.length-1].duration}
gops.byteLength+=currentGop.byteLength;gops.nalCount+=currentGop.nalCount;gops.duration+=currentGop.duration;gops.push(currentGop);return gops};var extendFirstKeyFrame=function extendFirstKeyFrame(gops){var currentGop;if(!gops[0][0].keyFrame&&gops.length>1){currentGop=gops.shift();gops.byteLength-=currentGop.byteLength;gops.nalCount-=currentGop.nalCount;gops[0][0].dts=currentGop.dts;gops[0][0].pts=currentGop.pts;gops[0][0].duration+=currentGop.duration}
return gops};var createDefaultSample=function createDefaultSample(){return{size:0,flags:{isLeading:0,dependsOn:1,isDependedOn:0,hasRedundancy:0,degradationPriority:0,isNonSyncSample:1}}};var sampleForFrame=function sampleForFrame(frame,dataOffset){var sample=createDefaultSample();sample.dataOffset=dataOffset;sample.compositionTimeOffset=frame.pts-frame.dts;sample.duration=frame.duration;sample.size=4*frame.length;sample.size+=frame.byteLength;if(frame.keyFrame){sample.flags.dependsOn=2;sample.flags.isNonSyncSample=0}
return sample};var generateSampleTable$1=function generateSampleTable(gops,baseDataOffset){var h,i,sample,currentGop,currentFrame,dataOffset=baseDataOffset||0,samples=[];for(h=0;h<gops.length;h++){currentGop=gops[h];for(i=0;i<currentGop.length;i++){currentFrame=currentGop[i];sample=sampleForFrame(currentFrame,dataOffset);dataOffset+=sample.size;samples.push(sample)}}
return samples};var concatenateNalData=function concatenateNalData(gops){var h,i,j,currentGop,currentFrame,currentNal,dataOffset=0,nalsByteLength=gops.byteLength,numberOfNals=gops.nalCount,totalByteLength=nalsByteLength+4*numberOfNals,data=new Uint8Array(totalByteLength),view=new DataView(data.buffer);for(h=0;h<gops.length;h++){currentGop=gops[h];for(i=0;i<currentGop.length;i++){currentFrame=currentGop[i];for(j=0;j<currentFrame.length;j++){currentNal=currentFrame[j];view.setUint32(dataOffset,currentNal.data.byteLength);dataOffset+=4;data.set(currentNal.data,dataOffset);dataOffset+=currentNal.data.byteLength}}}
return data};var generateSampleTableForFrame=function generateSampleTableForFrame(frame,baseDataOffset){var sample,dataOffset=baseDataOffset||0,samples=[];sample=sampleForFrame(frame,dataOffset);samples.push(sample);return samples};var concatenateNalDataForFrame=function concatenateNalDataForFrame(frame){var i,currentNal,dataOffset=0,nalsByteLength=frame.byteLength,numberOfNals=frame.length,totalByteLength=nalsByteLength+4*numberOfNals,data=new Uint8Array(totalByteLength),view=new DataView(data.buffer);for(i=0;i<frame.length;i++){currentNal=frame[i];view.setUint32(dataOffset,currentNal.data.byteLength);dataOffset+=4;data.set(currentNal.data,dataOffset);dataOffset+=currentNal.data.byteLength}
return data};var frameUtils={groupNalsIntoFrames:groupNalsIntoFrames,groupFramesIntoGops:groupFramesIntoGops,extendFirstKeyFrame:extendFirstKeyFrame,generateSampleTable:generateSampleTable$1,concatenateNalData:concatenateNalData,generateSampleTableForFrame:generateSampleTableForFrame,concatenateNalDataForFrame:concatenateNalDataForFrame};var highPrefix=[33,16,5,32,164,27];var lowPrefix=[33,65,108,84,1,2,4,8,168,2,4,8,17,191,252];var zeroFill=function zeroFill(count){var a=[];while(count--){a.push(0)}
return a};var makeTable=function makeTable(metaTable){return Object.keys(metaTable).reduce(function(obj,key){obj[key]=new Uint8Array(metaTable[key].reduce(function(arr,part){return arr.concat(part)},[]));return obj},{})};var silence;var silence_1=function silence_1(){if(!silence){var coneOfSilence={96000:[highPrefix,[227,64],zeroFill(154),[56]],88200:[highPrefix,[231],zeroFill(170),[56]],64000:[highPrefix,[248,192],zeroFill(240),[56]],48000:[highPrefix,[255,192],zeroFill(268),[55,148,128],zeroFill(54),[112]],44100:[highPrefix,[255,192],zeroFill(268),[55,163,128],zeroFill(84),[112]],32000:[highPrefix,[255,192],zeroFill(268),[55,234],zeroFill(226),[112]],24000:[highPrefix,[255,192],zeroFill(268),[55,255,128],zeroFill(268),[111,112],zeroFill(126),[224]],16000:[highPrefix,[255,192],zeroFill(268),[55,255,128],zeroFill(268),[111,255],zeroFill(269),[223,108],zeroFill(195),[1,192]],12000:[lowPrefix,zeroFill(268),[3,127,248],zeroFill(268),[6,255,240],zeroFill(268),[13,255,224],zeroFill(268),[27,253,128],zeroFill(259),[56]],11025:[lowPrefix,zeroFill(268),[3,127,248],zeroFill(268),[6,255,240],zeroFill(268),[13,255,224],zeroFill(268),[27,255,192],zeroFill(268),[55,175,128],zeroFill(108),[112]],8000:[lowPrefix,zeroFill(268),[3,121,16],zeroFill(47),[7]]};silence=makeTable(coneOfSilence)}
return silence};var ONE_SECOND_IN_TS$4=90000,secondsToVideoTs,secondsToAudioTs,videoTsToSeconds,audioTsToSeconds,audioTsToVideoTs,videoTsToAudioTs,metadataTsToSeconds;secondsToVideoTs=function secondsToVideoTs(seconds){return seconds*ONE_SECOND_IN_TS$4};secondsToAudioTs=function secondsToAudioTs(seconds,sampleRate){return seconds*sampleRate};videoTsToSeconds=function videoTsToSeconds(timestamp){return timestamp/ONE_SECOND_IN_TS$4};audioTsToSeconds=function audioTsToSeconds(timestamp,sampleRate){return timestamp/sampleRate};audioTsToVideoTs=function audioTsToVideoTs(timestamp,sampleRate){return secondsToVideoTs(audioTsToSeconds(timestamp,sampleRate))};videoTsToAudioTs=function videoTsToAudioTs(timestamp,sampleRate){return secondsToAudioTs(videoTsToSeconds(timestamp),sampleRate)};metadataTsToSeconds=function metadataTsToSeconds(timestamp,timelineStartPts,keepOriginalTimestamps){return videoTsToSeconds(keepOriginalTimestamps?timestamp:timestamp-timelineStartPts)};var clock={ONE_SECOND_IN_TS:ONE_SECOND_IN_TS$4,secondsToVideoTs:secondsToVideoTs,secondsToAudioTs:secondsToAudioTs,videoTsToSeconds:videoTsToSeconds,audioTsToSeconds:audioTsToSeconds,audioTsToVideoTs:audioTsToVideoTs,videoTsToAudioTs:videoTsToAudioTs,metadataTsToSeconds:metadataTsToSeconds};var sumFrameByteLengths=function sumFrameByteLengths(array){var i,currentObj,sum=0;for(i=0;i<array.length;i++){currentObj=array[i];sum+=currentObj.data.byteLength}
return sum};var prefixWithSilence=function prefixWithSilence(track,frames,audioAppendStartTs,videoBaseMediaDecodeTime){var baseMediaDecodeTimeTs,frameDuration=0,audioGapDuration=0,audioFillFrameCount=0,audioFillDuration=0,silentFrame,i,firstFrame;if(!frames.length){return}
baseMediaDecodeTimeTs=clock.audioTsToVideoTs(track.baseMediaDecodeTime,track.samplerate);frameDuration=Math.ceil(clock.ONE_SECOND_IN_TS/(track.samplerate/1024));if(audioAppendStartTs&&videoBaseMediaDecodeTime){audioGapDuration=baseMediaDecodeTimeTs-Math.max(audioAppendStartTs,videoBaseMediaDecodeTime);audioFillFrameCount=Math.floor(audioGapDuration/frameDuration);audioFillDuration=audioFillFrameCount*frameDuration}
if(audioFillFrameCount<1||audioFillDuration>clock.ONE_SECOND_IN_TS/2){return}
silentFrame=silence_1()[track.samplerate];if(!silentFrame){silentFrame=frames[0].data}
for(i=0;i<audioFillFrameCount;i++){firstFrame=frames[0];frames.splice(0,0,{data:silentFrame,dts:firstFrame.dts-frameDuration,pts:firstFrame.pts-frameDuration})}
track.baseMediaDecodeTime-=Math.floor(clock.videoTsToAudioTs(audioFillDuration,track.samplerate));return audioFillDuration};var trimAdtsFramesByEarliestDts=function trimAdtsFramesByEarliestDts(adtsFrames,track,earliestAllowedDts){if(track.minSegmentDts>=earliestAllowedDts){return adtsFrames}
track.minSegmentDts=Infinity;return adtsFrames.filter(function(currentFrame){if(currentFrame.dts>=earliestAllowedDts){track.minSegmentDts=Math.min(track.minSegmentDts,currentFrame.dts);track.minSegmentPts=track.minSegmentDts;return!0}
return!1})};var generateSampleTable=function generateSampleTable(frames){var i,currentFrame,samples=[];for(i=0;i<frames.length;i++){currentFrame=frames[i];samples.push({size:currentFrame.data.byteLength,duration:1024})}
return samples};var concatenateFrameData=function concatenateFrameData(frames){var i,currentFrame,dataOffset=0,data=new Uint8Array(sumFrameByteLengths(frames));for(i=0;i<frames.length;i++){currentFrame=frames[i];data.set(currentFrame.data,dataOffset);dataOffset+=currentFrame.data.byteLength}
return data};var audioFrameUtils={prefixWithSilence:prefixWithSilence,trimAdtsFramesByEarliestDts:trimAdtsFramesByEarliestDts,generateSampleTable:generateSampleTable,concatenateFrameData:concatenateFrameData};var ONE_SECOND_IN_TS$3=clock.ONE_SECOND_IN_TS;var collectDtsInfo=function collectDtsInfo(track,data){if(typeof data.pts==='number'){if(track.timelineStartInfo.pts===undefined){track.timelineStartInfo.pts=data.pts}
if(track.minSegmentPts===undefined){track.minSegmentPts=data.pts}else{track.minSegmentPts=Math.min(track.minSegmentPts,data.pts)}
if(track.maxSegmentPts===undefined){track.maxSegmentPts=data.pts}else{track.maxSegmentPts=Math.max(track.maxSegmentPts,data.pts)}}
if(typeof data.dts==='number'){if(track.timelineStartInfo.dts===undefined){track.timelineStartInfo.dts=data.dts}
if(track.minSegmentDts===undefined){track.minSegmentDts=data.dts}else{track.minSegmentDts=Math.min(track.minSegmentDts,data.dts)}
if(track.maxSegmentDts===undefined){track.maxSegmentDts=data.dts}else{track.maxSegmentDts=Math.max(track.maxSegmentDts,data.dts)}}};var clearDtsInfo=function clearDtsInfo(track){delete track.minSegmentDts;delete track.maxSegmentDts;delete track.minSegmentPts;delete track.maxSegmentPts};var calculateTrackBaseMediaDecodeTime=function calculateTrackBaseMediaDecodeTime(track,keepOriginalTimestamps){var baseMediaDecodeTime,scale,minSegmentDts=track.minSegmentDts;if(!keepOriginalTimestamps){minSegmentDts-=track.timelineStartInfo.dts}
baseMediaDecodeTime=track.timelineStartInfo.baseMediaDecodeTime;baseMediaDecodeTime+=minSegmentDts;baseMediaDecodeTime=Math.max(0,baseMediaDecodeTime);if(track.type==='audio'){scale=track.samplerate/ONE_SECOND_IN_TS$3;baseMediaDecodeTime*=scale;baseMediaDecodeTime=Math.floor(baseMediaDecodeTime)}
return baseMediaDecodeTime};var trackDecodeInfo={clearDtsInfo:clearDtsInfo,calculateTrackBaseMediaDecodeTime:calculateTrackBaseMediaDecodeTime,collectDtsInfo:collectDtsInfo};var USER_DATA_REGISTERED_ITU_T_T35=4,RBSP_TRAILING_BITS=128;var parseSei=function parseSei(bytes){var i=0,result={payloadType:-1,payloadSize:0},payloadType=0,payloadSize=0;while(i<bytes.byteLength){if(bytes[i]===RBSP_TRAILING_BITS){break}
while(bytes[i]===0xFF){payloadType+=255;i++}
payloadType+=bytes[i++];while(bytes[i]===0xFF){payloadSize+=255;i++}
payloadSize+=bytes[i++];if(!result.payload&&payloadType===USER_DATA_REGISTERED_ITU_T_T35){var userIdentifier=String.fromCharCode(bytes[i+3],bytes[i+4],bytes[i+5],bytes[i+6]);if(userIdentifier==='GA94'){result.payloadType=payloadType;result.payloadSize=payloadSize;result.payload=bytes.subarray(i,i+payloadSize);break}else{result.payload=void 0}}
i+=payloadSize;payloadType=0;payloadSize=0}
return result};var parseUserData=function parseUserData(sei){if(sei.payload[0]!==181){return null}
if((sei.payload[1]<<8|sei.payload[2])!==49){return null}
if(String.fromCharCode(sei.payload[3],sei.payload[4],sei.payload[5],sei.payload[6])!=='GA94'){return null}
if(sei.payload[7]!==0x03){return null}
return sei.payload.subarray(8,sei.payload.length-1)};var parseCaptionPackets=function parseCaptionPackets(pts,userData){var results=[],i,count,offset,data;if(!(userData[0]&0x40)){return results}
count=userData[0]&0x1f;for(i=0;i<count;i++){offset=i*3;data={type:userData[offset+2]&0x03,pts:pts};if(userData[offset+2]&0x04){data.ccData=userData[offset+3]<<8|userData[offset+4];results.push(data)}}
return results};var discardEmulationPreventionBytes$1=function discardEmulationPreventionBytes(data){var length=data.byteLength,emulationPreventionBytesPositions=[],i=1,newLength,newData;while(i<length-2){if(data[i]===0&&data[i+1]===0&&data[i+2]===0x03){emulationPreventionBytesPositions.push(i+2);i+=2}else{i++}}
if(emulationPreventionBytesPositions.length===0){return data}
newLength=length-emulationPreventionBytesPositions.length;newData=new Uint8Array(newLength);var sourceIndex=0;for(i=0;i<newLength;sourceIndex++,i++){if(sourceIndex===emulationPreventionBytesPositions[0]){sourceIndex++;emulationPreventionBytesPositions.shift()}
newData[i]=data[sourceIndex]}
return newData};var captionPacketParser={parseSei:parseSei,parseUserData:parseUserData,parseCaptionPackets:parseCaptionPackets,discardEmulationPreventionBytes:discardEmulationPreventionBytes$1,USER_DATA_REGISTERED_ITU_T_T35:USER_DATA_REGISTERED_ITU_T_T35};var CaptionStream$1=function CaptionStream(options){options=options||{};CaptionStream.prototype.init.call(this);this.parse708captions_=typeof options.parse708captions==='boolean'?options.parse708captions:!0;this.captionPackets_=[];this.ccStreams_=[new Cea608Stream(0,0),new Cea608Stream(0,1),new Cea608Stream(1,0),new Cea608Stream(1,1)];if(this.parse708captions_){this.cc708Stream_=new Cea708Stream({captionServices:options.captionServices})}
this.reset();this.ccStreams_.forEach(function(cc){cc.on('data',this.trigger.bind(this,'data'));cc.on('partialdone',this.trigger.bind(this,'partialdone'));cc.on('done',this.trigger.bind(this,'done'))},this);if(this.parse708captions_){this.cc708Stream_.on('data',this.trigger.bind(this,'data'));this.cc708Stream_.on('partialdone',this.trigger.bind(this,'partialdone'));this.cc708Stream_.on('done',this.trigger.bind(this,'done'))}};CaptionStream$1.prototype=new stream();CaptionStream$1.prototype.push=function(event){var sei,userData,newCaptionPackets;if(event.nalUnitType!=='sei_rbsp'){return}
sei=captionPacketParser.parseSei(event.escapedRBSP);if(!sei.payload){return}
if(sei.payloadType!==captionPacketParser.USER_DATA_REGISTERED_ITU_T_T35){return}
userData=captionPacketParser.parseUserData(sei);if(!userData){return}
if(event.dts<this.latestDts_){this.ignoreNextEqualDts_=!0;return}else if(event.dts===this.latestDts_&&this.ignoreNextEqualDts_){this.numSameDts_--;if(!this.numSameDts_){this.ignoreNextEqualDts_=!1}
return}
newCaptionPackets=captionPacketParser.parseCaptionPackets(event.pts,userData);this.captionPackets_=this.captionPackets_.concat(newCaptionPackets);if(this.latestDts_!==event.dts){this.numSameDts_=0}
this.numSameDts_++;this.latestDts_=event.dts};CaptionStream$1.prototype.flushCCStreams=function(flushType){this.ccStreams_.forEach(function(cc){return flushType==='flush'?cc.flush():cc.partialFlush()},this)};CaptionStream$1.prototype.flushStream=function(flushType){if(!this.captionPackets_.length){this.flushCCStreams(flushType);return}
this.captionPackets_.forEach(function(elem,idx){elem.presortIndex=idx});this.captionPackets_.sort(function(a,b){if(a.pts===b.pts){return a.presortIndex-b.presortIndex}
return a.pts-b.pts});this.captionPackets_.forEach(function(packet){if(packet.type<2){this.dispatchCea608Packet(packet)}else{this.dispatchCea708Packet(packet)}},this);this.captionPackets_.length=0;this.flushCCStreams(flushType)};CaptionStream$1.prototype.flush=function(){return this.flushStream('flush')};CaptionStream$1.prototype.partialFlush=function(){return this.flushStream('partialFlush')};CaptionStream$1.prototype.reset=function(){this.latestDts_=null;this.ignoreNextEqualDts_=!1;this.numSameDts_=0;this.activeCea608Channel_=[null,null];this.ccStreams_.forEach(function(ccStream){ccStream.reset()})};CaptionStream$1.prototype.dispatchCea608Packet=function(packet){if(this.setsTextOrXDSActive(packet)){this.activeCea608Channel_[packet.type]=null}else if(this.setsChannel1Active(packet)){this.activeCea608Channel_[packet.type]=0}else if(this.setsChannel2Active(packet)){this.activeCea608Channel_[packet.type]=1}
if(this.activeCea608Channel_[packet.type]===null){return}
this.ccStreams_[(packet.type<<1)+this.activeCea608Channel_[packet.type]].push(packet)};CaptionStream$1.prototype.setsChannel1Active=function(packet){return(packet.ccData&0x7800)===0x1000};CaptionStream$1.prototype.setsChannel2Active=function(packet){return(packet.ccData&0x7800)===0x1800};CaptionStream$1.prototype.setsTextOrXDSActive=function(packet){return(packet.ccData&0x7100)===0x0100||(packet.ccData&0x78fe)===0x102a||(packet.ccData&0x78fe)===0x182a};CaptionStream$1.prototype.dispatchCea708Packet=function(packet){if(this.parse708captions_){this.cc708Stream_.push(packet)}};var CHARACTER_TRANSLATION_708={0x7f:0x266a,0x1020:0x20,0x1021:0xa0,0x1025:0x2026,0x102a:0x0160,0x102c:0x0152,0x1030:0x2588,0x1031:0x2018,0x1032:0x2019,0x1033:0x201c,0x1034:0x201d,0x1035:0x2022,0x1039:0x2122,0x103a:0x0161,0x103c:0x0153,0x103d:0x2120,0x103f:0x0178,0x1076:0x215b,0x1077:0x215c,0x1078:0x215d,0x1079:0x215e,0x107a:0x23d0,0x107b:0x23a4,0x107c:0x23a3,0x107d:0x23af,0x107e:0x23a6,0x107f:0x23a1,0x10a0:0x3138};var get708CharFromCode=function get708CharFromCode(code){var newCode=CHARACTER_TRANSLATION_708[code]||code;if(code&0x1000&&code===newCode){return''}
return String.fromCharCode(newCode)};var within708TextBlock=function within708TextBlock(b){return 0x20<=b&&b<=0x7f||0xa0<=b&&b<=0xff};var Cea708Window=function Cea708Window(windowNum){this.windowNum=windowNum;this.reset()};Cea708Window.prototype.reset=function(){this.clearText();this.pendingNewLine=!1;this.winAttr={};this.penAttr={};this.penLoc={};this.penColor={};this.visible=0;this.rowLock=0;this.columnLock=0;this.priority=0;this.relativePositioning=0;this.anchorVertical=0;this.anchorHorizontal=0;this.anchorPoint=0;this.rowCount=1;this.virtualRowCount=this.rowCount+1;this.columnCount=41;this.windowStyle=0;this.penStyle=0};Cea708Window.prototype.getText=function(){return this.rows.join('\n')};Cea708Window.prototype.clearText=function(){this.rows=[''];this.rowIdx=0};Cea708Window.prototype.newLine=function(pts){if(this.rows.length>=this.virtualRowCount&&typeof this.beforeRowOverflow==='function'){this.beforeRowOverflow(pts)}
if(this.rows.length>0){this.rows.push('');this.rowIdx++}
while(this.rows.length>this.virtualRowCount){this.rows.shift();this.rowIdx--}};Cea708Window.prototype.isEmpty=function(){if(this.rows.length===0){return!0}else if(this.rows.length===1){return this.rows[0]===''}
return!1};Cea708Window.prototype.addText=function(text){this.rows[this.rowIdx]+=text};Cea708Window.prototype.backspace=function(){if(!this.isEmpty()){var row=this.rows[this.rowIdx];this.rows[this.rowIdx]=row.substr(0,row.length-1)}};var Cea708Service=function Cea708Service(serviceNum,encoding,stream){this.serviceNum=serviceNum;this.text='';this.currentWindow=new Cea708Window(-1);this.windows=[];this.stream=stream;if(typeof encoding==='string'){this.createTextDecoder(encoding)}};Cea708Service.prototype.init=function(pts,beforeRowOverflow){this.startPts=pts;for(var win=0;win<8;win++){this.windows[win]=new Cea708Window(win);if(typeof beforeRowOverflow==='function'){this.windows[win].beforeRowOverflow=beforeRowOverflow}}};Cea708Service.prototype.setCurrentWindow=function(windowNum){this.currentWindow=this.windows[windowNum]};Cea708Service.prototype.createTextDecoder=function(encoding){if(typeof TextDecoder==='undefined'){this.stream.trigger('log',{level:'warn',message:'The `encoding` option is unsupported without TextDecoder support'})}else{try{this.textDecoder_=new TextDecoder(encoding)}catch(error){this.stream.trigger('log',{level:'warn',message:'TextDecoder could not be created with '+encoding+' encoding. '+error})}}};var Cea708Stream=function Cea708Stream(options){options=options||{};Cea708Stream.prototype.init.call(this);var self=this;var captionServices=options.captionServices||{};var captionServiceEncodings={};var serviceProps;Object.keys(captionServices).forEach(function(serviceName){serviceProps=captionServices[serviceName];if(/^SERVICE/.test(serviceName)){captionServiceEncodings[serviceName]=serviceProps.encoding}});this.serviceEncodings=captionServiceEncodings;this.current708Packet=null;this.services={};this.push=function(packet){if(packet.type===3){self.new708Packet();self.add708Bytes(packet)}else{if(self.current708Packet===null){self.new708Packet()}
self.add708Bytes(packet)}}};Cea708Stream.prototype=new stream();Cea708Stream.prototype.new708Packet=function(){if(this.current708Packet!==null){this.push708Packet()}
this.current708Packet={data:[],ptsVals:[]}};Cea708Stream.prototype.add708Bytes=function(packet){var data=packet.ccData;var byte0=data>>>8;var byte1=data&0xff;this.current708Packet.ptsVals.push(packet.pts);this.current708Packet.data.push(byte0);this.current708Packet.data.push(byte1)};Cea708Stream.prototype.push708Packet=function(){var packet708=this.current708Packet;var packetData=packet708.data;var serviceNum=null;var blockSize=null;var i=0;var b=packetData[i++];packet708.seq=b>>6;packet708.sizeCode=b&0x3f;for(;i<packetData.length;i++){b=packetData[i++];serviceNum=b>>5;blockSize=b&0x1f;if(serviceNum===7&&blockSize>0){b=packetData[i++];serviceNum=b}
this.pushServiceBlock(serviceNum,i,blockSize);if(blockSize>0){i+=blockSize-1}}};Cea708Stream.prototype.pushServiceBlock=function(serviceNum,start,size){var b;var i=start;var packetData=this.current708Packet.data;var service=this.services[serviceNum];if(!service){service=this.initService(serviceNum,i)}
for(;i<start+size&&i<packetData.length;i++){b=packetData[i];if(within708TextBlock(b)){i=this.handleText(i,service)}else if(b===0x18){i=this.multiByteCharacter(i,service)}else if(b===0x10){i=this.extendedCommands(i,service)}else if(0x80<=b&&b<=0x87){i=this.setCurrentWindow(i,service)}else if(0x98<=b&&b<=0x9f){i=this.defineWindow(i,service)}else if(b===0x88){i=this.clearWindows(i,service)}else if(b===0x8c){i=this.deleteWindows(i,service)}else if(b===0x89){i=this.displayWindows(i,service)}else if(b===0x8a){i=this.hideWindows(i,service)}else if(b===0x8b){i=this.toggleWindows(i,service)}else if(b===0x97){i=this.setWindowAttributes(i,service)}else if(b===0x90){i=this.setPenAttributes(i,service)}else if(b===0x91){i=this.setPenColor(i,service)}else if(b===0x92){i=this.setPenLocation(i,service)}else if(b===0x8f){service=this.reset(i,service)}else if(b===0x08){service.currentWindow.backspace()}else if(b===0x0c){service.currentWindow.clearText()}else if(b===0x0d){service.currentWindow.pendingNewLine=!0}else if(b===0x0e){service.currentWindow.clearText()}else if(b===0x8d){i++}}};Cea708Stream.prototype.extendedCommands=function(i,service){var packetData=this.current708Packet.data;var b=packetData[++i];if(within708TextBlock(b)){i=this.handleText(i,service,{isExtended:!0})}
return i};Cea708Stream.prototype.getPts=function(byteIndex){return this.current708Packet.ptsVals[Math.floor(byteIndex/2)]};Cea708Stream.prototype.initService=function(serviceNum,i){var serviceName='SERVICE'+serviceNum;var self=this;var serviceName;var encoding;if(serviceName in this.serviceEncodings){encoding=this.serviceEncodings[serviceName]}
this.services[serviceNum]=new Cea708Service(serviceNum,encoding,self);this.services[serviceNum].init(this.getPts(i),function(pts){self.flushDisplayed(pts,self.services[serviceNum])});return this.services[serviceNum]};Cea708Stream.prototype.handleText=function(i,service,options){var isExtended=options&&options.isExtended;var isMultiByte=options&&options.isMultiByte;var packetData=this.current708Packet.data;var extended=isExtended?0x1000:0x0000;var currentByte=packetData[i];var nextByte=packetData[i+1];var win=service.currentWindow;var char;var charCodeArray;if(service.textDecoder_&&!isExtended){if(isMultiByte){charCodeArray=[currentByte,nextByte];i++}else{charCodeArray=[currentByte]}
char=service.textDecoder_.decode(new Uint8Array(charCodeArray))}else{char=get708CharFromCode(extended|currentByte)}
if(win.pendingNewLine&&!win.isEmpty()){win.newLine(this.getPts(i))}
win.pendingNewLine=!1;win.addText(char);return i};Cea708Stream.prototype.multiByteCharacter=function(i,service){var packetData=this.current708Packet.data;var firstByte=packetData[i+1];var secondByte=packetData[i+2];if(within708TextBlock(firstByte)&&within708TextBlock(secondByte)){i=this.handleText(++i,service,{isMultiByte:!0})}
return i};Cea708Stream.prototype.setCurrentWindow=function(i,service){var packetData=this.current708Packet.data;var b=packetData[i];var windowNum=b&0x07;service.setCurrentWindow(windowNum);return i};Cea708Stream.prototype.defineWindow=function(i,service){var packetData=this.current708Packet.data;var b=packetData[i];var windowNum=b&0x07;service.setCurrentWindow(windowNum);var win=service.currentWindow;b=packetData[++i];win.visible=(b&0x20)>>5;win.rowLock=(b&0x10)>>4;win.columnLock=(b&0x08)>>3;win.priority=b&0x07;b=packetData[++i];win.relativePositioning=(b&0x80)>>7;win.anchorVertical=b&0x7f;b=packetData[++i];win.anchorHorizontal=b;b=packetData[++i];win.anchorPoint=(b&0xf0)>>4;win.rowCount=b&0x0f;b=packetData[++i];win.columnCount=b&0x3f;b=packetData[++i];win.windowStyle=(b&0x38)>>3;win.penStyle=b&0x07;win.virtualRowCount=win.rowCount+1;return i};Cea708Stream.prototype.setWindowAttributes=function(i,service){var packetData=this.current708Packet.data;var b=packetData[i];var winAttr=service.currentWindow.winAttr;b=packetData[++i];winAttr.fillOpacity=(b&0xc0)>>6;winAttr.fillRed=(b&0x30)>>4;winAttr.fillGreen=(b&0x0c)>>2;winAttr.fillBlue=b&0x03;b=packetData[++i];winAttr.borderType=(b&0xc0)>>6;winAttr.borderRed=(b&0x30)>>4;winAttr.borderGreen=(b&0x0c)>>2;winAttr.borderBlue=b&0x03;b=packetData[++i];winAttr.borderType+=(b&0x80)>>5;winAttr.wordWrap=(b&0x40)>>6;winAttr.printDirection=(b&0x30)>>4;winAttr.scrollDirection=(b&0x0c)>>2;winAttr.justify=b&0x03;b=packetData[++i];winAttr.effectSpeed=(b&0xf0)>>4;winAttr.effectDirection=(b&0x0c)>>2;winAttr.displayEffect=b&0x03;return i};Cea708Stream.prototype.flushDisplayed=function(pts,service){var displayedText=[];for(var winId=0;winId<8;winId++){if(service.windows[winId].visible&&!service.windows[winId].isEmpty()){displayedText.push(service.windows[winId].getText())}}
service.endPts=pts;service.text=displayedText.join('\n\n');this.pushCaption(service);service.startPts=pts};Cea708Stream.prototype.pushCaption=function(service){if(service.text!==''){this.trigger('data',{startPts:service.startPts,endPts:service.endPts,text:service.text,stream:'cc708_'+service.serviceNum});service.text='';service.startPts=service.endPts}};Cea708Stream.prototype.displayWindows=function(i,service){var packetData=this.current708Packet.data;var b=packetData[++i];var pts=this.getPts(i);this.flushDisplayed(pts,service);for(var winId=0;winId<8;winId++){if(b&0x01<<winId){service.windows[winId].visible=1}}
return i};Cea708Stream.prototype.hideWindows=function(i,service){var packetData=this.current708Packet.data;var b=packetData[++i];var pts=this.getPts(i);this.flushDisplayed(pts,service);for(var winId=0;winId<8;winId++){if(b&0x01<<winId){service.windows[winId].visible=0}}
return i};Cea708Stream.prototype.toggleWindows=function(i,service){var packetData=this.current708Packet.data;var b=packetData[++i];var pts=this.getPts(i);this.flushDisplayed(pts,service);for(var winId=0;winId<8;winId++){if(b&0x01<<winId){service.windows[winId].visible^=1}}
return i};Cea708Stream.prototype.clearWindows=function(i,service){var packetData=this.current708Packet.data;var b=packetData[++i];var pts=this.getPts(i);this.flushDisplayed(pts,service);for(var winId=0;winId<8;winId++){if(b&0x01<<winId){service.windows[winId].clearText()}}
return i};Cea708Stream.prototype.deleteWindows=function(i,service){var packetData=this.current708Packet.data;var b=packetData[++i];var pts=this.getPts(i);this.flushDisplayed(pts,service);for(var winId=0;winId<8;winId++){if(b&0x01<<winId){service.windows[winId].reset()}}
return i};Cea708Stream.prototype.setPenAttributes=function(i,service){var packetData=this.current708Packet.data;var b=packetData[i];var penAttr=service.currentWindow.penAttr;b=packetData[++i];penAttr.textTag=(b&0xf0)>>4;penAttr.offset=(b&0x0c)>>2;penAttr.penSize=b&0x03;b=packetData[++i];penAttr.italics=(b&0x80)>>7;penAttr.underline=(b&0x40)>>6;penAttr.edgeType=(b&0x38)>>3;penAttr.fontStyle=b&0x07;return i};Cea708Stream.prototype.setPenColor=function(i,service){var packetData=this.current708Packet.data;var b=packetData[i];var penColor=service.currentWindow.penColor;b=packetData[++i];penColor.fgOpacity=(b&0xc0)>>6;penColor.fgRed=(b&0x30)>>4;penColor.fgGreen=(b&0x0c)>>2;penColor.fgBlue=b&0x03;b=packetData[++i];penColor.bgOpacity=(b&0xc0)>>6;penColor.bgRed=(b&0x30)>>4;penColor.bgGreen=(b&0x0c)>>2;penColor.bgBlue=b&0x03;b=packetData[++i];penColor.edgeRed=(b&0x30)>>4;penColor.edgeGreen=(b&0x0c)>>2;penColor.edgeBlue=b&0x03;return i};Cea708Stream.prototype.setPenLocation=function(i,service){var packetData=this.current708Packet.data;var b=packetData[i];var penLoc=service.currentWindow.penLoc;service.currentWindow.pendingNewLine=!0;b=packetData[++i];penLoc.row=b&0x0f;b=packetData[++i];penLoc.column=b&0x3f;return i};Cea708Stream.prototype.reset=function(i,service){var pts=this.getPts(i);this.flushDisplayed(pts,service);return this.initService(service.serviceNum,i)};var CHARACTER_TRANSLATION={0x2a:0xe1,0x5c:0xe9,0x5e:0xed,0x5f:0xf3,0x60:0xfa,0x7b:0xe7,0x7c:0xf7,0x7d:0xd1,0x7e:0xf1,0x7f:0x2588,0x0130:0xae,0x0131:0xb0,0x0132:0xbd,0x0133:0xbf,0x0134:0x2122,0x0135:0xa2,0x0136:0xa3,0x0137:0x266a,0x0138:0xe0,0x0139:0xa0,0x013a:0xe8,0x013b:0xe2,0x013c:0xea,0x013d:0xee,0x013e:0xf4,0x013f:0xfb,0x0220:0xc1,0x0221:0xc9,0x0222:0xd3,0x0223:0xda,0x0224:0xdc,0x0225:0xfc,0x0226:0x2018,0x0227:0xa1,0x0228:0x2a,0x0229:0x27,0x022a:0x2014,0x022b:0xa9,0x022c:0x2120,0x022d:0x2022,0x022e:0x201c,0x022f:0x201d,0x0230:0xc0,0x0231:0xc2,0x0232:0xc7,0x0233:0xc8,0x0234:0xca,0x0235:0xcb,0x0236:0xeb,0x0237:0xce,0x0238:0xcf,0x0239:0xef,0x023a:0xd4,0x023b:0xd9,0x023c:0xf9,0x023d:0xdb,0x023e:0xab,0x023f:0xbb,0x0320:0xc3,0x0321:0xe3,0x0322:0xcd,0x0323:0xcc,0x0324:0xec,0x0325:0xd2,0x0326:0xf2,0x0327:0xd5,0x0328:0xf5,0x0329:0x7b,0x032a:0x7d,0x032b:0x5c,0x032c:0x5e,0x032d:0x5f,0x032e:0x7c,0x032f:0x7e,0x0330:0xc4,0x0331:0xe4,0x0332:0xd6,0x0333:0xf6,0x0334:0xdf,0x0335:0xa5,0x0336:0xa4,0x0337:0x2502,0x0338:0xc5,0x0339:0xe5,0x033a:0xd8,0x033b:0xf8,0x033c:0x250c,0x033d:0x2510,0x033e:0x2514,0x033f:0x2518};var getCharFromCode=function getCharFromCode(code){if(code===null){return''}
code=CHARACTER_TRANSLATION[code]||code;return String.fromCharCode(code)};var BOTTOM_ROW=14;var ROWS=[0x1100,0x1120,0x1200,0x1220,0x1500,0x1520,0x1600,0x1620,0x1700,0x1720,0x1000,0x1300,0x1320,0x1400,0x1420];var createDisplayBuffer=function createDisplayBuffer(){var result=[],i=BOTTOM_ROW+1;while(i--){result.push('')}
return result};var Cea608Stream=function Cea608Stream(field,dataChannel){Cea608Stream.prototype.init.call(this);this.field_=field||0;this.dataChannel_=dataChannel||0;this.name_='CC'+((this.field_<<1|this.dataChannel_)+1);this.setConstants();this.reset();this.push=function(packet){var data,swap,char0,char1,text;data=packet.ccData&0x7f7f;if(data===this.lastControlCode_){this.lastControlCode_=null;return}
if((data&0xf000)===0x1000){this.lastControlCode_=data}else if(data!==this.PADDING_){this.lastControlCode_=null}
char0=data>>>8;char1=data&0xff;if(data===this.PADDING_){return}else if(data===this.RESUME_CAPTION_LOADING_){this.mode_='popOn'}else if(data===this.END_OF_CAPTION_){this.mode_='popOn';this.clearFormatting(packet.pts);this.flushDisplayed(packet.pts);swap=this.displayed_;this.displayed_=this.nonDisplayed_;this.nonDisplayed_=swap;this.startPts_=packet.pts}else if(data===this.ROLL_UP_2_ROWS_){this.rollUpRows_=2;this.setRollUp(packet.pts)}else if(data===this.ROLL_UP_3_ROWS_){this.rollUpRows_=3;this.setRollUp(packet.pts)}else if(data===this.ROLL_UP_4_ROWS_){this.rollUpRows_=4;this.setRollUp(packet.pts)}else if(data===this.CARRIAGE_RETURN_){this.clearFormatting(packet.pts);this.flushDisplayed(packet.pts);this.shiftRowsUp_();this.startPts_=packet.pts}else if(data===this.BACKSPACE_){if(this.mode_==='popOn'){this.nonDisplayed_[this.row_]=this.nonDisplayed_[this.row_].slice(0,-1)}else{this.displayed_[this.row_]=this.displayed_[this.row_].slice(0,-1)}}else if(data===this.ERASE_DISPLAYED_MEMORY_){this.flushDisplayed(packet.pts);this.displayed_=createDisplayBuffer()}else if(data===this.ERASE_NON_DISPLAYED_MEMORY_){this.nonDisplayed_=createDisplayBuffer()}else if(data===this.RESUME_DIRECT_CAPTIONING_){if(this.mode_!=='paintOn'){this.flushDisplayed(packet.pts);this.displayed_=createDisplayBuffer()}
this.mode_='paintOn';this.startPts_=packet.pts}else if(this.isSpecialCharacter(char0,char1)){char0=(char0&0x03)<<8;text=getCharFromCode(char0|char1);this[this.mode_](packet.pts,text);this.column_++}else if(this.isExtCharacter(char0,char1)){if(this.mode_==='popOn'){this.nonDisplayed_[this.row_]=this.nonDisplayed_[this.row_].slice(0,-1)}else{this.displayed_[this.row_]=this.displayed_[this.row_].slice(0,-1)}
char0=(char0&0x03)<<8;text=getCharFromCode(char0|char1);this[this.mode_](packet.pts,text);this.column_++}else if(this.isMidRowCode(char0,char1)){this.clearFormatting(packet.pts);this[this.mode_](packet.pts,' ');this.column_++;if((char1&0xe)===0xe){this.addFormatting(packet.pts,['i'])}
if((char1&0x1)===0x1){this.addFormatting(packet.pts,['u'])}}else if(this.isOffsetControlCode(char0,char1)){this.column_+=char1&0x03}else if(this.isPAC(char0,char1)){var row=ROWS.indexOf(data&0x1f20);if(this.mode_==='rollUp'){if(row-this.rollUpRows_+1<0){row=this.rollUpRows_-1}
this.setRollUp(packet.pts,row)}
if(row!==this.row_){this.clearFormatting(packet.pts);this.row_=row}
if(char1&0x1&&this.formatting_.indexOf('u')===-1){this.addFormatting(packet.pts,['u'])}
if((data&0x10)===0x10){this.column_=((data&0xe)>>1)*4}
if(this.isColorPAC(char1)){if((char1&0xe)===0xe){this.addFormatting(packet.pts,['i'])}}}else if(this.isNormalChar(char0)){if(char1===0x00){char1=null}
text=getCharFromCode(char0);text+=getCharFromCode(char1);this[this.mode_](packet.pts,text);this.column_+=text.length}}};Cea608Stream.prototype=new stream();Cea608Stream.prototype.flushDisplayed=function(pts){var content=this.displayed_.map(function(row,index){try{return row.trim()}catch(e){this.trigger('log',{level:'warn',message:'Skipping a malformed 608 caption at index '+index+'.'});return''}},this).join('\n').replace(/^\n+|\n+$/g,'');if(content.length){this.trigger('data',{startPts:this.startPts_,endPts:pts,text:content,stream:this.name_})}};Cea608Stream.prototype.reset=function(){this.mode_='popOn';this.topRow_=0;this.startPts_=0;this.displayed_=createDisplayBuffer();this.nonDisplayed_=createDisplayBuffer();this.lastControlCode_=null;this.column_=0;this.row_=BOTTOM_ROW;this.rollUpRows_=2;this.formatting_=[]};Cea608Stream.prototype.setConstants=function(){if(this.dataChannel_===0){this.BASE_=0x10;this.EXT_=0x11;this.CONTROL_=(0x14|this.field_)<<8;this.OFFSET_=0x17}else if(this.dataChannel_===1){this.BASE_=0x18;this.EXT_=0x19;this.CONTROL_=(0x1c|this.field_)<<8;this.OFFSET_=0x1f}
this.PADDING_=0x0000;this.RESUME_CAPTION_LOADING_=this.CONTROL_|0x20;this.END_OF_CAPTION_=this.CONTROL_|0x2f;this.ROLL_UP_2_ROWS_=this.CONTROL_|0x25;this.ROLL_UP_3_ROWS_=this.CONTROL_|0x26;this.ROLL_UP_4_ROWS_=this.CONTROL_|0x27;this.CARRIAGE_RETURN_=this.CONTROL_|0x2d;this.RESUME_DIRECT_CAPTIONING_=this.CONTROL_|0x29;this.BACKSPACE_=this.CONTROL_|0x21;this.ERASE_DISPLAYED_MEMORY_=this.CONTROL_|0x2c;this.ERASE_NON_DISPLAYED_MEMORY_=this.CONTROL_|0x2e};Cea608Stream.prototype.isSpecialCharacter=function(char0,char1){return char0===this.EXT_&&char1>=0x30&&char1<=0x3f};Cea608Stream.prototype.isExtCharacter=function(char0,char1){return(char0===this.EXT_+1||char0===this.EXT_+2)&&char1>=0x20&&char1<=0x3f};Cea608Stream.prototype.isMidRowCode=function(char0,char1){return char0===this.EXT_&&char1>=0x20&&char1<=0x2f};Cea608Stream.prototype.isOffsetControlCode=function(char0,char1){return char0===this.OFFSET_&&char1>=0x21&&char1<=0x23};Cea608Stream.prototype.isPAC=function(char0,char1){return char0>=this.BASE_&&char0<this.BASE_+8&&char1>=0x40&&char1<=0x7f};Cea608Stream.prototype.isColorPAC=function(char1){return char1>=0x40&&char1<=0x4f||char1>=0x60&&char1<=0x7f};Cea608Stream.prototype.isNormalChar=function(char){return char>=0x20&&char<=0x7f};Cea608Stream.prototype.setRollUp=function(pts,newBaseRow){if(this.mode_!=='rollUp'){this.row_=BOTTOM_ROW;this.mode_='rollUp';this.flushDisplayed(pts);this.nonDisplayed_=createDisplayBuffer();this.displayed_=createDisplayBuffer()}
if(newBaseRow!==undefined&&newBaseRow!==this.row_){for(var i=0;i<this.rollUpRows_;i++){this.displayed_[newBaseRow-i]=this.displayed_[this.row_-i];this.displayed_[this.row_-i]=''}}
if(newBaseRow===undefined){newBaseRow=this.row_}
this.topRow_=newBaseRow-this.rollUpRows_+1};Cea608Stream.prototype.addFormatting=function(pts,format){this.formatting_=this.formatting_.concat(format);var text=format.reduce(function(text,format){return text+'<'+format+'>'},'');this[this.mode_](pts,text)};Cea608Stream.prototype.clearFormatting=function(pts){if(!this.formatting_.length){return}
var text=this.formatting_.reverse().reduce(function(text,format){return text+'</'+format+'>'},'');this.formatting_=[];this[this.mode_](pts,text)};Cea608Stream.prototype.popOn=function(pts,text){var baseRow=this.nonDisplayed_[this.row_];baseRow+=text;this.nonDisplayed_[this.row_]=baseRow};Cea608Stream.prototype.rollUp=function(pts,text){var baseRow=this.displayed_[this.row_];baseRow+=text;this.displayed_[this.row_]=baseRow};Cea608Stream.prototype.shiftRowsUp_=function(){var i;for(i=0;i<this.topRow_;i++){this.displayed_[i]=''}
for(i=this.row_+1;i<BOTTOM_ROW+1;i++){this.displayed_[i]=''}
for(i=this.topRow_;i<this.row_;i++){this.displayed_[i]=this.displayed_[i+1]}
this.displayed_[this.row_]=''};Cea608Stream.prototype.paintOn=function(pts,text){var baseRow=this.displayed_[this.row_];baseRow+=text;this.displayed_[this.row_]=baseRow};var captionStream={CaptionStream:CaptionStream$1,Cea608Stream:Cea608Stream,Cea708Stream:Cea708Stream};var streamTypes={H264_STREAM_TYPE:0x1B,ADTS_STREAM_TYPE:0x0F,METADATA_STREAM_TYPE:0x15};var MAX_TS=8589934592;var RO_THRESH=4294967296;var TYPE_SHARED='shared';var handleRollover$1=function handleRollover(value,reference){var direction=1;if(value>reference){direction=-1}
while(Math.abs(reference-value)>RO_THRESH){value+=direction*MAX_TS}
return value};var TimestampRolloverStream$1=function TimestampRolloverStream(type){var lastDTS,referenceDTS;TimestampRolloverStream.prototype.init.call(this);this.type_=type||TYPE_SHARED;this.push=function(data){if(this.type_!==TYPE_SHARED&&data.type!==this.type_){return}
if(referenceDTS===undefined){referenceDTS=data.dts}
data.dts=handleRollover$1(data.dts,referenceDTS);data.pts=handleRollover$1(data.pts,referenceDTS);lastDTS=data.dts;this.trigger('data',data)};this.flush=function(){referenceDTS=lastDTS;this.trigger('done')};this.endTimeline=function(){this.flush();this.trigger('endedtimeline')};this.discontinuity=function(){referenceDTS=void 0;lastDTS=void 0};this.reset=function(){this.discontinuity();this.trigger('reset')}};TimestampRolloverStream$1.prototype=new stream();var timestampRolloverStream={TimestampRolloverStream:TimestampRolloverStream$1,handleRollover:handleRollover$1};var percentEncode$1=function percentEncode(bytes,start,end){var i,result='';for(i=start;i<end;i++){result+='%'+('00'+bytes[i].toString(16)).slice(-2)}
return result},parseUtf8=function parseUtf8(bytes,start,end){return decodeURIComponent(percentEncode$1(bytes,start,end))},parseIso88591$1=function parseIso88591(bytes,start,end){return unescape(percentEncode$1(bytes,start,end))},parseSyncSafeInteger$1=function parseSyncSafeInteger(data){return data[0]<<21|data[1]<<14|data[2]<<7|data[3]},tagParsers={TXXX:function TXXX(tag){var i;if(tag.data[0]!==3){return}
for(i=1;i<tag.data.length;i++){if(tag.data[i]===0){tag.description=parseUtf8(tag.data,1,i);tag.value=parseUtf8(tag.data,i+1,tag.data.length).replace(/\0*$/,'');break}}
tag.data=tag.value},WXXX:function WXXX(tag){var i;if(tag.data[0]!==3){return}
for(i=1;i<tag.data.length;i++){if(tag.data[i]===0){tag.description=parseUtf8(tag.data,1,i);tag.url=parseUtf8(tag.data,i+1,tag.data.length);break}}},PRIV:function PRIV(tag){var i;for(i=0;i<tag.data.length;i++){if(tag.data[i]===0){tag.owner=parseIso88591$1(tag.data,0,i);break}}
tag.privateData=tag.data.subarray(i+1);tag.data=tag.privateData}},_MetadataStream;_MetadataStream=function MetadataStream(options){var settings={descriptor:options&&options.descriptor},tagSize=0,buffer=[],bufferSize=0,i;_MetadataStream.prototype.init.call(this);this.dispatchType=streamTypes.METADATA_STREAM_TYPE.toString(16);if(settings.descriptor){for(i=0;i<settings.descriptor.length;i++){this.dispatchType+=('00'+settings.descriptor[i].toString(16)).slice(-2)}}
this.push=function(chunk){var tag,frameStart,frameSize,frame,i,frameHeader;if(chunk.type!=='timed-metadata'){return}
if(chunk.dataAlignmentIndicator){bufferSize=0;buffer.length=0}
if(buffer.length===0&&(chunk.data.length<10||chunk.data[0]!=='I'.charCodeAt(0)||chunk.data[1]!=='D'.charCodeAt(0)||chunk.data[2]!=='3'.charCodeAt(0))){this.trigger('log',{level:'warn',message:'Skipping unrecognized metadata packet'});return}
buffer.push(chunk);bufferSize+=chunk.data.byteLength;if(buffer.length===1){tagSize=parseSyncSafeInteger$1(chunk.data.subarray(6,10));tagSize+=10}
if(bufferSize<tagSize){return}
tag={data:new Uint8Array(tagSize),frames:[],pts:buffer[0].pts,dts:buffer[0].dts};for(i=0;i<tagSize;){tag.data.set(buffer[0].data.subarray(0,tagSize-i),i);i+=buffer[0].data.byteLength;bufferSize-=buffer[0].data.byteLength;buffer.shift()}
frameStart=10;if(tag.data[5]&0x40){frameStart+=4;frameStart+=parseSyncSafeInteger$1(tag.data.subarray(10,14));tagSize-=parseSyncSafeInteger$1(tag.data.subarray(16,20))}
do{frameSize=parseSyncSafeInteger$1(tag.data.subarray(frameStart+4,frameStart+8));if(frameSize<1){this.trigger('log',{level:'warn',message:'Malformed ID3 frame encountered. Skipping metadata parsing.'});return}
frameHeader=String.fromCharCode(tag.data[frameStart],tag.data[frameStart+1],tag.data[frameStart+2],tag.data[frameStart+3]);frame={id:frameHeader,data:tag.data.subarray(frameStart+10,frameStart+frameSize+10)};frame.key=frame.id;if(tagParsers[frame.id]){tagParsers[frame.id](frame);if(frame.owner==='com.apple.streaming.transportStreamTimestamp'){var d=frame.data,size=(d[3]&0x01)<<30|d[4]<<22|d[5]<<14|d[6]<<6|d[7]>>>2;size*=4;size+=d[7]&0x03;frame.timeStamp=size;if(tag.pts===undefined&&tag.dts===undefined){tag.pts=frame.timeStamp;tag.dts=frame.timeStamp}
this.trigger('timestamp',frame)}}
tag.frames.push(frame);frameStart+=10;frameStart+=frameSize}while(frameStart<tagSize);this.trigger('data',tag)}};_MetadataStream.prototype=new stream();var metadataStream=_MetadataStream;var TimestampRolloverStream=timestampRolloverStream.TimestampRolloverStream;var _TransportPacketStream,_TransportParseStream,_ElementaryStream;var MP2T_PACKET_LENGTH$1=188,SYNC_BYTE$1=0x47;_TransportPacketStream=function TransportPacketStream(){var buffer=new Uint8Array(MP2T_PACKET_LENGTH$1),bytesInBuffer=0;_TransportPacketStream.prototype.init.call(this);this.push=function(bytes){var startIndex=0,endIndex=MP2T_PACKET_LENGTH$1,everything;if(bytesInBuffer){everything=new Uint8Array(bytes.byteLength+bytesInBuffer);everything.set(buffer.subarray(0,bytesInBuffer));everything.set(bytes,bytesInBuffer);bytesInBuffer=0}else{everything=bytes}
while(endIndex<everything.byteLength){if(everything[startIndex]===SYNC_BYTE$1&&everything[endIndex]===SYNC_BYTE$1){this.trigger('data',everything.subarray(startIndex,endIndex));startIndex+=MP2T_PACKET_LENGTH$1;endIndex+=MP2T_PACKET_LENGTH$1;continue}
startIndex++;endIndex++}
if(startIndex<everything.byteLength){buffer.set(everything.subarray(startIndex),0);bytesInBuffer=everything.byteLength-startIndex}};this.flush=function(){if(bytesInBuffer===MP2T_PACKET_LENGTH$1&&buffer[0]===SYNC_BYTE$1){this.trigger('data',buffer);bytesInBuffer=0}
this.trigger('done')};this.endTimeline=function(){this.flush();this.trigger('endedtimeline')};this.reset=function(){bytesInBuffer=0;this.trigger('reset')}};_TransportPacketStream.prototype=new stream();_TransportParseStream=function TransportParseStream(){var parsePsi,parsePat,parsePmt,self;_TransportParseStream.prototype.init.call(this);self=this;this.packetsWaitingForPmt=[];this.programMapTable=undefined;parsePsi=function parsePsi(payload,psi){var offset=0;if(psi.payloadUnitStartIndicator){offset+=payload[offset]+1}
if(psi.type==='pat'){parsePat(payload.subarray(offset),psi)}else{parsePmt(payload.subarray(offset),psi)}};parsePat=function parsePat(payload,pat){pat.section_number=payload[7];pat.last_section_number=payload[8];self.pmtPid=(payload[10]&0x1F)<<8|payload[11];pat.pmtPid=self.pmtPid};parsePmt=function parsePmt(payload,pmt){var sectionLength,tableEnd,programInfoLength,offset;if(!(payload[5]&0x01)){return}
self.programMapTable={video:null,audio:null,'timed-metadata':{}};sectionLength=(payload[1]&0x0f)<<8|payload[2];tableEnd=3+sectionLength-4;programInfoLength=(payload[10]&0x0f)<<8|payload[11];offset=12+programInfoLength;while(offset<tableEnd){var streamType=payload[offset];var pid=(payload[offset+1]&0x1F)<<8|payload[offset+2];if(streamType===streamTypes.H264_STREAM_TYPE&&self.programMapTable.video===null){self.programMapTable.video=pid}else if(streamType===streamTypes.ADTS_STREAM_TYPE&&self.programMapTable.audio===null){self.programMapTable.audio=pid}else if(streamType===streamTypes.METADATA_STREAM_TYPE){self.programMapTable['timed-metadata'][pid]=streamType}
offset+=((payload[offset+3]&0x0F)<<8|payload[offset+4])+5}
pmt.programMapTable=self.programMapTable};this.push=function(packet){var result={},offset=4;result.payloadUnitStartIndicator=!!(packet[1]&0x40);result.pid=packet[1]&0x1f;result.pid<<=8;result.pid|=packet[2];if((packet[3]&0x30)>>>4>0x01){offset+=packet[offset]+1}
if(result.pid===0){result.type='pat';parsePsi(packet.subarray(offset),result);this.trigger('data',result)}else if(result.pid===this.pmtPid){result.type='pmt';parsePsi(packet.subarray(offset),result);this.trigger('data',result);while(this.packetsWaitingForPmt.length){this.processPes_.apply(this,this.packetsWaitingForPmt.shift())}}else if(this.programMapTable===undefined){this.packetsWaitingForPmt.push([packet,offset,result])}else{this.processPes_(packet,offset,result)}};this.processPes_=function(packet,offset,result){if(result.pid===this.programMapTable.video){result.streamType=streamTypes.H264_STREAM_TYPE}else if(result.pid===this.programMapTable.audio){result.streamType=streamTypes.ADTS_STREAM_TYPE}else{result.streamType=this.programMapTable['timed-metadata'][result.pid]}
result.type='pes';result.data=packet.subarray(offset);this.trigger('data',result)}};_TransportParseStream.prototype=new stream();_TransportParseStream.STREAM_TYPES={h264:0x1b,adts:0x0f};_ElementaryStream=function ElementaryStream(){var self=this,segmentHadPmt=!1,video={data:[],size:0},audio={data:[],size:0},timedMetadata={data:[],size:0},programMapTable,parsePes=function parsePes(payload,pes){var ptsDtsFlags;var startPrefix=payload[0]<<16|payload[1]<<8|payload[2];pes.data=new Uint8Array();if(startPrefix!==1){return}
pes.packetLength=6+(payload[4]<<8|payload[5]);pes.dataAlignmentIndicator=(payload[6]&0x04)!==0;ptsDtsFlags=payload[7];if(ptsDtsFlags&0xC0){pes.pts=(payload[9]&0x0E)<<27|(payload[10]&0xFF)<<20|(payload[11]&0xFE)<<12|(payload[12]&0xFF)<<5|(payload[13]&0xFE)>>>3;pes.pts*=4;pes.pts+=(payload[13]&0x06)>>>1;pes.dts=pes.pts;if(ptsDtsFlags&0x40){pes.dts=(payload[14]&0x0E)<<27|(payload[15]&0xFF)<<20|(payload[16]&0xFE)<<12|(payload[17]&0xFF)<<5|(payload[18]&0xFE)>>>3;pes.dts*=4;pes.dts+=(payload[18]&0x06)>>>1}}
pes.data=payload.subarray(9+payload[8])},flushStream=function flushStream(stream,type,forceFlush){var packetData=new Uint8Array(stream.size),event={type:type},i=0,offset=0,packetFlushable=!1,fragment;if(!stream.data.length||stream.size<9){return}
event.trackId=stream.data[0].pid;for(i=0;i<stream.data.length;i++){fragment=stream.data[i];packetData.set(fragment.data,offset);offset+=fragment.data.byteLength}
parsePes(packetData,event);packetFlushable=type==='video'||event.packetLength<=stream.size;if(forceFlush||packetFlushable){stream.size=0;stream.data.length=0}
if(packetFlushable){self.trigger('data',event)}};_ElementaryStream.prototype.init.call(this);this.push=function(data){({pat:function pat(){},pes:function pes(){var stream,streamType;switch(data.streamType){case streamTypes.H264_STREAM_TYPE:stream=video;streamType='video';break;case streamTypes.ADTS_STREAM_TYPE:stream=audio;streamType='audio';break;case streamTypes.METADATA_STREAM_TYPE:stream=timedMetadata;streamType='timed-metadata';break;default:return}
if(data.payloadUnitStartIndicator){flushStream(stream,streamType,!0)}
stream.data.push(data);stream.size+=data.data.byteLength},pmt:function pmt(){var event={type:'metadata',tracks:[]};programMapTable=data.programMapTable;if(programMapTable.video!==null){event.tracks.push({timelineStartInfo:{baseMediaDecodeTime:0},id:+programMapTable.video,codec:'avc',type:'video'})}
if(programMapTable.audio!==null){event.tracks.push({timelineStartInfo:{baseMediaDecodeTime:0},id:+programMapTable.audio,codec:'adts',type:'audio'})}
segmentHadPmt=!0;self.trigger('data',event)}})[data.type]()};this.reset=function(){video.size=0;video.data.length=0;audio.size=0;audio.data.length=0;this.trigger('reset')};this.flushStreams_=function(){flushStream(video,'video');flushStream(audio,'audio');flushStream(timedMetadata,'timed-metadata')};this.flush=function(){if(!segmentHadPmt&&programMapTable){var pmt={type:'metadata',tracks:[]};if(programMapTable.video!==null){pmt.tracks.push({timelineStartInfo:{baseMediaDecodeTime:0},id:+programMapTable.video,codec:'avc',type:'video'})}
if(programMapTable.audio!==null){pmt.tracks.push({timelineStartInfo:{baseMediaDecodeTime:0},id:+programMapTable.audio,codec:'adts',type:'audio'})}
self.trigger('data',pmt)}
segmentHadPmt=!1;this.flushStreams_();this.trigger('done')}};_ElementaryStream.prototype=new stream();var m2ts={PAT_PID:0x0000,MP2T_PACKET_LENGTH:MP2T_PACKET_LENGTH$1,TransportPacketStream:_TransportPacketStream,TransportParseStream:_TransportParseStream,ElementaryStream:_ElementaryStream,TimestampRolloverStream:TimestampRolloverStream,CaptionStream:captionStream.CaptionStream,Cea608Stream:captionStream.Cea608Stream,Cea708Stream:captionStream.Cea708Stream,MetadataStream:metadataStream};for(var type in streamTypes){if(streamTypes.hasOwnProperty(type)){m2ts[type]=streamTypes[type]}}
var m2ts_1=m2ts;var ONE_SECOND_IN_TS$2=clock.ONE_SECOND_IN_TS;var _AdtsStream;var ADTS_SAMPLING_FREQUENCIES$1=[96000,88200,64000,48000,44100,32000,24000,22050,16000,12000,11025,8000,7350];_AdtsStream=function AdtsStream(handlePartialSegments){var buffer,frameNum=0;_AdtsStream.prototype.init.call(this);this.skipWarn_=function(start,end){this.trigger('log',{level:'warn',message:"adts skiping bytes "+start+" to "+end+" in frame "+frameNum+" outside syncword"})};this.push=function(packet){var i=0,frameLength,protectionSkipBytes,oldBuffer,sampleCount,adtsFrameDuration;if(!handlePartialSegments){frameNum=0}
if(packet.type!=='audio'){return}
if(buffer&&buffer.length){oldBuffer=buffer;buffer=new Uint8Array(oldBuffer.byteLength+packet.data.byteLength);buffer.set(oldBuffer);buffer.set(packet.data,oldBuffer.byteLength)}else{buffer=packet.data}
var skip;while(i+7<buffer.length){if(buffer[i]!==0xFF||(buffer[i+1]&0xF6)!==0xF0){if(typeof skip!=='number'){skip=i}
i++;continue}
if(typeof skip==='number'){this.skipWarn_(skip,i);skip=null}
protectionSkipBytes=(~buffer[i+1]&0x01)*2;frameLength=(buffer[i+3]&0x03)<<11|buffer[i+4]<<3|(buffer[i+5]&0xe0)>>5;sampleCount=((buffer[i+6]&0x03)+1)*1024;adtsFrameDuration=sampleCount*ONE_SECOND_IN_TS$2/ADTS_SAMPLING_FREQUENCIES$1[(buffer[i+2]&0x3c)>>>2];if(buffer.byteLength-i<frameLength){break}
this.trigger('data',{pts:packet.pts+frameNum*adtsFrameDuration,dts:packet.dts+frameNum*adtsFrameDuration,sampleCount:sampleCount,audioobjecttype:(buffer[i+2]>>>6&0x03)+1,channelcount:(buffer[i+2]&1)<<2|(buffer[i+3]&0xc0)>>>6,samplerate:ADTS_SAMPLING_FREQUENCIES$1[(buffer[i+2]&0x3c)>>>2],samplingfrequencyindex:(buffer[i+2]&0x3c)>>>2,samplesize:16,data:buffer.subarray(i+7+protectionSkipBytes,i+frameLength)});frameNum++;i+=frameLength}
if(typeof skip==='number'){this.skipWarn_(skip,i);skip=null}
buffer=buffer.subarray(i)};this.flush=function(){frameNum=0;this.trigger('done')};this.reset=function(){buffer=void 0;this.trigger('reset')};this.endTimeline=function(){buffer=void 0;this.trigger('endedtimeline')}};_AdtsStream.prototype=new stream();var adts=_AdtsStream;var ExpGolomb;ExpGolomb=function ExpGolomb(workingData){var
workingBytesAvailable=workingData.byteLength,workingWord=0,workingBitsAvailable=0;this.length=function(){return 8*workingBytesAvailable};this.bitsAvailable=function(){return 8*workingBytesAvailable+workingBitsAvailable};this.loadWord=function(){var position=workingData.byteLength-workingBytesAvailable,workingBytes=new Uint8Array(4),availableBytes=Math.min(4,workingBytesAvailable);if(availableBytes===0){throw new Error('no bytes available')}
workingBytes.set(workingData.subarray(position,position+availableBytes));workingWord=new DataView(workingBytes.buffer).getUint32(0);workingBitsAvailable=availableBytes*8;workingBytesAvailable-=availableBytes};this.skipBits=function(count){var skipBytes;if(workingBitsAvailable>count){workingWord<<=count;workingBitsAvailable-=count}else{count-=workingBitsAvailable;skipBytes=Math.floor(count/8);count-=skipBytes*8;workingBytesAvailable-=skipBytes;this.loadWord();workingWord<<=count;workingBitsAvailable-=count}};this.readBits=function(size){var bits=Math.min(workingBitsAvailable,size),valu=workingWord>>>32-bits;workingBitsAvailable-=bits;if(workingBitsAvailable>0){workingWord<<=bits}else if(workingBytesAvailable>0){this.loadWord()}
bits=size-bits;if(bits>0){return valu<<bits|this.readBits(bits)}
return valu};this.skipLeadingZeros=function(){var leadingZeroCount;for(leadingZeroCount=0;leadingZeroCount<workingBitsAvailable;++leadingZeroCount){if((workingWord&0x80000000>>>leadingZeroCount)!==0){workingWord<<=leadingZeroCount;workingBitsAvailable-=leadingZeroCount;return leadingZeroCount}}
this.loadWord();return leadingZeroCount+this.skipLeadingZeros()};this.skipUnsignedExpGolomb=function(){this.skipBits(1+this.skipLeadingZeros())};this.skipExpGolomb=function(){this.skipBits(1+this.skipLeadingZeros())};this.readUnsignedExpGolomb=function(){var clz=this.skipLeadingZeros();return this.readBits(clz+1)-1};this.readExpGolomb=function(){var valu=this.readUnsignedExpGolomb();if(0x01&valu){return 1+valu>>>1}
return-1*(valu>>>1)};this.readBoolean=function(){return this.readBits(1)===1};this.readUnsignedByte=function(){return this.readBits(8)};this.loadWord()};var expGolomb=ExpGolomb;var _H264Stream,_NalByteStream;var PROFILES_WITH_OPTIONAL_SPS_DATA;_NalByteStream=function NalByteStream(){var syncPoint=0,i,buffer;_NalByteStream.prototype.init.call(this);this.push=function(data){var swapBuffer;if(!buffer){buffer=data.data}else{swapBuffer=new Uint8Array(buffer.byteLength+data.data.byteLength);swapBuffer.set(buffer);swapBuffer.set(data.data,buffer.byteLength);buffer=swapBuffer}
var len=buffer.byteLength;for(;syncPoint<len-3;syncPoint++){if(buffer[syncPoint+2]===1){i=syncPoint+5;break}}
while(i<len){switch(buffer[i]){case 0:if(buffer[i-1]!==0){i+=2;break}else if(buffer[i-2]!==0){i++;break}
if(syncPoint+3!==i-2){this.trigger('data',buffer.subarray(syncPoint+3,i-2))}
do{i++}while(buffer[i]!==1&&i<len);syncPoint=i-2;i+=3;break;case 1:if(buffer[i-1]!==0||buffer[i-2]!==0){i+=3;break}
this.trigger('data',buffer.subarray(syncPoint+3,i-2));syncPoint=i-2;i+=3;break;default:i+=3;break}}
buffer=buffer.subarray(syncPoint);i-=syncPoint;syncPoint=0};this.reset=function(){buffer=null;syncPoint=0;this.trigger('reset')};this.flush=function(){if(buffer&&buffer.byteLength>3){this.trigger('data',buffer.subarray(syncPoint+3))}
buffer=null;syncPoint=0;this.trigger('done')};this.endTimeline=function(){this.flush();this.trigger('endedtimeline')}};_NalByteStream.prototype=new stream();PROFILES_WITH_OPTIONAL_SPS_DATA={100:!0,110:!0,122:!0,244:!0,44:!0,83:!0,86:!0,118:!0,128:!0,138:!0,139:!0,134:!0};_H264Stream=function H264Stream(){var nalByteStream=new _NalByteStream(),self,trackId,currentPts,currentDts,discardEmulationPreventionBytes,readSequenceParameterSet,skipScalingList;_H264Stream.prototype.init.call(this);self=this;this.push=function(packet){if(packet.type!=='video'){return}
trackId=packet.trackId;currentPts=packet.pts;currentDts=packet.dts;nalByteStream.push(packet)};nalByteStream.on('data',function(data){var event={trackId:trackId,pts:currentPts,dts:currentDts,data:data,nalUnitTypeCode:data[0]&0x1f};switch(event.nalUnitTypeCode){case 0x05:event.nalUnitType='slice_layer_without_partitioning_rbsp_idr';break;case 0x06:event.nalUnitType='sei_rbsp';event.escapedRBSP=discardEmulationPreventionBytes(data.subarray(1));break;case 0x07:event.nalUnitType='seq_parameter_set_rbsp';event.escapedRBSP=discardEmulationPreventionBytes(data.subarray(1));event.config=readSequenceParameterSet(event.escapedRBSP);break;case 0x08:event.nalUnitType='pic_parameter_set_rbsp';break;case 0x09:event.nalUnitType='access_unit_delimiter_rbsp';break}
self.trigger('data',event)});nalByteStream.on('done',function(){self.trigger('done')});nalByteStream.on('partialdone',function(){self.trigger('partialdone')});nalByteStream.on('reset',function(){self.trigger('reset')});nalByteStream.on('endedtimeline',function(){self.trigger('endedtimeline')});this.flush=function(){nalByteStream.flush()};this.partialFlush=function(){nalByteStream.partialFlush()};this.reset=function(){nalByteStream.reset()};this.endTimeline=function(){nalByteStream.endTimeline()};skipScalingList=function skipScalingList(count,expGolombDecoder){var lastScale=8,nextScale=8,j,deltaScale;for(j=0;j<count;j++){if(nextScale!==0){deltaScale=expGolombDecoder.readExpGolomb();nextScale=(lastScale+deltaScale+256)%256}
lastScale=nextScale===0?lastScale:nextScale}};discardEmulationPreventionBytes=function discardEmulationPreventionBytes(data){var length=data.byteLength,emulationPreventionBytesPositions=[],i=1,newLength,newData;while(i<length-2){if(data[i]===0&&data[i+1]===0&&data[i+2]===0x03){emulationPreventionBytesPositions.push(i+2);i+=2}else{i++}}
if(emulationPreventionBytesPositions.length===0){return data}
newLength=length-emulationPreventionBytesPositions.length;newData=new Uint8Array(newLength);var sourceIndex=0;for(i=0;i<newLength;sourceIndex++,i++){if(sourceIndex===emulationPreventionBytesPositions[0]){sourceIndex++;emulationPreventionBytesPositions.shift()}
newData[i]=data[sourceIndex]}
return newData};readSequenceParameterSet=function readSequenceParameterSet(data){var frameCropLeftOffset=0,frameCropRightOffset=0,frameCropTopOffset=0,frameCropBottomOffset=0,expGolombDecoder,profileIdc,levelIdc,profileCompatibility,chromaFormatIdc,picOrderCntType,numRefFramesInPicOrderCntCycle,picWidthInMbsMinus1,picHeightInMapUnitsMinus1,frameMbsOnlyFlag,scalingListCount,sarRatio=[1,1],aspectRatioIdc,i;expGolombDecoder=new expGolomb(data);profileIdc=expGolombDecoder.readUnsignedByte();profileCompatibility=expGolombDecoder.readUnsignedByte();levelIdc=expGolombDecoder.readUnsignedByte();expGolombDecoder.skipUnsignedExpGolomb();if(PROFILES_WITH_OPTIONAL_SPS_DATA[profileIdc]){chromaFormatIdc=expGolombDecoder.readUnsignedExpGolomb();if(chromaFormatIdc===3){expGolombDecoder.skipBits(1)}
expGolombDecoder.skipUnsignedExpGolomb();expGolombDecoder.skipUnsignedExpGolomb();expGolombDecoder.skipBits(1);if(expGolombDecoder.readBoolean()){scalingListCount=chromaFormatIdc!==3?8:12;for(i=0;i<scalingListCount;i++){if(expGolombDecoder.readBoolean()){if(i<6){skipScalingList(16,expGolombDecoder)}else{skipScalingList(64,expGolombDecoder)}}}}}
expGolombDecoder.skipUnsignedExpGolomb();picOrderCntType=expGolombDecoder.readUnsignedExpGolomb();if(picOrderCntType===0){expGolombDecoder.readUnsignedExpGolomb()}else if(picOrderCntType===1){expGolombDecoder.skipBits(1);expGolombDecoder.skipExpGolomb();expGolombDecoder.skipExpGolomb();numRefFramesInPicOrderCntCycle=expGolombDecoder.readUnsignedExpGolomb();for(i=0;i<numRefFramesInPicOrderCntCycle;i++){expGolombDecoder.skipExpGolomb()}}
expGolombDecoder.skipUnsignedExpGolomb();expGolombDecoder.skipBits(1);picWidthInMbsMinus1=expGolombDecoder.readUnsignedExpGolomb();picHeightInMapUnitsMinus1=expGolombDecoder.readUnsignedExpGolomb();frameMbsOnlyFlag=expGolombDecoder.readBits(1);if(frameMbsOnlyFlag===0){expGolombDecoder.skipBits(1)}
expGolombDecoder.skipBits(1);if(expGolombDecoder.readBoolean()){frameCropLeftOffset=expGolombDecoder.readUnsignedExpGolomb();frameCropRightOffset=expGolombDecoder.readUnsignedExpGolomb();frameCropTopOffset=expGolombDecoder.readUnsignedExpGolomb();frameCropBottomOffset=expGolombDecoder.readUnsignedExpGolomb()}
if(expGolombDecoder.readBoolean()){if(expGolombDecoder.readBoolean()){aspectRatioIdc=expGolombDecoder.readUnsignedByte();switch(aspectRatioIdc){case 1:sarRatio=[1,1];break;case 2:sarRatio=[12,11];break;case 3:sarRatio=[10,11];break;case 4:sarRatio=[16,11];break;case 5:sarRatio=[40,33];break;case 6:sarRatio=[24,11];break;case 7:sarRatio=[20,11];break;case 8:sarRatio=[32,11];break;case 9:sarRatio=[80,33];break;case 10:sarRatio=[18,11];break;case 11:sarRatio=[15,11];break;case 12:sarRatio=[64,33];break;case 13:sarRatio=[160,99];break;case 14:sarRatio=[4,3];break;case 15:sarRatio=[3,2];break;case 16:sarRatio=[2,1];break;case 255:{sarRatio=[expGolombDecoder.readUnsignedByte()<<8|expGolombDecoder.readUnsignedByte(),expGolombDecoder.readUnsignedByte()<<8|expGolombDecoder.readUnsignedByte()];break}}
if(sarRatio){sarRatio[0]/sarRatio[1]}}}
return{profileIdc:profileIdc,levelIdc:levelIdc,profileCompatibility:profileCompatibility,width:(picWidthInMbsMinus1+1)*16-frameCropLeftOffset*2-frameCropRightOffset*2,height:(2-frameMbsOnlyFlag)*(picHeightInMapUnitsMinus1+1)*16-frameCropTopOffset*2-frameCropBottomOffset*2,sarRatio:sarRatio}}};_H264Stream.prototype=new stream();var h264={H264Stream:_H264Stream,NalByteStream:_NalByteStream};var ADTS_SAMPLING_FREQUENCIES=[96000,88200,64000,48000,44100,32000,24000,22050,16000,12000,11025,8000,7350];var parseId3TagSize=function parseId3TagSize(header,byteIndex){var returnSize=header[byteIndex+6]<<21|header[byteIndex+7]<<14|header[byteIndex+8]<<7|header[byteIndex+9],flags=header[byteIndex+5],footerPresent=(flags&16)>>4;returnSize=returnSize>=0?returnSize:0;if(footerPresent){return returnSize+20}
return returnSize+10};var getId3Offset=function getId3Offset(data,offset){if(data.length-offset<10||data[offset]!=='I'.charCodeAt(0)||data[offset+1]!=='D'.charCodeAt(0)||data[offset+2]!=='3'.charCodeAt(0)){return offset}
offset+=parseId3TagSize(data,offset);return getId3Offset(data,offset)};var isLikelyAacData$1=function isLikelyAacData(data){var offset=getId3Offset(data,0);return data.length>=offset+2&&(data[offset]&0xFF)===0xFF&&(data[offset+1]&0xF0)===0xF0&&(data[offset+1]&0x16)===0x10};var parseSyncSafeInteger=function parseSyncSafeInteger(data){return data[0]<<21|data[1]<<14|data[2]<<7|data[3]};var percentEncode=function percentEncode(bytes,start,end){var i,result='';for(i=start;i<end;i++){result+='%'+('00'+bytes[i].toString(16)).slice(-2)}
return result};var parseIso88591=function parseIso88591(bytes,start,end){return unescape(percentEncode(bytes,start,end))};var parseAdtsSize=function parseAdtsSize(header,byteIndex){var lowThree=(header[byteIndex+5]&0xE0)>>5,middle=header[byteIndex+4]<<3,highTwo=header[byteIndex+3]&0x3<<11;return highTwo|middle|lowThree};var parseType$2=function parseType(header,byteIndex){if(header[byteIndex]==='I'.charCodeAt(0)&&header[byteIndex+1]==='D'.charCodeAt(0)&&header[byteIndex+2]==='3'.charCodeAt(0)){return'timed-metadata'}else if(header[byteIndex]&0xff===0xff&&(header[byteIndex+1]&0xf0)===0xf0){return'audio'}
return null};var parseSampleRate=function parseSampleRate(packet){var i=0;while(i+5<packet.length){if(packet[i]!==0xFF||(packet[i+1]&0xF6)!==0xF0){i++;continue}
return ADTS_SAMPLING_FREQUENCIES[(packet[i+2]&0x3c)>>>2]}
return null};var parseAacTimestamp=function parseAacTimestamp(packet){var frameStart,frameSize,frame,frameHeader;frameStart=10;if(packet[5]&0x40){frameStart+=4;frameStart+=parseSyncSafeInteger(packet.subarray(10,14))}
do{frameSize=parseSyncSafeInteger(packet.subarray(frameStart+4,frameStart+8));if(frameSize<1){return null}
frameHeader=String.fromCharCode(packet[frameStart],packet[frameStart+1],packet[frameStart+2],packet[frameStart+3]);if(frameHeader==='PRIV'){frame=packet.subarray(frameStart+10,frameStart+frameSize+10);for(var i=0;i<frame.byteLength;i++){if(frame[i]===0){var owner=parseIso88591(frame,0,i);if(owner==='com.apple.streaming.transportStreamTimestamp'){var d=frame.subarray(i+1);var size=(d[3]&0x01)<<30|d[4]<<22|d[5]<<14|d[6]<<6|d[7]>>>2;size*=4;size+=d[7]&0x03;return size}
break}}}
frameStart+=10;frameStart+=frameSize}while(frameStart<packet.byteLength);return null};var utils={isLikelyAacData:isLikelyAacData$1,parseId3TagSize:parseId3TagSize,parseAdtsSize:parseAdtsSize,parseType:parseType$2,parseSampleRate:parseSampleRate,parseAacTimestamp:parseAacTimestamp};var _AacStream;_AacStream=function AacStream(){var everything=new Uint8Array(),timeStamp=0;_AacStream.prototype.init.call(this);this.setTimestamp=function(timestamp){timeStamp=timestamp};this.push=function(bytes){var frameSize=0,byteIndex=0,bytesLeft,chunk,packet,tempLength;if(everything.length){tempLength=everything.length;everything=new Uint8Array(bytes.byteLength+tempLength);everything.set(everything.subarray(0,tempLength));everything.set(bytes,tempLength)}else{everything=bytes}
while(everything.length-byteIndex>=3){if(everything[byteIndex]==='I'.charCodeAt(0)&&everything[byteIndex+1]==='D'.charCodeAt(0)&&everything[byteIndex+2]==='3'.charCodeAt(0)){if(everything.length-byteIndex<10){break}
frameSize=utils.parseId3TagSize(everything,byteIndex);if(byteIndex+frameSize>everything.length){break}
chunk={type:'timed-metadata',data:everything.subarray(byteIndex,byteIndex+frameSize)};this.trigger('data',chunk);byteIndex+=frameSize;continue}else if((everything[byteIndex]&0xff)===0xff&&(everything[byteIndex+1]&0xf0)===0xf0){if(everything.length-byteIndex<7){break}
frameSize=utils.parseAdtsSize(everything,byteIndex);if(byteIndex+frameSize>everything.length){break}
packet={type:'audio',data:everything.subarray(byteIndex,byteIndex+frameSize),pts:timeStamp,dts:timeStamp};this.trigger('data',packet);byteIndex+=frameSize;continue}
byteIndex++}
bytesLeft=everything.length-byteIndex;if(bytesLeft>0){everything=everything.subarray(byteIndex)}else{everything=new Uint8Array()}};this.reset=function(){everything=new Uint8Array();this.trigger('reset')};this.endTimeline=function(){everything=new Uint8Array();this.trigger('endedtimeline')}};_AacStream.prototype=new stream();var aac=_AacStream;var AUDIO_PROPERTIES=['audioobjecttype','channelcount','samplerate','samplingfrequencyindex','samplesize'];var audioProperties=AUDIO_PROPERTIES;var VIDEO_PROPERTIES=['width','height','profileIdc','levelIdc','profileCompatibility','sarRatio'];var videoProperties=VIDEO_PROPERTIES;var H264Stream=h264.H264Stream;var isLikelyAacData=utils.isLikelyAacData;var ONE_SECOND_IN_TS$1=clock.ONE_SECOND_IN_TS;var _VideoSegmentStream,_AudioSegmentStream,_Transmuxer,_CoalesceStream;var retriggerForStream=function retriggerForStream(key,event){event.stream=key;this.trigger('log',event)};var addPipelineLogRetriggers=function addPipelineLogRetriggers(transmuxer,pipeline){var keys=Object.keys(pipeline);for(var i=0;i<keys.length;i++){var key=keys[i];if(key==='headOfPipeline'||!pipeline[key].on){continue}
pipeline[key].on('log',retriggerForStream.bind(transmuxer,key))}};var arrayEquals=function arrayEquals(a,b){var i;if(a.length!==b.length){return!1}
for(i=0;i<a.length;i++){if(a[i]!==b[i]){return!1}}
return!0};var generateSegmentTimingInfo=function generateSegmentTimingInfo(baseMediaDecodeTime,startDts,startPts,endDts,endPts,prependedContentDuration){var ptsOffsetFromDts=startPts-startDts,decodeDuration=endDts-startDts,presentationDuration=endPts-startPts;return{start:{dts:baseMediaDecodeTime,pts:baseMediaDecodeTime+ptsOffsetFromDts},end:{dts:baseMediaDecodeTime+decodeDuration,pts:baseMediaDecodeTime+presentationDuration},prependedContentDuration:prependedContentDuration,baseMediaDecodeTime:baseMediaDecodeTime}};_AudioSegmentStream=function AudioSegmentStream(track,options){var adtsFrames=[],sequenceNumber,earliestAllowedDts=0,audioAppendStartTs=0,videoBaseMediaDecodeTime=Infinity;options=options||{};sequenceNumber=options.firstSequenceNumber||0;_AudioSegmentStream.prototype.init.call(this);this.push=function(data){trackDecodeInfo.collectDtsInfo(track,data);if(track){audioProperties.forEach(function(prop){track[prop]=data[prop]})}
adtsFrames.push(data)};this.setEarliestDts=function(earliestDts){earliestAllowedDts=earliestDts};this.setVideoBaseMediaDecodeTime=function(baseMediaDecodeTime){videoBaseMediaDecodeTime=baseMediaDecodeTime};this.setAudioAppendStart=function(timestamp){audioAppendStartTs=timestamp};this.flush=function(){var frames,moof,mdat,boxes,frameDuration,segmentDuration,videoClockCyclesOfSilencePrefixed;if(adtsFrames.length===0){this.trigger('done','AudioSegmentStream');return}
frames=audioFrameUtils.trimAdtsFramesByEarliestDts(adtsFrames,track,earliestAllowedDts);track.baseMediaDecodeTime=trackDecodeInfo.calculateTrackBaseMediaDecodeTime(track,options.keepOriginalTimestamps);videoClockCyclesOfSilencePrefixed=audioFrameUtils.prefixWithSilence(track,frames,audioAppendStartTs,videoBaseMediaDecodeTime);track.samples=audioFrameUtils.generateSampleTable(frames);mdat=mp4Generator.mdat(audioFrameUtils.concatenateFrameData(frames));adtsFrames=[];moof=mp4Generator.moof(sequenceNumber,[track]);boxes=new Uint8Array(moof.byteLength+mdat.byteLength);sequenceNumber++;boxes.set(moof);boxes.set(mdat,moof.byteLength);trackDecodeInfo.clearDtsInfo(track);frameDuration=Math.ceil(ONE_SECOND_IN_TS$1*1024/track.samplerate);if(frames.length){segmentDuration=frames.length*frameDuration;this.trigger('segmentTimingInfo',generateSegmentTimingInfo(clock.audioTsToVideoTs(track.baseMediaDecodeTime,track.samplerate),frames[0].dts,frames[0].pts,frames[0].dts+segmentDuration,frames[0].pts+segmentDuration,videoClockCyclesOfSilencePrefixed||0));this.trigger('timingInfo',{start:frames[0].pts,end:frames[0].pts+segmentDuration})}
this.trigger('data',{track:track,boxes:boxes});this.trigger('done','AudioSegmentStream')};this.reset=function(){trackDecodeInfo.clearDtsInfo(track);adtsFrames=[];this.trigger('reset')}};_AudioSegmentStream.prototype=new stream();_VideoSegmentStream=function VideoSegmentStream(track,options){var sequenceNumber,nalUnits=[],gopsToAlignWith=[],config,pps;options=options||{};sequenceNumber=options.firstSequenceNumber||0;_VideoSegmentStream.prototype.init.call(this);delete track.minPTS;this.gopCache_=[];this.push=function(nalUnit){trackDecodeInfo.collectDtsInfo(track,nalUnit);if(nalUnit.nalUnitType==='seq_parameter_set_rbsp'&&!config){config=nalUnit.config;track.sps=[nalUnit.data];videoProperties.forEach(function(prop){track[prop]=config[prop]},this)}
if(nalUnit.nalUnitType==='pic_parameter_set_rbsp'&&!pps){pps=nalUnit.data;track.pps=[nalUnit.data]}
nalUnits.push(nalUnit)};this.flush=function(){var frames,gopForFusion,gops,moof,mdat,boxes,prependedContentDuration=0,firstGop,lastGop;while(nalUnits.length){if(nalUnits[0].nalUnitType==='access_unit_delimiter_rbsp'){break}
nalUnits.shift()}
if(nalUnits.length===0){this.resetStream_();this.trigger('done','VideoSegmentStream');return}
frames=frameUtils.groupNalsIntoFrames(nalUnits);gops=frameUtils.groupFramesIntoGops(frames);if(!gops[0][0].keyFrame){gopForFusion=this.getGopForFusion_(nalUnits[0],track);if(gopForFusion){prependedContentDuration=gopForFusion.duration;gops.unshift(gopForFusion);gops.byteLength+=gopForFusion.byteLength;gops.nalCount+=gopForFusion.nalCount;gops.pts=gopForFusion.pts;gops.dts=gopForFusion.dts;gops.duration+=gopForFusion.duration}else{gops=frameUtils.extendFirstKeyFrame(gops)}}
if(gopsToAlignWith.length){var alignedGops;if(options.alignGopsAtEnd){alignedGops=this.alignGopsAtEnd_(gops)}else{alignedGops=this.alignGopsAtStart_(gops)}
if(!alignedGops){this.gopCache_.unshift({gop:gops.pop(),pps:track.pps,sps:track.sps});this.gopCache_.length=Math.min(6,this.gopCache_.length);nalUnits=[];this.resetStream_();this.trigger('done','VideoSegmentStream');return}
trackDecodeInfo.clearDtsInfo(track);gops=alignedGops}
trackDecodeInfo.collectDtsInfo(track,gops);track.samples=frameUtils.generateSampleTable(gops);mdat=mp4Generator.mdat(frameUtils.concatenateNalData(gops));track.baseMediaDecodeTime=trackDecodeInfo.calculateTrackBaseMediaDecodeTime(track,options.keepOriginalTimestamps);this.trigger('processedGopsInfo',gops.map(function(gop){return{pts:gop.pts,dts:gop.dts,byteLength:gop.byteLength}}));firstGop=gops[0];lastGop=gops[gops.length-1];this.trigger('segmentTimingInfo',generateSegmentTimingInfo(track.baseMediaDecodeTime,firstGop.dts,firstGop.pts,lastGop.dts+lastGop.duration,lastGop.pts+lastGop.duration,prependedContentDuration));this.trigger('timingInfo',{start:gops[0].pts,end:gops[gops.length-1].pts+gops[gops.length-1].duration});this.gopCache_.unshift({gop:gops.pop(),pps:track.pps,sps:track.sps});this.gopCache_.length=Math.min(6,this.gopCache_.length);nalUnits=[];this.trigger('baseMediaDecodeTime',track.baseMediaDecodeTime);this.trigger('timelineStartInfo',track.timelineStartInfo);moof=mp4Generator.moof(sequenceNumber,[track]);boxes=new Uint8Array(moof.byteLength+mdat.byteLength);sequenceNumber++;boxes.set(moof);boxes.set(mdat,moof.byteLength);this.trigger('data',{track:track,boxes:boxes});this.resetStream_();this.trigger('done','VideoSegmentStream')};this.reset=function(){this.resetStream_();nalUnits=[];this.gopCache_.length=0;gopsToAlignWith.length=0;this.trigger('reset')};this.resetStream_=function(){trackDecodeInfo.clearDtsInfo(track);config=undefined;pps=undefined};this.getGopForFusion_=function(nalUnit){var halfSecond=45000,allowableOverlap=10000,nearestDistance=Infinity,dtsDistance,nearestGopObj,currentGop,currentGopObj,i;for(i=0;i<this.gopCache_.length;i++){currentGopObj=this.gopCache_[i];currentGop=currentGopObj.gop;if(!(track.pps&&arrayEquals(track.pps[0],currentGopObj.pps[0]))||!(track.sps&&arrayEquals(track.sps[0],currentGopObj.sps[0]))){continue}
if(currentGop.dts<track.timelineStartInfo.dts){continue}
dtsDistance=nalUnit.dts-currentGop.dts-currentGop.duration;if(dtsDistance>=-allowableOverlap&&dtsDistance<=halfSecond){if(!nearestGopObj||nearestDistance>dtsDistance){nearestGopObj=currentGopObj;nearestDistance=dtsDistance}}}
if(nearestGopObj){return nearestGopObj.gop}
return null};this.alignGopsAtStart_=function(gops){var alignIndex,gopIndex,align,gop,byteLength,nalCount,duration,alignedGops;byteLength=gops.byteLength;nalCount=gops.nalCount;duration=gops.duration;alignIndex=gopIndex=0;while(alignIndex<gopsToAlignWith.length&&gopIndex<gops.length){align=gopsToAlignWith[alignIndex];gop=gops[gopIndex];if(align.pts===gop.pts){break}
if(gop.pts>align.pts){alignIndex++;continue}
gopIndex++;byteLength-=gop.byteLength;nalCount-=gop.nalCount;duration-=gop.duration}
if(gopIndex===0){return gops}
if(gopIndex===gops.length){return null}
alignedGops=gops.slice(gopIndex);alignedGops.byteLength=byteLength;alignedGops.duration=duration;alignedGops.nalCount=nalCount;alignedGops.pts=alignedGops[0].pts;alignedGops.dts=alignedGops[0].dts;return alignedGops};this.alignGopsAtEnd_=function(gops){var alignIndex,gopIndex,align,gop,alignEndIndex,matchFound;alignIndex=gopsToAlignWith.length-1;gopIndex=gops.length-1;alignEndIndex=null;matchFound=!1;while(alignIndex>=0&&gopIndex>=0){align=gopsToAlignWith[alignIndex];gop=gops[gopIndex];if(align.pts===gop.pts){matchFound=!0;break}
if(align.pts>gop.pts){alignIndex--;continue}
if(alignIndex===gopsToAlignWith.length-1){alignEndIndex=gopIndex}
gopIndex--}
if(!matchFound&&alignEndIndex===null){return null}
var trimIndex;if(matchFound){trimIndex=gopIndex}else{trimIndex=alignEndIndex}
if(trimIndex===0){return gops}
var alignedGops=gops.slice(trimIndex);var metadata=alignedGops.reduce(function(total,gop){total.byteLength+=gop.byteLength;total.duration+=gop.duration;total.nalCount+=gop.nalCount;return total},{byteLength:0,duration:0,nalCount:0});alignedGops.byteLength=metadata.byteLength;alignedGops.duration=metadata.duration;alignedGops.nalCount=metadata.nalCount;alignedGops.pts=alignedGops[0].pts;alignedGops.dts=alignedGops[0].dts;return alignedGops};this.alignGopsWith=function(newGopsToAlignWith){gopsToAlignWith=newGopsToAlignWith}};_VideoSegmentStream.prototype=new stream();_CoalesceStream=function CoalesceStream(options,metadataStream){this.numberOfTracks=0;this.metadataStream=metadataStream;options=options||{};if(typeof options.remux!=='undefined'){this.remuxTracks=!!options.remux}else{this.remuxTracks=!0}
if(typeof options.keepOriginalTimestamps==='boolean'){this.keepOriginalTimestamps=options.keepOriginalTimestamps}else{this.keepOriginalTimestamps=!1}
this.pendingTracks=[];this.videoTrack=null;this.pendingBoxes=[];this.pendingCaptions=[];this.pendingMetadata=[];this.pendingBytes=0;this.emittedTracks=0;_CoalesceStream.prototype.init.call(this);this.push=function(output){if(output.text){return this.pendingCaptions.push(output)}
if(output.frames){return this.pendingMetadata.push(output)}
this.pendingTracks.push(output.track);this.pendingBytes+=output.boxes.byteLength;if(output.track.type==='video'){this.videoTrack=output.track;this.pendingBoxes.push(output.boxes)}
if(output.track.type==='audio'){this.audioTrack=output.track;this.pendingBoxes.unshift(output.boxes)}}};_CoalesceStream.prototype=new stream();_CoalesceStream.prototype.flush=function(flushSource){var offset=0,event={captions:[],captionStreams:{},metadata:[],info:{}},caption,id3,initSegment,timelineStartPts=0,i;if(this.pendingTracks.length<this.numberOfTracks){if(flushSource!=='VideoSegmentStream'&&flushSource!=='AudioSegmentStream'){return}else if(this.remuxTracks){return}else if(this.pendingTracks.length===0){this.emittedTracks++;if(this.emittedTracks>=this.numberOfTracks){this.trigger('done');this.emittedTracks=0}
return}}
if(this.videoTrack){timelineStartPts=this.videoTrack.timelineStartInfo.pts;videoProperties.forEach(function(prop){event.info[prop]=this.videoTrack[prop]},this)}else if(this.audioTrack){timelineStartPts=this.audioTrack.timelineStartInfo.pts;audioProperties.forEach(function(prop){event.info[prop]=this.audioTrack[prop]},this)}
if(this.videoTrack||this.audioTrack){if(this.pendingTracks.length===1){event.type=this.pendingTracks[0].type}else{event.type='combined'}
this.emittedTracks+=this.pendingTracks.length;initSegment=mp4Generator.initSegment(this.pendingTracks);event.initSegment=new Uint8Array(initSegment.byteLength);event.initSegment.set(initSegment);event.data=new Uint8Array(this.pendingBytes);for(i=0;i<this.pendingBoxes.length;i++){event.data.set(this.pendingBoxes[i],offset);offset+=this.pendingBoxes[i].byteLength}
for(i=0;i<this.pendingCaptions.length;i++){caption=this.pendingCaptions[i];caption.startTime=clock.metadataTsToSeconds(caption.startPts,timelineStartPts,this.keepOriginalTimestamps);caption.endTime=clock.metadataTsToSeconds(caption.endPts,timelineStartPts,this.keepOriginalTimestamps);event.captionStreams[caption.stream]=!0;event.captions.push(caption)}
for(i=0;i<this.pendingMetadata.length;i++){id3=this.pendingMetadata[i];id3.cueTime=clock.metadataTsToSeconds(id3.pts,timelineStartPts,this.keepOriginalTimestamps);event.metadata.push(id3)}
event.metadata.dispatchType=this.metadataStream.dispatchType;this.pendingTracks.length=0;this.videoTrack=null;this.pendingBoxes.length=0;this.pendingCaptions.length=0;this.pendingBytes=0;this.pendingMetadata.length=0;this.trigger('data',event);for(i=0;i<event.captions.length;i++){caption=event.captions[i];this.trigger('caption',caption)}
for(i=0;i<event.metadata.length;i++){id3=event.metadata[i];this.trigger('id3Frame',id3)}}
if(this.emittedTracks>=this.numberOfTracks){this.trigger('done');this.emittedTracks=0}};_CoalesceStream.prototype.setRemux=function(val){this.remuxTracks=val};_Transmuxer=function Transmuxer(options){var self=this,hasFlushed=!0,videoTrack,audioTrack;_Transmuxer.prototype.init.call(this);options=options||{};this.baseMediaDecodeTime=options.baseMediaDecodeTime||0;this.transmuxPipeline_={};this.setupAacPipeline=function(){var pipeline={};this.transmuxPipeline_=pipeline;pipeline.type='aac';pipeline.metadataStream=new m2ts_1.MetadataStream();pipeline.aacStream=new aac();pipeline.audioTimestampRolloverStream=new m2ts_1.TimestampRolloverStream('audio');pipeline.timedMetadataTimestampRolloverStream=new m2ts_1.TimestampRolloverStream('timed-metadata');pipeline.adtsStream=new adts();pipeline.coalesceStream=new _CoalesceStream(options,pipeline.metadataStream);pipeline.headOfPipeline=pipeline.aacStream;pipeline.aacStream.pipe(pipeline.audioTimestampRolloverStream).pipe(pipeline.adtsStream);pipeline.aacStream.pipe(pipeline.timedMetadataTimestampRolloverStream).pipe(pipeline.metadataStream).pipe(pipeline.coalesceStream);pipeline.metadataStream.on('timestamp',function(frame){pipeline.aacStream.setTimestamp(frame.timeStamp)});pipeline.aacStream.on('data',function(data){if(data.type!=='timed-metadata'&&data.type!=='audio'||pipeline.audioSegmentStream){return}
audioTrack=audioTrack||{timelineStartInfo:{baseMediaDecodeTime:self.baseMediaDecodeTime},codec:'adts',type:'audio'};pipeline.coalesceStream.numberOfTracks++;pipeline.audioSegmentStream=new _AudioSegmentStream(audioTrack,options);pipeline.audioSegmentStream.on('log',self.getLogTrigger_('audioSegmentStream'));pipeline.audioSegmentStream.on('timingInfo',self.trigger.bind(self,'audioTimingInfo'));pipeline.adtsStream.pipe(pipeline.audioSegmentStream).pipe(pipeline.coalesceStream);self.trigger('trackinfo',{hasAudio:!!audioTrack,hasVideo:!!videoTrack})});pipeline.coalesceStream.on('data',this.trigger.bind(this,'data'));pipeline.coalesceStream.on('done',this.trigger.bind(this,'done'));addPipelineLogRetriggers(this,pipeline)};this.setupTsPipeline=function(){var pipeline={};this.transmuxPipeline_=pipeline;pipeline.type='ts';pipeline.metadataStream=new m2ts_1.MetadataStream();pipeline.packetStream=new m2ts_1.TransportPacketStream();pipeline.parseStream=new m2ts_1.TransportParseStream();pipeline.elementaryStream=new m2ts_1.ElementaryStream();pipeline.timestampRolloverStream=new m2ts_1.TimestampRolloverStream();pipeline.adtsStream=new adts();pipeline.h264Stream=new H264Stream();pipeline.captionStream=new m2ts_1.CaptionStream(options);pipeline.coalesceStream=new _CoalesceStream(options,pipeline.metadataStream);pipeline.headOfPipeline=pipeline.packetStream;pipeline.packetStream.pipe(pipeline.parseStream).pipe(pipeline.elementaryStream).pipe(pipeline.timestampRolloverStream);pipeline.timestampRolloverStream.pipe(pipeline.h264Stream);pipeline.timestampRolloverStream.pipe(pipeline.adtsStream);pipeline.timestampRolloverStream.pipe(pipeline.metadataStream).pipe(pipeline.coalesceStream);pipeline.h264Stream.pipe(pipeline.captionStream).pipe(pipeline.coalesceStream);pipeline.elementaryStream.on('data',function(data){var i;if(data.type==='metadata'){i=data.tracks.length;while(i--){if(!videoTrack&&data.tracks[i].type==='video'){videoTrack=data.tracks[i];videoTrack.timelineStartInfo.baseMediaDecodeTime=self.baseMediaDecodeTime}else if(!audioTrack&&data.tracks[i].type==='audio'){audioTrack=data.tracks[i];audioTrack.timelineStartInfo.baseMediaDecodeTime=self.baseMediaDecodeTime}}
if(videoTrack&&!pipeline.videoSegmentStream){pipeline.coalesceStream.numberOfTracks++;pipeline.videoSegmentStream=new _VideoSegmentStream(videoTrack,options);pipeline.videoSegmentStream.on('log',self.getLogTrigger_('videoSegmentStream'));pipeline.videoSegmentStream.on('timelineStartInfo',function(timelineStartInfo){if(audioTrack&&!options.keepOriginalTimestamps){audioTrack.timelineStartInfo=timelineStartInfo;pipeline.audioSegmentStream.setEarliestDts(timelineStartInfo.dts-self.baseMediaDecodeTime)}});pipeline.videoSegmentStream.on('processedGopsInfo',self.trigger.bind(self,'gopInfo'));pipeline.videoSegmentStream.on('segmentTimingInfo',self.trigger.bind(self,'videoSegmentTimingInfo'));pipeline.videoSegmentStream.on('baseMediaDecodeTime',function(baseMediaDecodeTime){if(audioTrack){pipeline.audioSegmentStream.setVideoBaseMediaDecodeTime(baseMediaDecodeTime)}});pipeline.videoSegmentStream.on('timingInfo',self.trigger.bind(self,'videoTimingInfo'));pipeline.h264Stream.pipe(pipeline.videoSegmentStream).pipe(pipeline.coalesceStream)}
if(audioTrack&&!pipeline.audioSegmentStream){pipeline.coalesceStream.numberOfTracks++;pipeline.audioSegmentStream=new _AudioSegmentStream(audioTrack,options);pipeline.audioSegmentStream.on('log',self.getLogTrigger_('audioSegmentStream'));pipeline.audioSegmentStream.on('timingInfo',self.trigger.bind(self,'audioTimingInfo'));pipeline.audioSegmentStream.on('segmentTimingInfo',self.trigger.bind(self,'audioSegmentTimingInfo'));pipeline.adtsStream.pipe(pipeline.audioSegmentStream).pipe(pipeline.coalesceStream)}
self.trigger('trackinfo',{hasAudio:!!audioTrack,hasVideo:!!videoTrack})}});pipeline.coalesceStream.on('data',this.trigger.bind(this,'data'));pipeline.coalesceStream.on('id3Frame',function(id3Frame){id3Frame.dispatchType=pipeline.metadataStream.dispatchType;self.trigger('id3Frame',id3Frame)});pipeline.coalesceStream.on('caption',this.trigger.bind(this,'caption'));pipeline.coalesceStream.on('done',this.trigger.bind(this,'done'));addPipelineLogRetriggers(this,pipeline)};this.setBaseMediaDecodeTime=function(baseMediaDecodeTime){var pipeline=this.transmuxPipeline_;if(!options.keepOriginalTimestamps){this.baseMediaDecodeTime=baseMediaDecodeTime}
if(audioTrack){audioTrack.timelineStartInfo.dts=undefined;audioTrack.timelineStartInfo.pts=undefined;trackDecodeInfo.clearDtsInfo(audioTrack);if(pipeline.audioTimestampRolloverStream){pipeline.audioTimestampRolloverStream.discontinuity()}}
if(videoTrack){if(pipeline.videoSegmentStream){pipeline.videoSegmentStream.gopCache_=[]}
videoTrack.timelineStartInfo.dts=undefined;videoTrack.timelineStartInfo.pts=undefined;trackDecodeInfo.clearDtsInfo(videoTrack);pipeline.captionStream.reset()}
if(pipeline.timestampRolloverStream){pipeline.timestampRolloverStream.discontinuity()}};this.setAudioAppendStart=function(timestamp){if(audioTrack){this.transmuxPipeline_.audioSegmentStream.setAudioAppendStart(timestamp)}};this.setRemux=function(val){var pipeline=this.transmuxPipeline_;options.remux=val;if(pipeline&&pipeline.coalesceStream){pipeline.coalesceStream.setRemux(val)}};this.alignGopsWith=function(gopsToAlignWith){if(videoTrack&&this.transmuxPipeline_.videoSegmentStream){this.transmuxPipeline_.videoSegmentStream.alignGopsWith(gopsToAlignWith)}};this.getLogTrigger_=function(key){var self=this;return function(event){event.stream=key;self.trigger('log',event)}};this.push=function(data){if(hasFlushed){var isAac=isLikelyAacData(data);if(isAac&&this.transmuxPipeline_.type!=='aac'){this.setupAacPipeline()}else if(!isAac&&this.transmuxPipeline_.type!=='ts'){this.setupTsPipeline()}
hasFlushed=!1}
this.transmuxPipeline_.headOfPipeline.push(data)};this.flush=function(){hasFlushed=!0;this.transmuxPipeline_.headOfPipeline.flush()};this.endTimeline=function(){this.transmuxPipeline_.headOfPipeline.endTimeline()};this.reset=function(){if(this.transmuxPipeline_.headOfPipeline){this.transmuxPipeline_.headOfPipeline.reset()}};this.resetCaptions=function(){if(this.transmuxPipeline_.captionStream){this.transmuxPipeline_.captionStream.reset()}}};_Transmuxer.prototype=new stream();var transmuxer={Transmuxer:_Transmuxer,VideoSegmentStream:_VideoSegmentStream,AudioSegmentStream:_AudioSegmentStream,AUDIO_PROPERTIES:audioProperties,VIDEO_PROPERTIES:videoProperties,generateSegmentTimingInfo:generateSegmentTimingInfo};var toUnsigned$3=function toUnsigned(value){return value>>>0};var toHexString$1=function toHexString(value){return('00'+value.toString(16)).slice(-2)};var bin={toUnsigned:toUnsigned$3,toHexString:toHexString$1};var parseType$1=function parseType(buffer){var result='';result+=String.fromCharCode(buffer[0]);result+=String.fromCharCode(buffer[1]);result+=String.fromCharCode(buffer[2]);result+=String.fromCharCode(buffer[3]);return result};var parseType_1=parseType$1;var toUnsigned$2=bin.toUnsigned;var findBox=function findBox(data,path){var results=[],i,size,type,end,subresults;if(!path.length){return null}
for(i=0;i<data.byteLength;){size=toUnsigned$2(data[i]<<24|data[i+1]<<16|data[i+2]<<8|data[i+3]);type=parseType_1(data.subarray(i+4,i+8));end=size>1?i+size:data.byteLength;if(type===path[0]){if(path.length===1){results.push(data.subarray(i+8,end))}else{subresults=findBox(data.subarray(i+8,end),path.slice(1));if(subresults.length){results=results.concat(subresults)}}}
i=end}
return results};var findBox_1=findBox;var toUnsigned$1=bin.toUnsigned;var getUint64$1=numbers.getUint64;var tfdt=function tfdt(data){var result={version:data[0],flags:new Uint8Array(data.subarray(1,4))};if(result.version===1){result.baseMediaDecodeTime=getUint64$1(data.subarray(4))}else{result.baseMediaDecodeTime=toUnsigned$1(data[4]<<24|data[5]<<16|data[6]<<8|data[7])}
return result};var parseTfdt=tfdt;var parseSampleFlags=function parseSampleFlags(flags){return{isLeading:(flags[0]&0x0c)>>>2,dependsOn:flags[0]&0x03,isDependedOn:(flags[1]&0xc0)>>>6,hasRedundancy:(flags[1]&0x30)>>>4,paddingValue:(flags[1]&0x0e)>>>1,isNonSyncSample:flags[1]&0x01,degradationPriority:flags[2]<<8|flags[3]}};var parseSampleFlags_1=parseSampleFlags;var trun=function trun(data){var result={version:data[0],flags:new Uint8Array(data.subarray(1,4)),samples:[]},view=new DataView(data.buffer,data.byteOffset,data.byteLength),dataOffsetPresent=result.flags[2]&0x01,firstSampleFlagsPresent=result.flags[2]&0x04,sampleDurationPresent=result.flags[1]&0x01,sampleSizePresent=result.flags[1]&0x02,sampleFlagsPresent=result.flags[1]&0x04,sampleCompositionTimeOffsetPresent=result.flags[1]&0x08,sampleCount=view.getUint32(4),offset=8,sample;if(dataOffsetPresent){result.dataOffset=view.getInt32(offset);offset+=4}
if(firstSampleFlagsPresent&&sampleCount){sample={flags:parseSampleFlags_1(data.subarray(offset,offset+4))};offset+=4;if(sampleDurationPresent){sample.duration=view.getUint32(offset);offset+=4}
if(sampleSizePresent){sample.size=view.getUint32(offset);offset+=4}
if(sampleCompositionTimeOffsetPresent){if(result.version===1){sample.compositionTimeOffset=view.getInt32(offset)}else{sample.compositionTimeOffset=view.getUint32(offset)}
offset+=4}
result.samples.push(sample);sampleCount--}
while(sampleCount--){sample={};if(sampleDurationPresent){sample.duration=view.getUint32(offset);offset+=4}
if(sampleSizePresent){sample.size=view.getUint32(offset);offset+=4}
if(sampleFlagsPresent){sample.flags=parseSampleFlags_1(data.subarray(offset,offset+4));offset+=4}
if(sampleCompositionTimeOffsetPresent){if(result.version===1){sample.compositionTimeOffset=view.getInt32(offset)}else{sample.compositionTimeOffset=view.getUint32(offset)}
offset+=4}
result.samples.push(sample)}
return result};var parseTrun=trun;var tfhd=function tfhd(data){var view=new DataView(data.buffer,data.byteOffset,data.byteLength),result={version:data[0],flags:new Uint8Array(data.subarray(1,4)),trackId:view.getUint32(4)},baseDataOffsetPresent=result.flags[2]&0x01,sampleDescriptionIndexPresent=result.flags[2]&0x02,defaultSampleDurationPresent=result.flags[2]&0x08,defaultSampleSizePresent=result.flags[2]&0x10,defaultSampleFlagsPresent=result.flags[2]&0x20,durationIsEmpty=result.flags[0]&0x010000,defaultBaseIsMoof=result.flags[0]&0x020000,i;i=8;if(baseDataOffsetPresent){i+=4;result.baseDataOffset=view.getUint32(12);i+=4}
if(sampleDescriptionIndexPresent){result.sampleDescriptionIndex=view.getUint32(i);i+=4}
if(defaultSampleDurationPresent){result.defaultSampleDuration=view.getUint32(i);i+=4}
if(defaultSampleSizePresent){result.defaultSampleSize=view.getUint32(i);i+=4}
if(defaultSampleFlagsPresent){result.defaultSampleFlags=view.getUint32(i)}
if(durationIsEmpty){result.durationIsEmpty=!0}
if(!baseDataOffsetPresent&&defaultBaseIsMoof){result.baseDataOffsetIsMoof=!0}
return result};var parseTfhd=tfhd;var commonjsGlobal=typeof globalThis!=='undefined'?globalThis:typeof window!=='undefined'?window:typeof global!=='undefined'?global:typeof self!=='undefined'?self:{};var win;if(typeof window!=="undefined"){win=window}else if(typeof commonjsGlobal!=="undefined"){win=commonjsGlobal}else if(typeof self!=="undefined"){win=self}else{win={}}
var window_1=win;var discardEmulationPreventionBytes=captionPacketParser.discardEmulationPreventionBytes;var CaptionStream=captionStream.CaptionStream;var mapToSample=function mapToSample(offset,samples){var approximateOffset=offset;for(var i=0;i<samples.length;i++){var sample=samples[i];if(approximateOffset<sample.size){return sample}
approximateOffset-=sample.size}
return null};var findSeiNals=function findSeiNals(avcStream,samples,trackId){var avcView=new DataView(avcStream.buffer,avcStream.byteOffset,avcStream.byteLength),result={logs:[],seiNals:[]},seiNal,i,length,lastMatchedSample;for(i=0;i+4<avcStream.length;i+=length){length=avcView.getUint32(i);i+=4;if(length<=0){continue}
switch(avcStream[i]&0x1F){case 0x06:var data=avcStream.subarray(i+1,i+1+length);var matchingSample=mapToSample(i,samples);seiNal={nalUnitType:'sei_rbsp',size:length,data:data,escapedRBSP:discardEmulationPreventionBytes(data),trackId:trackId};if(matchingSample){seiNal.pts=matchingSample.pts;seiNal.dts=matchingSample.dts;lastMatchedSample=matchingSample}else if(lastMatchedSample){seiNal.pts=lastMatchedSample.pts;seiNal.dts=lastMatchedSample.dts}else{result.logs.push({level:'warn',message:'We\'ve encountered a nal unit without data at '+i+' for trackId '+trackId+'. See mux.js#223.'});break}
result.seiNals.push(seiNal);break}}
return result};var parseSamples=function parseSamples(truns,baseMediaDecodeTime,tfhd){var currentDts=baseMediaDecodeTime;var defaultSampleDuration=tfhd.defaultSampleDuration||0;var defaultSampleSize=tfhd.defaultSampleSize||0;var trackId=tfhd.trackId;var allSamples=[];truns.forEach(function(trun){var trackRun=parseTrun(trun);var samples=trackRun.samples;samples.forEach(function(sample){if(sample.duration===undefined){sample.duration=defaultSampleDuration}
if(sample.size===undefined){sample.size=defaultSampleSize}
sample.trackId=trackId;sample.dts=currentDts;if(sample.compositionTimeOffset===undefined){sample.compositionTimeOffset=0}
if(typeof currentDts==='bigint'){sample.pts=currentDts+window_1.BigInt(sample.compositionTimeOffset);currentDts+=window_1.BigInt(sample.duration)}else{sample.pts=currentDts+sample.compositionTimeOffset;currentDts+=sample.duration}});allSamples=allSamples.concat(samples)});return allSamples};var parseCaptionNals=function parseCaptionNals(segment,videoTrackId){var trafs=findBox_1(segment,['moof','traf']);var mdats=findBox_1(segment,['mdat']);var captionNals={};var mdatTrafPairs=[];mdats.forEach(function(mdat,index){var matchingTraf=trafs[index];mdatTrafPairs.push({mdat:mdat,traf:matchingTraf})});mdatTrafPairs.forEach(function(pair){var mdat=pair.mdat;var traf=pair.traf;var tfhd=findBox_1(traf,['tfhd']);var headerInfo=parseTfhd(tfhd[0]);var trackId=headerInfo.trackId;var tfdt=findBox_1(traf,['tfdt']);var baseMediaDecodeTime=tfdt.length>0?parseTfdt(tfdt[0]).baseMediaDecodeTime:0;var truns=findBox_1(traf,['trun']);var samples;var result;if(videoTrackId===trackId&&truns.length>0){samples=parseSamples(truns,baseMediaDecodeTime,headerInfo);result=findSeiNals(mdat,samples,trackId);if(!captionNals[trackId]){captionNals[trackId]={seiNals:[],logs:[]}}
captionNals[trackId].seiNals=captionNals[trackId].seiNals.concat(result.seiNals);captionNals[trackId].logs=captionNals[trackId].logs.concat(result.logs)}});return captionNals};var parseEmbeddedCaptions=function parseEmbeddedCaptions(segment,trackId,timescale){var captionNals;if(trackId===null){return null}
captionNals=parseCaptionNals(segment,trackId);var trackNals=captionNals[trackId]||{};return{seiNals:trackNals.seiNals,logs:trackNals.logs,timescale:timescale}};var CaptionParser=function CaptionParser(){var isInitialized=!1;var captionStream;var segmentCache;var trackId;var timescale;var parsedCaptions;var parsingPartial;this.isInitialized=function(){return isInitialized};this.init=function(options){captionStream=new CaptionStream();isInitialized=!0;parsingPartial=options?options.isPartial:!1;captionStream.on('data',function(event){event.startTime=event.startPts/timescale;event.endTime=event.endPts/timescale;parsedCaptions.captions.push(event);parsedCaptions.captionStreams[event.stream]=!0});captionStream.on('log',function(log){parsedCaptions.logs.push(log)})};this.isNewInit=function(videoTrackIds,timescales){if(videoTrackIds&&videoTrackIds.length===0||timescales&&typeof timescales==='object'&&Object.keys(timescales).length===0){return!1}
return trackId!==videoTrackIds[0]||timescale!==timescales[trackId]};this.parse=function(segment,videoTrackIds,timescales){var parsedData;if(!this.isInitialized()){return null}else if(!videoTrackIds||!timescales){return null}else if(this.isNewInit(videoTrackIds,timescales)){trackId=videoTrackIds[0];timescale=timescales[trackId]}else if(trackId===null||!timescale){segmentCache.push(segment);return null}
while(segmentCache.length>0){var cachedSegment=segmentCache.shift();this.parse(cachedSegment,videoTrackIds,timescales)}
parsedData=parseEmbeddedCaptions(segment,trackId,timescale);if(parsedData&&parsedData.logs){parsedCaptions.logs=parsedCaptions.logs.concat(parsedData.logs)}
if(parsedData===null||!parsedData.seiNals){if(parsedCaptions.logs.length){return{logs:parsedCaptions.logs,captions:[],captionStreams:[]}}
return null}
this.pushNals(parsedData.seiNals);this.flushStream();return parsedCaptions};this.pushNals=function(nals){if(!this.isInitialized()||!nals||nals.length===0){return null}
nals.forEach(function(nal){captionStream.push(nal)})};this.flushStream=function(){if(!this.isInitialized()){return null}
if(!parsingPartial){captionStream.flush()}else{captionStream.partialFlush()}};this.clearParsedCaptions=function(){parsedCaptions.captions=[];parsedCaptions.captionStreams={};parsedCaptions.logs=[]};this.resetCaptionStream=function(){if(!this.isInitialized()){return null}
captionStream.reset()};this.clearAllCaptions=function(){this.clearParsedCaptions();this.resetCaptionStream()};this.reset=function(){segmentCache=[];trackId=null;timescale=null;if(!parsedCaptions){parsedCaptions={captions:[],captionStreams:{},logs:[]}}else{this.clearParsedCaptions()}
this.resetCaptionStream()};this.reset()};var captionParser=CaptionParser;var toUnsigned=bin.toUnsigned;var toHexString=bin.toHexString;var getUint64=numbers.getUint64;var timescale,startTime,compositionStartTime,getVideoTrackIds,getTracks,getTimescaleFromMediaHeader;timescale=function timescale(init){var result={},traks=findBox_1(init,['moov','trak']);return traks.reduce(function(result,trak){var tkhd,version,index,id,mdhd;tkhd=findBox_1(trak,['tkhd'])[0];if(!tkhd){return null}
version=tkhd[0];index=version===0?12:20;id=toUnsigned(tkhd[index]<<24|tkhd[index+1]<<16|tkhd[index+2]<<8|tkhd[index+3]);mdhd=findBox_1(trak,['mdia','mdhd'])[0];if(!mdhd){return null}
version=mdhd[0];index=version===0?12:20;result[id]=toUnsigned(mdhd[index]<<24|mdhd[index+1]<<16|mdhd[index+2]<<8|mdhd[index+3]);return result},result)};startTime=function startTime(timescale,fragment){var trafs;trafs=findBox_1(fragment,['moof','traf']);var lowestTime=trafs.reduce(function(acc,traf){var tfhd=findBox_1(traf,['tfhd'])[0];var id=toUnsigned(tfhd[4]<<24|tfhd[5]<<16|tfhd[6]<<8|tfhd[7]);var scale=timescale[id]||90e3;var tfdt=findBox_1(traf,['tfdt'])[0];var dv=new DataView(tfdt.buffer,tfdt.byteOffset,tfdt.byteLength);var baseTime;if(tfdt[0]===1){baseTime=getUint64(tfdt.subarray(4,12))}else{baseTime=dv.getUint32(4)}
var seconds;if(typeof baseTime==='bigint'){seconds=baseTime/window_1.BigInt(scale)}else if(typeof baseTime==='number'&&!isNaN(baseTime)){seconds=baseTime/scale}
if(seconds<Number.MAX_SAFE_INTEGER){seconds=Number(seconds)}
if(seconds<acc){acc=seconds}
return acc},Infinity);return typeof lowestTime==='bigint'||isFinite(lowestTime)?lowestTime:0};compositionStartTime=function compositionStartTime(timescales,fragment){var trafBoxes=findBox_1(fragment,['moof','traf']);var baseMediaDecodeTime=0;var compositionTimeOffset=0;var trackId;if(trafBoxes&&trafBoxes.length){var tfhd=findBox_1(trafBoxes[0],['tfhd'])[0];var trun=findBox_1(trafBoxes[0],['trun'])[0];var tfdt=findBox_1(trafBoxes[0],['tfdt'])[0];if(tfhd){var parsedTfhd=parseTfhd(tfhd);trackId=parsedTfhd.trackId}
if(tfdt){var parsedTfdt=parseTfdt(tfdt);baseMediaDecodeTime=parsedTfdt.baseMediaDecodeTime}
if(trun){var parsedTrun=parseTrun(trun);if(parsedTrun.samples&&parsedTrun.samples.length){compositionTimeOffset=parsedTrun.samples[0].compositionTimeOffset||0}}}
var timescale=timescales[trackId]||90e3;if(typeof baseMediaDecodeTime==='bigint'){compositionTimeOffset=window_1.BigInt(compositionTimeOffset);timescale=window_1.BigInt(timescale)}
var result=(baseMediaDecodeTime+compositionTimeOffset)/timescale;if(typeof result==='bigint'&&result<Number.MAX_SAFE_INTEGER){result=Number(result)}
return result};getVideoTrackIds=function getVideoTrackIds(init){var traks=findBox_1(init,['moov','trak']);var videoTrackIds=[];traks.forEach(function(trak){var hdlrs=findBox_1(trak,['mdia','hdlr']);var tkhds=findBox_1(trak,['tkhd']);hdlrs.forEach(function(hdlr,index){var handlerType=parseType_1(hdlr.subarray(8,12));var tkhd=tkhds[index];var view;var version;var trackId;if(handlerType==='vide'){view=new DataView(tkhd.buffer,tkhd.byteOffset,tkhd.byteLength);version=view.getUint8(0);trackId=version===0?view.getUint32(12):view.getUint32(20);videoTrackIds.push(trackId)}})});return videoTrackIds};getTimescaleFromMediaHeader=function getTimescaleFromMediaHeader(mdhd){var version=mdhd[0];var index=version===0?12:20;return toUnsigned(mdhd[index]<<24|mdhd[index+1]<<16|mdhd[index+2]<<8|mdhd[index+3])};getTracks=function getTracks(init){var traks=findBox_1(init,['moov','trak']);var tracks=[];traks.forEach(function(trak){var track={};var tkhd=findBox_1(trak,['tkhd'])[0];var view,tkhdVersion;if(tkhd){view=new DataView(tkhd.buffer,tkhd.byteOffset,tkhd.byteLength);tkhdVersion=view.getUint8(0);track.id=tkhdVersion===0?view.getUint32(12):view.getUint32(20)}
var hdlr=findBox_1(trak,['mdia','hdlr'])[0];if(hdlr){var type=parseType_1(hdlr.subarray(8,12));if(type==='vide'){track.type='video'}else if(type==='soun'){track.type='audio'}else{track.type=type}}
var stsd=findBox_1(trak,['mdia','minf','stbl','stsd'])[0];if(stsd){var sampleDescriptions=stsd.subarray(8);track.codec=parseType_1(sampleDescriptions.subarray(4,8));var codecBox=findBox_1(sampleDescriptions,[track.codec])[0];var codecConfig,codecConfigType;if(codecBox){if(/^[asm]vc[1-9]$/i.test(track.codec)){codecConfig=codecBox.subarray(78);codecConfigType=parseType_1(codecConfig.subarray(4,8));if(codecConfigType==='avcC'&&codecConfig.length>11){track.codec+='.';track.codec+=toHexString(codecConfig[9]);track.codec+=toHexString(codecConfig[10]);track.codec+=toHexString(codecConfig[11])}else{track.codec='avc1.4d400d'}}else if(/^mp4[a,v]$/i.test(track.codec)){codecConfig=codecBox.subarray(28);codecConfigType=parseType_1(codecConfig.subarray(4,8));if(codecConfigType==='esds'&&codecConfig.length>20&&codecConfig[19]!==0){track.codec+='.'+toHexString(codecConfig[19]);track.codec+='.'+toHexString(codecConfig[20]>>>2&0x3f).replace(/^0/,'')}else{track.codec='mp4a.40.2'}}else{track.codec=track.codec.toLowerCase()}}}
var mdhd=findBox_1(trak,['mdia','mdhd'])[0];if(mdhd){track.timescale=getTimescaleFromMediaHeader(mdhd)}
tracks.push(track)});return tracks};var probe$2={findBox:findBox_1,parseType:parseType_1,timescale:timescale,startTime:startTime,compositionStartTime:compositionStartTime,videoTrackIds:getVideoTrackIds,tracks:getTracks,getTimescaleFromMediaHeader:getTimescaleFromMediaHeader};var parsePid=function parsePid(packet){var pid=packet[1]&0x1f;pid<<=8;pid|=packet[2];return pid};var parsePayloadUnitStartIndicator=function parsePayloadUnitStartIndicator(packet){return!!(packet[1]&0x40)};var parseAdaptionField=function parseAdaptionField(packet){var offset=0;if((packet[3]&0x30)>>>4>0x01){offset+=packet[4]+1}
return offset};var parseType=function parseType(packet,pmtPid){var pid=parsePid(packet);if(pid===0){return'pat'}else if(pid===pmtPid){return'pmt'}else if(pmtPid){return'pes'}
return null};var parsePat=function parsePat(packet){var pusi=parsePayloadUnitStartIndicator(packet);var offset=4+parseAdaptionField(packet);if(pusi){offset+=packet[offset]+1}
return(packet[offset+10]&0x1f)<<8|packet[offset+11]};var parsePmt=function parsePmt(packet){var programMapTable={};var pusi=parsePayloadUnitStartIndicator(packet);var payloadOffset=4+parseAdaptionField(packet);if(pusi){payloadOffset+=packet[payloadOffset]+1}
if(!(packet[payloadOffset+5]&0x01)){return}
var sectionLength,tableEnd,programInfoLength;sectionLength=(packet[payloadOffset+1]&0x0f)<<8|packet[payloadOffset+2];tableEnd=3+sectionLength-4;programInfoLength=(packet[payloadOffset+10]&0x0f)<<8|packet[payloadOffset+11];var offset=12+programInfoLength;while(offset<tableEnd){var i=payloadOffset+offset;programMapTable[(packet[i+1]&0x1F)<<8|packet[i+2]]=packet[i];offset+=((packet[i+3]&0x0F)<<8|packet[i+4])+5}
return programMapTable};var parsePesType=function parsePesType(packet,programMapTable){var pid=parsePid(packet);var type=programMapTable[pid];switch(type){case streamTypes.H264_STREAM_TYPE:return'video';case streamTypes.ADTS_STREAM_TYPE:return'audio';case streamTypes.METADATA_STREAM_TYPE:return'timed-metadata';default:return null}};var parsePesTime=function parsePesTime(packet){var pusi=parsePayloadUnitStartIndicator(packet);if(!pusi){return null}
var offset=4+parseAdaptionField(packet);if(offset>=packet.byteLength){return null}
var pes=null;var ptsDtsFlags;ptsDtsFlags=packet[offset+7];if(ptsDtsFlags&0xC0){pes={};pes.pts=(packet[offset+9]&0x0E)<<27|(packet[offset+10]&0xFF)<<20|(packet[offset+11]&0xFE)<<12|(packet[offset+12]&0xFF)<<5|(packet[offset+13]&0xFE)>>>3;pes.pts*=4;pes.pts+=(packet[offset+13]&0x06)>>>1;pes.dts=pes.pts;if(ptsDtsFlags&0x40){pes.dts=(packet[offset+14]&0x0E)<<27|(packet[offset+15]&0xFF)<<20|(packet[offset+16]&0xFE)<<12|(packet[offset+17]&0xFF)<<5|(packet[offset+18]&0xFE)>>>3;pes.dts*=4;pes.dts+=(packet[offset+18]&0x06)>>>1}}
return pes};var parseNalUnitType=function parseNalUnitType(type){switch(type){case 0x05:return'slice_layer_without_partitioning_rbsp_idr';case 0x06:return'sei_rbsp';case 0x07:return'seq_parameter_set_rbsp';case 0x08:return'pic_parameter_set_rbsp';case 0x09:return'access_unit_delimiter_rbsp';default:return null}};var videoPacketContainsKeyFrame=function videoPacketContainsKeyFrame(packet){var offset=4+parseAdaptionField(packet);var frameBuffer=packet.subarray(offset);var frameI=0;var frameSyncPoint=0;var foundKeyFrame=!1;var nalType;for(;frameSyncPoint<frameBuffer.byteLength-3;frameSyncPoint++){if(frameBuffer[frameSyncPoint+2]===1){frameI=frameSyncPoint+5;break}}
while(frameI<frameBuffer.byteLength){switch(frameBuffer[frameI]){case 0:if(frameBuffer[frameI-1]!==0){frameI+=2;break}else if(frameBuffer[frameI-2]!==0){frameI++;break}
if(frameSyncPoint+3!==frameI-2){nalType=parseNalUnitType(frameBuffer[frameSyncPoint+3]&0x1f);if(nalType==='slice_layer_without_partitioning_rbsp_idr'){foundKeyFrame=!0}}
do{frameI++}while(frameBuffer[frameI]!==1&&frameI<frameBuffer.length);frameSyncPoint=frameI-2;frameI+=3;break;case 1:if(frameBuffer[frameI-1]!==0||frameBuffer[frameI-2]!==0){frameI+=3;break}
nalType=parseNalUnitType(frameBuffer[frameSyncPoint+3]&0x1f);if(nalType==='slice_layer_without_partitioning_rbsp_idr'){foundKeyFrame=!0}
frameSyncPoint=frameI-2;frameI+=3;break;default:frameI+=3;break}}
frameBuffer=frameBuffer.subarray(frameSyncPoint);frameI-=frameSyncPoint;frameSyncPoint=0;if(frameBuffer&&frameBuffer.byteLength>3){nalType=parseNalUnitType(frameBuffer[frameSyncPoint+3]&0x1f);if(nalType==='slice_layer_without_partitioning_rbsp_idr'){foundKeyFrame=!0}}
return foundKeyFrame};var probe$1={parseType:parseType,parsePat:parsePat,parsePmt:parsePmt,parsePayloadUnitStartIndicator:parsePayloadUnitStartIndicator,parsePesType:parsePesType,parsePesTime:parsePesTime,videoPacketContainsKeyFrame:videoPacketContainsKeyFrame};var handleRollover=timestampRolloverStream.handleRollover;var probe={};probe.ts=probe$1;probe.aac=utils;var ONE_SECOND_IN_TS=clock.ONE_SECOND_IN_TS;var MP2T_PACKET_LENGTH=188,SYNC_BYTE=0x47;var parsePsi_=function parsePsi_(bytes,pmt){var startIndex=0,endIndex=MP2T_PACKET_LENGTH,packet,type;while(endIndex<bytes.byteLength){if(bytes[startIndex]===SYNC_BYTE&&bytes[endIndex]===SYNC_BYTE){packet=bytes.subarray(startIndex,endIndex);type=probe.ts.parseType(packet,pmt.pid);switch(type){case 'pat':pmt.pid=probe.ts.parsePat(packet);break;case 'pmt':var table=probe.ts.parsePmt(packet);pmt.table=pmt.table||{};Object.keys(table).forEach(function(key){pmt.table[key]=table[key]});break}
startIndex+=MP2T_PACKET_LENGTH;endIndex+=MP2T_PACKET_LENGTH;continue}
startIndex++;endIndex++}};var parseAudioPes_=function parseAudioPes_(bytes,pmt,result){var startIndex=0,endIndex=MP2T_PACKET_LENGTH,packet,type,pesType,pusi,parsed;var endLoop=!1;while(endIndex<=bytes.byteLength){if(bytes[startIndex]===SYNC_BYTE&&(bytes[endIndex]===SYNC_BYTE||endIndex===bytes.byteLength)){packet=bytes.subarray(startIndex,endIndex);type=probe.ts.parseType(packet,pmt.pid);switch(type){case 'pes':pesType=probe.ts.parsePesType(packet,pmt.table);pusi=probe.ts.parsePayloadUnitStartIndicator(packet);if(pesType==='audio'&&pusi){parsed=probe.ts.parsePesTime(packet);if(parsed){parsed.type='audio';result.audio.push(parsed);endLoop=!0}}
break}
if(endLoop){break}
startIndex+=MP2T_PACKET_LENGTH;endIndex+=MP2T_PACKET_LENGTH;continue}
startIndex++;endIndex++}
endIndex=bytes.byteLength;startIndex=endIndex-MP2T_PACKET_LENGTH;endLoop=!1;while(startIndex>=0){if(bytes[startIndex]===SYNC_BYTE&&(bytes[endIndex]===SYNC_BYTE||endIndex===bytes.byteLength)){packet=bytes.subarray(startIndex,endIndex);type=probe.ts.parseType(packet,pmt.pid);switch(type){case 'pes':pesType=probe.ts.parsePesType(packet,pmt.table);pusi=probe.ts.parsePayloadUnitStartIndicator(packet);if(pesType==='audio'&&pusi){parsed=probe.ts.parsePesTime(packet);if(parsed){parsed.type='audio';result.audio.push(parsed);endLoop=!0}}
break}
if(endLoop){break}
startIndex-=MP2T_PACKET_LENGTH;endIndex-=MP2T_PACKET_LENGTH;continue}
startIndex--;endIndex--}};var parseVideoPes_=function parseVideoPes_(bytes,pmt,result){var startIndex=0,endIndex=MP2T_PACKET_LENGTH,packet,type,pesType,pusi,parsed,frame,i,pes;var endLoop=!1;var currentFrame={data:[],size:0};while(endIndex<bytes.byteLength){if(bytes[startIndex]===SYNC_BYTE&&bytes[endIndex]===SYNC_BYTE){packet=bytes.subarray(startIndex,endIndex);type=probe.ts.parseType(packet,pmt.pid);switch(type){case 'pes':pesType=probe.ts.parsePesType(packet,pmt.table);pusi=probe.ts.parsePayloadUnitStartIndicator(packet);if(pesType==='video'){if(pusi&&!endLoop){parsed=probe.ts.parsePesTime(packet);if(parsed){parsed.type='video';result.video.push(parsed);endLoop=!0}}
if(!result.firstKeyFrame){if(pusi){if(currentFrame.size!==0){frame=new Uint8Array(currentFrame.size);i=0;while(currentFrame.data.length){pes=currentFrame.data.shift();frame.set(pes,i);i+=pes.byteLength}
if(probe.ts.videoPacketContainsKeyFrame(frame)){var firstKeyFrame=probe.ts.parsePesTime(frame);if(firstKeyFrame){result.firstKeyFrame=firstKeyFrame;result.firstKeyFrame.type='video'}else{console.warn('Failed to extract PTS/DTS from PES at first keyframe. '+'This could be an unusual TS segment, or else mux.js did not '+'parse your TS segment correctly. If you know your TS '+'segments do contain PTS/DTS on keyframes please file a bug '+'report! You can try ffprobe to double check for yourself.')}}
currentFrame.size=0}}
currentFrame.data.push(packet);currentFrame.size+=packet.byteLength}}
break}
if(endLoop&&result.firstKeyFrame){break}
startIndex+=MP2T_PACKET_LENGTH;endIndex+=MP2T_PACKET_LENGTH;continue}
startIndex++;endIndex++}
endIndex=bytes.byteLength;startIndex=endIndex-MP2T_PACKET_LENGTH;endLoop=!1;while(startIndex>=0){if(bytes[startIndex]===SYNC_BYTE&&bytes[endIndex]===SYNC_BYTE){packet=bytes.subarray(startIndex,endIndex);type=probe.ts.parseType(packet,pmt.pid);switch(type){case 'pes':pesType=probe.ts.parsePesType(packet,pmt.table);pusi=probe.ts.parsePayloadUnitStartIndicator(packet);if(pesType==='video'&&pusi){parsed=probe.ts.parsePesTime(packet);if(parsed){parsed.type='video';result.video.push(parsed);endLoop=!0}}
break}
if(endLoop){break}
startIndex-=MP2T_PACKET_LENGTH;endIndex-=MP2T_PACKET_LENGTH;continue}
startIndex--;endIndex--}};var adjustTimestamp_=function adjustTimestamp_(segmentInfo,baseTimestamp){if(segmentInfo.audio&&segmentInfo.audio.length){var audioBaseTimestamp=baseTimestamp;if(typeof audioBaseTimestamp==='undefined'||isNaN(audioBaseTimestamp)){audioBaseTimestamp=segmentInfo.audio[0].dts}
segmentInfo.audio.forEach(function(info){info.dts=handleRollover(info.dts,audioBaseTimestamp);info.pts=handleRollover(info.pts,audioBaseTimestamp);info.dtsTime=info.dts/ONE_SECOND_IN_TS;info.ptsTime=info.pts/ONE_SECOND_IN_TS})}
if(segmentInfo.video&&segmentInfo.video.length){var videoBaseTimestamp=baseTimestamp;if(typeof videoBaseTimestamp==='undefined'||isNaN(videoBaseTimestamp)){videoBaseTimestamp=segmentInfo.video[0].dts}
segmentInfo.video.forEach(function(info){info.dts=handleRollover(info.dts,videoBaseTimestamp);info.pts=handleRollover(info.pts,videoBaseTimestamp);info.dtsTime=info.dts/ONE_SECOND_IN_TS;info.ptsTime=info.pts/ONE_SECOND_IN_TS});if(segmentInfo.firstKeyFrame){var frame=segmentInfo.firstKeyFrame;frame.dts=handleRollover(frame.dts,videoBaseTimestamp);frame.pts=handleRollover(frame.pts,videoBaseTimestamp);frame.dtsTime=frame.dts/ONE_SECOND_IN_TS;frame.ptsTime=frame.pts/ONE_SECOND_IN_TS}}};var inspectAac_=function inspectAac_(bytes){var endLoop=!1,audioCount=0,sampleRate=null,timestamp=null,frameSize=0,byteIndex=0,packet;while(bytes.length-byteIndex>=3){var type=probe.aac.parseType(bytes,byteIndex);switch(type){case 'timed-metadata':if(bytes.length-byteIndex<10){endLoop=!0;break}
frameSize=probe.aac.parseId3TagSize(bytes,byteIndex);if(frameSize>bytes.length){endLoop=!0;break}
if(timestamp===null){packet=bytes.subarray(byteIndex,byteIndex+frameSize);timestamp=probe.aac.parseAacTimestamp(packet)}
byteIndex+=frameSize;break;case 'audio':if(bytes.length-byteIndex<7){endLoop=!0;break}
frameSize=probe.aac.parseAdtsSize(bytes,byteIndex);if(frameSize>bytes.length){endLoop=!0;break}
if(sampleRate===null){packet=bytes.subarray(byteIndex,byteIndex+frameSize);sampleRate=probe.aac.parseSampleRate(packet)}
audioCount++;byteIndex+=frameSize;break;default:byteIndex++;break}
if(endLoop){return null}}
if(sampleRate===null||timestamp===null){return null}
var audioTimescale=ONE_SECOND_IN_TS/sampleRate;var result={audio:[{type:'audio',dts:timestamp,pts:timestamp},{type:'audio',dts:timestamp+audioCount*1024*audioTimescale,pts:timestamp+audioCount*1024*audioTimescale}]};return result};var inspectTs_=function inspectTs_(bytes){var pmt={pid:null,table:null};var result={};parsePsi_(bytes,pmt);for(var pid in pmt.table){if(pmt.table.hasOwnProperty(pid)){var type=pmt.table[pid];switch(type){case streamTypes.H264_STREAM_TYPE:result.video=[];parseVideoPes_(bytes,pmt,result);if(result.video.length===0){delete result.video}
break;case streamTypes.ADTS_STREAM_TYPE:result.audio=[];parseAudioPes_(bytes,pmt,result);if(result.audio.length===0){delete result.audio}
break}}}
return result};var inspect=function inspect(bytes,baseTimestamp){var isAacData=probe.aac.isLikelyAacData(bytes);var result;if(isAacData){result=inspectAac_(bytes)}else{result=inspectTs_(bytes)}
if(!result||!result.audio&&!result.video){return null}
adjustTimestamp_(result,baseTimestamp);return result};var tsInspector={inspect:inspect,parseAudioPes_:parseAudioPes_};var wireTransmuxerEvents=function wireTransmuxerEvents(self,transmuxer){transmuxer.on('data',function(segment){var initArray=segment.initSegment;segment.initSegment={data:initArray.buffer,byteOffset:initArray.byteOffset,byteLength:initArray.byteLength};var typedArray=segment.data;segment.data=typedArray.buffer;self.postMessage({action:'data',segment:segment,byteOffset:typedArray.byteOffset,byteLength:typedArray.byteLength},[segment.data])});transmuxer.on('done',function(data){self.postMessage({action:'done'})});transmuxer.on('gopInfo',function(gopInfo){self.postMessage({action:'gopInfo',gopInfo:gopInfo})});transmuxer.on('videoSegmentTimingInfo',function(timingInfo){var videoSegmentTimingInfo={start:{decode:clock.videoTsToSeconds(timingInfo.start.dts),presentation:clock.videoTsToSeconds(timingInfo.start.pts)},end:{decode:clock.videoTsToSeconds(timingInfo.end.dts),presentation:clock.videoTsToSeconds(timingInfo.end.pts)},baseMediaDecodeTime:clock.videoTsToSeconds(timingInfo.baseMediaDecodeTime)};if(timingInfo.prependedContentDuration){videoSegmentTimingInfo.prependedContentDuration=clock.videoTsToSeconds(timingInfo.prependedContentDuration)}
self.postMessage({action:'videoSegmentTimingInfo',videoSegmentTimingInfo:videoSegmentTimingInfo})});transmuxer.on('audioSegmentTimingInfo',function(timingInfo){var audioSegmentTimingInfo={start:{decode:clock.videoTsToSeconds(timingInfo.start.dts),presentation:clock.videoTsToSeconds(timingInfo.start.pts)},end:{decode:clock.videoTsToSeconds(timingInfo.end.dts),presentation:clock.videoTsToSeconds(timingInfo.end.pts)},baseMediaDecodeTime:clock.videoTsToSeconds(timingInfo.baseMediaDecodeTime)};if(timingInfo.prependedContentDuration){audioSegmentTimingInfo.prependedContentDuration=clock.videoTsToSeconds(timingInfo.prependedContentDuration)}
self.postMessage({action:'audioSegmentTimingInfo',audioSegmentTimingInfo:audioSegmentTimingInfo})});transmuxer.on('id3Frame',function(id3Frame){self.postMessage({action:'id3Frame',id3Frame:id3Frame})});transmuxer.on('caption',function(caption){self.postMessage({action:'caption',caption:caption})});transmuxer.on('trackinfo',function(trackInfo){self.postMessage({action:'trackinfo',trackInfo:trackInfo})});transmuxer.on('audioTimingInfo',function(audioTimingInfo){self.postMessage({action:'audioTimingInfo',audioTimingInfo:{start:clock.videoTsToSeconds(audioTimingInfo.start),end:clock.videoTsToSeconds(audioTimingInfo.end)}})});transmuxer.on('videoTimingInfo',function(videoTimingInfo){self.postMessage({action:'videoTimingInfo',videoTimingInfo:{start:clock.videoTsToSeconds(videoTimingInfo.start),end:clock.videoTsToSeconds(videoTimingInfo.end)}})});transmuxer.on('log',function(log){self.postMessage({action:'log',log:log})})};var MessageHandlers=function(){function MessageHandlers(self,options){this.options=options||{};this.self=self;this.init()}
var _proto=MessageHandlers.prototype;_proto.init=function init(){if(this.transmuxer){this.transmuxer.dispose()}
this.transmuxer=new transmuxer.Transmuxer(this.options);wireTransmuxerEvents(this.self,this.transmuxer)};_proto.pushMp4Captions=function pushMp4Captions(data){if(!this.captionParser){this.captionParser=new captionParser();this.captionParser.init()}
var segment=new Uint8Array(data.data,data.byteOffset,data.byteLength);var parsed=this.captionParser.parse(segment,data.trackIds,data.timescales);this.self.postMessage({action:'mp4Captions',captions:parsed&&parsed.captions||[],logs:parsed&&parsed.logs||[],data:segment.buffer},[segment.buffer])};_proto.probeMp4StartTime=function probeMp4StartTime(_ref){var timescales=_ref.timescales,data=_ref.data;var startTime=probe$2.startTime(timescales,data);this.self.postMessage({action:'probeMp4StartTime',startTime:startTime,data:data},[data.buffer])};_proto.probeMp4Tracks=function probeMp4Tracks(_ref2){var data=_ref2.data;var tracks=probe$2.tracks(data);this.self.postMessage({action:'probeMp4Tracks',tracks:tracks,data:data},[data.buffer])};_proto.probeTs=function probeTs(_ref3){var data=_ref3.data,baseStartTime=_ref3.baseStartTime;var tsStartTime=typeof baseStartTime==='number'&&!isNaN(baseStartTime)?baseStartTime*clock.ONE_SECOND_IN_TS:void 0;var timeInfo=tsInspector.inspect(data,tsStartTime);var result=null;if(timeInfo){result={hasVideo:timeInfo.video&&timeInfo.video.length===2||!1,hasAudio:timeInfo.audio&&timeInfo.audio.length===2||!1};if(result.hasVideo){result.videoStart=timeInfo.video[0].ptsTime}
if(result.hasAudio){result.audioStart=timeInfo.audio[0].ptsTime}}
this.self.postMessage({action:'probeTs',result:result,data:data},[data.buffer])};_proto.clearAllMp4Captions=function clearAllMp4Captions(){if(this.captionParser){this.captionParser.clearAllCaptions()}};_proto.clearParsedMp4Captions=function clearParsedMp4Captions(){if(this.captionParser){this.captionParser.clearParsedCaptions()}};_proto.push=function push(data){var segment=new Uint8Array(data.data,data.byteOffset,data.byteLength);this.transmuxer.push(segment)};_proto.reset=function reset(){this.transmuxer.reset()};_proto.setTimestampOffset=function setTimestampOffset(data){var timestampOffset=data.timestampOffset||0;this.transmuxer.setBaseMediaDecodeTime(Math.round(clock.secondsToVideoTs(timestampOffset)))};_proto.setAudioAppendStart=function setAudioAppendStart(data){this.transmuxer.setAudioAppendStart(Math.ceil(clock.secondsToVideoTs(data.appendStart)))};_proto.setRemux=function setRemux(data){this.transmuxer.setRemux(data.remux)};_proto.flush=function flush(data){this.transmuxer.flush();self.postMessage({action:'done',type:'transmuxed'})};_proto.endTimeline=function endTimeline(){this.transmuxer.endTimeline();self.postMessage({action:'endedtimeline',type:'transmuxed'})};_proto.alignGopsWith=function alignGopsWith(data){this.transmuxer.alignGopsWith(data.gopsToAlignWith.slice())};return MessageHandlers}();self.onmessage=function(event){if(event.data.action==='init'&&event.data.options){this.messageHandlers=new MessageHandlers(self,event.data.options);return}
if(!this.messageHandlers){this.messageHandlers=new MessageHandlers(self)}
if(event.data&&event.data.action&&event.data.action!=='init'){if(this.messageHandlers[event.data.action]){this.messageHandlers[event.data.action](event.data)}}}}));var TransmuxWorker=factory(workerCode$1);var handleData_=function handleData_(event,transmuxedData,callback){var _event$data$segment=event.data.segment,type=_event$data$segment.type,initSegment=_event$data$segment.initSegment,captions=_event$data$segment.captions,captionStreams=_event$data$segment.captionStreams,metadata=_event$data$segment.metadata,videoFrameDtsTime=_event$data$segment.videoFrameDtsTime,videoFramePtsTime=_event$data$segment.videoFramePtsTime;transmuxedData.buffer.push({captions:captions,captionStreams:captionStreams,metadata:metadata});var boxes=event.data.segment.boxes||{data:event.data.segment.data};var result={type:type,data:new Uint8Array(boxes.data,boxes.data.byteOffset,boxes.data.byteLength),initSegment:new Uint8Array(initSegment.data,initSegment.byteOffset,initSegment.byteLength)};if(typeof videoFrameDtsTime!=='undefined'){result.videoFrameDtsTime=videoFrameDtsTime}
if(typeof videoFramePtsTime!=='undefined'){result.videoFramePtsTime=videoFramePtsTime}
callback(result)};var handleDone_=function handleDone_(_ref){var transmuxedData=_ref.transmuxedData,callback=_ref.callback;transmuxedData.buffer=[];callback(transmuxedData)};var handleGopInfo_=function handleGopInfo_(event,transmuxedData){transmuxedData.gopInfo=event.data.gopInfo};var processTransmux=function processTransmux(options){var transmuxer=options.transmuxer,bytes=options.bytes,audioAppendStart=options.audioAppendStart,gopsToAlignWith=options.gopsToAlignWith,remux=options.remux,onData=options.onData,onTrackInfo=options.onTrackInfo,onAudioTimingInfo=options.onAudioTimingInfo,onVideoTimingInfo=options.onVideoTimingInfo,onVideoSegmentTimingInfo=options.onVideoSegmentTimingInfo,onAudioSegmentTimingInfo=options.onAudioSegmentTimingInfo,onId3=options.onId3,onCaptions=options.onCaptions,onDone=options.onDone,onEndedTimeline=options.onEndedTimeline,onTransmuxerLog=options.onTransmuxerLog,isEndOfTimeline=options.isEndOfTimeline;var transmuxedData={buffer:[]};var waitForEndedTimelineEvent=isEndOfTimeline;var handleMessage=function handleMessage(event){if(transmuxer.currentTransmux!==options){return}
if(event.data.action==='data'){handleData_(event,transmuxedData,onData)}
if(event.data.action==='trackinfo'){onTrackInfo(event.data.trackInfo)}
if(event.data.action==='gopInfo'){handleGopInfo_(event,transmuxedData)}
if(event.data.action==='audioTimingInfo'){onAudioTimingInfo(event.data.audioTimingInfo)}
if(event.data.action==='videoTimingInfo'){onVideoTimingInfo(event.data.videoTimingInfo)}
if(event.data.action==='videoSegmentTimingInfo'){onVideoSegmentTimingInfo(event.data.videoSegmentTimingInfo)}
if(event.data.action==='audioSegmentTimingInfo'){onAudioSegmentTimingInfo(event.data.audioSegmentTimingInfo)}
if(event.data.action==='id3Frame'){onId3([event.data.id3Frame],event.data.id3Frame.dispatchType)}
if(event.data.action==='caption'){onCaptions(event.data.caption)}
if(event.data.action==='endedtimeline'){waitForEndedTimelineEvent=!1;onEndedTimeline()}
if(event.data.action==='log'){onTransmuxerLog(event.data.log)}
if(event.data.type!=='transmuxed'){return}
if(waitForEndedTimelineEvent){return}
transmuxer.onmessage=null;handleDone_({transmuxedData:transmuxedData,callback:onDone});dequeue(transmuxer)};transmuxer.onmessage=handleMessage;if(audioAppendStart){transmuxer.postMessage({action:'setAudioAppendStart',appendStart:audioAppendStart})}
if(Array.isArray(gopsToAlignWith)){transmuxer.postMessage({action:'alignGopsWith',gopsToAlignWith:gopsToAlignWith})}
if(typeof remux!=='undefined'){transmuxer.postMessage({action:'setRemux',remux:remux})}
if(bytes.byteLength){var buffer=bytes instanceof ArrayBuffer?bytes:bytes.buffer;var byteOffset=bytes instanceof ArrayBuffer?0:bytes.byteOffset;transmuxer.postMessage({action:'push',data:buffer,byteOffset:byteOffset,byteLength:bytes.byteLength},[buffer])}
if(isEndOfTimeline){transmuxer.postMessage({action:'endTimeline'})}
transmuxer.postMessage({action:'flush'})};var dequeue=function dequeue(transmuxer){transmuxer.currentTransmux=null;if(transmuxer.transmuxQueue.length){transmuxer.currentTransmux=transmuxer.transmuxQueue.shift();if(typeof transmuxer.currentTransmux==='function'){transmuxer.currentTransmux()}else{processTransmux(transmuxer.currentTransmux)}}};var processAction=function processAction(transmuxer,action){transmuxer.postMessage({action:action});dequeue(transmuxer)};var enqueueAction=function enqueueAction(action,transmuxer){if(!transmuxer.currentTransmux){transmuxer.currentTransmux=action;processAction(transmuxer,action);return}
transmuxer.transmuxQueue.push(processAction.bind(null,transmuxer,action))};var reset=function reset(transmuxer){enqueueAction('reset',transmuxer)};var endTimeline=function endTimeline(transmuxer){enqueueAction('endTimeline',transmuxer)};var transmux=function transmux(options){if(!options.transmuxer.currentTransmux){options.transmuxer.currentTransmux=options;processTransmux(options);return}
options.transmuxer.transmuxQueue.push(options)};var createTransmuxer=function createTransmuxer(options){var transmuxer=new TransmuxWorker();transmuxer.currentTransmux=null;transmuxer.transmuxQueue=[];var term=transmuxer.terminate;transmuxer.terminate=function(){transmuxer.currentTransmux=null;transmuxer.transmuxQueue.length=0;return term.call(transmuxer)};transmuxer.postMessage({action:'init',options:options});return transmuxer};var segmentTransmuxer={reset:reset,endTimeline:endTimeline,transmux:transmux,createTransmuxer:createTransmuxer};var workerCallback=function workerCallback(options){var transmuxer=options.transmuxer;var endAction=options.endAction||options.action;var callback=options.callback;var message=_extends_1({},options,{endAction:null,transmuxer:null,callback:null});var listenForEndEvent=function listenForEndEvent(event){if(event.data.action!==endAction){return}
transmuxer.removeEventListener('message',listenForEndEvent);if(event.data.data){event.data.data=new Uint8Array(event.data.data,options.byteOffset||0,options.byteLength||event.data.data.byteLength);if(options.data){options.data=event.data.data}}
callback(event.data)};transmuxer.addEventListener('message',listenForEndEvent);if(options.data){var isArrayBuffer=options.data instanceof ArrayBuffer;message.byteOffset=isArrayBuffer?0:options.data.byteOffset;message.byteLength=options.data.byteLength;var transfers=[isArrayBuffer?options.data:options.data.buffer];transmuxer.postMessage(message,transfers)}else{transmuxer.postMessage(message)}};var REQUEST_ERRORS={FAILURE:2,TIMEOUT:-101,ABORTED:-102};var abortAll=function abortAll(activeXhrs){activeXhrs.forEach(function(xhr){xhr.abort()})};var getRequestStats=function getRequestStats(request){return{bandwidth:request.bandwidth,bytesReceived:request.bytesReceived||0,roundTripTime:request.roundTripTime||0}};var getProgressStats=function getProgressStats(progressEvent){var request=progressEvent.target;var roundTripTime=Date.now()-request.requestTime;var stats={bandwidth:Infinity,bytesReceived:0,roundTripTime:roundTripTime||0};stats.bytesReceived=progressEvent.loaded;stats.bandwidth=Math.floor(stats.bytesReceived/stats.roundTripTime*8*1000);return stats};var handleErrors=function handleErrors(error,request){if(request.timedout){return{status:request.status,message:'HLS request timed-out at URL: '+request.uri,code:REQUEST_ERRORS.TIMEOUT,xhr:request}}
if(request.aborted){return{status:request.status,message:'HLS request aborted at URL: '+request.uri,code:REQUEST_ERRORS.ABORTED,xhr:request}}
if(error){return{status:request.status,message:'HLS request errored at URL: '+request.uri,code:REQUEST_ERRORS.FAILURE,xhr:request}}
if(request.responseType==='arraybuffer'&&request.response.byteLength===0){return{status:request.status,message:'Empty HLS response at URL: '+request.uri,code:REQUEST_ERRORS.FAILURE,xhr:request}}
return null};var handleKeyResponse=function handleKeyResponse(segment,objects,finishProcessingFn){return function(error,request){var response=request.response;var errorObj=handleErrors(error,request);if(errorObj){return finishProcessingFn(errorObj,segment)}
if(response.byteLength!==16){return finishProcessingFn({status:request.status,message:'Invalid HLS key at URL: '+request.uri,code:REQUEST_ERRORS.FAILURE,xhr:request},segment)}
var view=new DataView(response);var bytes=new Uint32Array([view.getUint32(0),view.getUint32(4),view.getUint32(8),view.getUint32(12)]);for(var i=0;i<objects.length;i++){objects[i].bytes=bytes}
return finishProcessingFn(null,segment)}};var parseInitSegment=function parseInitSegment(segment,_callback){var type=detectContainerForBytes(segment.map.bytes);if(type!=='mp4'){var uri=segment.map.resolvedUri||segment.map.uri;return _callback({internal:!0,message:"Found unsupported "+(type||'unknown')+" container for initialization segment at URL: "+uri,code:REQUEST_ERRORS.FAILURE})}
workerCallback({action:'probeMp4Tracks',data:segment.map.bytes,transmuxer:segment.transmuxer,callback:function callback(_ref){var tracks=_ref.tracks,data=_ref.data;segment.map.bytes=data;tracks.forEach(function(track){segment.map.tracks=segment.map.tracks||{};if(segment.map.tracks[track.type]){return}
segment.map.tracks[track.type]=track;if(typeof track.id==='number'&&track.timescale){segment.map.timescales=segment.map.timescales||{};segment.map.timescales[track.id]=track.timescale}});return _callback(null)}})};var handleInitSegmentResponse=function handleInitSegmentResponse(_ref2){var segment=_ref2.segment,finishProcessingFn=_ref2.finishProcessingFn;return function(error,request){var errorObj=handleErrors(error,request);if(errorObj){return finishProcessingFn(errorObj,segment)}
var bytes=new Uint8Array(request.response);if(segment.map.key){segment.map.encryptedBytes=bytes;return finishProcessingFn(null,segment)}
segment.map.bytes=bytes;parseInitSegment(segment,function(parseError){if(parseError){parseError.xhr=request;parseError.status=request.status;return finishProcessingFn(parseError,segment)}
finishProcessingFn(null,segment)})}};var handleSegmentResponse=function handleSegmentResponse(_ref3){var segment=_ref3.segment,finishProcessingFn=_ref3.finishProcessingFn,responseType=_ref3.responseType;return function(error,request){var errorObj=handleErrors(error,request);if(errorObj){return finishProcessingFn(errorObj,segment)}
var newBytes=responseType==='arraybuffer'||!request.responseText?request.response:stringToArrayBuffer(request.responseText.substring(segment.lastReachedChar||0));segment.stats=getRequestStats(request);if(segment.key){segment.encryptedBytes=new Uint8Array(newBytes)}else{segment.bytes=new Uint8Array(newBytes)}
return finishProcessingFn(null,segment)}};var transmuxAndNotify=function transmuxAndNotify(_ref4){var segment=_ref4.segment,bytes=_ref4.bytes,trackInfoFn=_ref4.trackInfoFn,timingInfoFn=_ref4.timingInfoFn,videoSegmentTimingInfoFn=_ref4.videoSegmentTimingInfoFn,audioSegmentTimingInfoFn=_ref4.audioSegmentTimingInfoFn,id3Fn=_ref4.id3Fn,captionsFn=_ref4.captionsFn,isEndOfTimeline=_ref4.isEndOfTimeline,endedTimelineFn=_ref4.endedTimelineFn,dataFn=_ref4.dataFn,doneFn=_ref4.doneFn,onTransmuxerLog=_ref4.onTransmuxerLog;var fmp4Tracks=segment.map&&segment.map.tracks||{};var isMuxed=Boolean(fmp4Tracks.audio&&fmp4Tracks.video);var audioStartFn=timingInfoFn.bind(null,segment,'audio','start');var audioEndFn=timingInfoFn.bind(null,segment,'audio','end');var videoStartFn=timingInfoFn.bind(null,segment,'video','start');var videoEndFn=timingInfoFn.bind(null,segment,'video','end');var finish=function finish(){return transmux({bytes:bytes,transmuxer:segment.transmuxer,audioAppendStart:segment.audioAppendStart,gopsToAlignWith:segment.gopsToAlignWith,remux:isMuxed,onData:function onData(result){result.type=result.type==='combined'?'video':result.type;dataFn(segment,result)},onTrackInfo:function onTrackInfo(trackInfo){if(trackInfoFn){if(isMuxed){trackInfo.isMuxed=!0}
trackInfoFn(segment,trackInfo)}},onAudioTimingInfo:function onAudioTimingInfo(audioTimingInfo){if(audioStartFn&&typeof audioTimingInfo.start!=='undefined'){audioStartFn(audioTimingInfo.start);audioStartFn=null}
if(audioEndFn&&typeof audioTimingInfo.end!=='undefined'){audioEndFn(audioTimingInfo.end)}},onVideoTimingInfo:function onVideoTimingInfo(videoTimingInfo){if(videoStartFn&&typeof videoTimingInfo.start!=='undefined'){videoStartFn(videoTimingInfo.start);videoStartFn=null}
if(videoEndFn&&typeof videoTimingInfo.end!=='undefined'){videoEndFn(videoTimingInfo.end)}},onVideoSegmentTimingInfo:function onVideoSegmentTimingInfo(videoSegmentTimingInfo){videoSegmentTimingInfoFn(videoSegmentTimingInfo)},onAudioSegmentTimingInfo:function onAudioSegmentTimingInfo(audioSegmentTimingInfo){audioSegmentTimingInfoFn(audioSegmentTimingInfo)},onId3:function onId3(id3Frames,dispatchType){id3Fn(segment,id3Frames,dispatchType)},onCaptions:function onCaptions(captions){captionsFn(segment,[captions])},isEndOfTimeline:isEndOfTimeline,onEndedTimeline:function onEndedTimeline(){endedTimelineFn()},onTransmuxerLog:onTransmuxerLog,onDone:function onDone(result){if(!doneFn){return}
result.type=result.type==='combined'?'video':result.type;doneFn(null,segment,result)}})};workerCallback({action:'probeTs',transmuxer:segment.transmuxer,data:bytes,baseStartTime:segment.baseStartTime,callback:function callback(data){segment.bytes=bytes=data.data;var probeResult=data.result;if(probeResult){trackInfoFn(segment,{hasAudio:probeResult.hasAudio,hasVideo:probeResult.hasVideo,isMuxed:isMuxed});trackInfoFn=null;if(probeResult.hasAudio&&!isMuxed){audioStartFn(probeResult.audioStart)}
if(probeResult.hasVideo){videoStartFn(probeResult.videoStart)}
audioStartFn=null;videoStartFn=null}
finish()}})};var handleSegmentBytes=function handleSegmentBytes(_ref5){var segment=_ref5.segment,bytes=_ref5.bytes,trackInfoFn=_ref5.trackInfoFn,timingInfoFn=_ref5.timingInfoFn,videoSegmentTimingInfoFn=_ref5.videoSegmentTimingInfoFn,audioSegmentTimingInfoFn=_ref5.audioSegmentTimingInfoFn,id3Fn=_ref5.id3Fn,captionsFn=_ref5.captionsFn,isEndOfTimeline=_ref5.isEndOfTimeline,endedTimelineFn=_ref5.endedTimelineFn,dataFn=_ref5.dataFn,doneFn=_ref5.doneFn,onTransmuxerLog=_ref5.onTransmuxerLog;var bytesAsUint8Array=new Uint8Array(bytes);if(isLikelyFmp4MediaSegment(bytesAsUint8Array)){segment.isFmp4=!0;var tracks=segment.map.tracks;var trackInfo={isFmp4:!0,hasVideo:!!tracks.video,hasAudio:!!tracks.audio};if(tracks.audio&&tracks.audio.codec&&tracks.audio.codec!=='enca'){trackInfo.audioCodec=tracks.audio.codec}
if(tracks.video&&tracks.video.codec&&tracks.video.codec!=='encv'){trackInfo.videoCodec=tracks.video.codec}
if(tracks.video&&tracks.audio){trackInfo.isMuxed=!0}
trackInfoFn(segment,trackInfo);var finishLoading=function finishLoading(captions){dataFn(segment,{data:bytesAsUint8Array,type:trackInfo.hasAudio&&!trackInfo.isMuxed?'audio':'video'});if(captions&&captions.length){captionsFn(segment,captions)}
doneFn(null,segment,{})};workerCallback({action:'probeMp4StartTime',timescales:segment.map.timescales,data:bytesAsUint8Array,transmuxer:segment.transmuxer,callback:function callback(_ref6){var data=_ref6.data,startTime=_ref6.startTime;bytes=data.buffer;segment.bytes=bytesAsUint8Array=data;if(trackInfo.hasAudio&&!trackInfo.isMuxed){timingInfoFn(segment,'audio','start',startTime)}
if(trackInfo.hasVideo){timingInfoFn(segment,'video','start',startTime)}
if(!tracks.video||!data.byteLength||!segment.transmuxer){finishLoading();return}
workerCallback({action:'pushMp4Captions',endAction:'mp4Captions',transmuxer:segment.transmuxer,data:bytesAsUint8Array,timescales:segment.map.timescales,trackIds:[tracks.video.id],callback:function callback(message){bytes=message.data.buffer;segment.bytes=bytesAsUint8Array=message.data;message.logs.forEach(function(log){onTransmuxerLog(videojs__default["default"].mergeOptions(log,{stream:'mp4CaptionParser'}))});finishLoading(message.captions)}})}});return}
if(!segment.transmuxer){doneFn(null,segment,{});return}
if(typeof segment.container==='undefined'){segment.container=detectContainerForBytes(bytesAsUint8Array)}
if(segment.container!=='ts'&&segment.container!=='aac'){trackInfoFn(segment,{hasAudio:!1,hasVideo:!1});doneFn(null,segment,{});return}
transmuxAndNotify({segment:segment,bytes:bytes,trackInfoFn:trackInfoFn,timingInfoFn:timingInfoFn,videoSegmentTimingInfoFn:videoSegmentTimingInfoFn,audioSegmentTimingInfoFn:audioSegmentTimingInfoFn,id3Fn:id3Fn,captionsFn:captionsFn,isEndOfTimeline:isEndOfTimeline,endedTimelineFn:endedTimelineFn,dataFn:dataFn,doneFn:doneFn,onTransmuxerLog:onTransmuxerLog})};var decrypt=function decrypt(_ref7,callback){var id=_ref7.id,key=_ref7.key,encryptedBytes=_ref7.encryptedBytes,decryptionWorker=_ref7.decryptionWorker;var decryptionHandler=function decryptionHandler(event){if(event.data.source===id){decryptionWorker.removeEventListener('message',decryptionHandler);var decrypted=event.data.decrypted;callback(new Uint8Array(decrypted.bytes,decrypted.byteOffset,decrypted.byteLength))}};decryptionWorker.addEventListener('message',decryptionHandler);var keyBytes;if(key.bytes.slice){keyBytes=key.bytes.slice()}else{keyBytes=new Uint32Array(Array.prototype.slice.call(key.bytes))}
decryptionWorker.postMessage(createTransferableMessage({source:id,encrypted:encryptedBytes,key:keyBytes,iv:key.iv}),[encryptedBytes.buffer,keyBytes.buffer])};var decryptSegment=function decryptSegment(_ref8){var decryptionWorker=_ref8.decryptionWorker,segment=_ref8.segment,trackInfoFn=_ref8.trackInfoFn,timingInfoFn=_ref8.timingInfoFn,videoSegmentTimingInfoFn=_ref8.videoSegmentTimingInfoFn,audioSegmentTimingInfoFn=_ref8.audioSegmentTimingInfoFn,id3Fn=_ref8.id3Fn,captionsFn=_ref8.captionsFn,isEndOfTimeline=_ref8.isEndOfTimeline,endedTimelineFn=_ref8.endedTimelineFn,dataFn=_ref8.dataFn,doneFn=_ref8.doneFn,onTransmuxerLog=_ref8.onTransmuxerLog;decrypt({id:segment.requestId,key:segment.key,encryptedBytes:segment.encryptedBytes,decryptionWorker:decryptionWorker},function(decryptedBytes){segment.bytes=decryptedBytes;handleSegmentBytes({segment:segment,bytes:segment.bytes,trackInfoFn:trackInfoFn,timingInfoFn:timingInfoFn,videoSegmentTimingInfoFn:videoSegmentTimingInfoFn,audioSegmentTimingInfoFn:audioSegmentTimingInfoFn,id3Fn:id3Fn,captionsFn:captionsFn,isEndOfTimeline:isEndOfTimeline,endedTimelineFn:endedTimelineFn,dataFn:dataFn,doneFn:doneFn,onTransmuxerLog:onTransmuxerLog})})};var waitForCompletion=function waitForCompletion(_ref9){var activeXhrs=_ref9.activeXhrs,decryptionWorker=_ref9.decryptionWorker,trackInfoFn=_ref9.trackInfoFn,timingInfoFn=_ref9.timingInfoFn,videoSegmentTimingInfoFn=_ref9.videoSegmentTimingInfoFn,audioSegmentTimingInfoFn=_ref9.audioSegmentTimingInfoFn,id3Fn=_ref9.id3Fn,captionsFn=_ref9.captionsFn,isEndOfTimeline=_ref9.isEndOfTimeline,endedTimelineFn=_ref9.endedTimelineFn,dataFn=_ref9.dataFn,doneFn=_ref9.doneFn,onTransmuxerLog=_ref9.onTransmuxerLog;var count=0;var didError=!1;return function(error,segment){if(didError){return}
if(error){didError=!0;abortAll(activeXhrs);return doneFn(error,segment)}
count+=1;if(count===activeXhrs.length){var segmentFinish=function segmentFinish(){if(segment.encryptedBytes){return decryptSegment({decryptionWorker:decryptionWorker,segment:segment,trackInfoFn:trackInfoFn,timingInfoFn:timingInfoFn,videoSegmentTimingInfoFn:videoSegmentTimingInfoFn,audioSegmentTimingInfoFn:audioSegmentTimingInfoFn,id3Fn:id3Fn,captionsFn:captionsFn,isEndOfTimeline:isEndOfTimeline,endedTimelineFn:endedTimelineFn,dataFn:dataFn,doneFn:doneFn,onTransmuxerLog:onTransmuxerLog})}
handleSegmentBytes({segment:segment,bytes:segment.bytes,trackInfoFn:trackInfoFn,timingInfoFn:timingInfoFn,videoSegmentTimingInfoFn:videoSegmentTimingInfoFn,audioSegmentTimingInfoFn:audioSegmentTimingInfoFn,id3Fn:id3Fn,captionsFn:captionsFn,isEndOfTimeline:isEndOfTimeline,endedTimelineFn:endedTimelineFn,dataFn:dataFn,doneFn:doneFn,onTransmuxerLog:onTransmuxerLog})};segment.endOfAllRequests=Date.now();if(segment.map&&segment.map.encryptedBytes&&!segment.map.bytes){return decrypt({decryptionWorker:decryptionWorker,id:segment.requestId+'-init',encryptedBytes:segment.map.encryptedBytes,key:segment.map.key},function(decryptedBytes){segment.map.bytes=decryptedBytes;parseInitSegment(segment,function(parseError){if(parseError){abortAll(activeXhrs);return doneFn(parseError,segment)}
segmentFinish()})})}
segmentFinish()}}};var handleLoadEnd=function handleLoadEnd(_ref10){var loadendState=_ref10.loadendState,abortFn=_ref10.abortFn;return function(event){var request=event.target;if(request.aborted&&abortFn&&!loadendState.calledAbortFn){abortFn();loadendState.calledAbortFn=!0}}};var handleProgress=function handleProgress(_ref11){var segment=_ref11.segment,progressFn=_ref11.progressFn;_ref11.trackInfoFn;_ref11.timingInfoFn;_ref11.videoSegmentTimingInfoFn;_ref11.audioSegmentTimingInfoFn;_ref11.id3Fn;_ref11.captionsFn;_ref11.isEndOfTimeline;_ref11.endedTimelineFn;_ref11.dataFn;return function(event){var request=event.target;if(request.aborted){return}
segment.stats=videojs__default["default"].mergeOptions(segment.stats,getProgressStats(event));if(!segment.stats.firstBytesReceivedAt&&segment.stats.bytesReceived){segment.stats.firstBytesReceivedAt=Date.now()}
return progressFn(event,segment)}};var mediaSegmentRequest=function mediaSegmentRequest(_ref12){var xhr=_ref12.xhr,xhrOptions=_ref12.xhrOptions,decryptionWorker=_ref12.decryptionWorker,segment=_ref12.segment,abortFn=_ref12.abortFn,progressFn=_ref12.progressFn,trackInfoFn=_ref12.trackInfoFn,timingInfoFn=_ref12.timingInfoFn,videoSegmentTimingInfoFn=_ref12.videoSegmentTimingInfoFn,audioSegmentTimingInfoFn=_ref12.audioSegmentTimingInfoFn,id3Fn=_ref12.id3Fn,captionsFn=_ref12.captionsFn,isEndOfTimeline=_ref12.isEndOfTimeline,endedTimelineFn=_ref12.endedTimelineFn,dataFn=_ref12.dataFn,doneFn=_ref12.doneFn,onTransmuxerLog=_ref12.onTransmuxerLog;var activeXhrs=[];var finishProcessingFn=waitForCompletion({activeXhrs:activeXhrs,decryptionWorker:decryptionWorker,trackInfoFn:trackInfoFn,timingInfoFn:timingInfoFn,videoSegmentTimingInfoFn:videoSegmentTimingInfoFn,audioSegmentTimingInfoFn:audioSegmentTimingInfoFn,id3Fn:id3Fn,captionsFn:captionsFn,isEndOfTimeline:isEndOfTimeline,endedTimelineFn:endedTimelineFn,dataFn:dataFn,doneFn:doneFn,onTransmuxerLog:onTransmuxerLog});if(segment.key&&!segment.key.bytes){var objects=[segment.key];if(segment.map&&!segment.map.bytes&&segment.map.key&&segment.map.key.resolvedUri===segment.key.resolvedUri){objects.push(segment.map.key)}
var keyRequestOptions=videojs__default["default"].mergeOptions(xhrOptions,{uri:segment.key.resolvedUri,responseType:'arraybuffer'});var keyRequestCallback=handleKeyResponse(segment,objects,finishProcessingFn);var keyXhr=xhr(keyRequestOptions,keyRequestCallback);activeXhrs.push(keyXhr)}
if(segment.map&&!segment.map.bytes){var differentMapKey=segment.map.key&&(!segment.key||segment.key.resolvedUri!==segment.map.key.resolvedUri);if(differentMapKey){var mapKeyRequestOptions=videojs__default["default"].mergeOptions(xhrOptions,{uri:segment.map.key.resolvedUri,responseType:'arraybuffer'});var mapKeyRequestCallback=handleKeyResponse(segment,[segment.map.key],finishProcessingFn);var mapKeyXhr=xhr(mapKeyRequestOptions,mapKeyRequestCallback);activeXhrs.push(mapKeyXhr)}
var initSegmentOptions=videojs__default["default"].mergeOptions(xhrOptions,{uri:segment.map.resolvedUri,responseType:'arraybuffer',headers:segmentXhrHeaders(segment.map)});var initSegmentRequestCallback=handleInitSegmentResponse({segment:segment,finishProcessingFn:finishProcessingFn});var initSegmentXhr=xhr(initSegmentOptions,initSegmentRequestCallback);activeXhrs.push(initSegmentXhr)}
var segmentRequestOptions=videojs__default["default"].mergeOptions(xhrOptions,{uri:segment.part&&segment.part.resolvedUri||segment.resolvedUri,responseType:'arraybuffer',headers:segmentXhrHeaders(segment)});var segmentRequestCallback=handleSegmentResponse({segment:segment,finishProcessingFn:finishProcessingFn,responseType:segmentRequestOptions.responseType});var segmentXhr=xhr(segmentRequestOptions,segmentRequestCallback);segmentXhr.addEventListener('progress',handleProgress({segment:segment,progressFn:progressFn,trackInfoFn:trackInfoFn,timingInfoFn:timingInfoFn,videoSegmentTimingInfoFn:videoSegmentTimingInfoFn,audioSegmentTimingInfoFn:audioSegmentTimingInfoFn,id3Fn:id3Fn,captionsFn:captionsFn,isEndOfTimeline:isEndOfTimeline,endedTimelineFn:endedTimelineFn,dataFn:dataFn}));activeXhrs.push(segmentXhr);var loadendState={};activeXhrs.forEach(function(activeXhr){activeXhr.addEventListener('loadend',handleLoadEnd({loadendState:loadendState,abortFn:abortFn}))});return function(){return abortAll(activeXhrs)}};var logFn$1=logger('CodecUtils');var getCodecs=function getCodecs(media){var mediaAttributes=media.attributes||{};if(mediaAttributes.CODECS){return parseCodecs(mediaAttributes.CODECS)}};var isMaat=function isMaat(master,media){var mediaAttributes=media.attributes||{};return master&&master.mediaGroups&&master.mediaGroups.AUDIO&&mediaAttributes.AUDIO&&master.mediaGroups.AUDIO[mediaAttributes.AUDIO]};var isMuxed=function isMuxed(master,media){if(!isMaat(master,media)){return!0}
var mediaAttributes=media.attributes||{};var audioGroup=master.mediaGroups.AUDIO[mediaAttributes.AUDIO];for(var groupId in audioGroup){if(!audioGroup[groupId].uri&&!audioGroup[groupId].playlists){return!0}}
return!1};var unwrapCodecList=function unwrapCodecList(codecList){var codecs={};codecList.forEach(function(_ref){var mediaType=_ref.mediaType,type=_ref.type,details=_ref.details;codecs[mediaType]=codecs[mediaType]||[];codecs[mediaType].push(translateLegacyCodec(""+type+details))});Object.keys(codecs).forEach(function(mediaType){if(codecs[mediaType].length>1){logFn$1("multiple "+mediaType+" codecs found as attributes: "+codecs[mediaType].join(', ')+". Setting playlist codecs to null so that we wait for mux.js to probe segments for real codecs.");codecs[mediaType]=null;return}
codecs[mediaType]=codecs[mediaType][0]});return codecs};var codecCount=function codecCount(codecObj){var count=0;if(codecObj.audio){count++}
if(codecObj.video){count++}
return count};var codecsForPlaylist=function codecsForPlaylist(master,media){var mediaAttributes=media.attributes||{};var codecInfo=unwrapCodecList(getCodecs(media)||[]);if(isMaat(master,media)&&!codecInfo.audio){if(!isMuxed(master,media)){var defaultCodecs=unwrapCodecList(codecsFromDefault(master,mediaAttributes.AUDIO)||[]);if(defaultCodecs.audio){codecInfo.audio=defaultCodecs.audio}}}
return codecInfo};var logFn=logger('PlaylistSelector');var representationToString=function representationToString(representation){if(!representation||!representation.playlist){return}
var playlist=representation.playlist;return JSON.stringify({id:playlist.id,bandwidth:representation.bandwidth,width:representation.width,height:representation.height,codecs:playlist.attributes&&playlist.attributes.CODECS||''})};var safeGetComputedStyle=function safeGetComputedStyle(el,property){if(!el){return''}
var result=window.getComputedStyle(el);if(!result){return''}
return result[property]};var stableSort=function stableSort(array,sortFn){var newArray=array.slice();array.sort(function(left,right){var cmp=sortFn(left,right);if(cmp===0){return newArray.indexOf(left)-newArray.indexOf(right)}
return cmp})};var comparePlaylistBandwidth=function comparePlaylistBandwidth(left,right){var leftBandwidth;var rightBandwidth;if(left.attributes.BANDWIDTH){leftBandwidth=left.attributes.BANDWIDTH}
leftBandwidth=leftBandwidth||window.Number.MAX_VALUE;if(right.attributes.BANDWIDTH){rightBandwidth=right.attributes.BANDWIDTH}
rightBandwidth=rightBandwidth||window.Number.MAX_VALUE;return leftBandwidth-rightBandwidth};var comparePlaylistResolution=function comparePlaylistResolution(left,right){var leftWidth;var rightWidth;if(left.attributes.RESOLUTION&&left.attributes.RESOLUTION.width){leftWidth=left.attributes.RESOLUTION.width}
leftWidth=leftWidth||window.Number.MAX_VALUE;if(right.attributes.RESOLUTION&&right.attributes.RESOLUTION.width){rightWidth=right.attributes.RESOLUTION.width}
rightWidth=rightWidth||window.Number.MAX_VALUE;if(leftWidth===rightWidth&&left.attributes.BANDWIDTH&&right.attributes.BANDWIDTH){return left.attributes.BANDWIDTH-right.attributes.BANDWIDTH}
return leftWidth-rightWidth};var simpleSelector=function simpleSelector(master,playerBandwidth,playerWidth,playerHeight,limitRenditionByPlayerDimensions,masterPlaylistController){if(!master){return}
var options={bandwidth:playerBandwidth,width:playerWidth,height:playerHeight,limitRenditionByPlayerDimensions:limitRenditionByPlayerDimensions};var playlists=master.playlists;if(Playlist.isAudioOnly(master)){playlists=masterPlaylistController.getAudioTrackPlaylists_();options.audioOnly=!0}
var sortedPlaylistReps=playlists.map(function(playlist){var bandwidth;var width=playlist.attributes&&playlist.attributes.RESOLUTION&&playlist.attributes.RESOLUTION.width;var height=playlist.attributes&&playlist.attributes.RESOLUTION&&playlist.attributes.RESOLUTION.height;bandwidth=playlist.attributes&&playlist.attributes.BANDWIDTH;bandwidth=bandwidth||window.Number.MAX_VALUE;return{bandwidth:bandwidth,width:width,height:height,playlist:playlist}});stableSort(sortedPlaylistReps,function(left,right){return left.bandwidth-right.bandwidth});sortedPlaylistReps=sortedPlaylistReps.filter(function(rep){return!Playlist.isIncompatible(rep.playlist)});var enabledPlaylistReps=sortedPlaylistReps.filter(function(rep){return Playlist.isEnabled(rep.playlist)});if(!enabledPlaylistReps.length){enabledPlaylistReps=sortedPlaylistReps.filter(function(rep){return!Playlist.isDisabled(rep.playlist)})}
var bandwidthPlaylistReps=enabledPlaylistReps.filter(function(rep){return rep.bandwidth*Config.BANDWIDTH_VARIANCE<playerBandwidth});var highestRemainingBandwidthRep=bandwidthPlaylistReps[bandwidthPlaylistReps.length-1];var bandwidthBestRep=bandwidthPlaylistReps.filter(function(rep){return rep.bandwidth===highestRemainingBandwidthRep.bandwidth})[0];if(limitRenditionByPlayerDimensions===!1){var _chosenRep=bandwidthBestRep||enabledPlaylistReps[0]||sortedPlaylistReps[0];if(_chosenRep&&_chosenRep.playlist){var type='sortedPlaylistReps';if(bandwidthBestRep){type='bandwidthBestRep'}
if(enabledPlaylistReps[0]){type='enabledPlaylistReps'}
logFn("choosing "+representationToString(_chosenRep)+" using "+type+" with options",options);return _chosenRep.playlist}
logFn('could not choose a playlist with options',options);return null}
var haveResolution=bandwidthPlaylistReps.filter(function(rep){return rep.width&&rep.height});stableSort(haveResolution,function(left,right){return left.width-right.width});var resolutionBestRepList=haveResolution.filter(function(rep){return rep.width===playerWidth&&rep.height===playerHeight});highestRemainingBandwidthRep=resolutionBestRepList[resolutionBestRepList.length-1];var resolutionBestRep=resolutionBestRepList.filter(function(rep){return rep.bandwidth===highestRemainingBandwidthRep.bandwidth})[0];var resolutionPlusOneList;var resolutionPlusOneSmallest;var resolutionPlusOneRep;if(!resolutionBestRep){resolutionPlusOneList=haveResolution.filter(function(rep){return rep.width>playerWidth||rep.height>playerHeight});resolutionPlusOneSmallest=resolutionPlusOneList.filter(function(rep){return rep.width===resolutionPlusOneList[0].width&&rep.height===resolutionPlusOneList[0].height});highestRemainingBandwidthRep=resolutionPlusOneSmallest[resolutionPlusOneSmallest.length-1];resolutionPlusOneRep=resolutionPlusOneSmallest.filter(function(rep){return rep.bandwidth===highestRemainingBandwidthRep.bandwidth})[0]}
var leastPixelDiffRep;if(masterPlaylistController.experimentalLeastPixelDiffSelector){var leastPixelDiffList=haveResolution.map(function(rep){rep.pixelDiff=Math.abs(rep.width-playerWidth)+Math.abs(rep.height-playerHeight);return rep});stableSort(leastPixelDiffList,function(left,right){if(left.pixelDiff===right.pixelDiff){return right.bandwidth-left.bandwidth}
return left.pixelDiff-right.pixelDiff});leastPixelDiffRep=leastPixelDiffList[0]}
var chosenRep=leastPixelDiffRep||resolutionPlusOneRep||resolutionBestRep||bandwidthBestRep||enabledPlaylistReps[0]||sortedPlaylistReps[0];if(chosenRep&&chosenRep.playlist){var _type='sortedPlaylistReps';if(leastPixelDiffRep){_type='leastPixelDiffRep'}else if(resolutionPlusOneRep){_type='resolutionPlusOneRep'}else if(resolutionBestRep){_type='resolutionBestRep'}else if(bandwidthBestRep){_type='bandwidthBestRep'}else if(enabledPlaylistReps[0]){_type='enabledPlaylistReps'}
logFn("choosing "+representationToString(chosenRep)+" using "+_type+" with options",options);return chosenRep.playlist}
logFn('could not choose a playlist with options',options);return null};var lastBandwidthSelector=function lastBandwidthSelector(){var pixelRatio=this.useDevicePixelRatio?window.devicePixelRatio||1:1;return simpleSelector(this.playlists.master,this.systemBandwidth,parseInt(safeGetComputedStyle(this.tech_.el(),'width'),10)*pixelRatio,parseInt(safeGetComputedStyle(this.tech_.el(),'height'),10)*pixelRatio,this.limitRenditionByPlayerDimensions,this.masterPlaylistController_)};var movingAverageBandwidthSelector=function movingAverageBandwidthSelector(decay){var average=-1;var lastSystemBandwidth=-1;if(decay<0||decay>1){throw new Error('Moving average bandwidth decay must be between 0 and 1.')}
return function(){var pixelRatio=this.useDevicePixelRatio?window.devicePixelRatio||1:1;if(average<0){average=this.systemBandwidth;lastSystemBandwidth=this.systemBandwidth}
if(this.systemBandwidth>0&&this.systemBandwidth!==lastSystemBandwidth){average=decay*this.systemBandwidth+(1-decay)*average;lastSystemBandwidth=this.systemBandwidth}
return simpleSelector(this.playlists.master,average,parseInt(safeGetComputedStyle(this.tech_.el(),'width'),10)*pixelRatio,parseInt(safeGetComputedStyle(this.tech_.el(),'height'),10)*pixelRatio,this.limitRenditionByPlayerDimensions,this.masterPlaylistController_)}};var minRebufferMaxBandwidthSelector=function minRebufferMaxBandwidthSelector(settings){var master=settings.master,currentTime=settings.currentTime,bandwidth=settings.bandwidth,duration=settings.duration,segmentDuration=settings.segmentDuration,timeUntilRebuffer=settings.timeUntilRebuffer,currentTimeline=settings.currentTimeline,syncController=settings.syncController;var compatiblePlaylists=master.playlists.filter(function(playlist){return!Playlist.isIncompatible(playlist)});var enabledPlaylists=compatiblePlaylists.filter(Playlist.isEnabled);if(!enabledPlaylists.length){enabledPlaylists=compatiblePlaylists.filter(function(playlist){return!Playlist.isDisabled(playlist)})}
var bandwidthPlaylists=enabledPlaylists.filter(Playlist.hasAttribute.bind(null,'BANDWIDTH'));var rebufferingEstimates=bandwidthPlaylists.map(function(playlist){var syncPoint=syncController.getSyncPoint(playlist,duration,currentTimeline,currentTime);var numRequests=syncPoint?1:2;var requestTimeEstimate=Playlist.estimateSegmentRequestTime(segmentDuration,bandwidth,playlist);var rebufferingImpact=requestTimeEstimate*numRequests-timeUntilRebuffer;return{playlist:playlist,rebufferingImpact:rebufferingImpact}});var noRebufferingPlaylists=rebufferingEstimates.filter(function(estimate){return estimate.rebufferingImpact<=0});stableSort(noRebufferingPlaylists,function(a,b){return comparePlaylistBandwidth(b.playlist,a.playlist)});if(noRebufferingPlaylists.length){return noRebufferingPlaylists[0]}
stableSort(rebufferingEstimates,function(a,b){return a.rebufferingImpact-b.rebufferingImpact});return rebufferingEstimates[0]||null};var lowestBitrateCompatibleVariantSelector=function lowestBitrateCompatibleVariantSelector(){var _this=this;var playlists=this.playlists.master.playlists.filter(Playlist.isEnabled);stableSort(playlists,function(a,b){return comparePlaylistBandwidth(a,b)});var playlistsWithVideo=playlists.filter(function(playlist){return!!codecsForPlaylist(_this.playlists.master,playlist).video});return playlistsWithVideo[0]||null};var concatSegments=function concatSegments(segmentObj){var offset=0;var tempBuffer;if(segmentObj.bytes){tempBuffer=new Uint8Array(segmentObj.bytes);segmentObj.segments.forEach(function(segment){tempBuffer.set(segment,offset);offset+=segment.byteLength})}
return tempBuffer};var createCaptionsTrackIfNotExists=function createCaptionsTrackIfNotExists(inbandTextTracks,tech,captionStream){if(!inbandTextTracks[captionStream]){tech.trigger({type:'usage',name:'vhs-608'});tech.trigger({type:'usage',name:'hls-608'});var instreamId=captionStream;if(/^cc708_/.test(captionStream)){instreamId='SERVICE'+captionStream.split('_')[1]}
var track=tech.textTracks().getTrackById(instreamId);if(track){inbandTextTracks[captionStream]=track}else{var captionServices=tech.options_.vhs&&tech.options_.vhs.captionServices||{};var label=captionStream;var language=captionStream;var def=!1;var captionService=captionServices[instreamId];if(captionService){label=captionService.label;language=captionService.language;def=captionService.default}
inbandTextTracks[captionStream]=tech.addRemoteTextTrack({kind:'captions',id:instreamId,default:def,label:label,language:language},!1).track}}};var addCaptionData=function addCaptionData(_ref){var inbandTextTracks=_ref.inbandTextTracks,captionArray=_ref.captionArray,timestampOffset=_ref.timestampOffset;if(!captionArray){return}
var Cue=window.WebKitDataCue||window.VTTCue;captionArray.forEach(function(caption){var track=caption.stream;inbandTextTracks[track].addCue(new Cue(caption.startTime+timestampOffset,caption.endTime+timestampOffset,caption.text))})};var deprecateOldCue=function deprecateOldCue(cue){Object.defineProperties(cue.frame,{id:{get:function get(){videojs__default["default"].log.warn('cue.frame.id is deprecated. Use cue.value.key instead.');return cue.value.key}},value:{get:function get(){videojs__default["default"].log.warn('cue.frame.value is deprecated. Use cue.value.data instead.');return cue.value.data}},privateData:{get:function get(){videojs__default["default"].log.warn('cue.frame.privateData is deprecated. Use cue.value.data instead.');return cue.value.data}}})};var addMetadata=function addMetadata(_ref2){var inbandTextTracks=_ref2.inbandTextTracks,metadataArray=_ref2.metadataArray,timestampOffset=_ref2.timestampOffset,videoDuration=_ref2.videoDuration;if(!metadataArray){return}
var Cue=window.WebKitDataCue||window.VTTCue;var metadataTrack=inbandTextTracks.metadataTrack_;if(!metadataTrack){return}
metadataArray.forEach(function(metadata){var time=metadata.cueTime+timestampOffset;if(typeof time!=='number'||window.isNaN(time)||time<0||!(time<Infinity)){return}
metadata.frames.forEach(function(frame){var cue=new Cue(time,time,frame.value||frame.url||frame.data||'');cue.frame=frame;cue.value=frame;deprecateOldCue(cue);metadataTrack.addCue(cue)})});if(!metadataTrack.cues||!metadataTrack.cues.length){return}
var cues=metadataTrack.cues;var cuesArray=[];for(var i=0;i<cues.length;i++){if(cues[i]){cuesArray.push(cues[i])}}
var cuesGroupedByStartTime=cuesArray.reduce(function(obj,cue){var timeSlot=obj[cue.startTime]||[];timeSlot.push(cue);obj[cue.startTime]=timeSlot;return obj},{});var sortedStartTimes=Object.keys(cuesGroupedByStartTime).sort(function(a,b){return Number(a)-Number(b)});sortedStartTimes.forEach(function(startTime,idx){var cueGroup=cuesGroupedByStartTime[startTime];var nextTime=Number(sortedStartTimes[idx+1])||videoDuration;cueGroup.forEach(function(cue){cue.endTime=nextTime})})};var createMetadataTrackIfNotExists=function createMetadataTrackIfNotExists(inbandTextTracks,dispatchType,tech){if(inbandTextTracks.metadataTrack_){return}
inbandTextTracks.metadataTrack_=tech.addRemoteTextTrack({kind:'metadata',label:'Timed Metadata'},!1).track;inbandTextTracks.metadataTrack_.inBandMetadataTrackDispatchType=dispatchType};var removeCuesFromTrack=function removeCuesFromTrack(start,end,track){var i;var cue;if(!track){return}
if(!track.cues){return}
i=track.cues.length;while(i--){cue=track.cues[i];if(cue.startTime>=start&&cue.endTime<=end){track.removeCue(cue)}}};var removeDuplicateCuesFromTrack=function removeDuplicateCuesFromTrack(track){var cues=track.cues;if(!cues){return}
for(var i=0;i<cues.length;i++){var duplicates=[];var occurrences=0;for(var j=0;j<cues.length;j++){if(cues[i].startTime===cues[j].startTime&&cues[i].endTime===cues[j].endTime&&cues[i].text===cues[j].text){occurrences++;if(occurrences>1){duplicates.push(cues[j])}}}
if(duplicates.length){duplicates.forEach(function(dupe){return track.removeCue(dupe)})}}};var ONE_SECOND_IN_TS=90000,secondsToVideoTs,secondsToAudioTs,videoTsToSeconds,audioTsToSeconds,audioTsToVideoTs,videoTsToAudioTs,metadataTsToSeconds;secondsToVideoTs=function secondsToVideoTs(seconds){return seconds*ONE_SECOND_IN_TS};secondsToAudioTs=function secondsToAudioTs(seconds,sampleRate){return seconds*sampleRate};videoTsToSeconds=function videoTsToSeconds(timestamp){return timestamp/ONE_SECOND_IN_TS};audioTsToSeconds=function audioTsToSeconds(timestamp,sampleRate){return timestamp/sampleRate};audioTsToVideoTs=function audioTsToVideoTs(timestamp,sampleRate){return secondsToVideoTs(audioTsToSeconds(timestamp,sampleRate))};videoTsToAudioTs=function videoTsToAudioTs(timestamp,sampleRate){return secondsToAudioTs(videoTsToSeconds(timestamp),sampleRate)};metadataTsToSeconds=function metadataTsToSeconds(timestamp,timelineStartPts,keepOriginalTimestamps){return videoTsToSeconds(keepOriginalTimestamps?timestamp:timestamp-timelineStartPts)};var clock={ONE_SECOND_IN_TS:ONE_SECOND_IN_TS,secondsToVideoTs:secondsToVideoTs,secondsToAudioTs:secondsToAudioTs,videoTsToSeconds:videoTsToSeconds,audioTsToSeconds:audioTsToSeconds,audioTsToVideoTs:audioTsToVideoTs,videoTsToAudioTs:videoTsToAudioTs,metadataTsToSeconds:metadataTsToSeconds};var gopsSafeToAlignWith=function gopsSafeToAlignWith(buffer,currentTime,mapping){if(typeof currentTime==='undefined'||currentTime===null||!buffer.length){return[]}
var currentTimePts=Math.ceil((currentTime-mapping+3)*clock.ONE_SECOND_IN_TS);var i;for(i=0;i<buffer.length;i++){if(buffer[i].pts>currentTimePts){break}}
return buffer.slice(i)};var updateGopBuffer=function updateGopBuffer(buffer,gops,replace){if(!gops.length){return buffer}
if(replace){return gops.slice()}
var start=gops[0].pts;var i=0;for(i;i<buffer.length;i++){if(buffer[i].pts>=start){break}}
return buffer.slice(0,i).concat(gops)};var removeGopBuffer=function removeGopBuffer(buffer,start,end,mapping){var startPts=Math.ceil((start-mapping)*clock.ONE_SECOND_IN_TS);var endPts=Math.ceil((end-mapping)*clock.ONE_SECOND_IN_TS);var updatedBuffer=buffer.slice();var i=buffer.length;while(i--){if(buffer[i].pts<=endPts){break}}
if(i===-1){return updatedBuffer}
var j=i+1;while(j--){if(buffer[j].pts<=startPts){break}}
j=Math.max(j,0);updatedBuffer.splice(j,i-j+1);return updatedBuffer};var shallowEqual=function shallowEqual(a,b){if(!a&&!b||!a&&b||a&&!b){return!1}
if(a===b){return!0}
var akeys=Object.keys(a).sort();var bkeys=Object.keys(b).sort();if(akeys.length!==bkeys.length){return!1}
for(var i=0;i<akeys.length;i++){var key=akeys[i];if(key!==bkeys[i]){return!1}
if(a[key]!==b[key]){return!1}}
return!0};var QUOTA_EXCEEDED_ERR=22;var getSyncSegmentCandidate=function getSyncSegmentCandidate(currentTimeline,segments,targetTime){segments=segments||[];var timelineSegments=[];var time=0;for(var i=0;i<segments.length;i++){var segment=segments[i];if(currentTimeline===segment.timeline){timelineSegments.push(i);time+=segment.duration;if(time>targetTime){return i}}}
if(timelineSegments.length===0){return 0}
return timelineSegments[timelineSegments.length-1]};var MIN_BACK_BUFFER=1;var CHECK_BUFFER_DELAY=500;var finite=function finite(num){return typeof num==='number'&&isFinite(num)};var MIN_SEGMENT_DURATION_TO_SAVE_STATS=1/60;var illegalMediaSwitch=function illegalMediaSwitch(loaderType,startingMedia,trackInfo){if(loaderType!=='main'||!startingMedia||!trackInfo){return null}
if(!trackInfo.hasAudio&&!trackInfo.hasVideo){return'Neither audio nor video found in segment.'}
if(startingMedia.hasVideo&&!trackInfo.hasVideo){return'Only audio found in segment when we expected video.'+' We can\'t switch to audio only from a stream that had video.'+' To get rid of this message, please add codec information to the manifest.'}
if(!startingMedia.hasVideo&&trackInfo.hasVideo){return'Video found in segment when we expected only audio.'+' We can\'t switch to a stream with video from an audio only stream.'+' To get rid of this message, please add codec information to the manifest.'}
return null};var safeBackBufferTrimTime=function safeBackBufferTrimTime(seekable,currentTime,targetDuration){var trimTime=currentTime-Config.BACK_BUFFER_LENGTH;if(seekable.length){trimTime=Math.max(trimTime,seekable.start(0))}
var maxTrimTime=currentTime-targetDuration;return Math.min(maxTrimTime,trimTime)};var segmentInfoString=function segmentInfoString(segmentInfo){var startOfSegment=segmentInfo.startOfSegment,duration=segmentInfo.duration,segment=segmentInfo.segment,part=segmentInfo.part,_segmentInfo$playlist=segmentInfo.playlist,seq=_segmentInfo$playlist.mediaSequence,id=_segmentInfo$playlist.id,_segmentInfo$playlist2=_segmentInfo$playlist.segments,segments=_segmentInfo$playlist2===void 0?[]:_segmentInfo$playlist2,index=segmentInfo.mediaIndex,partIndex=segmentInfo.partIndex,timeline=segmentInfo.timeline;var segmentLen=segments.length-1;var selection='mediaIndex/partIndex increment';if(segmentInfo.getMediaInfoForTime){selection="getMediaInfoForTime ("+segmentInfo.getMediaInfoForTime+")"}else if(segmentInfo.isSyncRequest){selection='getSyncSegmentCandidate (isSyncRequest)'}
if(segmentInfo.independent){selection+=" with independent "+segmentInfo.independent}
var hasPartIndex=typeof partIndex==='number';var name=segmentInfo.segment.uri?'segment':'pre-segment';var zeroBasedPartCount=hasPartIndex?getKnownPartCount({preloadSegment:segment})-1:0;return name+" ["+(seq+index)+"/"+(seq+segmentLen)+"]"+(hasPartIndex?" part ["+partIndex+"/"+zeroBasedPartCount+"]":'')+(" segment start/end ["+segment.start+" => "+segment.end+"]")+(hasPartIndex?" part start/end ["+part.start+" => "+part.end+"]":'')+(" startOfSegment ["+startOfSegment+"]")+(" duration ["+duration+"]")+(" timeline ["+timeline+"]")+(" selected by ["+selection+"]")+(" playlist ["+id+"]")};var timingInfoPropertyForMedia=function timingInfoPropertyForMedia(mediaType){return mediaType+"TimingInfo"};var timestampOffsetForSegment=function timestampOffsetForSegment(_ref){var segmentTimeline=_ref.segmentTimeline,currentTimeline=_ref.currentTimeline,startOfSegment=_ref.startOfSegment,buffered=_ref.buffered,overrideCheck=_ref.overrideCheck;if(!overrideCheck&&segmentTimeline===currentTimeline){return null}
if(segmentTimeline<currentTimeline){return startOfSegment}
return buffered.length?buffered.end(buffered.length-1):startOfSegment};var shouldWaitForTimelineChange=function shouldWaitForTimelineChange(_ref2){var timelineChangeController=_ref2.timelineChangeController,currentTimeline=_ref2.currentTimeline,segmentTimeline=_ref2.segmentTimeline,loaderType=_ref2.loaderType,audioDisabled=_ref2.audioDisabled;if(currentTimeline===segmentTimeline){return!1}
if(loaderType==='audio'){var lastMainTimelineChange=timelineChangeController.lastTimelineChange({type:'main'});return!lastMainTimelineChange||lastMainTimelineChange.to!==segmentTimeline}
if(loaderType==='main'&&audioDisabled){var pendingAudioTimelineChange=timelineChangeController.pendingTimelineChange({type:'audio'});if(pendingAudioTimelineChange&&pendingAudioTimelineChange.to===segmentTimeline){return!1}
return!0}
return!1};var mediaDuration=function mediaDuration(timingInfos){var maxDuration=0;['video','audio'].forEach(function(type){var typeTimingInfo=timingInfos[type+"TimingInfo"];if(!typeTimingInfo){return}
var start=typeTimingInfo.start,end=typeTimingInfo.end;var duration;if(typeof start==='bigint'||typeof end==='bigint'){duration=window.BigInt(end)-window.BigInt(start)}else if(typeof start==='number'&&typeof end==='number'){duration=end-start}
if(typeof duration!=='undefined'&&duration>maxDuration){maxDuration=duration}});if(typeof maxDuration==='bigint'&&maxDuration<Number.MAX_SAFE_INTEGER){maxDuration=Number(maxDuration)}
return maxDuration};var segmentTooLong=function segmentTooLong(_ref3){var segmentDuration=_ref3.segmentDuration,maxDuration=_ref3.maxDuration;if(!segmentDuration){return!1}
return Math.round(segmentDuration)>maxDuration+TIME_FUDGE_FACTOR};var getTroublesomeSegmentDurationMessage=function getTroublesomeSegmentDurationMessage(segmentInfo,sourceType){if(sourceType!=='hls'){return null}
var segmentDuration=mediaDuration({audioTimingInfo:segmentInfo.audioTimingInfo,videoTimingInfo:segmentInfo.videoTimingInfo});if(!segmentDuration){return null}
var targetDuration=segmentInfo.playlist.targetDuration;var isSegmentWayTooLong=segmentTooLong({segmentDuration:segmentDuration,maxDuration:targetDuration*2});var isSegmentSlightlyTooLong=segmentTooLong({segmentDuration:segmentDuration,maxDuration:targetDuration});var segmentTooLongMessage="Segment with index "+segmentInfo.mediaIndex+" "+("from playlist "+segmentInfo.playlist.id+" ")+("has a duration of "+segmentDuration+" ")+("when the reported duration is "+segmentInfo.duration+" ")+("and the target duration is "+targetDuration+". ")+'For HLS content, a duration in excess of the target duration may result in '+'playback issues. See the HLS specification section on EXT-X-TARGETDURATION for '+'more details: '+'https://tools.ietf.org/html/draft-pantos-http-live-streaming-23#section-4.3.3.1';if(isSegmentWayTooLong||isSegmentSlightlyTooLong){return{severity:isSegmentWayTooLong?'warn':'info',message:segmentTooLongMessage}}
return null};var SegmentLoader=function(_videojs$EventTarget){inheritsLoose(SegmentLoader,_videojs$EventTarget);function SegmentLoader(settings,options){var _this;_this=_videojs$EventTarget.call(this)||this;if(!settings){throw new TypeError('Initialization settings are required')}
if(typeof settings.currentTime!=='function'){throw new TypeError('No currentTime getter specified')}
if(!settings.mediaSource){throw new TypeError('No MediaSource specified')}
_this.bandwidth=settings.bandwidth;_this.throughput={rate:0,count:0};_this.roundTrip=NaN;_this.resetStats_();_this.mediaIndex=null;_this.partIndex=null;_this.hasPlayed_=settings.hasPlayed;_this.currentTime_=settings.currentTime;_this.seekable_=settings.seekable;_this.seeking_=settings.seeking;_this.duration_=settings.duration;_this.mediaSource_=settings.mediaSource;_this.vhs_=settings.vhs;_this.loaderType_=settings.loaderType;_this.currentMediaInfo_=void 0;_this.startingMediaInfo_=void 0;_this.segmentMetadataTrack_=settings.segmentMetadataTrack;_this.goalBufferLength_=settings.goalBufferLength;_this.sourceType_=settings.sourceType;_this.sourceUpdater_=settings.sourceUpdater;_this.inbandTextTracks_=settings.inbandTextTracks;_this.state_='INIT';_this.timelineChangeController_=settings.timelineChangeController;_this.shouldSaveSegmentTimingInfo_=!0;_this.parse708captions_=settings.parse708captions;_this.useDtsForTimestampOffset_=settings.useDtsForTimestampOffset;_this.captionServices_=settings.captionServices;_this.experimentalExactManifestTimings=settings.experimentalExactManifestTimings;_this.checkBufferTimeout_=null;_this.error_=void 0;_this.currentTimeline_=-1;_this.pendingSegment_=null;_this.xhrOptions_=null;_this.pendingSegments_=[];_this.audioDisabled_=!1;_this.isPendingTimestampOffset_=!1;_this.gopBuffer_=[];_this.timeMapping_=0;_this.safeAppend_=videojs__default["default"].browser.IE_VERSION>=11;_this.appendInitSegment_={audio:!0,video:!0};_this.playlistOfLastInitSegment_={audio:null,video:null};_this.callQueue_=[];_this.loadQueue_=[];_this.metadataQueue_={id3:[],caption:[]};_this.waitingOnRemove_=!1;_this.quotaExceededErrorRetryTimeout_=null;_this.activeInitSegmentId_=null;_this.initSegments_={};_this.cacheEncryptionKeys_=settings.cacheEncryptionKeys;_this.keyCache_={};_this.decrypter_=settings.decrypter;_this.syncController_=settings.syncController;_this.syncPoint_={segmentIndex:0,time:0};_this.transmuxer_=_this.createTransmuxer_();_this.triggerSyncInfoUpdate_=function(){return _this.trigger('syncinfoupdate')};_this.syncController_.on('syncinfoupdate',_this.triggerSyncInfoUpdate_);_this.mediaSource_.addEventListener('sourceopen',function(){if(!_this.isEndOfStream_()){_this.ended_=!1}});_this.fetchAtBuffer_=!1;_this.logger_=logger("SegmentLoader["+_this.loaderType_+"]");Object.defineProperty(assertThisInitialized(_this),'state',{get:function get(){return this.state_},set:function set(newState){if(newState!==this.state_){this.logger_(this.state_+" -> "+newState);this.state_=newState;this.trigger('statechange')}}});_this.sourceUpdater_.on('ready',function(){if(_this.hasEnoughInfoToAppend_()){_this.processCallQueue_()}});if(_this.loaderType_==='main'){_this.timelineChangeController_.on('pendingtimelinechange',function(){if(_this.hasEnoughInfoToAppend_()){_this.processCallQueue_()}})}
if(_this.loaderType_==='audio'){_this.timelineChangeController_.on('timelinechange',function(){if(_this.hasEnoughInfoToLoad_()){_this.processLoadQueue_()}
if(_this.hasEnoughInfoToAppend_()){_this.processCallQueue_()}})}
return _this}
var _proto=SegmentLoader.prototype;_proto.createTransmuxer_=function createTransmuxer_(){return segmentTransmuxer.createTransmuxer({remux:!1,alignGopsAtEnd:this.safeAppend_,keepOriginalTimestamps:!0,parse708captions:this.parse708captions_,captionServices:this.captionServices_})};_proto.resetStats_=function resetStats_(){this.mediaBytesTransferred=0;this.mediaRequests=0;this.mediaRequestsAborted=0;this.mediaRequestsTimedout=0;this.mediaRequestsErrored=0;this.mediaTransferDuration=0;this.mediaSecondsLoaded=0;this.mediaAppends=0};_proto.dispose=function dispose(){this.trigger('dispose');this.state='DISPOSED';this.pause();this.abort_();if(this.transmuxer_){this.transmuxer_.terminate()}
this.resetStats_();if(this.checkBufferTimeout_){window.clearTimeout(this.checkBufferTimeout_)}
if(this.syncController_&&this.triggerSyncInfoUpdate_){this.syncController_.off('syncinfoupdate',this.triggerSyncInfoUpdate_)}
this.off()};_proto.setAudio=function setAudio(enable){this.audioDisabled_=!enable;if(enable){this.appendInitSegment_.audio=!0}else{this.sourceUpdater_.removeAudio(0,this.duration_())}};_proto.abort=function abort(){if(this.state!=='WAITING'){if(this.pendingSegment_){this.pendingSegment_=null}
return}
this.abort_();this.state='READY';if(!this.paused()){this.monitorBuffer_()}};_proto.abort_=function abort_(){if(this.pendingSegment_&&this.pendingSegment_.abortRequests){this.pendingSegment_.abortRequests()}
this.pendingSegment_=null;this.callQueue_=[];this.loadQueue_=[];this.metadataQueue_.id3=[];this.metadataQueue_.caption=[];this.timelineChangeController_.clearPendingTimelineChange(this.loaderType_);this.waitingOnRemove_=!1;window.clearTimeout(this.quotaExceededErrorRetryTimeout_);this.quotaExceededErrorRetryTimeout_=null};_proto.checkForAbort_=function checkForAbort_(requestId){if(this.state==='APPENDING'&&!this.pendingSegment_){this.state='READY';return!0}
if(!this.pendingSegment_||this.pendingSegment_.requestId!==requestId){return!0}
return!1};_proto.error=function error(_error){if(typeof _error!=='undefined'){this.logger_('error occurred:',_error);this.error_=_error}
this.pendingSegment_=null;return this.error_};_proto.endOfStream=function endOfStream(){this.ended_=!0;if(this.transmuxer_){segmentTransmuxer.reset(this.transmuxer_)}
this.gopBuffer_.length=0;this.pause();this.trigger('ended')};_proto.buffered_=function buffered_(){var trackInfo=this.getMediaInfo_();if(!this.sourceUpdater_||!trackInfo){return videojs__default["default"].createTimeRanges()}
if(this.loaderType_==='main'){var hasAudio=trackInfo.hasAudio,hasVideo=trackInfo.hasVideo,isMuxed=trackInfo.isMuxed;if(hasVideo&&hasAudio&&!this.audioDisabled_&&!isMuxed){return this.sourceUpdater_.buffered()}
if(hasVideo){return this.sourceUpdater_.videoBuffered()}}
return this.sourceUpdater_.audioBuffered()};_proto.initSegmentForMap=function initSegmentForMap(map,set){if(set===void 0){set=!1}
if(!map){return null}
var id=initSegmentId(map);var storedMap=this.initSegments_[id];if(set&&!storedMap&&map.bytes){this.initSegments_[id]=storedMap={resolvedUri:map.resolvedUri,byterange:map.byterange,bytes:map.bytes,tracks:map.tracks,timescales:map.timescales}}
return storedMap||map};_proto.segmentKey=function segmentKey(key,set){if(set===void 0){set=!1}
if(!key){return null}
var id=segmentKeyId(key);var storedKey=this.keyCache_[id];if(this.cacheEncryptionKeys_&&set&&!storedKey&&key.bytes){this.keyCache_[id]=storedKey={resolvedUri:key.resolvedUri,bytes:key.bytes}}
var result={resolvedUri:(storedKey||key).resolvedUri};if(storedKey){result.bytes=storedKey.bytes}
return result};_proto.couldBeginLoading_=function couldBeginLoading_(){return this.playlist_&&!this.paused()};_proto.load=function load(){this.monitorBuffer_();if(!this.playlist_){return}
if(this.state==='INIT'&&this.couldBeginLoading_()){return this.init_()}
if(!this.couldBeginLoading_()||this.state!=='READY'&&this.state!=='INIT'){return}
this.state='READY'};_proto.init_=function init_(){this.state='READY';this.resetEverything();return this.monitorBuffer_()};_proto.playlist=function playlist(newPlaylist,options){if(options===void 0){options={}}
if(!newPlaylist){return}
var oldPlaylist=this.playlist_;var segmentInfo=this.pendingSegment_;this.playlist_=newPlaylist;this.xhrOptions_=options;if(this.state==='INIT'){newPlaylist.syncInfo={mediaSequence:newPlaylist.mediaSequence,time:0};if(this.loaderType_==='main'){this.syncController_.setDateTimeMappingForStart(newPlaylist)}}
var oldId=null;if(oldPlaylist){if(oldPlaylist.id){oldId=oldPlaylist.id}else if(oldPlaylist.uri){oldId=oldPlaylist.uri}}
this.logger_("playlist update ["+oldId+" => "+(newPlaylist.id||newPlaylist.uri)+"]");this.trigger('syncinfoupdate');if(this.state==='INIT'&&this.couldBeginLoading_()){return this.init_()}
if(!oldPlaylist||oldPlaylist.uri!==newPlaylist.uri){if(this.mediaIndex!==null){if(!newPlaylist.endList){this.resetLoader()}else{this.resyncLoader()}}
this.currentMediaInfo_=void 0;this.trigger('playlistupdate');return}
var mediaSequenceDiff=newPlaylist.mediaSequence-oldPlaylist.mediaSequence;this.logger_("live window shift ["+mediaSequenceDiff+"]");if(this.mediaIndex!==null){this.mediaIndex-=mediaSequenceDiff;if(this.mediaIndex<0){this.mediaIndex=null;this.partIndex=null}else{var segment=this.playlist_.segments[this.mediaIndex];if(this.partIndex&&(!segment.parts||!segment.parts.length||!segment.parts[this.partIndex])){var mediaIndex=this.mediaIndex;this.logger_("currently processing part (index "+this.partIndex+") no longer exists.");this.resetLoader();this.mediaIndex=mediaIndex}}}
if(segmentInfo){segmentInfo.mediaIndex-=mediaSequenceDiff;if(segmentInfo.mediaIndex<0){segmentInfo.mediaIndex=null;segmentInfo.partIndex=null}else{if(segmentInfo.mediaIndex>=0){segmentInfo.segment=newPlaylist.segments[segmentInfo.mediaIndex]}
if(segmentInfo.partIndex>=0&&segmentInfo.segment.parts){segmentInfo.part=segmentInfo.segment.parts[segmentInfo.partIndex]}}}
this.syncController_.saveExpiredSegmentInfo(oldPlaylist,newPlaylist)};_proto.pause=function pause(){if(this.checkBufferTimeout_){window.clearTimeout(this.checkBufferTimeout_);this.checkBufferTimeout_=null}};_proto.paused=function paused(){return this.checkBufferTimeout_===null};_proto.resetEverything=function resetEverything(done){this.ended_=!1;this.appendInitSegment_={audio:!0,video:!0};this.resetLoader();this.remove(0,Infinity,done);if(this.transmuxer_){this.transmuxer_.postMessage({action:'clearAllMp4Captions'});this.transmuxer_.postMessage({action:'reset'})}};_proto.resetLoader=function resetLoader(){this.fetchAtBuffer_=!1;this.resyncLoader()};_proto.resyncLoader=function resyncLoader(){if(this.transmuxer_){segmentTransmuxer.reset(this.transmuxer_)}
this.mediaIndex=null;this.partIndex=null;this.syncPoint_=null;this.isPendingTimestampOffset_=!1;this.callQueue_=[];this.loadQueue_=[];this.metadataQueue_.id3=[];this.metadataQueue_.caption=[];this.abort();if(this.transmuxer_){this.transmuxer_.postMessage({action:'clearParsedMp4Captions'})}};_proto.remove=function remove(start,end,done,force){if(done===void 0){done=function done(){}}
if(force===void 0){force=!1}
if(end===Infinity){end=this.duration_()}
if(end<=start){this.logger_('skipping remove because end ${end} is <= start ${start}');return}
if(!this.sourceUpdater_||!this.getMediaInfo_()){this.logger_('skipping remove because no source updater or starting media info');return}
var removesRemaining=1;var removeFinished=function removeFinished(){removesRemaining--;if(removesRemaining===0){done()}};if(force||!this.audioDisabled_){removesRemaining++;this.sourceUpdater_.removeAudio(start,end,removeFinished)}
if(force||this.loaderType_==='main'){this.gopBuffer_=removeGopBuffer(this.gopBuffer_,start,end,this.timeMapping_);removesRemaining++;this.sourceUpdater_.removeVideo(start,end,removeFinished)}
for(var track in this.inbandTextTracks_){removeCuesFromTrack(start,end,this.inbandTextTracks_[track])}
removeCuesFromTrack(start,end,this.segmentMetadataTrack_);removeFinished()};_proto.monitorBuffer_=function monitorBuffer_(){if(this.checkBufferTimeout_){window.clearTimeout(this.checkBufferTimeout_)}
this.checkBufferTimeout_=window.setTimeout(this.monitorBufferTick_.bind(this),1)};_proto.monitorBufferTick_=function monitorBufferTick_(){if(this.state==='READY'){this.fillBuffer_()}
if(this.checkBufferTimeout_){window.clearTimeout(this.checkBufferTimeout_)}
this.checkBufferTimeout_=window.setTimeout(this.monitorBufferTick_.bind(this),CHECK_BUFFER_DELAY)};_proto.fillBuffer_=function fillBuffer_(){if(this.sourceUpdater_.updating()){return}
var segmentInfo=this.chooseNextRequest_();if(!segmentInfo){return}
if(typeof segmentInfo.timestampOffset==='number'){this.isPendingTimestampOffset_=!1;this.timelineChangeController_.pendingTimelineChange({type:this.loaderType_,from:this.currentTimeline_,to:segmentInfo.timeline})}
this.loadSegment_(segmentInfo)};_proto.isEndOfStream_=function isEndOfStream_(mediaIndex,playlist,partIndex){if(mediaIndex===void 0){mediaIndex=this.mediaIndex}
if(playlist===void 0){playlist=this.playlist_}
if(partIndex===void 0){partIndex=this.partIndex}
if(!playlist||!this.mediaSource_){return!1}
var segment=typeof mediaIndex==='number'&&playlist.segments[mediaIndex];var appendedLastSegment=mediaIndex+1===playlist.segments.length;var appendedLastPart=!segment||!segment.parts||partIndex+1===segment.parts.length;return playlist.endList&&this.mediaSource_.readyState==='open'&&appendedLastSegment&&appendedLastPart};_proto.chooseNextRequest_=function chooseNextRequest_(){var buffered=this.buffered_();var bufferedEnd=lastBufferedEnd(buffered)||0;var bufferedTime=timeAheadOf(buffered,this.currentTime_());var preloaded=!this.hasPlayed_()&&bufferedTime>=1;var haveEnoughBuffer=bufferedTime>=this.goalBufferLength_();var segments=this.playlist_.segments;if(!segments.length||preloaded||haveEnoughBuffer){return null}
this.syncPoint_=this.syncPoint_||this.syncController_.getSyncPoint(this.playlist_,this.duration_(),this.currentTimeline_,this.currentTime_());var next={partIndex:null,mediaIndex:null,startOfSegment:null,playlist:this.playlist_,isSyncRequest:Boolean(!this.syncPoint_)};if(next.isSyncRequest){next.mediaIndex=getSyncSegmentCandidate(this.currentTimeline_,segments,bufferedEnd)}else if(this.mediaIndex!==null){var segment=segments[this.mediaIndex];var partIndex=typeof this.partIndex==='number'?this.partIndex:-1;next.startOfSegment=segment.end?segment.end:bufferedEnd;if(segment.parts&&segment.parts[partIndex+1]){next.mediaIndex=this.mediaIndex;next.partIndex=partIndex+1}else{next.mediaIndex=this.mediaIndex+1}}else{var _Playlist$getMediaInf=Playlist.getMediaInfoForTime({experimentalExactManifestTimings:this.experimentalExactManifestTimings,playlist:this.playlist_,currentTime:this.fetchAtBuffer_?bufferedEnd:this.currentTime_(),startingPartIndex:this.syncPoint_.partIndex,startingSegmentIndex:this.syncPoint_.segmentIndex,startTime:this.syncPoint_.time}),segmentIndex=_Playlist$getMediaInf.segmentIndex,startTime=_Playlist$getMediaInf.startTime,_partIndex=_Playlist$getMediaInf.partIndex;next.getMediaInfoForTime=this.fetchAtBuffer_?"bufferedEnd "+bufferedEnd:"currentTime "+this.currentTime_();next.mediaIndex=segmentIndex;next.startOfSegment=startTime;next.partIndex=_partIndex}
var nextSegment=segments[next.mediaIndex];var nextPart=nextSegment&&typeof next.partIndex==='number'&&nextSegment.parts&&nextSegment.parts[next.partIndex];if(!nextSegment||typeof next.partIndex==='number'&&!nextPart){return null}
if(typeof next.partIndex!=='number'&&nextSegment.parts){next.partIndex=0;nextPart=nextSegment.parts[0]}
if(!bufferedTime&&nextPart&&!nextPart.independent){if(next.partIndex===0){var lastSegment=segments[next.mediaIndex-1];var lastSegmentLastPart=lastSegment.parts&&lastSegment.parts.length&&lastSegment.parts[lastSegment.parts.length-1];if(lastSegmentLastPart&&lastSegmentLastPart.independent){next.mediaIndex-=1;next.partIndex=lastSegment.parts.length-1;next.independent='previous segment'}}else if(nextSegment.parts[next.partIndex-1].independent){next.partIndex-=1;next.independent='previous part'}}
var ended=this.mediaSource_&&this.mediaSource_.readyState==='ended';if(next.mediaIndex>=segments.length-1&&ended&&!this.seeking_()){return null}
return this.generateSegmentInfo_(next)};_proto.generateSegmentInfo_=function generateSegmentInfo_(options){var independent=options.independent,playlist=options.playlist,mediaIndex=options.mediaIndex,startOfSegment=options.startOfSegment,isSyncRequest=options.isSyncRequest,partIndex=options.partIndex,forceTimestampOffset=options.forceTimestampOffset,getMediaInfoForTime=options.getMediaInfoForTime;var segment=playlist.segments[mediaIndex];var part=typeof partIndex==='number'&&segment.parts[partIndex];var segmentInfo={requestId:'segment-loader-'+Math.random(),uri:part&&part.resolvedUri||segment.resolvedUri,mediaIndex:mediaIndex,partIndex:part?partIndex:null,isSyncRequest:isSyncRequest,startOfSegment:startOfSegment,playlist:playlist,bytes:null,encryptedBytes:null,timestampOffset:null,timeline:segment.timeline,duration:part&&part.duration||segment.duration,segment:segment,part:part,byteLength:0,transmuxer:this.transmuxer_,getMediaInfoForTime:getMediaInfoForTime,independent:independent};var overrideCheck=typeof forceTimestampOffset!=='undefined'?forceTimestampOffset:this.isPendingTimestampOffset_;segmentInfo.timestampOffset=this.timestampOffsetForSegment_({segmentTimeline:segment.timeline,currentTimeline:this.currentTimeline_,startOfSegment:startOfSegment,buffered:this.buffered_(),overrideCheck:overrideCheck});var audioBufferedEnd=lastBufferedEnd(this.sourceUpdater_.audioBuffered());if(typeof audioBufferedEnd==='number'){segmentInfo.audioAppendStart=audioBufferedEnd-this.sourceUpdater_.audioTimestampOffset()}
if(this.sourceUpdater_.videoBuffered().length){segmentInfo.gopsToAlignWith=gopsSafeToAlignWith(this.gopBuffer_,this.currentTime_()-this.sourceUpdater_.videoTimestampOffset(),this.timeMapping_)}
return segmentInfo};_proto.timestampOffsetForSegment_=function timestampOffsetForSegment_(options){return timestampOffsetForSegment(options)};_proto.earlyAbortWhenNeeded_=function earlyAbortWhenNeeded_(stats){if(this.vhs_.tech_.paused()||!this.xhrOptions_.timeout||!this.playlist_.attributes.BANDWIDTH){return}
if(Date.now()-(stats.firstBytesReceivedAt||Date.now())<1000){return}
var currentTime=this.currentTime_();var measuredBandwidth=stats.bandwidth;var segmentDuration=this.pendingSegment_.duration;var requestTimeRemaining=Playlist.estimateSegmentRequestTime(segmentDuration,measuredBandwidth,this.playlist_,stats.bytesReceived);var timeUntilRebuffer$1=timeUntilRebuffer(this.buffered_(),currentTime,this.vhs_.tech_.playbackRate())-1;if(requestTimeRemaining<=timeUntilRebuffer$1){return}
var switchCandidate=minRebufferMaxBandwidthSelector({master:this.vhs_.playlists.master,currentTime:currentTime,bandwidth:measuredBandwidth,duration:this.duration_(),segmentDuration:segmentDuration,timeUntilRebuffer:timeUntilRebuffer$1,currentTimeline:this.currentTimeline_,syncController:this.syncController_});if(!switchCandidate){return}
var rebufferingImpact=requestTimeRemaining-timeUntilRebuffer$1;var timeSavedBySwitching=rebufferingImpact-switchCandidate.rebufferingImpact;var minimumTimeSaving=0.5;if(timeUntilRebuffer$1<=TIME_FUDGE_FACTOR){minimumTimeSaving=1}
if(!switchCandidate.playlist||switchCandidate.playlist.uri===this.playlist_.uri||timeSavedBySwitching<minimumTimeSaving){return}
this.bandwidth=switchCandidate.playlist.attributes.BANDWIDTH*Config.BANDWIDTH_VARIANCE+1;this.trigger('earlyabort')};_proto.handleAbort_=function handleAbort_(segmentInfo){this.logger_("Aborting "+segmentInfoString(segmentInfo));this.mediaRequestsAborted+=1};_proto.handleProgress_=function handleProgress_(event,simpleSegment){this.earlyAbortWhenNeeded_(simpleSegment.stats);if(this.checkForAbort_(simpleSegment.requestId)){return}
this.trigger('progress')};_proto.handleTrackInfo_=function handleTrackInfo_(simpleSegment,trackInfo){this.earlyAbortWhenNeeded_(simpleSegment.stats);if(this.checkForAbort_(simpleSegment.requestId)){return}
if(this.checkForIllegalMediaSwitch(trackInfo)){return}
trackInfo=trackInfo||{};if(!shallowEqual(this.currentMediaInfo_,trackInfo)){this.appendInitSegment_={audio:!0,video:!0};this.startingMediaInfo_=trackInfo;this.currentMediaInfo_=trackInfo;this.logger_('trackinfo update',trackInfo);this.trigger('trackinfo')}
if(this.checkForAbort_(simpleSegment.requestId)){return}
this.pendingSegment_.trackInfo=trackInfo;if(this.hasEnoughInfoToAppend_()){this.processCallQueue_()}};_proto.handleTimingInfo_=function handleTimingInfo_(simpleSegment,mediaType,timeType,time){this.earlyAbortWhenNeeded_(simpleSegment.stats);if(this.checkForAbort_(simpleSegment.requestId)){return}
var segmentInfo=this.pendingSegment_;var timingInfoProperty=timingInfoPropertyForMedia(mediaType);segmentInfo[timingInfoProperty]=segmentInfo[timingInfoProperty]||{};segmentInfo[timingInfoProperty][timeType]=time;this.logger_("timinginfo: "+mediaType+" - "+timeType+" - "+time);if(this.hasEnoughInfoToAppend_()){this.processCallQueue_()}};_proto.handleCaptions_=function handleCaptions_(simpleSegment,captionData){var _this2=this;this.earlyAbortWhenNeeded_(simpleSegment.stats);if(this.checkForAbort_(simpleSegment.requestId)){return}
if(captionData.length===0){this.logger_('SegmentLoader received no captions from a caption event');return}
var segmentInfo=this.pendingSegment_;if(!segmentInfo.hasAppendedData_){this.metadataQueue_.caption.push(this.handleCaptions_.bind(this,simpleSegment,captionData));return}
var timestampOffset=this.sourceUpdater_.videoTimestampOffset()===null?this.sourceUpdater_.audioTimestampOffset():this.sourceUpdater_.videoTimestampOffset();var captionTracks={};captionData.forEach(function(caption){captionTracks[caption.stream]=captionTracks[caption.stream]||{startTime:Infinity,captions:[],endTime:0};var captionTrack=captionTracks[caption.stream];captionTrack.startTime=Math.min(captionTrack.startTime,caption.startTime+timestampOffset);captionTrack.endTime=Math.max(captionTrack.endTime,caption.endTime+timestampOffset);captionTrack.captions.push(caption)});Object.keys(captionTracks).forEach(function(trackName){var _captionTracks$trackN=captionTracks[trackName],startTime=_captionTracks$trackN.startTime,endTime=_captionTracks$trackN.endTime,captions=_captionTracks$trackN.captions;var inbandTextTracks=_this2.inbandTextTracks_;_this2.logger_("adding cues from "+startTime+" -> "+endTime+" for "+trackName);createCaptionsTrackIfNotExists(inbandTextTracks,_this2.vhs_.tech_,trackName);removeCuesFromTrack(startTime,endTime,inbandTextTracks[trackName]);addCaptionData({captionArray:captions,inbandTextTracks:inbandTextTracks,timestampOffset:timestampOffset})});if(this.transmuxer_){this.transmuxer_.postMessage({action:'clearParsedMp4Captions'})}};_proto.handleId3_=function handleId3_(simpleSegment,id3Frames,dispatchType){this.earlyAbortWhenNeeded_(simpleSegment.stats);if(this.checkForAbort_(simpleSegment.requestId)){return}
var segmentInfo=this.pendingSegment_;if(!segmentInfo.hasAppendedData_){this.metadataQueue_.id3.push(this.handleId3_.bind(this,simpleSegment,id3Frames,dispatchType));return}
var timestampOffset=this.sourceUpdater_.videoTimestampOffset()===null?this.sourceUpdater_.audioTimestampOffset():this.sourceUpdater_.videoTimestampOffset();createMetadataTrackIfNotExists(this.inbandTextTracks_,dispatchType,this.vhs_.tech_);addMetadata({inbandTextTracks:this.inbandTextTracks_,metadataArray:id3Frames,timestampOffset:timestampOffset,videoDuration:this.duration_()})};_proto.processMetadataQueue_=function processMetadataQueue_(){this.metadataQueue_.id3.forEach(function(fn){return fn()});this.metadataQueue_.caption.forEach(function(fn){return fn()});this.metadataQueue_.id3=[];this.metadataQueue_.caption=[]};_proto.processCallQueue_=function processCallQueue_(){var callQueue=this.callQueue_;this.callQueue_=[];callQueue.forEach(function(fun){return fun()})};_proto.processLoadQueue_=function processLoadQueue_(){var loadQueue=this.loadQueue_;this.loadQueue_=[];loadQueue.forEach(function(fun){return fun()})};_proto.hasEnoughInfoToLoad_=function hasEnoughInfoToLoad_(){if(this.loaderType_!=='audio'){return!0}
var segmentInfo=this.pendingSegment_;if(!segmentInfo){return!1}
if(!this.getCurrentMediaInfo_()){return!0}
if(shouldWaitForTimelineChange({timelineChangeController:this.timelineChangeController_,currentTimeline:this.currentTimeline_,segmentTimeline:segmentInfo.timeline,loaderType:this.loaderType_,audioDisabled:this.audioDisabled_})){return!1}
return!0};_proto.getCurrentMediaInfo_=function getCurrentMediaInfo_(segmentInfo){if(segmentInfo===void 0){segmentInfo=this.pendingSegment_}
return segmentInfo&&segmentInfo.trackInfo||this.currentMediaInfo_};_proto.getMediaInfo_=function getMediaInfo_(segmentInfo){if(segmentInfo===void 0){segmentInfo=this.pendingSegment_}
return this.getCurrentMediaInfo_(segmentInfo)||this.startingMediaInfo_};_proto.hasEnoughInfoToAppend_=function hasEnoughInfoToAppend_(){if(!this.sourceUpdater_.ready()){return!1}
if(this.waitingOnRemove_||this.quotaExceededErrorRetryTimeout_){return!1}
var segmentInfo=this.pendingSegment_;var trackInfo=this.getCurrentMediaInfo_();if(!segmentInfo||!trackInfo){return!1}
var hasAudio=trackInfo.hasAudio,hasVideo=trackInfo.hasVideo,isMuxed=trackInfo.isMuxed;if(hasVideo&&!segmentInfo.videoTimingInfo){return!1}
if(hasAudio&&!this.audioDisabled_&&!isMuxed&&!segmentInfo.audioTimingInfo){return!1}
if(shouldWaitForTimelineChange({timelineChangeController:this.timelineChangeController_,currentTimeline:this.currentTimeline_,segmentTimeline:segmentInfo.timeline,loaderType:this.loaderType_,audioDisabled:this.audioDisabled_})){return!1}
return!0};_proto.handleData_=function handleData_(simpleSegment,result){this.earlyAbortWhenNeeded_(simpleSegment.stats);if(this.checkForAbort_(simpleSegment.requestId)){return}
if(this.callQueue_.length||!this.hasEnoughInfoToAppend_()){this.callQueue_.push(this.handleData_.bind(this,simpleSegment,result));return}
var segmentInfo=this.pendingSegment_;this.setTimeMapping_(segmentInfo.timeline);this.updateMediaSecondsLoaded_(segmentInfo.part||segmentInfo.segment);if(this.mediaSource_.readyState==='closed'){return}
if(simpleSegment.map){simpleSegment.map=this.initSegmentForMap(simpleSegment.map,!0);segmentInfo.segment.map=simpleSegment.map}
if(simpleSegment.key){this.segmentKey(simpleSegment.key,!0)}
segmentInfo.isFmp4=simpleSegment.isFmp4;segmentInfo.timingInfo=segmentInfo.timingInfo||{};if(segmentInfo.isFmp4){this.trigger('fmp4');segmentInfo.timingInfo.start=segmentInfo[timingInfoPropertyForMedia(result.type)].start}else{var trackInfo=this.getCurrentMediaInfo_();var useVideoTimingInfo=this.loaderType_==='main'&&trackInfo&&trackInfo.hasVideo;var firstVideoFrameTimeForData;if(useVideoTimingInfo){firstVideoFrameTimeForData=segmentInfo.videoTimingInfo.start}
segmentInfo.timingInfo.start=this.trueSegmentStart_({currentStart:segmentInfo.timingInfo.start,playlist:segmentInfo.playlist,mediaIndex:segmentInfo.mediaIndex,currentVideoTimestampOffset:this.sourceUpdater_.videoTimestampOffset(),useVideoTimingInfo:useVideoTimingInfo,firstVideoFrameTimeForData:firstVideoFrameTimeForData,videoTimingInfo:segmentInfo.videoTimingInfo,audioTimingInfo:segmentInfo.audioTimingInfo})}
this.updateAppendInitSegmentStatus(segmentInfo,result.type);this.updateSourceBufferTimestampOffset_(segmentInfo);if(segmentInfo.isSyncRequest){this.updateTimingInfoEnd_(segmentInfo);this.syncController_.saveSegmentTimingInfo({segmentInfo:segmentInfo,shouldSaveTimelineMapping:this.loaderType_==='main'});var next=this.chooseNextRequest_();if(next.mediaIndex!==segmentInfo.mediaIndex||next.partIndex!==segmentInfo.partIndex){this.logger_('sync segment was incorrect, not appending');return}
this.logger_('sync segment was correct, appending')}
segmentInfo.hasAppendedData_=!0;this.processMetadataQueue_();this.appendData_(segmentInfo,result)};_proto.updateAppendInitSegmentStatus=function updateAppendInitSegmentStatus(segmentInfo,type){if(this.loaderType_==='main'&&typeof segmentInfo.timestampOffset==='number'&&!segmentInfo.changedTimestampOffset){this.appendInitSegment_={audio:!0,video:!0}}
if(this.playlistOfLastInitSegment_[type]!==segmentInfo.playlist){this.appendInitSegment_[type]=!0}};_proto.getInitSegmentAndUpdateState_=function getInitSegmentAndUpdateState_(_ref4){var type=_ref4.type,initSegment=_ref4.initSegment,map=_ref4.map,playlist=_ref4.playlist;if(map){var id=initSegmentId(map);if(this.activeInitSegmentId_===id){return null}
initSegment=this.initSegmentForMap(map,!0).bytes;this.activeInitSegmentId_=id}
if(initSegment&&this.appendInitSegment_[type]){this.playlistOfLastInitSegment_[type]=playlist;this.appendInitSegment_[type]=!1;this.activeInitSegmentId_=null;return initSegment}
return null};_proto.handleQuotaExceededError_=function handleQuotaExceededError_(_ref5,error){var _this3=this;var segmentInfo=_ref5.segmentInfo,type=_ref5.type,bytes=_ref5.bytes;var audioBuffered=this.sourceUpdater_.audioBuffered();var videoBuffered=this.sourceUpdater_.videoBuffered();if(audioBuffered.length>1){this.logger_('On QUOTA_EXCEEDED_ERR, found gaps in the audio buffer: '+timeRangesToArray(audioBuffered).join(', '))}
if(videoBuffered.length>1){this.logger_('On QUOTA_EXCEEDED_ERR, found gaps in the video buffer: '+timeRangesToArray(videoBuffered).join(', '))}
var audioBufferStart=audioBuffered.length?audioBuffered.start(0):0;var audioBufferEnd=audioBuffered.length?audioBuffered.end(audioBuffered.length-1):0;var videoBufferStart=videoBuffered.length?videoBuffered.start(0):0;var videoBufferEnd=videoBuffered.length?videoBuffered.end(videoBuffered.length-1):0;if(audioBufferEnd-audioBufferStart<=MIN_BACK_BUFFER&&videoBufferEnd-videoBufferStart<=MIN_BACK_BUFFER){this.logger_('On QUOTA_EXCEEDED_ERR, single segment too large to append to '+'buffer, triggering an error. '+("Appended byte length: "+bytes.byteLength+", ")+("audio buffer: "+timeRangesToArray(audioBuffered).join(', ')+", ")+("video buffer: "+timeRangesToArray(videoBuffered).join(', ')+", "));this.error({message:'Quota exceeded error with append of a single segment of content',excludeUntil:Infinity});this.trigger('error');return}
this.waitingOnRemove_=!0;this.callQueue_.push(this.appendToSourceBuffer_.bind(this,{segmentInfo:segmentInfo,type:type,bytes:bytes}));var currentTime=this.currentTime_();var timeToRemoveUntil=currentTime-MIN_BACK_BUFFER;this.logger_("On QUOTA_EXCEEDED_ERR, removing audio/video from 0 to "+timeToRemoveUntil);this.remove(0,timeToRemoveUntil,function(){_this3.logger_("On QUOTA_EXCEEDED_ERR, retrying append in "+MIN_BACK_BUFFER+"s");_this3.waitingOnRemove_=!1;_this3.quotaExceededErrorRetryTimeout_=window.setTimeout(function(){_this3.logger_('On QUOTA_EXCEEDED_ERR, re-processing call queue');_this3.quotaExceededErrorRetryTimeout_=null;_this3.processCallQueue_()},MIN_BACK_BUFFER*1000)},!0)};_proto.handleAppendError_=function handleAppendError_(_ref6,error){var segmentInfo=_ref6.segmentInfo,type=_ref6.type,bytes=_ref6.bytes;if(!error){return}
if(error.code===QUOTA_EXCEEDED_ERR){this.handleQuotaExceededError_({segmentInfo:segmentInfo,type:type,bytes:bytes});return}
this.logger_('Received non QUOTA_EXCEEDED_ERR on append',error);this.error(type+" append of "+bytes.length+"b failed for segment "+("#"+segmentInfo.mediaIndex+" in playlist "+segmentInfo.playlist.id));this.trigger('appenderror')};_proto.appendToSourceBuffer_=function appendToSourceBuffer_(_ref7){var segmentInfo=_ref7.segmentInfo,type=_ref7.type,initSegment=_ref7.initSegment,data=_ref7.data,bytes=_ref7.bytes;if(!bytes){var segments=[data];var byteLength=data.byteLength;if(initSegment){segments.unshift(initSegment);byteLength+=initSegment.byteLength}
bytes=concatSegments({bytes:byteLength,segments:segments})}
this.sourceUpdater_.appendBuffer({segmentInfo:segmentInfo,type:type,bytes:bytes},this.handleAppendError_.bind(this,{segmentInfo:segmentInfo,type:type,bytes:bytes}))};_proto.handleSegmentTimingInfo_=function handleSegmentTimingInfo_(type,requestId,segmentTimingInfo){if(!this.pendingSegment_||requestId!==this.pendingSegment_.requestId){return}
var segment=this.pendingSegment_.segment;var timingInfoProperty=type+"TimingInfo";if(!segment[timingInfoProperty]){segment[timingInfoProperty]={}}
segment[timingInfoProperty].transmuxerPrependedSeconds=segmentTimingInfo.prependedContentDuration||0;segment[timingInfoProperty].transmuxedPresentationStart=segmentTimingInfo.start.presentation;segment[timingInfoProperty].transmuxedDecodeStart=segmentTimingInfo.start.decode;segment[timingInfoProperty].transmuxedPresentationEnd=segmentTimingInfo.end.presentation;segment[timingInfoProperty].transmuxedDecodeEnd=segmentTimingInfo.end.decode;segment[timingInfoProperty].baseMediaDecodeTime=segmentTimingInfo.baseMediaDecodeTime};_proto.appendData_=function appendData_(segmentInfo,result){var type=result.type,data=result.data;if(!data||!data.byteLength){return}
if(type==='audio'&&this.audioDisabled_){return}
var initSegment=this.getInitSegmentAndUpdateState_({type:type,initSegment:result.initSegment,playlist:segmentInfo.playlist,map:segmentInfo.isFmp4?segmentInfo.segment.map:null});this.appendToSourceBuffer_({segmentInfo:segmentInfo,type:type,initSegment:initSegment,data:data})};_proto.loadSegment_=function loadSegment_(segmentInfo){var _this4=this;this.state='WAITING';this.pendingSegment_=segmentInfo;this.trimBackBuffer_(segmentInfo);if(typeof segmentInfo.timestampOffset==='number'){if(this.transmuxer_){this.transmuxer_.postMessage({action:'clearAllMp4Captions'})}}
if(!this.hasEnoughInfoToLoad_()){this.loadQueue_.push(function(){var options=_extends_1({},segmentInfo,{forceTimestampOffset:!0});_extends_1(segmentInfo,_this4.generateSegmentInfo_(options));_this4.isPendingTimestampOffset_=!1;_this4.updateTransmuxerAndRequestSegment_(segmentInfo)});return}
this.updateTransmuxerAndRequestSegment_(segmentInfo)};_proto.updateTransmuxerAndRequestSegment_=function updateTransmuxerAndRequestSegment_(segmentInfo){var _this5=this;if(this.shouldUpdateTransmuxerTimestampOffset_(segmentInfo.timestampOffset)){this.gopBuffer_.length=0;segmentInfo.gopsToAlignWith=[];this.timeMapping_=0;this.transmuxer_.postMessage({action:'reset'});this.transmuxer_.postMessage({action:'setTimestampOffset',timestampOffset:segmentInfo.timestampOffset})}
var simpleSegment=this.createSimplifiedSegmentObj_(segmentInfo);var isEndOfStream=this.isEndOfStream_(segmentInfo.mediaIndex,segmentInfo.playlist,segmentInfo.partIndex);var isWalkingForward=this.mediaIndex!==null;var isDiscontinuity=segmentInfo.timeline!==this.currentTimeline_&&segmentInfo.timeline>0;var isEndOfTimeline=isEndOfStream||isWalkingForward&&isDiscontinuity;this.logger_("Requesting "+segmentInfoString(segmentInfo));if(simpleSegment.map&&!simpleSegment.map.bytes){this.logger_('going to request init segment.');this.appendInitSegment_={video:!0,audio:!0}}
segmentInfo.abortRequests=mediaSegmentRequest({xhr:this.vhs_.xhr,xhrOptions:this.xhrOptions_,decryptionWorker:this.decrypter_,segment:simpleSegment,abortFn:this.handleAbort_.bind(this,segmentInfo),progressFn:this.handleProgress_.bind(this),trackInfoFn:this.handleTrackInfo_.bind(this),timingInfoFn:this.handleTimingInfo_.bind(this),videoSegmentTimingInfoFn:this.handleSegmentTimingInfo_.bind(this,'video',segmentInfo.requestId),audioSegmentTimingInfoFn:this.handleSegmentTimingInfo_.bind(this,'audio',segmentInfo.requestId),captionsFn:this.handleCaptions_.bind(this),isEndOfTimeline:isEndOfTimeline,endedTimelineFn:function endedTimelineFn(){_this5.logger_('received endedtimeline callback')},id3Fn:this.handleId3_.bind(this),dataFn:this.handleData_.bind(this),doneFn:this.segmentRequestFinished_.bind(this),onTransmuxerLog:function onTransmuxerLog(_ref8){var message=_ref8.message,level=_ref8.level,stream=_ref8.stream;_this5.logger_(segmentInfoString(segmentInfo)+" logged from transmuxer stream "+stream+" as a "+level+": "+message)}})};_proto.trimBackBuffer_=function trimBackBuffer_(segmentInfo){var removeToTime=safeBackBufferTrimTime(this.seekable_(),this.currentTime_(),this.playlist_.targetDuration||10);if(removeToTime>0){this.remove(0,removeToTime)}};_proto.createSimplifiedSegmentObj_=function createSimplifiedSegmentObj_(segmentInfo){var segment=segmentInfo.segment;var part=segmentInfo.part;var simpleSegment={resolvedUri:part?part.resolvedUri:segment.resolvedUri,byterange:part?part.byterange:segment.byterange,requestId:segmentInfo.requestId,transmuxer:segmentInfo.transmuxer,audioAppendStart:segmentInfo.audioAppendStart,gopsToAlignWith:segmentInfo.gopsToAlignWith,part:segmentInfo.part};var previousSegment=segmentInfo.playlist.segments[segmentInfo.mediaIndex-1];if(previousSegment&&previousSegment.timeline===segment.timeline){if(previousSegment.videoTimingInfo){simpleSegment.baseStartTime=previousSegment.videoTimingInfo.transmuxedDecodeEnd}else if(previousSegment.audioTimingInfo){simpleSegment.baseStartTime=previousSegment.audioTimingInfo.transmuxedDecodeEnd}}
if(segment.key){var iv=segment.key.iv||new Uint32Array([0,0,0,segmentInfo.mediaIndex+segmentInfo.playlist.mediaSequence]);simpleSegment.key=this.segmentKey(segment.key);simpleSegment.key.iv=iv}
if(segment.map){simpleSegment.map=this.initSegmentForMap(segment.map)}
return simpleSegment};_proto.saveTransferStats_=function saveTransferStats_(stats){this.mediaRequests+=1;if(stats){this.mediaBytesTransferred+=stats.bytesReceived;this.mediaTransferDuration+=stats.roundTripTime}};_proto.saveBandwidthRelatedStats_=function saveBandwidthRelatedStats_(duration,stats){this.pendingSegment_.byteLength=stats.bytesReceived;if(duration<MIN_SEGMENT_DURATION_TO_SAVE_STATS){this.logger_("Ignoring segment's bandwidth because its duration of "+duration+(" is less than the min to record "+MIN_SEGMENT_DURATION_TO_SAVE_STATS));return}
this.bandwidth=stats.bandwidth;this.roundTrip=stats.roundTripTime};_proto.handleTimeout_=function handleTimeout_(){this.mediaRequestsTimedout+=1;this.bandwidth=1;this.roundTrip=NaN;this.trigger('bandwidthupdate');this.trigger('timeout')};_proto.segmentRequestFinished_=function segmentRequestFinished_(error,simpleSegment,result){if(this.callQueue_.length){this.callQueue_.push(this.segmentRequestFinished_.bind(this,error,simpleSegment,result));return}
this.saveTransferStats_(simpleSegment.stats);if(!this.pendingSegment_){return}
if(simpleSegment.requestId!==this.pendingSegment_.requestId){return}
if(error){this.pendingSegment_=null;this.state='READY';if(error.code===REQUEST_ERRORS.ABORTED){return}
this.pause();if(error.code===REQUEST_ERRORS.TIMEOUT){this.handleTimeout_();return}
this.mediaRequestsErrored+=1;this.error(error);this.trigger('error');return}
var segmentInfo=this.pendingSegment_;this.saveBandwidthRelatedStats_(segmentInfo.duration,simpleSegment.stats);segmentInfo.endOfAllRequests=simpleSegment.endOfAllRequests;if(result.gopInfo){this.gopBuffer_=updateGopBuffer(this.gopBuffer_,result.gopInfo,this.safeAppend_)}
this.state='APPENDING';this.trigger('appending');this.waitForAppendsToComplete_(segmentInfo)};_proto.setTimeMapping_=function setTimeMapping_(timeline){var timelineMapping=this.syncController_.mappingForTimeline(timeline);if(timelineMapping!==null){this.timeMapping_=timelineMapping}};_proto.updateMediaSecondsLoaded_=function updateMediaSecondsLoaded_(segment){if(typeof segment.start==='number'&&typeof segment.end==='number'){this.mediaSecondsLoaded+=segment.end-segment.start}else{this.mediaSecondsLoaded+=segment.duration}};_proto.shouldUpdateTransmuxerTimestampOffset_=function shouldUpdateTransmuxerTimestampOffset_(timestampOffset){if(timestampOffset===null){return!1}
if(this.loaderType_==='main'&&timestampOffset!==this.sourceUpdater_.videoTimestampOffset()){return!0}
if(!this.audioDisabled_&&timestampOffset!==this.sourceUpdater_.audioTimestampOffset()){return!0}
return!1};_proto.trueSegmentStart_=function trueSegmentStart_(_ref9){var currentStart=_ref9.currentStart,playlist=_ref9.playlist,mediaIndex=_ref9.mediaIndex,firstVideoFrameTimeForData=_ref9.firstVideoFrameTimeForData,currentVideoTimestampOffset=_ref9.currentVideoTimestampOffset,useVideoTimingInfo=_ref9.useVideoTimingInfo,videoTimingInfo=_ref9.videoTimingInfo,audioTimingInfo=_ref9.audioTimingInfo;if(typeof currentStart!=='undefined'){return currentStart}
if(!useVideoTimingInfo){return audioTimingInfo.start}
var previousSegment=playlist.segments[mediaIndex-1];if(mediaIndex===0||!previousSegment||typeof previousSegment.start==='undefined'||previousSegment.end!==firstVideoFrameTimeForData+currentVideoTimestampOffset){return firstVideoFrameTimeForData}
return videoTimingInfo.start};_proto.waitForAppendsToComplete_=function waitForAppendsToComplete_(segmentInfo){var trackInfo=this.getCurrentMediaInfo_(segmentInfo);if(!trackInfo){this.error({message:'No starting media returned, likely due to an unsupported media format.',blacklistDuration:Infinity});this.trigger('error');return}
var hasAudio=trackInfo.hasAudio,hasVideo=trackInfo.hasVideo,isMuxed=trackInfo.isMuxed;var waitForVideo=this.loaderType_==='main'&&hasVideo;var waitForAudio=!this.audioDisabled_&&hasAudio&&!isMuxed;segmentInfo.waitingOnAppends=0;if(!segmentInfo.hasAppendedData_){if(!segmentInfo.timingInfo&&typeof segmentInfo.timestampOffset==='number'){this.isPendingTimestampOffset_=!0}
segmentInfo.timingInfo={start:0};segmentInfo.waitingOnAppends++;if(!this.isPendingTimestampOffset_){this.updateSourceBufferTimestampOffset_(segmentInfo);this.processMetadataQueue_()}
this.checkAppendsDone_(segmentInfo);return}
if(waitForVideo){segmentInfo.waitingOnAppends++}
if(waitForAudio){segmentInfo.waitingOnAppends++}
if(waitForVideo){this.sourceUpdater_.videoQueueCallback(this.checkAppendsDone_.bind(this,segmentInfo))}
if(waitForAudio){this.sourceUpdater_.audioQueueCallback(this.checkAppendsDone_.bind(this,segmentInfo))}};_proto.checkAppendsDone_=function checkAppendsDone_(segmentInfo){if(this.checkForAbort_(segmentInfo.requestId)){return}
segmentInfo.waitingOnAppends--;if(segmentInfo.waitingOnAppends===0){this.handleAppendsDone_()}};_proto.checkForIllegalMediaSwitch=function checkForIllegalMediaSwitch(trackInfo){var illegalMediaSwitchError=illegalMediaSwitch(this.loaderType_,this.getCurrentMediaInfo_(),trackInfo);if(illegalMediaSwitchError){this.error({message:illegalMediaSwitchError,blacklistDuration:Infinity});this.trigger('error');return!0}
return!1};_proto.updateSourceBufferTimestampOffset_=function updateSourceBufferTimestampOffset_(segmentInfo){if(segmentInfo.timestampOffset===null||typeof segmentInfo.timingInfo.start!=='number'||segmentInfo.changedTimestampOffset||this.loaderType_!=='main'){return}
var didChange=!1;segmentInfo.timestampOffset-=this.getSegmentStartTimeForTimestampOffsetCalculation_({videoTimingInfo:segmentInfo.segment.videoTimingInfo,audioTimingInfo:segmentInfo.segment.audioTimingInfo,timingInfo:segmentInfo.timingInfo});segmentInfo.changedTimestampOffset=!0;if(segmentInfo.timestampOffset!==this.sourceUpdater_.videoTimestampOffset()){this.sourceUpdater_.videoTimestampOffset(segmentInfo.timestampOffset);didChange=!0}
if(segmentInfo.timestampOffset!==this.sourceUpdater_.audioTimestampOffset()){this.sourceUpdater_.audioTimestampOffset(segmentInfo.timestampOffset);didChange=!0}
if(didChange){this.trigger('timestampoffset')}};_proto.getSegmentStartTimeForTimestampOffsetCalculation_=function getSegmentStartTimeForTimestampOffsetCalculation_(_ref10){var videoTimingInfo=_ref10.videoTimingInfo,audioTimingInfo=_ref10.audioTimingInfo,timingInfo=_ref10.timingInfo;if(!this.useDtsForTimestampOffset_){return timingInfo.start}
if(videoTimingInfo&&typeof videoTimingInfo.transmuxedDecodeStart==='number'){return videoTimingInfo.transmuxedDecodeStart}
if(audioTimingInfo&&typeof audioTimingInfo.transmuxedDecodeStart==='number'){return audioTimingInfo.transmuxedDecodeStart}
return timingInfo.start};_proto.updateTimingInfoEnd_=function updateTimingInfoEnd_(segmentInfo){segmentInfo.timingInfo=segmentInfo.timingInfo||{};var trackInfo=this.getMediaInfo_();var useVideoTimingInfo=this.loaderType_==='main'&&trackInfo&&trackInfo.hasVideo;var prioritizedTimingInfo=useVideoTimingInfo&&segmentInfo.videoTimingInfo?segmentInfo.videoTimingInfo:segmentInfo.audioTimingInfo;if(!prioritizedTimingInfo){return}
segmentInfo.timingInfo.end=typeof prioritizedTimingInfo.end==='number'?prioritizedTimingInfo.end:prioritizedTimingInfo.start+segmentInfo.duration};_proto.handleAppendsDone_=function handleAppendsDone_(){if(this.pendingSegment_){this.trigger('appendsdone')}
if(!this.pendingSegment_){this.state='READY';if(!this.paused()){this.monitorBuffer_()}
return}
var segmentInfo=this.pendingSegment_;this.updateTimingInfoEnd_(segmentInfo);if(this.shouldSaveSegmentTimingInfo_){this.syncController_.saveSegmentTimingInfo({segmentInfo:segmentInfo,shouldSaveTimelineMapping:this.loaderType_==='main'})}
var segmentDurationMessage=getTroublesomeSegmentDurationMessage(segmentInfo,this.sourceType_);if(segmentDurationMessage){if(segmentDurationMessage.severity==='warn'){videojs__default["default"].log.warn(segmentDurationMessage.message)}else{this.logger_(segmentDurationMessage.message)}}
this.recordThroughput_(segmentInfo);this.pendingSegment_=null;this.state='READY';if(segmentInfo.isSyncRequest){this.trigger('syncinfoupdate');if(!segmentInfo.hasAppendedData_){this.logger_("Throwing away un-appended sync request "+segmentInfoString(segmentInfo));return}}
this.logger_("Appended "+segmentInfoString(segmentInfo));this.addSegmentMetadataCue_(segmentInfo);this.fetchAtBuffer_=!0;if(this.currentTimeline_!==segmentInfo.timeline){this.timelineChangeController_.lastTimelineChange({type:this.loaderType_,from:this.currentTimeline_,to:segmentInfo.timeline});if(this.loaderType_==='main'&&!this.audioDisabled_){this.timelineChangeController_.lastTimelineChange({type:'audio',from:this.currentTimeline_,to:segmentInfo.timeline})}}
this.currentTimeline_=segmentInfo.timeline;this.trigger('syncinfoupdate');var segment=segmentInfo.segment;var part=segmentInfo.part;var badSegmentGuess=segment.end&&this.currentTime_()-segment.end>segmentInfo.playlist.targetDuration*3;var badPartGuess=part&&part.end&&this.currentTime_()-part.end>segmentInfo.playlist.partTargetDuration*3;if(badSegmentGuess||badPartGuess){this.logger_("bad "+(badSegmentGuess?'segment':'part')+" "+segmentInfoString(segmentInfo));this.resetEverything();return}
var isWalkingForward=this.mediaIndex!==null;if(isWalkingForward){this.trigger('bandwidthupdate')}
this.trigger('progress');this.mediaIndex=segmentInfo.mediaIndex;this.partIndex=segmentInfo.partIndex;if(this.isEndOfStream_(segmentInfo.mediaIndex,segmentInfo.playlist,segmentInfo.partIndex)){this.endOfStream()}
this.trigger('appended');if(segmentInfo.hasAppendedData_){this.mediaAppends++}
if(!this.paused()){this.monitorBuffer_()}};_proto.recordThroughput_=function recordThroughput_(segmentInfo){if(segmentInfo.duration<MIN_SEGMENT_DURATION_TO_SAVE_STATS){this.logger_("Ignoring segment's throughput because its duration of "+segmentInfo.duration+(" is less than the min to record "+MIN_SEGMENT_DURATION_TO_SAVE_STATS));return}
var rate=this.throughput.rate;var segmentProcessingTime=Date.now()-segmentInfo.endOfAllRequests+1;var segmentProcessingThroughput=Math.floor(segmentInfo.byteLength/segmentProcessingTime*8*1000);this.throughput.rate+=(segmentProcessingThroughput-rate)/++this.throughput.count};_proto.addSegmentMetadataCue_=function addSegmentMetadataCue_(segmentInfo){if(!this.segmentMetadataTrack_){return}
var segment=segmentInfo.segment;var start=segment.start;var end=segment.end;if(!finite(start)||!finite(end)){return}
removeCuesFromTrack(start,end,this.segmentMetadataTrack_);var Cue=window.WebKitDataCue||window.VTTCue;var value={custom:segment.custom,dateTimeObject:segment.dateTimeObject,dateTimeString:segment.dateTimeString,bandwidth:segmentInfo.playlist.attributes.BANDWIDTH,resolution:segmentInfo.playlist.attributes.RESOLUTION,codecs:segmentInfo.playlist.attributes.CODECS,byteLength:segmentInfo.byteLength,uri:segmentInfo.uri,timeline:segmentInfo.timeline,playlist:segmentInfo.playlist.id,start:start,end:end};var data=JSON.stringify(value);var cue=new Cue(start,end,data);cue.value=value;this.segmentMetadataTrack_.addCue(cue)};return SegmentLoader}(videojs__default["default"].EventTarget);function noop(){}
var toTitleCase=function toTitleCase(string){if(typeof string!=='string'){return string}
return string.replace(/./,function(w){return w.toUpperCase()})};var bufferTypes=['video','audio'];var _updating=function updating(type,sourceUpdater){var sourceBuffer=sourceUpdater[type+"Buffer"];return sourceBuffer&&sourceBuffer.updating||sourceUpdater.queuePending[type]};var nextQueueIndexOfType=function nextQueueIndexOfType(type,queue){for(var i=0;i<queue.length;i++){var queueEntry=queue[i];if(queueEntry.type==='mediaSource'){return null}
if(queueEntry.type===type){return i}}
return null};var shiftQueue=function shiftQueue(type,sourceUpdater){if(sourceUpdater.queue.length===0){return}
var queueIndex=0;var queueEntry=sourceUpdater.queue[queueIndex];if(queueEntry.type==='mediaSource'){if(!sourceUpdater.updating()&&sourceUpdater.mediaSource.readyState!=='closed'){sourceUpdater.queue.shift();queueEntry.action(sourceUpdater);if(queueEntry.doneFn){queueEntry.doneFn()}
shiftQueue('audio',sourceUpdater);shiftQueue('video',sourceUpdater)}
return}
if(type==='mediaSource'){return}
if(!sourceUpdater.ready()||sourceUpdater.mediaSource.readyState==='closed'||_updating(type,sourceUpdater)){return}
if(queueEntry.type!==type){queueIndex=nextQueueIndexOfType(type,sourceUpdater.queue);if(queueIndex===null){return}
queueEntry=sourceUpdater.queue[queueIndex]}
sourceUpdater.queue.splice(queueIndex,1);sourceUpdater.queuePending[type]=queueEntry;queueEntry.action(type,sourceUpdater);if(!queueEntry.doneFn){sourceUpdater.queuePending[type]=null;shiftQueue(type,sourceUpdater);return}};var cleanupBuffer=function cleanupBuffer(type,sourceUpdater){var buffer=sourceUpdater[type+"Buffer"];var titleType=toTitleCase(type);if(!buffer){return}
buffer.removeEventListener('updateend',sourceUpdater["on"+titleType+"UpdateEnd_"]);buffer.removeEventListener('error',sourceUpdater["on"+titleType+"Error_"]);sourceUpdater.codecs[type]=null;sourceUpdater[type+"Buffer"]=null};var inSourceBuffers=function inSourceBuffers(mediaSource,sourceBuffer){return mediaSource&&sourceBuffer&&Array.prototype.indexOf.call(mediaSource.sourceBuffers,sourceBuffer)!==-1};var actions={appendBuffer:function appendBuffer(bytes,segmentInfo,onError){return function(type,sourceUpdater){var sourceBuffer=sourceUpdater[type+"Buffer"];if(!inSourceBuffers(sourceUpdater.mediaSource,sourceBuffer)){return}
sourceUpdater.logger_("Appending segment "+segmentInfo.mediaIndex+"'s "+bytes.length+" bytes to "+type+"Buffer");try{sourceBuffer.appendBuffer(bytes)}catch(e){sourceUpdater.logger_("Error with code "+e.code+" "+(e.code===QUOTA_EXCEEDED_ERR?'(QUOTA_EXCEEDED_ERR) ':'')+("when appending segment "+segmentInfo.mediaIndex+" to "+type+"Buffer"));sourceUpdater.queuePending[type]=null;onError(e)}}},remove:function remove(start,end){return function(type,sourceUpdater){var sourceBuffer=sourceUpdater[type+"Buffer"];if(!inSourceBuffers(sourceUpdater.mediaSource,sourceBuffer)){return}
sourceUpdater.logger_("Removing "+start+" to "+end+" from "+type+"Buffer");try{sourceBuffer.remove(start,end)}catch(e){sourceUpdater.logger_("Remove "+start+" to "+end+" from "+type+"Buffer failed")}}},timestampOffset:function timestampOffset(offset){return function(type,sourceUpdater){var sourceBuffer=sourceUpdater[type+"Buffer"];if(!inSourceBuffers(sourceUpdater.mediaSource,sourceBuffer)){return}
sourceUpdater.logger_("Setting "+type+"timestampOffset to "+offset);sourceBuffer.timestampOffset=offset}},callback:function callback(_callback){return function(type,sourceUpdater){_callback()}},endOfStream:function endOfStream(error){return function(sourceUpdater){if(sourceUpdater.mediaSource.readyState!=='open'){return}
sourceUpdater.logger_("Calling mediaSource endOfStream("+(error||'')+")");try{sourceUpdater.mediaSource.endOfStream(error)}catch(e){videojs__default["default"].log.warn('Failed to call media source endOfStream',e)}}},duration:function duration(_duration){return function(sourceUpdater){sourceUpdater.logger_("Setting mediaSource duration to "+_duration);try{sourceUpdater.mediaSource.duration=_duration}catch(e){videojs__default["default"].log.warn('Failed to set media source duration',e)}}},abort:function abort(){return function(type,sourceUpdater){if(sourceUpdater.mediaSource.readyState!=='open'){return}
var sourceBuffer=sourceUpdater[type+"Buffer"];if(!inSourceBuffers(sourceUpdater.mediaSource,sourceBuffer)){return}
sourceUpdater.logger_("calling abort on "+type+"Buffer");try{sourceBuffer.abort()}catch(e){videojs__default["default"].log.warn("Failed to abort on "+type+"Buffer",e)}}},addSourceBuffer:function addSourceBuffer(type,codec){return function(sourceUpdater){var titleType=toTitleCase(type);var mime=getMimeForCodec(codec);sourceUpdater.logger_("Adding "+type+"Buffer with codec "+codec+" to mediaSource");var sourceBuffer=sourceUpdater.mediaSource.addSourceBuffer(mime);sourceBuffer.addEventListener('updateend',sourceUpdater["on"+titleType+"UpdateEnd_"]);sourceBuffer.addEventListener('error',sourceUpdater["on"+titleType+"Error_"]);sourceUpdater.codecs[type]=codec;sourceUpdater[type+"Buffer"]=sourceBuffer}},removeSourceBuffer:function removeSourceBuffer(type){return function(sourceUpdater){var sourceBuffer=sourceUpdater[type+"Buffer"];cleanupBuffer(type,sourceUpdater);if(!inSourceBuffers(sourceUpdater.mediaSource,sourceBuffer)){return}
sourceUpdater.logger_("Removing "+type+"Buffer with codec "+sourceUpdater.codecs[type]+" from mediaSource");try{sourceUpdater.mediaSource.removeSourceBuffer(sourceBuffer)}catch(e){videojs__default["default"].log.warn("Failed to removeSourceBuffer "+type+"Buffer",e)}}},changeType:function changeType(codec){return function(type,sourceUpdater){var sourceBuffer=sourceUpdater[type+"Buffer"];var mime=getMimeForCodec(codec);if(!inSourceBuffers(sourceUpdater.mediaSource,sourceBuffer)){return}
if(sourceUpdater.codecs[type]===codec){return}
sourceUpdater.logger_("changing "+type+"Buffer codec from "+sourceUpdater.codecs[type]+" to "+codec);sourceBuffer.changeType(mime);sourceUpdater.codecs[type]=codec}}};var pushQueue=function pushQueue(_ref){var type=_ref.type,sourceUpdater=_ref.sourceUpdater,action=_ref.action,doneFn=_ref.doneFn,name=_ref.name;sourceUpdater.queue.push({type:type,action:action,doneFn:doneFn,name:name});shiftQueue(type,sourceUpdater)};var onUpdateend=function onUpdateend(type,sourceUpdater){return function(e){if(sourceUpdater.queuePending[type]){var doneFn=sourceUpdater.queuePending[type].doneFn;sourceUpdater.queuePending[type]=null;if(doneFn){doneFn(sourceUpdater[type+"Error_"])}}
shiftQueue(type,sourceUpdater)}};var SourceUpdater=function(_videojs$EventTarget){inheritsLoose(SourceUpdater,_videojs$EventTarget);function SourceUpdater(mediaSource){var _this;_this=_videojs$EventTarget.call(this)||this;_this.mediaSource=mediaSource;_this.sourceopenListener_=function(){return shiftQueue('mediaSource',assertThisInitialized(_this))};_this.mediaSource.addEventListener('sourceopen',_this.sourceopenListener_);_this.logger_=logger('SourceUpdater');_this.audioTimestampOffset_=0;_this.videoTimestampOffset_=0;_this.queue=[];_this.queuePending={audio:null,video:null};_this.delayedAudioAppendQueue_=[];_this.videoAppendQueued_=!1;_this.codecs={};_this.onVideoUpdateEnd_=onUpdateend('video',assertThisInitialized(_this));_this.onAudioUpdateEnd_=onUpdateend('audio',assertThisInitialized(_this));_this.onVideoError_=function(e){_this.videoError_=e};_this.onAudioError_=function(e){_this.audioError_=e};_this.createdSourceBuffers_=!1;_this.initializedEme_=!1;_this.triggeredReady_=!1;return _this}
var _proto=SourceUpdater.prototype;_proto.initializedEme=function initializedEme(){this.initializedEme_=!0;this.triggerReady()};_proto.hasCreatedSourceBuffers=function hasCreatedSourceBuffers(){return this.createdSourceBuffers_};_proto.hasInitializedAnyEme=function hasInitializedAnyEme(){return this.initializedEme_};_proto.ready=function ready(){return this.hasCreatedSourceBuffers()&&this.hasInitializedAnyEme()};_proto.createSourceBuffers=function createSourceBuffers(codecs){if(this.hasCreatedSourceBuffers()){return}
this.addOrChangeSourceBuffers(codecs);this.createdSourceBuffers_=!0;this.trigger('createdsourcebuffers');this.triggerReady()};_proto.triggerReady=function triggerReady(){if(this.ready()&&!this.triggeredReady_){this.triggeredReady_=!0;this.trigger('ready')}};_proto.addSourceBuffer=function addSourceBuffer(type,codec){pushQueue({type:'mediaSource',sourceUpdater:this,action:actions.addSourceBuffer(type,codec),name:'addSourceBuffer'})};_proto.abort=function abort(type){pushQueue({type:type,sourceUpdater:this,action:actions.abort(type),name:'abort'})};_proto.removeSourceBuffer=function removeSourceBuffer(type){if(!this.canRemoveSourceBuffer()){videojs__default["default"].log.error('removeSourceBuffer is not supported!');return}
pushQueue({type:'mediaSource',sourceUpdater:this,action:actions.removeSourceBuffer(type),name:'removeSourceBuffer'})};_proto.canRemoveSourceBuffer=function canRemoveSourceBuffer(){return!videojs__default["default"].browser.IE_VERSION&&!videojs__default["default"].browser.IS_FIREFOX&&window.MediaSource&&window.MediaSource.prototype&&typeof window.MediaSource.prototype.removeSourceBuffer==='function'};SourceUpdater.canChangeType=function canChangeType(){return window.SourceBuffer&&window.SourceBuffer.prototype&&typeof window.SourceBuffer.prototype.changeType==='function'};_proto.canChangeType=function canChangeType(){return this.constructor.canChangeType()};_proto.changeType=function changeType(type,codec){if(!this.canChangeType()){videojs__default["default"].log.error('changeType is not supported!');return}
pushQueue({type:type,sourceUpdater:this,action:actions.changeType(codec),name:'changeType'})};_proto.addOrChangeSourceBuffers=function addOrChangeSourceBuffers(codecs){var _this2=this;if(!codecs||typeof codecs!=='object'||Object.keys(codecs).length===0){throw new Error('Cannot addOrChangeSourceBuffers to undefined codecs')}
Object.keys(codecs).forEach(function(type){var codec=codecs[type];if(!_this2.hasCreatedSourceBuffers()){return _this2.addSourceBuffer(type,codec)}
if(_this2.canChangeType()){_this2.changeType(type,codec)}})};_proto.appendBuffer=function appendBuffer(options,doneFn){var _this3=this;var segmentInfo=options.segmentInfo,type=options.type,bytes=options.bytes;this.processedAppend_=!0;if(type==='audio'&&this.videoBuffer&&!this.videoAppendQueued_){this.delayedAudioAppendQueue_.push([options,doneFn]);this.logger_("delayed audio append of "+bytes.length+" until video append");return}
var onError=doneFn;pushQueue({type:type,sourceUpdater:this,action:actions.appendBuffer(bytes,segmentInfo||{mediaIndex:-1},onError),doneFn:doneFn,name:'appendBuffer'});if(type==='video'){this.videoAppendQueued_=!0;if(!this.delayedAudioAppendQueue_.length){return}
var queue=this.delayedAudioAppendQueue_.slice();this.logger_("queuing delayed audio "+queue.length+" appendBuffers");this.delayedAudioAppendQueue_.length=0;queue.forEach(function(que){_this3.appendBuffer.apply(_this3,que)})}};_proto.audioBuffered=function audioBuffered(){if(!inSourceBuffers(this.mediaSource,this.audioBuffer)){return videojs__default["default"].createTimeRange()}
return this.audioBuffer.buffered?this.audioBuffer.buffered:videojs__default["default"].createTimeRange()};_proto.videoBuffered=function videoBuffered(){if(!inSourceBuffers(this.mediaSource,this.videoBuffer)){return videojs__default["default"].createTimeRange()}
return this.videoBuffer.buffered?this.videoBuffer.buffered:videojs__default["default"].createTimeRange()};_proto.buffered=function buffered(){var video=inSourceBuffers(this.mediaSource,this.videoBuffer)?this.videoBuffer:null;var audio=inSourceBuffers(this.mediaSource,this.audioBuffer)?this.audioBuffer:null;if(audio&&!video){return this.audioBuffered()}
if(video&&!audio){return this.videoBuffered()}
return bufferIntersection(this.audioBuffered(),this.videoBuffered())};_proto.setDuration=function setDuration(duration,doneFn){if(doneFn===void 0){doneFn=noop}
pushQueue({type:'mediaSource',sourceUpdater:this,action:actions.duration(duration),name:'duration',doneFn:doneFn})};_proto.endOfStream=function endOfStream(error,doneFn){if(error===void 0){error=null}
if(doneFn===void 0){doneFn=noop}
if(typeof error!=='string'){error=undefined}
pushQueue({type:'mediaSource',sourceUpdater:this,action:actions.endOfStream(error),name:'endOfStream',doneFn:doneFn})};_proto.removeAudio=function removeAudio(start,end,done){if(done===void 0){done=noop}
if(!this.audioBuffered().length||this.audioBuffered().end(0)===0){done();return}
pushQueue({type:'audio',sourceUpdater:this,action:actions.remove(start,end),doneFn:done,name:'remove'})};_proto.removeVideo=function removeVideo(start,end,done){if(done===void 0){done=noop}
if(!this.videoBuffered().length||this.videoBuffered().end(0)===0){done();return}
pushQueue({type:'video',sourceUpdater:this,action:actions.remove(start,end),doneFn:done,name:'remove'})};_proto.updating=function updating(){if(_updating('audio',this)||_updating('video',this)){return!0}
return!1};_proto.audioTimestampOffset=function audioTimestampOffset(offset){if(typeof offset!=='undefined'&&this.audioBuffer&&this.audioTimestampOffset_!==offset){pushQueue({type:'audio',sourceUpdater:this,action:actions.timestampOffset(offset),name:'timestampOffset'});this.audioTimestampOffset_=offset}
return this.audioTimestampOffset_};_proto.videoTimestampOffset=function videoTimestampOffset(offset){if(typeof offset!=='undefined'&&this.videoBuffer&&this.videoTimestampOffset!==offset){pushQueue({type:'video',sourceUpdater:this,action:actions.timestampOffset(offset),name:'timestampOffset'});this.videoTimestampOffset_=offset}
return this.videoTimestampOffset_};_proto.audioQueueCallback=function audioQueueCallback(callback){if(!this.audioBuffer){return}
pushQueue({type:'audio',sourceUpdater:this,action:actions.callback(callback),name:'callback'})};_proto.videoQueueCallback=function videoQueueCallback(callback){if(!this.videoBuffer){return}
pushQueue({type:'video',sourceUpdater:this,action:actions.callback(callback),name:'callback'})};_proto.dispose=function dispose(){var _this4=this;this.trigger('dispose');bufferTypes.forEach(function(type){_this4.abort(type);if(_this4.canRemoveSourceBuffer()){_this4.removeSourceBuffer(type)}else{_this4[type+"QueueCallback"](function(){return cleanupBuffer(type,_this4)})}});this.videoAppendQueued_=!1;this.delayedAudioAppendQueue_.length=0;if(this.sourceopenListener_){this.mediaSource.removeEventListener('sourceopen',this.sourceopenListener_)}
this.off()};return SourceUpdater}(videojs__default["default"].EventTarget);var uint8ToUtf8=function uint8ToUtf8(uintArray){return decodeURIComponent(escape(String.fromCharCode.apply(null,uintArray)))};var VTT_LINE_TERMINATORS=new Uint8Array('\n\n'.split('').map(function(char){return char.charCodeAt(0)}));var VTTSegmentLoader=function(_SegmentLoader){inheritsLoose(VTTSegmentLoader,_SegmentLoader);function VTTSegmentLoader(settings,options){var _this;if(options===void 0){options={}}
_this=_SegmentLoader.call(this,settings,options)||this;_this.mediaSource_=null;_this.subtitlesTrack_=null;_this.loaderType_='subtitle';_this.featuresNativeTextTracks_=settings.featuresNativeTextTracks;_this.shouldSaveSegmentTimingInfo_=!1;return _this}
var _proto=VTTSegmentLoader.prototype;_proto.createTransmuxer_=function createTransmuxer_(){return null};_proto.buffered_=function buffered_(){if(!this.subtitlesTrack_||!this.subtitlesTrack_.cues||!this.subtitlesTrack_.cues.length){return videojs__default["default"].createTimeRanges()}
var cues=this.subtitlesTrack_.cues;var start=cues[0].startTime;var end=cues[cues.length-1].startTime;return videojs__default["default"].createTimeRanges([[start,end]])};_proto.initSegmentForMap=function initSegmentForMap(map,set){if(set===void 0){set=!1}
if(!map){return null}
var id=initSegmentId(map);var storedMap=this.initSegments_[id];if(set&&!storedMap&&map.bytes){var combinedByteLength=VTT_LINE_TERMINATORS.byteLength+map.bytes.byteLength;var combinedSegment=new Uint8Array(combinedByteLength);combinedSegment.set(map.bytes);combinedSegment.set(VTT_LINE_TERMINATORS,map.bytes.byteLength);this.initSegments_[id]=storedMap={resolvedUri:map.resolvedUri,byterange:map.byterange,bytes:combinedSegment}}
return storedMap||map};_proto.couldBeginLoading_=function couldBeginLoading_(){return this.playlist_&&this.subtitlesTrack_&&!this.paused()};_proto.init_=function init_(){this.state='READY';this.resetEverything();return this.monitorBuffer_()};_proto.track=function track(_track){if(typeof _track==='undefined'){return this.subtitlesTrack_}
this.subtitlesTrack_=_track;if(this.state==='INIT'&&this.couldBeginLoading_()){this.init_()}
return this.subtitlesTrack_};_proto.remove=function remove(start,end){removeCuesFromTrack(start,end,this.subtitlesTrack_)};_proto.fillBuffer_=function fillBuffer_(){var _this2=this;var segmentInfo=this.chooseNextRequest_();if(!segmentInfo){return}
if(this.syncController_.timestampOffsetForTimeline(segmentInfo.timeline)===null){var checkTimestampOffset=function checkTimestampOffset(){_this2.state='READY';if(!_this2.paused()){_this2.monitorBuffer_()}};this.syncController_.one('timestampoffset',checkTimestampOffset);this.state='WAITING_ON_TIMELINE';return}
this.loadSegment_(segmentInfo)};_proto.timestampOffsetForSegment_=function timestampOffsetForSegment_(){return null};_proto.chooseNextRequest_=function chooseNextRequest_(){return this.skipEmptySegments_(_SegmentLoader.prototype.chooseNextRequest_.call(this))};_proto.skipEmptySegments_=function skipEmptySegments_(segmentInfo){while(segmentInfo&&segmentInfo.segment.empty){if(segmentInfo.mediaIndex+1>=segmentInfo.playlist.segments.length){segmentInfo=null;break}
segmentInfo=this.generateSegmentInfo_({playlist:segmentInfo.playlist,mediaIndex:segmentInfo.mediaIndex+1,startOfSegment:segmentInfo.startOfSegment+segmentInfo.duration,isSyncRequest:segmentInfo.isSyncRequest})}
return segmentInfo};_proto.stopForError=function stopForError(error){this.error(error);this.state='READY';this.pause();this.trigger('error')};_proto.segmentRequestFinished_=function segmentRequestFinished_(error,simpleSegment,result){var _this3=this;if(!this.subtitlesTrack_){this.state='READY';return}
this.saveTransferStats_(simpleSegment.stats);if(!this.pendingSegment_){this.state='READY';this.mediaRequestsAborted+=1;return}
if(error){if(error.code===REQUEST_ERRORS.TIMEOUT){this.handleTimeout_()}
if(error.code===REQUEST_ERRORS.ABORTED){this.mediaRequestsAborted+=1}else{this.mediaRequestsErrored+=1}
this.stopForError(error);return}
var segmentInfo=this.pendingSegment_;this.saveBandwidthRelatedStats_(segmentInfo.duration,simpleSegment.stats);if(simpleSegment.key){this.segmentKey(simpleSegment.key,!0)}
this.state='APPENDING';this.trigger('appending');var segment=segmentInfo.segment;if(segment.map){segment.map.bytes=simpleSegment.map.bytes}
segmentInfo.bytes=simpleSegment.bytes;if(typeof window.WebVTT!=='function'&&this.subtitlesTrack_&&this.subtitlesTrack_.tech_){var loadHandler;var errorHandler=function errorHandler(){_this3.subtitlesTrack_.tech_.off('vttjsloaded',loadHandler);_this3.stopForError({message:'Error loading vtt.js'});return};loadHandler=function loadHandler(){_this3.subtitlesTrack_.tech_.off('vttjserror',errorHandler);_this3.segmentRequestFinished_(error,simpleSegment,result)};this.state='WAITING_ON_VTTJS';this.subtitlesTrack_.tech_.one('vttjsloaded',loadHandler);this.subtitlesTrack_.tech_.one('vttjserror',errorHandler);return}
segment.requested=!0;try{this.parseVTTCues_(segmentInfo)}catch(e){this.stopForError({message:e.message});return}
this.updateTimeMapping_(segmentInfo,this.syncController_.timelines[segmentInfo.timeline],this.playlist_);if(segmentInfo.cues.length){segmentInfo.timingInfo={start:segmentInfo.cues[0].startTime,end:segmentInfo.cues[segmentInfo.cues.length-1].endTime}}else{segmentInfo.timingInfo={start:segmentInfo.startOfSegment,end:segmentInfo.startOfSegment+segmentInfo.duration}}
if(segmentInfo.isSyncRequest){this.trigger('syncinfoupdate');this.pendingSegment_=null;this.state='READY';return}
segmentInfo.byteLength=segmentInfo.bytes.byteLength;this.mediaSecondsLoaded+=segment.duration;segmentInfo.cues.forEach(function(cue){_this3.subtitlesTrack_.addCue(_this3.featuresNativeTextTracks_?new window.VTTCue(cue.startTime,cue.endTime,cue.text):cue)});removeDuplicateCuesFromTrack(this.subtitlesTrack_);this.handleAppendsDone_()};_proto.handleData_=function handleData_(){};_proto.updateTimingInfoEnd_=function updateTimingInfoEnd_(){};_proto.parseVTTCues_=function parseVTTCues_(segmentInfo){var decoder;var decodeBytesToString=!1;if(typeof window.TextDecoder==='function'){decoder=new window.TextDecoder('utf8')}else{decoder=window.WebVTT.StringDecoder();decodeBytesToString=!0}
var parser=new window.WebVTT.Parser(window,window.vttjs,decoder);segmentInfo.cues=[];segmentInfo.timestampmap={MPEGTS:0,LOCAL:0};parser.oncue=segmentInfo.cues.push.bind(segmentInfo.cues);parser.ontimestampmap=function(map){segmentInfo.timestampmap=map};parser.onparsingerror=function(error){videojs__default["default"].log.warn('Error encountered when parsing cues: '+error.message)};if(segmentInfo.segment.map){var mapData=segmentInfo.segment.map.bytes;if(decodeBytesToString){mapData=uint8ToUtf8(mapData)}
parser.parse(mapData)}
var segmentData=segmentInfo.bytes;if(decodeBytesToString){segmentData=uint8ToUtf8(segmentData)}
parser.parse(segmentData);parser.flush()};_proto.updateTimeMapping_=function updateTimeMapping_(segmentInfo,mappingObj,playlist){var segment=segmentInfo.segment;if(!mappingObj){return}
if(!segmentInfo.cues.length){segment.empty=!0;return}
var timestampmap=segmentInfo.timestampmap;var diff=timestampmap.MPEGTS/clock.ONE_SECOND_IN_TS-timestampmap.LOCAL+mappingObj.mapping;segmentInfo.cues.forEach(function(cue){cue.startTime+=diff;cue.endTime+=diff});if(!playlist.syncInfo){var firstStart=segmentInfo.cues[0].startTime;var lastStart=segmentInfo.cues[segmentInfo.cues.length-1].startTime;playlist.syncInfo={mediaSequence:playlist.mediaSequence+segmentInfo.mediaIndex,time:Math.min(firstStart,lastStart-segment.duration)}}};return VTTSegmentLoader}(SegmentLoader);var findAdCue=function findAdCue(track,mediaTime){var cues=track.cues;for(var i=0;i<cues.length;i++){var cue=cues[i];if(mediaTime>=cue.adStartTime&&mediaTime<=cue.adEndTime){return cue}}
return null};var updateAdCues=function updateAdCues(media,track,offset){if(offset===void 0){offset=0}
if(!media.segments){return}
var mediaTime=offset;var cue;for(var i=0;i<media.segments.length;i++){var segment=media.segments[i];if(!cue){cue=findAdCue(track,mediaTime+segment.duration/2)}
if(cue){if('cueIn' in segment){cue.endTime=mediaTime;cue.adEndTime=mediaTime;mediaTime+=segment.duration;cue=null;continue}
if(mediaTime<cue.endTime){mediaTime+=segment.duration;continue}
cue.endTime+=segment.duration}else{if('cueOut' in segment){cue=new window.VTTCue(mediaTime,mediaTime+segment.duration,segment.cueOut);cue.adStartTime=mediaTime;cue.adEndTime=mediaTime+parseFloat(segment.cueOut);track.addCue(cue)}
if('cueOutCont' in segment){var _segment$cueOutCont$s=segment.cueOutCont.split('/').map(parseFloat),adOffset=_segment$cueOutCont$s[0],adTotal=_segment$cueOutCont$s[1];cue=new window.VTTCue(mediaTime,mediaTime+segment.duration,'');cue.adStartTime=mediaTime-adOffset;cue.adEndTime=cue.adStartTime+adTotal;track.addCue(cue)}}
mediaTime+=segment.duration}};var MAX_MEDIA_SEQUENCE_DIFF_FOR_SYNC=86400;var syncPointStrategies=[{name:'VOD',run:function run(syncController,playlist,duration,currentTimeline,currentTime){if(duration!==Infinity){var syncPoint={time:0,segmentIndex:0,partIndex:null};return syncPoint}
return null}},{name:'ProgramDateTime',run:function run(syncController,playlist,duration,currentTimeline,currentTime){if(!Object.keys(syncController.timelineToDatetimeMappings).length){return null}
var syncPoint=null;var lastDistance=null;var partsAndSegments=getPartsAndSegments(playlist);currentTime=currentTime||0;for(var i=0;i<partsAndSegments.length;i++){var index=playlist.endList||currentTime===0?i:partsAndSegments.length-(i+1);var partAndSegment=partsAndSegments[index];var segment=partAndSegment.segment;var datetimeMapping=syncController.timelineToDatetimeMappings[segment.timeline];if(!datetimeMapping||!segment.dateTimeObject){continue}
var segmentTime=segment.dateTimeObject.getTime()/1000;var start=segmentTime+datetimeMapping;if(segment.parts&&typeof partAndSegment.partIndex==='number'){for(var z=0;z<partAndSegment.partIndex;z++){start+=segment.parts[z].duration}}
var distance=Math.abs(currentTime-start);if(lastDistance!==null&&(distance===0||lastDistance<distance)){break}
lastDistance=distance;syncPoint={time:start,segmentIndex:partAndSegment.segmentIndex,partIndex:partAndSegment.partIndex}}
return syncPoint}},{name:'Segment',run:function run(syncController,playlist,duration,currentTimeline,currentTime){var syncPoint=null;var lastDistance=null;currentTime=currentTime||0;var partsAndSegments=getPartsAndSegments(playlist);for(var i=0;i<partsAndSegments.length;i++){var index=playlist.endList||currentTime===0?i:partsAndSegments.length-(i+1);var partAndSegment=partsAndSegments[index];var segment=partAndSegment.segment;var start=partAndSegment.part&&partAndSegment.part.start||segment&&segment.start;if(segment.timeline===currentTimeline&&typeof start!=='undefined'){var distance=Math.abs(currentTime-start);if(lastDistance!==null&&lastDistance<distance){break}
if(!syncPoint||lastDistance===null||lastDistance>=distance){lastDistance=distance;syncPoint={time:start,segmentIndex:partAndSegment.segmentIndex,partIndex:partAndSegment.partIndex}}}}
return syncPoint}},{name:'Discontinuity',run:function run(syncController,playlist,duration,currentTimeline,currentTime){var syncPoint=null;currentTime=currentTime||0;if(playlist.discontinuityStarts&&playlist.discontinuityStarts.length){var lastDistance=null;for(var i=0;i<playlist.discontinuityStarts.length;i++){var segmentIndex=playlist.discontinuityStarts[i];var discontinuity=playlist.discontinuitySequence+i+1;var discontinuitySync=syncController.discontinuities[discontinuity];if(discontinuitySync){var distance=Math.abs(currentTime-discontinuitySync.time);if(lastDistance!==null&&lastDistance<distance){break}
if(!syncPoint||lastDistance===null||lastDistance>=distance){lastDistance=distance;syncPoint={time:discontinuitySync.time,segmentIndex:segmentIndex,partIndex:null}}}}}
return syncPoint}},{name:'Playlist',run:function run(syncController,playlist,duration,currentTimeline,currentTime){if(playlist.syncInfo){var syncPoint={time:playlist.syncInfo.time,segmentIndex:playlist.syncInfo.mediaSequence-playlist.mediaSequence,partIndex:null};return syncPoint}
return null}}];var SyncController=function(_videojs$EventTarget){inheritsLoose(SyncController,_videojs$EventTarget);function SyncController(options){var _this;_this=_videojs$EventTarget.call(this)||this;_this.timelines=[];_this.discontinuities=[];_this.timelineToDatetimeMappings={};_this.logger_=logger('SyncController');return _this}
var _proto=SyncController.prototype;_proto.getSyncPoint=function getSyncPoint(playlist,duration,currentTimeline,currentTime){var syncPoints=this.runStrategies_(playlist,duration,currentTimeline,currentTime);if(!syncPoints.length){return null}
return this.selectSyncPoint_(syncPoints,{key:'time',value:currentTime})};_proto.getExpiredTime=function getExpiredTime(playlist,duration){if(!playlist||!playlist.segments){return null}
var syncPoints=this.runStrategies_(playlist,duration,playlist.discontinuitySequence,0);if(!syncPoints.length){return null}
var syncPoint=this.selectSyncPoint_(syncPoints,{key:'segmentIndex',value:0});if(syncPoint.segmentIndex>0){syncPoint.time*=-1}
return Math.abs(syncPoint.time+sumDurations({defaultDuration:playlist.targetDuration,durationList:playlist.segments,startIndex:syncPoint.segmentIndex,endIndex:0}))};_proto.runStrategies_=function runStrategies_(playlist,duration,currentTimeline,currentTime){var syncPoints=[];for(var i=0;i<syncPointStrategies.length;i++){var strategy=syncPointStrategies[i];var syncPoint=strategy.run(this,playlist,duration,currentTimeline,currentTime);if(syncPoint){syncPoint.strategy=strategy.name;syncPoints.push({strategy:strategy.name,syncPoint:syncPoint})}}
return syncPoints};_proto.selectSyncPoint_=function selectSyncPoint_(syncPoints,target){var bestSyncPoint=syncPoints[0].syncPoint;var bestDistance=Math.abs(syncPoints[0].syncPoint[target.key]-target.value);var bestStrategy=syncPoints[0].strategy;for(var i=1;i<syncPoints.length;i++){var newDistance=Math.abs(syncPoints[i].syncPoint[target.key]-target.value);if(newDistance<bestDistance){bestDistance=newDistance;bestSyncPoint=syncPoints[i].syncPoint;bestStrategy=syncPoints[i].strategy}}
this.logger_("syncPoint for ["+target.key+": "+target.value+"] chosen with strategy"+(" ["+bestStrategy+"]: [time:"+bestSyncPoint.time+",")+(" segmentIndex:"+bestSyncPoint.segmentIndex)+(typeof bestSyncPoint.partIndex==='number'?",partIndex:"+bestSyncPoint.partIndex:'')+']');return bestSyncPoint};_proto.saveExpiredSegmentInfo=function saveExpiredSegmentInfo(oldPlaylist,newPlaylist){var mediaSequenceDiff=newPlaylist.mediaSequence-oldPlaylist.mediaSequence;if(mediaSequenceDiff>MAX_MEDIA_SEQUENCE_DIFF_FOR_SYNC){videojs__default["default"].log.warn("Not saving expired segment info. Media sequence gap "+mediaSequenceDiff+" is too large.");return}
for(var i=mediaSequenceDiff-1;i>=0;i--){var lastRemovedSegment=oldPlaylist.segments[i];if(lastRemovedSegment&&typeof lastRemovedSegment.start!=='undefined'){newPlaylist.syncInfo={mediaSequence:oldPlaylist.mediaSequence+i,time:lastRemovedSegment.start};this.logger_("playlist refresh sync: [time:"+newPlaylist.syncInfo.time+","+(" mediaSequence: "+newPlaylist.syncInfo.mediaSequence+"]"));this.trigger('syncinfoupdate');break}}};_proto.setDateTimeMappingForStart=function setDateTimeMappingForStart(playlist){this.timelineToDatetimeMappings={};if(playlist.segments&&playlist.segments.length&&playlist.segments[0].dateTimeObject){var firstSegment=playlist.segments[0];var playlistTimestamp=firstSegment.dateTimeObject.getTime()/1000;this.timelineToDatetimeMappings[firstSegment.timeline]=-playlistTimestamp}};_proto.saveSegmentTimingInfo=function saveSegmentTimingInfo(_ref){var segmentInfo=_ref.segmentInfo,shouldSaveTimelineMapping=_ref.shouldSaveTimelineMapping;var didCalculateSegmentTimeMapping=this.calculateSegmentTimeMapping_(segmentInfo,segmentInfo.timingInfo,shouldSaveTimelineMapping);var segment=segmentInfo.segment;if(didCalculateSegmentTimeMapping){this.saveDiscontinuitySyncInfo_(segmentInfo);if(!segmentInfo.playlist.syncInfo){segmentInfo.playlist.syncInfo={mediaSequence:segmentInfo.playlist.mediaSequence+segmentInfo.mediaIndex,time:segment.start}}}
var dateTime=segment.dateTimeObject;if(segment.discontinuity&&shouldSaveTimelineMapping&&dateTime){this.timelineToDatetimeMappings[segment.timeline]=-(dateTime.getTime()/1000)}};_proto.timestampOffsetForTimeline=function timestampOffsetForTimeline(timeline){if(typeof this.timelines[timeline]==='undefined'){return null}
return this.timelines[timeline].time};_proto.mappingForTimeline=function mappingForTimeline(timeline){if(typeof this.timelines[timeline]==='undefined'){return null}
return this.timelines[timeline].mapping};_proto.calculateSegmentTimeMapping_=function calculateSegmentTimeMapping_(segmentInfo,timingInfo,shouldSaveTimelineMapping){var segment=segmentInfo.segment;var part=segmentInfo.part;var mappingObj=this.timelines[segmentInfo.timeline];var start;var end;if(typeof segmentInfo.timestampOffset==='number'){mappingObj={time:segmentInfo.startOfSegment,mapping:segmentInfo.startOfSegment-timingInfo.start};if(shouldSaveTimelineMapping){this.timelines[segmentInfo.timeline]=mappingObj;this.trigger('timestampoffset');this.logger_("time mapping for timeline "+segmentInfo.timeline+": "+("[time: "+mappingObj.time+"] [mapping: "+mappingObj.mapping+"]"))}
start=segmentInfo.startOfSegment;end=timingInfo.end+mappingObj.mapping}else if(mappingObj){start=timingInfo.start+mappingObj.mapping;end=timingInfo.end+mappingObj.mapping}else{return!1}
if(part){part.start=start;part.end=end}
if(!segment.start||start<segment.start){segment.start=start}
segment.end=end;return!0};_proto.saveDiscontinuitySyncInfo_=function saveDiscontinuitySyncInfo_(segmentInfo){var playlist=segmentInfo.playlist;var segment=segmentInfo.segment;if(segment.discontinuity){this.discontinuities[segment.timeline]={time:segment.start,accuracy:0}}else if(playlist.discontinuityStarts&&playlist.discontinuityStarts.length){for(var i=0;i<playlist.discontinuityStarts.length;i++){var segmentIndex=playlist.discontinuityStarts[i];var discontinuity=playlist.discontinuitySequence+i+1;var mediaIndexDiff=segmentIndex-segmentInfo.mediaIndex;var accuracy=Math.abs(mediaIndexDiff);if(!this.discontinuities[discontinuity]||this.discontinuities[discontinuity].accuracy>accuracy){var time=void 0;if(mediaIndexDiff<0){time=segment.start-sumDurations({defaultDuration:playlist.targetDuration,durationList:playlist.segments,startIndex:segmentInfo.mediaIndex,endIndex:segmentIndex})}else{time=segment.end+sumDurations({defaultDuration:playlist.targetDuration,durationList:playlist.segments,startIndex:segmentInfo.mediaIndex+1,endIndex:segmentIndex})}
this.discontinuities[discontinuity]={time:time,accuracy:accuracy}}}}};_proto.dispose=function dispose(){this.trigger('dispose');this.off()};return SyncController}(videojs__default["default"].EventTarget);var TimelineChangeController=function(_videojs$EventTarget){inheritsLoose(TimelineChangeController,_videojs$EventTarget);function TimelineChangeController(){var _this;_this=_videojs$EventTarget.call(this)||this;_this.pendingTimelineChanges_={};_this.lastTimelineChanges_={};return _this}
var _proto=TimelineChangeController.prototype;_proto.clearPendingTimelineChange=function clearPendingTimelineChange(type){this.pendingTimelineChanges_[type]=null;this.trigger('pendingtimelinechange')};_proto.pendingTimelineChange=function pendingTimelineChange(_ref){var type=_ref.type,from=_ref.from,to=_ref.to;if(typeof from==='number'&&typeof to==='number'){this.pendingTimelineChanges_[type]={type:type,from:from,to:to};this.trigger('pendingtimelinechange')}
return this.pendingTimelineChanges_[type]};_proto.lastTimelineChange=function lastTimelineChange(_ref2){var type=_ref2.type,from=_ref2.from,to=_ref2.to;if(typeof from==='number'&&typeof to==='number'){this.lastTimelineChanges_[type]={type:type,from:from,to:to};delete this.pendingTimelineChanges_[type];this.trigger('timelinechange')}
return this.lastTimelineChanges_[type]};_proto.dispose=function dispose(){this.trigger('dispose');this.pendingTimelineChanges_={};this.lastTimelineChanges_={};this.off()};return TimelineChangeController}(videojs__default["default"].EventTarget);var workerCode=transform(getWorkerString(function(){var commonjsGlobal=typeof globalThis!=='undefined'?globalThis:typeof window!=='undefined'?window:typeof global!=='undefined'?global:typeof self!=='undefined'?self:{};function createCommonjsModule(fn,basedir,module){return module={path:basedir,exports:{},require:function require(path,base){return commonjsRequire(path,base===undefined||base===null?module.path:base)}},fn(module,module.exports),module.exports}
function commonjsRequire(){throw new Error('Dynamic requires are not currently supported by @rollup/plugin-commonjs')}
var createClass=createCommonjsModule(function(module){function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1;descriptor.configurable=!0;if("value" in descriptor)descriptor.writable=!0;Object.defineProperty(target,descriptor.key,descriptor)}}
function _createClass(Constructor,protoProps,staticProps){if(protoProps)_defineProperties(Constructor.prototype,protoProps);if(staticProps)_defineProperties(Constructor,staticProps);return Constructor}
module.exports=_createClass;module.exports["default"]=module.exports,module.exports.__esModule=!0});var setPrototypeOf=createCommonjsModule(function(module){function _setPrototypeOf(o,p){module.exports=_setPrototypeOf=Object.setPrototypeOf||function _setPrototypeOf(o,p){o.__proto__=p;return o};module.exports["default"]=module.exports,module.exports.__esModule=!0;return _setPrototypeOf(o,p)}
module.exports=_setPrototypeOf;module.exports["default"]=module.exports,module.exports.__esModule=!0});var inheritsLoose=createCommonjsModule(function(module){function _inheritsLoose(subClass,superClass){subClass.prototype=Object.create(superClass.prototype);subClass.prototype.constructor=subClass;setPrototypeOf(subClass,superClass)}
module.exports=_inheritsLoose;module.exports["default"]=module.exports,module.exports.__esModule=!0});var Stream=function(){function Stream(){this.listeners={}}
var _proto=Stream.prototype;_proto.on=function on(type,listener){if(!this.listeners[type]){this.listeners[type]=[]}
this.listeners[type].push(listener)};_proto.off=function off(type,listener){if(!this.listeners[type]){return!1}
var index=this.listeners[type].indexOf(listener);this.listeners[type]=this.listeners[type].slice(0);this.listeners[type].splice(index,1);return index>-1};_proto.trigger=function trigger(type){var callbacks=this.listeners[type];if(!callbacks){return}
if(arguments.length===2){var length=callbacks.length;for(var i=0;i<length;++i){callbacks[i].call(this,arguments[1])}}else{var args=Array.prototype.slice.call(arguments,1);var _length=callbacks.length;for(var _i=0;_i<_length;++_i){callbacks[_i].apply(this,args)}}};_proto.dispose=function dispose(){this.listeners={}};_proto.pipe=function pipe(destination){this.on('data',function(data){destination.push(data)})};return Stream}();/*! @name pkcs7 @version 1.0.4 @license Apache-2.0 */
function unpad(padded){return padded.subarray(0,padded.byteLength-padded[padded.byteLength-1])}/*! @name aes-decrypter @version 3.1.3 @license Apache-2.0 */
var precompute=function precompute(){var tables=[[[],[],[],[],[]],[[],[],[],[],[]]];var encTable=tables[0];var decTable=tables[1];var sbox=encTable[4];var sboxInv=decTable[4];var i;var x;var xInv;var d=[];var th=[];var x2;var x4;var x8;var s;var tEnc;var tDec;for(i=0;i<256;i++){th[(d[i]=i<<1^(i>>7)*283)^i]=i}
for(x=xInv=0;!sbox[x];x^=x2||1,xInv=th[xInv]||1){s=xInv^xInv<<1^xInv<<2^xInv<<3^xInv<<4;s=s>>8^s&255^99;sbox[x]=s;sboxInv[s]=x;x8=d[x4=d[x2=d[x]]];tDec=x8*0x1010101^x4*0x10001^x2*0x101^x*0x1010100;tEnc=d[s]*0x101^s*0x1010100;for(i=0;i<4;i++){encTable[i][x]=tEnc=tEnc<<24^tEnc>>>8;decTable[i][s]=tDec=tDec<<24^tDec>>>8}}
for(i=0;i<5;i++){encTable[i]=encTable[i].slice(0);decTable[i]=decTable[i].slice(0)}
return tables};var aesTables=null;var AES=function(){function AES(key){if(!aesTables){aesTables=precompute()}
this._tables=[[aesTables[0][0].slice(),aesTables[0][1].slice(),aesTables[0][2].slice(),aesTables[0][3].slice(),aesTables[0][4].slice()],[aesTables[1][0].slice(),aesTables[1][1].slice(),aesTables[1][2].slice(),aesTables[1][3].slice(),aesTables[1][4].slice()]];var i;var j;var tmp;var sbox=this._tables[0][4];var decTable=this._tables[1];var keyLen=key.length;var rcon=1;if(keyLen!==4&&keyLen!==6&&keyLen!==8){throw new Error('Invalid aes key size')}
var encKey=key.slice(0);var decKey=[];this._key=[encKey,decKey];for(i=keyLen;i<4*keyLen+28;i++){tmp=encKey[i-1];if(i%keyLen===0||keyLen===8&&i%keyLen===4){tmp=sbox[tmp>>>24]<<24^sbox[tmp>>16&255]<<16^sbox[tmp>>8&255]<<8^sbox[tmp&255];if(i%keyLen===0){tmp=tmp<<8^tmp>>>24^rcon<<24;rcon=rcon<<1^(rcon>>7)*283}}
encKey[i]=encKey[i-keyLen]^tmp}
for(j=0;i;j++,i--){tmp=encKey[j&3?i:i-4];if(i<=4||j<4){decKey[j]=tmp}else{decKey[j]=decTable[0][sbox[tmp>>>24]]^decTable[1][sbox[tmp>>16&255]]^decTable[2][sbox[tmp>>8&255]]^decTable[3][sbox[tmp&255]]}}}
var _proto=AES.prototype;_proto.decrypt=function decrypt(encrypted0,encrypted1,encrypted2,encrypted3,out,offset){var key=this._key[1];var a=encrypted0^key[0];var b=encrypted3^key[1];var c=encrypted2^key[2];var d=encrypted1^key[3];var a2;var b2;var c2;var nInnerRounds=key.length/4-2;var i;var kIndex=4;var table=this._tables[1];var table0=table[0];var table1=table[1];var table2=table[2];var table3=table[3];var sbox=table[4];for(i=0;i<nInnerRounds;i++){a2=table0[a>>>24]^table1[b>>16&255]^table2[c>>8&255]^table3[d&255]^key[kIndex];b2=table0[b>>>24]^table1[c>>16&255]^table2[d>>8&255]^table3[a&255]^key[kIndex+1];c2=table0[c>>>24]^table1[d>>16&255]^table2[a>>8&255]^table3[b&255]^key[kIndex+2];d=table0[d>>>24]^table1[a>>16&255]^table2[b>>8&255]^table3[c&255]^key[kIndex+3];kIndex+=4;a=a2;b=b2;c=c2}
for(i=0;i<4;i++){out[(3&-i)+offset]=sbox[a>>>24]<<24^sbox[b>>16&255]<<16^sbox[c>>8&255]<<8^sbox[d&255]^key[kIndex++];a2=a;a=b;b=c;c=d;d=a2}};return AES}();var AsyncStream=function(_Stream){inheritsLoose(AsyncStream,_Stream);function AsyncStream(){var _this;_this=_Stream.call(this,Stream)||this;_this.jobs=[];_this.delay=1;_this.timeout_=null;return _this}
var _proto=AsyncStream.prototype;_proto.processJob_=function processJob_(){this.jobs.shift()();if(this.jobs.length){this.timeout_=setTimeout(this.processJob_.bind(this),this.delay)}else{this.timeout_=null}};_proto.push=function push(job){this.jobs.push(job);if(!this.timeout_){this.timeout_=setTimeout(this.processJob_.bind(this),this.delay)}};return AsyncStream}(Stream);var ntoh=function ntoh(word){return word<<24|(word&0xff00)<<8|(word&0xff0000)>>8|word>>>24};var decrypt=function decrypt(encrypted,key,initVector){var encrypted32=new Int32Array(encrypted.buffer,encrypted.byteOffset,encrypted.byteLength>>2);var decipher=new AES(Array.prototype.slice.call(key));var decrypted=new Uint8Array(encrypted.byteLength);var decrypted32=new Int32Array(decrypted.buffer);var init0;var init1;var init2;var init3;var encrypted0;var encrypted1;var encrypted2;var encrypted3;var wordIx;init0=initVector[0];init1=initVector[1];init2=initVector[2];init3=initVector[3];for(wordIx=0;wordIx<encrypted32.length;wordIx+=4){encrypted0=ntoh(encrypted32[wordIx]);encrypted1=ntoh(encrypted32[wordIx+1]);encrypted2=ntoh(encrypted32[wordIx+2]);encrypted3=ntoh(encrypted32[wordIx+3]);decipher.decrypt(encrypted0,encrypted1,encrypted2,encrypted3,decrypted32,wordIx);decrypted32[wordIx]=ntoh(decrypted32[wordIx]^init0);decrypted32[wordIx+1]=ntoh(decrypted32[wordIx+1]^init1);decrypted32[wordIx+2]=ntoh(decrypted32[wordIx+2]^init2);decrypted32[wordIx+3]=ntoh(decrypted32[wordIx+3]^init3);init0=encrypted0;init1=encrypted1;init2=encrypted2;init3=encrypted3}
return decrypted};var Decrypter=function(){function Decrypter(encrypted,key,initVector,done){var step=Decrypter.STEP;var encrypted32=new Int32Array(encrypted.buffer);var decrypted=new Uint8Array(encrypted.byteLength);var i=0;this.asyncStream_=new AsyncStream();this.asyncStream_.push(this.decryptChunk_(encrypted32.subarray(i,i+step),key,initVector,decrypted));for(i=step;i<encrypted32.length;i+=step){initVector=new Uint32Array([ntoh(encrypted32[i-4]),ntoh(encrypted32[i-3]),ntoh(encrypted32[i-2]),ntoh(encrypted32[i-1])]);this.asyncStream_.push(this.decryptChunk_(encrypted32.subarray(i,i+step),key,initVector,decrypted))}
this.asyncStream_.push(function(){done(null,unpad(decrypted))})}
var _proto=Decrypter.prototype;_proto.decryptChunk_=function decryptChunk_(encrypted,key,initVector,decrypted){return function(){var bytes=decrypt(encrypted,key,initVector);decrypted.set(bytes,encrypted.byteOffset)}};createClass(Decrypter,null,[{key:"STEP",get:function get(){return 32000}}]);return Decrypter}();var win;if(typeof window!=="undefined"){win=window}else if(typeof commonjsGlobal!=="undefined"){win=commonjsGlobal}else if(typeof self!=="undefined"){win=self}else{win={}}
var window_1=win;var isArrayBufferView=function isArrayBufferView(obj){if(ArrayBuffer.isView==='function'){return ArrayBuffer.isView(obj)}
return obj&&obj.buffer instanceof ArrayBuffer};var BigInt=window_1.BigInt||Number;[BigInt('0x1'),BigInt('0x100'),BigInt('0x10000'),BigInt('0x1000000'),BigInt('0x100000000'),BigInt('0x10000000000'),BigInt('0x1000000000000'),BigInt('0x100000000000000'),BigInt('0x10000000000000000')];(function(){var a=new Uint16Array([0xFFCC]);var b=new Uint8Array(a.buffer,a.byteOffset,a.byteLength);if(b[0]===0xFF){return'big'}
if(b[0]===0xCC){return'little'}
return'unknown'})();var createTransferableMessage=function createTransferableMessage(message){var transferable={};Object.keys(message).forEach(function(key){var value=message[key];if(isArrayBufferView(value)){transferable[key]={bytes:value.buffer,byteOffset:value.byteOffset,byteLength:value.byteLength}}else{transferable[key]=value}});return transferable};self.onmessage=function(event){var data=event.data;var encrypted=new Uint8Array(data.encrypted.bytes,data.encrypted.byteOffset,data.encrypted.byteLength);var key=new Uint32Array(data.key.bytes,data.key.byteOffset,data.key.byteLength/4);var iv=new Uint32Array(data.iv.bytes,data.iv.byteOffset,data.iv.byteLength/4);new Decrypter(encrypted,key,iv,function(err,bytes){self.postMessage(createTransferableMessage({source:data.source,decrypted:bytes}),[bytes.buffer])})}}));var Decrypter=factory(workerCode);var audioTrackKind_=function audioTrackKind_(properties){var kind=properties.default?'main':'alternative';if(properties.characteristics&&properties.characteristics.indexOf('public.accessibility.describes-video')>=0){kind='main-desc'}
return kind};var stopLoaders=function stopLoaders(segmentLoader,mediaType){segmentLoader.abort();segmentLoader.pause();if(mediaType&&mediaType.activePlaylistLoader){mediaType.activePlaylistLoader.pause();mediaType.activePlaylistLoader=null}};var startLoaders=function startLoaders(playlistLoader,mediaType){mediaType.activePlaylistLoader=playlistLoader;playlistLoader.load()};var onGroupChanged=function onGroupChanged(type,settings){return function(){var _settings$segmentLoad=settings.segmentLoaders,segmentLoader=_settings$segmentLoad[type],mainSegmentLoader=_settings$segmentLoad.main,mediaType=settings.mediaTypes[type];var activeTrack=mediaType.activeTrack();var activeGroup=mediaType.getActiveGroup();var previousActiveLoader=mediaType.activePlaylistLoader;var lastGroup=mediaType.lastGroup_;if(activeGroup&&lastGroup&&activeGroup.id===lastGroup.id){return}
mediaType.lastGroup_=activeGroup;mediaType.lastTrack_=activeTrack;stopLoaders(segmentLoader,mediaType);if(!activeGroup||activeGroup.isMasterPlaylist){return}
if(!activeGroup.playlistLoader){if(previousActiveLoader){mainSegmentLoader.resetEverything()}
return}
segmentLoader.resyncLoader();startLoaders(activeGroup.playlistLoader,mediaType)}};var onGroupChanging=function onGroupChanging(type,settings){return function(){var segmentLoader=settings.segmentLoaders[type],mediaType=settings.mediaTypes[type];mediaType.lastGroup_=null;segmentLoader.abort();segmentLoader.pause()}};var onTrackChanged=function onTrackChanged(type,settings){return function(){var masterPlaylistLoader=settings.masterPlaylistLoader,_settings$segmentLoad2=settings.segmentLoaders,segmentLoader=_settings$segmentLoad2[type],mainSegmentLoader=_settings$segmentLoad2.main,mediaType=settings.mediaTypes[type];var activeTrack=mediaType.activeTrack();var activeGroup=mediaType.getActiveGroup();var previousActiveLoader=mediaType.activePlaylistLoader;var lastTrack=mediaType.lastTrack_;if(lastTrack&&activeTrack&&lastTrack.id===activeTrack.id){return}
mediaType.lastGroup_=activeGroup;mediaType.lastTrack_=activeTrack;stopLoaders(segmentLoader,mediaType);if(!activeGroup){return}
if(activeGroup.isMasterPlaylist){if(!activeTrack||!lastTrack||activeTrack.id===lastTrack.id){return}
var mpc=settings.vhs.masterPlaylistController_;var newPlaylist=mpc.selectPlaylist();if(mpc.media()===newPlaylist){return}
mediaType.logger_("track change. Switching master audio from "+lastTrack.id+" to "+activeTrack.id);masterPlaylistLoader.pause();mainSegmentLoader.resetEverything();mpc.fastQualityChange_(newPlaylist);return}
if(type==='AUDIO'){if(!activeGroup.playlistLoader){mainSegmentLoader.setAudio(!0);mainSegmentLoader.resetEverything();return}
segmentLoader.setAudio(!0);mainSegmentLoader.setAudio(!1)}
if(previousActiveLoader===activeGroup.playlistLoader){startLoaders(activeGroup.playlistLoader,mediaType);return}
if(segmentLoader.track){segmentLoader.track(activeTrack)}
segmentLoader.resetEverything();startLoaders(activeGroup.playlistLoader,mediaType)}};var onError={AUDIO:function AUDIO(type,settings){return function(){var segmentLoader=settings.segmentLoaders[type],mediaType=settings.mediaTypes[type],blacklistCurrentPlaylist=settings.blacklistCurrentPlaylist;stopLoaders(segmentLoader,mediaType);var activeTrack=mediaType.activeTrack();var activeGroup=mediaType.activeGroup();var id=(activeGroup.filter(function(group){return group.default})[0]||activeGroup[0]).id;var defaultTrack=mediaType.tracks[id];if(activeTrack===defaultTrack){blacklistCurrentPlaylist({message:'Problem encountered loading the default audio track.'});return}
videojs__default["default"].log.warn('Problem encountered loading the alternate audio track.'+'Switching back to default.');for(var trackId in mediaType.tracks){mediaType.tracks[trackId].enabled=mediaType.tracks[trackId]===defaultTrack}
mediaType.onTrackChanged()}},SUBTITLES:function SUBTITLES(type,settings){return function(){var segmentLoader=settings.segmentLoaders[type],mediaType=settings.mediaTypes[type];videojs__default["default"].log.warn('Problem encountered loading the subtitle track.'+'Disabling subtitle track.');stopLoaders(segmentLoader,mediaType);var track=mediaType.activeTrack();if(track){track.mode='disabled'}
mediaType.onTrackChanged()}}};var setupListeners={AUDIO:function AUDIO(type,playlistLoader,settings){if(!playlistLoader){return}
var tech=settings.tech,requestOptions=settings.requestOptions,segmentLoader=settings.segmentLoaders[type];playlistLoader.on('loadedmetadata',function(){var media=playlistLoader.media();segmentLoader.playlist(media,requestOptions);if(!tech.paused()||media.endList&&tech.preload()!=='none'){segmentLoader.load()}});playlistLoader.on('loadedplaylist',function(){segmentLoader.playlist(playlistLoader.media(),requestOptions);if(!tech.paused()){segmentLoader.load()}});playlistLoader.on('error',onError[type](type,settings))},SUBTITLES:function SUBTITLES(type,playlistLoader,settings){var tech=settings.tech,requestOptions=settings.requestOptions,segmentLoader=settings.segmentLoaders[type],mediaType=settings.mediaTypes[type];playlistLoader.on('loadedmetadata',function(){var media=playlistLoader.media();segmentLoader.playlist(media,requestOptions);segmentLoader.track(mediaType.activeTrack());if(!tech.paused()||media.endList&&tech.preload()!=='none'){segmentLoader.load()}});playlistLoader.on('loadedplaylist',function(){segmentLoader.playlist(playlistLoader.media(),requestOptions);if(!tech.paused()){segmentLoader.load()}});playlistLoader.on('error',onError[type](type,settings))}};var initialize={'AUDIO':function AUDIO(type,settings){var vhs=settings.vhs,sourceType=settings.sourceType,segmentLoader=settings.segmentLoaders[type],requestOptions=settings.requestOptions,mediaGroups=settings.master.mediaGroups,_settings$mediaTypes$=settings.mediaTypes[type],groups=_settings$mediaTypes$.groups,tracks=_settings$mediaTypes$.tracks,logger_=_settings$mediaTypes$.logger_,masterPlaylistLoader=settings.masterPlaylistLoader;var audioOnlyMaster=isAudioOnly(masterPlaylistLoader.master);if(!mediaGroups[type]||Object.keys(mediaGroups[type]).length===0){mediaGroups[type]={main:{default:{default:!0}}};if(audioOnlyMaster){mediaGroups[type].main.default.playlists=masterPlaylistLoader.master.playlists}}
for(var groupId in mediaGroups[type]){if(!groups[groupId]){groups[groupId]=[]}
for(var variantLabel in mediaGroups[type][groupId]){var properties=mediaGroups[type][groupId][variantLabel];var playlistLoader=void 0;if(audioOnlyMaster){logger_("AUDIO group '"+groupId+"' label '"+variantLabel+"' is a master playlist");properties.isMasterPlaylist=!0;playlistLoader=null}else if(sourceType==='vhs-json'&&properties.playlists){playlistLoader=new PlaylistLoader(properties.playlists[0],vhs,requestOptions)}else if(properties.resolvedUri){playlistLoader=new PlaylistLoader(properties.resolvedUri,vhs,requestOptions)}else if(properties.playlists&&sourceType==='dash'){playlistLoader=new DashPlaylistLoader(properties.playlists[0],vhs,requestOptions,masterPlaylistLoader)}else{playlistLoader=null}
properties=videojs__default["default"].mergeOptions({id:variantLabel,playlistLoader:playlistLoader},properties);setupListeners[type](type,properties.playlistLoader,settings);groups[groupId].push(properties);if(typeof tracks[variantLabel]==='undefined'){var track=new videojs__default["default"].AudioTrack({id:variantLabel,kind:audioTrackKind_(properties),enabled:!1,language:properties.language,default:properties.default,label:variantLabel});tracks[variantLabel]=track}}}
segmentLoader.on('error',onError[type](type,settings))},'SUBTITLES':function SUBTITLES(type,settings){var tech=settings.tech,vhs=settings.vhs,sourceType=settings.sourceType,segmentLoader=settings.segmentLoaders[type],requestOptions=settings.requestOptions,mediaGroups=settings.master.mediaGroups,_settings$mediaTypes$2=settings.mediaTypes[type],groups=_settings$mediaTypes$2.groups,tracks=_settings$mediaTypes$2.tracks,masterPlaylistLoader=settings.masterPlaylistLoader;for(var groupId in mediaGroups[type]){if(!groups[groupId]){groups[groupId]=[]}
for(var variantLabel in mediaGroups[type][groupId]){if(mediaGroups[type][groupId][variantLabel].forced){continue}
var properties=mediaGroups[type][groupId][variantLabel];var playlistLoader=void 0;if(sourceType==='hls'){playlistLoader=new PlaylistLoader(properties.resolvedUri,vhs,requestOptions)}else if(sourceType==='dash'){var playlists=properties.playlists.filter(function(p){return p.excludeUntil!==Infinity});if(!playlists.length){return}
playlistLoader=new DashPlaylistLoader(properties.playlists[0],vhs,requestOptions,masterPlaylistLoader)}else if(sourceType==='vhs-json'){playlistLoader=new PlaylistLoader(properties.playlists?properties.playlists[0]:properties.resolvedUri,vhs,requestOptions)}
properties=videojs__default["default"].mergeOptions({id:variantLabel,playlistLoader:playlistLoader},properties);setupListeners[type](type,properties.playlistLoader,settings);groups[groupId].push(properties);if(typeof tracks[variantLabel]==='undefined'){var track=tech.addRemoteTextTrack({id:variantLabel,kind:'subtitles',default:properties.default&&properties.autoselect,language:properties.language,label:variantLabel},!1).track;tracks[variantLabel]=track}}}
segmentLoader.on('error',onError[type](type,settings))},'CLOSED-CAPTIONS':function CLOSEDCAPTIONS(type,settings){var tech=settings.tech,mediaGroups=settings.master.mediaGroups,_settings$mediaTypes$3=settings.mediaTypes[type],groups=_settings$mediaTypes$3.groups,tracks=_settings$mediaTypes$3.tracks;for(var groupId in mediaGroups[type]){if(!groups[groupId]){groups[groupId]=[]}
for(var variantLabel in mediaGroups[type][groupId]){var properties=mediaGroups[type][groupId][variantLabel];if(!/^(?:CC|SERVICE)/.test(properties.instreamId)){continue}
var captionServices=tech.options_.vhs&&tech.options_.vhs.captionServices||{};var newProps={label:variantLabel,language:properties.language,instreamId:properties.instreamId,default:properties.default&&properties.autoselect};if(captionServices[newProps.instreamId]){newProps=videojs__default["default"].mergeOptions(newProps,captionServices[newProps.instreamId])}
if(newProps.default===undefined){delete newProps.default}
groups[groupId].push(videojs__default["default"].mergeOptions({id:variantLabel},properties));if(typeof tracks[variantLabel]==='undefined'){var track=tech.addRemoteTextTrack({id:newProps.instreamId,kind:'captions',default:newProps.default,language:newProps.language,label:newProps.label},!1).track;tracks[variantLabel]=track}}}}};var groupMatch=function groupMatch(list,media){for(var i=0;i<list.length;i++){if(playlistMatch(media,list[i])){return!0}
if(list[i].playlists&&groupMatch(list[i].playlists,media)){return!0}}
return!1};var activeGroup=function activeGroup(type,settings){return function(track){var masterPlaylistLoader=settings.masterPlaylistLoader,groups=settings.mediaTypes[type].groups;var media=masterPlaylistLoader.media();if(!media){return null}
var variants=null;if(media.attributes[type]){variants=groups[media.attributes[type]]}
var groupKeys=Object.keys(groups);if(!variants){if(type==='AUDIO'&&groupKeys.length>1&&isAudioOnly(settings.master)){for(var i=0;i<groupKeys.length;i++){var groupPropertyList=groups[groupKeys[i]];if(groupMatch(groupPropertyList,media)){variants=groupPropertyList;break}}}else if(groups.main){variants=groups.main}else if(groupKeys.length===1){variants=groups[groupKeys[0]]}}
if(typeof track==='undefined'){return variants}
if(track===null||!variants){return null}
return variants.filter(function(props){return props.id===track.id})[0]||null}};var activeTrack={AUDIO:function AUDIO(type,settings){return function(){var tracks=settings.mediaTypes[type].tracks;for(var id in tracks){if(tracks[id].enabled){return tracks[id]}}
return null}},SUBTITLES:function SUBTITLES(type,settings){return function(){var tracks=settings.mediaTypes[type].tracks;for(var id in tracks){if(tracks[id].mode==='showing'||tracks[id].mode==='hidden'){return tracks[id]}}
return null}}};var getActiveGroup=function getActiveGroup(type,_ref){var mediaTypes=_ref.mediaTypes;return function(){var activeTrack_=mediaTypes[type].activeTrack();if(!activeTrack_){return null}
return mediaTypes[type].activeGroup(activeTrack_)}};var setupMediaGroups=function setupMediaGroups(settings){['AUDIO','SUBTITLES','CLOSED-CAPTIONS'].forEach(function(type){initialize[type](type,settings)});var mediaTypes=settings.mediaTypes,masterPlaylistLoader=settings.masterPlaylistLoader,tech=settings.tech,vhs=settings.vhs,_settings$segmentLoad3=settings.segmentLoaders,audioSegmentLoader=_settings$segmentLoad3.AUDIO,mainSegmentLoader=_settings$segmentLoad3.main;['AUDIO','SUBTITLES'].forEach(function(type){mediaTypes[type].activeGroup=activeGroup(type,settings);mediaTypes[type].activeTrack=activeTrack[type](type,settings);mediaTypes[type].onGroupChanged=onGroupChanged(type,settings);mediaTypes[type].onGroupChanging=onGroupChanging(type,settings);mediaTypes[type].onTrackChanged=onTrackChanged(type,settings);mediaTypes[type].getActiveGroup=getActiveGroup(type,settings)});var audioGroup=mediaTypes.AUDIO.activeGroup();if(audioGroup){var groupId=(audioGroup.filter(function(group){return group.default})[0]||audioGroup[0]).id;mediaTypes.AUDIO.tracks[groupId].enabled=!0;mediaTypes.AUDIO.onGroupChanged();mediaTypes.AUDIO.onTrackChanged();var activeAudioGroup=mediaTypes.AUDIO.getActiveGroup();if(!activeAudioGroup.playlistLoader){mainSegmentLoader.setAudio(!0)}else{mainSegmentLoader.setAudio(!1);audioSegmentLoader.setAudio(!0)}}
masterPlaylistLoader.on('mediachange',function(){['AUDIO','SUBTITLES'].forEach(function(type){return mediaTypes[type].onGroupChanged()})});masterPlaylistLoader.on('mediachanging',function(){['AUDIO','SUBTITLES'].forEach(function(type){return mediaTypes[type].onGroupChanging()})});var onAudioTrackChanged=function onAudioTrackChanged(){mediaTypes.AUDIO.onTrackChanged();tech.trigger({type:'usage',name:'vhs-audio-change'});tech.trigger({type:'usage',name:'hls-audio-change'})};tech.audioTracks().addEventListener('change',onAudioTrackChanged);tech.remoteTextTracks().addEventListener('change',mediaTypes.SUBTITLES.onTrackChanged);vhs.on('dispose',function(){tech.audioTracks().removeEventListener('change',onAudioTrackChanged);tech.remoteTextTracks().removeEventListener('change',mediaTypes.SUBTITLES.onTrackChanged)});tech.clearTracks('audio');for(var id in mediaTypes.AUDIO.tracks){tech.audioTracks().addTrack(mediaTypes.AUDIO.tracks[id])}};var createMediaTypes=function createMediaTypes(){var mediaTypes={};['AUDIO','SUBTITLES','CLOSED-CAPTIONS'].forEach(function(type){mediaTypes[type]={groups:{},tracks:{},activePlaylistLoader:null,activeGroup:noop,activeTrack:noop,getActiveGroup:noop,onGroupChanged:noop,onTrackChanged:noop,lastTrack_:null,logger_:logger("MediaGroups["+type+"]")}});return mediaTypes};var ABORT_EARLY_BLACKLIST_SECONDS=60*2;var Vhs$1;var loaderStats=['mediaRequests','mediaRequestsAborted','mediaRequestsTimedout','mediaRequestsErrored','mediaTransferDuration','mediaBytesTransferred','mediaAppends'];var sumLoaderStat=function sumLoaderStat(stat){return this.audioSegmentLoader_[stat]+this.mainSegmentLoader_[stat]};var shouldSwitchToMedia=function shouldSwitchToMedia(_ref){var currentPlaylist=_ref.currentPlaylist,buffered=_ref.buffered,currentTime=_ref.currentTime,nextPlaylist=_ref.nextPlaylist,bufferLowWaterLine=_ref.bufferLowWaterLine,bufferHighWaterLine=_ref.bufferHighWaterLine,duration=_ref.duration,experimentalBufferBasedABR=_ref.experimentalBufferBasedABR,log=_ref.log;if(!nextPlaylist){videojs__default["default"].log.warn('We received no playlist to switch to. Please check your stream.');return!1}
var sharedLogLine="allowing switch "+(currentPlaylist&&currentPlaylist.id||'null')+" -> "+nextPlaylist.id;if(!currentPlaylist){log(sharedLogLine+" as current playlist is not set");return!0}
if(nextPlaylist.id===currentPlaylist.id){return!1}
var isBuffered=Boolean(findRange(buffered,currentTime).length);if(!currentPlaylist.endList){if(!isBuffered&&typeof currentPlaylist.partTargetDuration==='number'){log("not "+sharedLogLine+" as current playlist is live llhls, but currentTime isn't in buffered.");return!1}
log(sharedLogLine+" as current playlist is live");return!0}
var forwardBuffer=timeAheadOf(buffered,currentTime);var maxBufferLowWaterLine=experimentalBufferBasedABR?Config.EXPERIMENTAL_MAX_BUFFER_LOW_WATER_LINE:Config.MAX_BUFFER_LOW_WATER_LINE;if(duration<maxBufferLowWaterLine){log(sharedLogLine+" as duration < max low water line ("+duration+" < "+maxBufferLowWaterLine+")");return!0}
var nextBandwidth=nextPlaylist.attributes.BANDWIDTH;var currBandwidth=currentPlaylist.attributes.BANDWIDTH;if(nextBandwidth<currBandwidth&&(!experimentalBufferBasedABR||forwardBuffer<bufferHighWaterLine)){var logLine=sharedLogLine+" as next bandwidth < current bandwidth ("+nextBandwidth+" < "+currBandwidth+")";if(experimentalBufferBasedABR){logLine+=" and forwardBuffer < bufferHighWaterLine ("+forwardBuffer+" < "+bufferHighWaterLine+")"}
log(logLine);return!0}
if((!experimentalBufferBasedABR||nextBandwidth>currBandwidth)&&forwardBuffer>=bufferLowWaterLine){var _logLine=sharedLogLine+" as forwardBuffer >= bufferLowWaterLine ("+forwardBuffer+" >= "+bufferLowWaterLine+")";if(experimentalBufferBasedABR){_logLine+=" and next bandwidth > current bandwidth ("+nextBandwidth+" > "+currBandwidth+")"}
log(_logLine);return!0}
log("not "+sharedLogLine+" as no switching criteria met");return!1};var MasterPlaylistController=function(_videojs$EventTarget){inheritsLoose(MasterPlaylistController,_videojs$EventTarget);function MasterPlaylistController(options){var _this;_this=_videojs$EventTarget.call(this)||this;var src=options.src,handleManifestRedirects=options.handleManifestRedirects,withCredentials=options.withCredentials,tech=options.tech,bandwidth=options.bandwidth,externVhs=options.externVhs,useCueTags=options.useCueTags,blacklistDuration=options.blacklistDuration,enableLowInitialPlaylist=options.enableLowInitialPlaylist,sourceType=options.sourceType,cacheEncryptionKeys=options.cacheEncryptionKeys,experimentalBufferBasedABR=options.experimentalBufferBasedABR,experimentalLeastPixelDiffSelector=options.experimentalLeastPixelDiffSelector,captionServices=options.captionServices;if(!src){throw new Error('A non-empty playlist URL or JSON manifest string is required')}
var maxPlaylistRetries=options.maxPlaylistRetries;if(maxPlaylistRetries===null||typeof maxPlaylistRetries==='undefined'){maxPlaylistRetries=Infinity}
Vhs$1=externVhs;_this.experimentalBufferBasedABR=Boolean(experimentalBufferBasedABR);_this.experimentalLeastPixelDiffSelector=Boolean(experimentalLeastPixelDiffSelector);_this.withCredentials=withCredentials;_this.tech_=tech;_this.vhs_=tech.vhs;_this.sourceType_=sourceType;_this.useCueTags_=useCueTags;_this.blacklistDuration=blacklistDuration;_this.maxPlaylistRetries=maxPlaylistRetries;_this.enableLowInitialPlaylist=enableLowInitialPlaylist;if(_this.useCueTags_){_this.cueTagsTrack_=_this.tech_.addTextTrack('metadata','ad-cues');_this.cueTagsTrack_.inBandMetadataTrackDispatchType=''}
_this.requestOptions_={withCredentials:withCredentials,handleManifestRedirects:handleManifestRedirects,maxPlaylistRetries:maxPlaylistRetries,timeout:null};_this.on('error',_this.pauseLoading);_this.mediaTypes_=createMediaTypes();_this.mediaSource=new window.MediaSource();_this.handleDurationChange_=_this.handleDurationChange_.bind(assertThisInitialized(_this));_this.handleSourceOpen_=_this.handleSourceOpen_.bind(assertThisInitialized(_this));_this.handleSourceEnded_=_this.handleSourceEnded_.bind(assertThisInitialized(_this));_this.mediaSource.addEventListener('durationchange',_this.handleDurationChange_);_this.mediaSource.addEventListener('sourceopen',_this.handleSourceOpen_);_this.mediaSource.addEventListener('sourceended',_this.handleSourceEnded_);_this.seekable_=videojs__default["default"].createTimeRanges();_this.hasPlayed_=!1;_this.syncController_=new SyncController(options);_this.segmentMetadataTrack_=tech.addRemoteTextTrack({kind:'metadata',label:'segment-metadata'},!1).track;_this.decrypter_=new Decrypter();_this.sourceUpdater_=new SourceUpdater(_this.mediaSource);_this.inbandTextTracks_={};_this.timelineChangeController_=new TimelineChangeController();var segmentLoaderSettings={vhs:_this.vhs_,parse708captions:options.parse708captions,useDtsForTimestampOffset:options.useDtsForTimestampOffset,captionServices:captionServices,mediaSource:_this.mediaSource,currentTime:_this.tech_.currentTime.bind(_this.tech_),seekable:function seekable(){return _this.seekable()},seeking:function seeking(){return _this.tech_.seeking()},duration:function duration(){return _this.duration()},hasPlayed:function hasPlayed(){return _this.hasPlayed_},goalBufferLength:function goalBufferLength(){return _this.goalBufferLength()},bandwidth:bandwidth,syncController:_this.syncController_,decrypter:_this.decrypter_,sourceType:_this.sourceType_,inbandTextTracks:_this.inbandTextTracks_,cacheEncryptionKeys:cacheEncryptionKeys,sourceUpdater:_this.sourceUpdater_,timelineChangeController:_this.timelineChangeController_,experimentalExactManifestTimings:options.experimentalExactManifestTimings};_this.masterPlaylistLoader_=_this.sourceType_==='dash'?new DashPlaylistLoader(src,_this.vhs_,_this.requestOptions_):new PlaylistLoader(src,_this.vhs_,_this.requestOptions_);_this.setupMasterPlaylistLoaderListeners_();_this.mainSegmentLoader_=new SegmentLoader(videojs__default["default"].mergeOptions(segmentLoaderSettings,{segmentMetadataTrack:_this.segmentMetadataTrack_,loaderType:'main'}),options);_this.audioSegmentLoader_=new SegmentLoader(videojs__default["default"].mergeOptions(segmentLoaderSettings,{loaderType:'audio'}),options);_this.subtitleSegmentLoader_=new VTTSegmentLoader(videojs__default["default"].mergeOptions(segmentLoaderSettings,{loaderType:'vtt',featuresNativeTextTracks:_this.tech_.featuresNativeTextTracks}),options);_this.setupSegmentLoaderListeners_();if(_this.experimentalBufferBasedABR){_this.masterPlaylistLoader_.one('loadedplaylist',function(){return _this.startABRTimer_()});_this.tech_.on('pause',function(){return _this.stopABRTimer_()});_this.tech_.on('play',function(){return _this.startABRTimer_()})}
loaderStats.forEach(function(stat){_this[stat+'_']=sumLoaderStat.bind(assertThisInitialized(_this),stat)});_this.logger_=logger('MPC');_this.triggeredFmp4Usage=!1;if(_this.tech_.preload()==='none'){_this.loadOnPlay_=function(){_this.loadOnPlay_=null;_this.masterPlaylistLoader_.load()};_this.tech_.one('play',_this.loadOnPlay_)}else{_this.masterPlaylistLoader_.load()}
_this.timeToLoadedData__=-1;_this.mainAppendsToLoadedData__=-1;_this.audioAppendsToLoadedData__=-1;var event=_this.tech_.preload()==='none'?'play':'loadstart';_this.tech_.one(event,function(){var timeToLoadedDataStart=Date.now();_this.tech_.one('loadeddata',function(){_this.timeToLoadedData__=Date.now()-timeToLoadedDataStart;_this.mainAppendsToLoadedData__=_this.mainSegmentLoader_.mediaAppends;_this.audioAppendsToLoadedData__=_this.audioSegmentLoader_.mediaAppends})});return _this}
var _proto=MasterPlaylistController.prototype;_proto.mainAppendsToLoadedData_=function mainAppendsToLoadedData_(){return this.mainAppendsToLoadedData__};_proto.audioAppendsToLoadedData_=function audioAppendsToLoadedData_(){return this.audioAppendsToLoadedData__};_proto.appendsToLoadedData_=function appendsToLoadedData_(){var main=this.mainAppendsToLoadedData_();var audio=this.audioAppendsToLoadedData_();if(main===-1||audio===-1){return-1}
return main+audio};_proto.timeToLoadedData_=function timeToLoadedData_(){return this.timeToLoadedData__};_proto.checkABR_=function checkABR_(reason){if(reason===void 0){reason='abr'}
var nextPlaylist=this.selectPlaylist();if(nextPlaylist&&this.shouldSwitchToMedia_(nextPlaylist)){this.switchMedia_(nextPlaylist,reason)}};_proto.switchMedia_=function switchMedia_(playlist,cause,delay){var oldMedia=this.media();var oldId=oldMedia&&(oldMedia.id||oldMedia.uri);var newId=playlist.id||playlist.uri;if(oldId&&oldId!==newId){this.logger_("switch media "+oldId+" -> "+newId+" from "+cause);this.tech_.trigger({type:'usage',name:"vhs-rendition-change-"+cause})}
this.masterPlaylistLoader_.media(playlist,delay)};_proto.startABRTimer_=function startABRTimer_(){var _this2=this;this.stopABRTimer_();this.abrTimer_=window.setInterval(function(){return _this2.checkABR_()},250)};_proto.stopABRTimer_=function stopABRTimer_(){if(this.tech_.scrubbing&&this.tech_.scrubbing()){return}
window.clearInterval(this.abrTimer_);this.abrTimer_=null};_proto.getAudioTrackPlaylists_=function getAudioTrackPlaylists_(){var master=this.master();var defaultPlaylists=master&&master.playlists||[];if(!master||!master.mediaGroups||!master.mediaGroups.AUDIO){return defaultPlaylists}
var AUDIO=master.mediaGroups.AUDIO;var groupKeys=Object.keys(AUDIO);var track;if(Object.keys(this.mediaTypes_.AUDIO.groups).length){track=this.mediaTypes_.AUDIO.activeTrack()}else{var defaultGroup=AUDIO.main||groupKeys.length&&AUDIO[groupKeys[0]];for(var label in defaultGroup){if(defaultGroup[label].default){track={label:label};break}}}
if(!track){return defaultPlaylists}
var playlists=[];for(var group in AUDIO){if(AUDIO[group][track.label]){var properties=AUDIO[group][track.label];if(properties.playlists&&properties.playlists.length){playlists.push.apply(playlists,properties.playlists)}else if(properties.uri){playlists.push(properties)}else if(master.playlists.length){for(var i=0;i<master.playlists.length;i++){var playlist=master.playlists[i];if(playlist.attributes&&playlist.attributes.AUDIO&&playlist.attributes.AUDIO===group){playlists.push(playlist)}}}}}
if(!playlists.length){return defaultPlaylists}
return playlists};_proto.setupMasterPlaylistLoaderListeners_=function setupMasterPlaylistLoaderListeners_(){var _this3=this;this.masterPlaylistLoader_.on('loadedmetadata',function(){var media=_this3.masterPlaylistLoader_.media();var requestTimeout=media.targetDuration*1.5*1000;if(isLowestEnabledRendition(_this3.masterPlaylistLoader_.master,_this3.masterPlaylistLoader_.media())){_this3.requestOptions_.timeout=0}else{_this3.requestOptions_.timeout=requestTimeout}
if(media.endList&&_this3.tech_.preload()!=='none'){_this3.mainSegmentLoader_.playlist(media,_this3.requestOptions_);_this3.mainSegmentLoader_.load()}
setupMediaGroups({sourceType:_this3.sourceType_,segmentLoaders:{AUDIO:_this3.audioSegmentLoader_,SUBTITLES:_this3.subtitleSegmentLoader_,main:_this3.mainSegmentLoader_},tech:_this3.tech_,requestOptions:_this3.requestOptions_,masterPlaylistLoader:_this3.masterPlaylistLoader_,vhs:_this3.vhs_,master:_this3.master(),mediaTypes:_this3.mediaTypes_,blacklistCurrentPlaylist:_this3.blacklistCurrentPlaylist.bind(_this3)});_this3.triggerPresenceUsage_(_this3.master(),media);_this3.setupFirstPlay();if(!_this3.mediaTypes_.AUDIO.activePlaylistLoader||_this3.mediaTypes_.AUDIO.activePlaylistLoader.media()){_this3.trigger('selectedinitialmedia')}else{_this3.mediaTypes_.AUDIO.activePlaylistLoader.one('loadedmetadata',function(){_this3.trigger('selectedinitialmedia')})}});this.masterPlaylistLoader_.on('loadedplaylist',function(){if(_this3.loadOnPlay_){_this3.tech_.off('play',_this3.loadOnPlay_)}
var updatedPlaylist=_this3.masterPlaylistLoader_.media();if(!updatedPlaylist){_this3.excludeUnsupportedVariants_();var selectedMedia;if(_this3.enableLowInitialPlaylist){selectedMedia=_this3.selectInitialPlaylist()}
if(!selectedMedia){selectedMedia=_this3.selectPlaylist()}
if(!selectedMedia||!_this3.shouldSwitchToMedia_(selectedMedia)){return}
_this3.initialMedia_=selectedMedia;_this3.switchMedia_(_this3.initialMedia_,'initial');var haveJsonSource=_this3.sourceType_==='vhs-json'&&_this3.initialMedia_.segments;if(!haveJsonSource){return}
updatedPlaylist=_this3.initialMedia_}
_this3.handleUpdatedMediaPlaylist(updatedPlaylist)});this.masterPlaylistLoader_.on('error',function(){_this3.blacklistCurrentPlaylist(_this3.masterPlaylistLoader_.error)});this.masterPlaylistLoader_.on('mediachanging',function(){_this3.mainSegmentLoader_.abort();_this3.mainSegmentLoader_.pause()});this.masterPlaylistLoader_.on('mediachange',function(){var media=_this3.masterPlaylistLoader_.media();var requestTimeout=media.targetDuration*1.5*1000;if(isLowestEnabledRendition(_this3.masterPlaylistLoader_.master,_this3.masterPlaylistLoader_.media())){_this3.requestOptions_.timeout=0}else{_this3.requestOptions_.timeout=requestTimeout}
_this3.masterPlaylistLoader_.load();_this3.mainSegmentLoader_.playlist(media,_this3.requestOptions_);_this3.mainSegmentLoader_.load();_this3.tech_.trigger({type:'mediachange',bubbles:!0})});this.masterPlaylistLoader_.on('playlistunchanged',function(){var updatedPlaylist=_this3.masterPlaylistLoader_.media();if(updatedPlaylist.lastExcludeReason_==='playlist-unchanged'){return}
var playlistOutdated=_this3.stuckAtPlaylistEnd_(updatedPlaylist);if(playlistOutdated){_this3.blacklistCurrentPlaylist({message:'Playlist no longer updating.',reason:'playlist-unchanged'});_this3.tech_.trigger('playliststuck')}});this.masterPlaylistLoader_.on('renditiondisabled',function(){_this3.tech_.trigger({type:'usage',name:'vhs-rendition-disabled'});_this3.tech_.trigger({type:'usage',name:'hls-rendition-disabled'})});this.masterPlaylistLoader_.on('renditionenabled',function(){_this3.tech_.trigger({type:'usage',name:'vhs-rendition-enabled'});_this3.tech_.trigger({type:'usage',name:'hls-rendition-enabled'})})};_proto.handleUpdatedMediaPlaylist=function handleUpdatedMediaPlaylist(updatedPlaylist){if(this.useCueTags_){this.updateAdCues_(updatedPlaylist)}
this.mainSegmentLoader_.playlist(updatedPlaylist,this.requestOptions_);this.updateDuration(!updatedPlaylist.endList);if(!this.tech_.paused()){this.mainSegmentLoader_.load();if(this.audioSegmentLoader_){this.audioSegmentLoader_.load()}}};_proto.triggerPresenceUsage_=function triggerPresenceUsage_(master,media){var mediaGroups=master.mediaGroups||{};var defaultDemuxed=!0;var audioGroupKeys=Object.keys(mediaGroups.AUDIO);for(var mediaGroup in mediaGroups.AUDIO){for(var label in mediaGroups.AUDIO[mediaGroup]){var properties=mediaGroups.AUDIO[mediaGroup][label];if(!properties.uri){defaultDemuxed=!1}}}
if(defaultDemuxed){this.tech_.trigger({type:'usage',name:'vhs-demuxed'});this.tech_.trigger({type:'usage',name:'hls-demuxed'})}
if(Object.keys(mediaGroups.SUBTITLES).length){this.tech_.trigger({type:'usage',name:'vhs-webvtt'});this.tech_.trigger({type:'usage',name:'hls-webvtt'})}
if(Vhs$1.Playlist.isAes(media)){this.tech_.trigger({type:'usage',name:'vhs-aes'});this.tech_.trigger({type:'usage',name:'hls-aes'})}
if(audioGroupKeys.length&&Object.keys(mediaGroups.AUDIO[audioGroupKeys[0]]).length>1){this.tech_.trigger({type:'usage',name:'vhs-alternate-audio'});this.tech_.trigger({type:'usage',name:'hls-alternate-audio'})}
if(this.useCueTags_){this.tech_.trigger({type:'usage',name:'vhs-playlist-cue-tags'});this.tech_.trigger({type:'usage',name:'hls-playlist-cue-tags'})}};_proto.shouldSwitchToMedia_=function shouldSwitchToMedia_(nextPlaylist){var currentPlaylist=this.masterPlaylistLoader_.media()||this.masterPlaylistLoader_.pendingMedia_;var currentTime=this.tech_.currentTime();var bufferLowWaterLine=this.bufferLowWaterLine();var bufferHighWaterLine=this.bufferHighWaterLine();var buffered=this.tech_.buffered();return shouldSwitchToMedia({buffered:buffered,currentTime:currentTime,currentPlaylist:currentPlaylist,nextPlaylist:nextPlaylist,bufferLowWaterLine:bufferLowWaterLine,bufferHighWaterLine:bufferHighWaterLine,duration:this.duration(),experimentalBufferBasedABR:this.experimentalBufferBasedABR,log:this.logger_})};_proto.setupSegmentLoaderListeners_=function setupSegmentLoaderListeners_(){var _this4=this;this.mainSegmentLoader_.on('bandwidthupdate',function(){_this4.checkABR_('bandwidthupdate');_this4.tech_.trigger('bandwidthupdate')});this.mainSegmentLoader_.on('timeout',function(){if(_this4.experimentalBufferBasedABR){_this4.mainSegmentLoader_.load()}});if(!this.experimentalBufferBasedABR){this.mainSegmentLoader_.on('progress',function(){_this4.trigger('progress')})}
this.mainSegmentLoader_.on('error',function(){_this4.blacklistCurrentPlaylist(_this4.mainSegmentLoader_.error())});this.mainSegmentLoader_.on('appenderror',function(){_this4.error=_this4.mainSegmentLoader_.error_;_this4.trigger('error')});this.mainSegmentLoader_.on('syncinfoupdate',function(){_this4.onSyncInfoUpdate_()});this.mainSegmentLoader_.on('timestampoffset',function(){_this4.tech_.trigger({type:'usage',name:'vhs-timestamp-offset'});_this4.tech_.trigger({type:'usage',name:'hls-timestamp-offset'})});this.audioSegmentLoader_.on('syncinfoupdate',function(){_this4.onSyncInfoUpdate_()});this.audioSegmentLoader_.on('appenderror',function(){_this4.error=_this4.audioSegmentLoader_.error_;_this4.trigger('error')});this.mainSegmentLoader_.on('ended',function(){_this4.logger_('main segment loader ended');_this4.onEndOfStream()});this.mainSegmentLoader_.on('earlyabort',function(event){if(_this4.experimentalBufferBasedABR){return}
_this4.delegateLoaders_('all',['abort']);_this4.blacklistCurrentPlaylist({message:'Aborted early because there isn\'t enough bandwidth to complete the '+'request without rebuffering.'},ABORT_EARLY_BLACKLIST_SECONDS)});var updateCodecs=function updateCodecs(){if(!_this4.sourceUpdater_.hasCreatedSourceBuffers()){return _this4.tryToCreateSourceBuffers_()}
var codecs=_this4.getCodecsOrExclude_();if(!codecs){return}
_this4.sourceUpdater_.addOrChangeSourceBuffers(codecs)};this.mainSegmentLoader_.on('trackinfo',updateCodecs);this.audioSegmentLoader_.on('trackinfo',updateCodecs);this.mainSegmentLoader_.on('fmp4',function(){if(!_this4.triggeredFmp4Usage){_this4.tech_.trigger({type:'usage',name:'vhs-fmp4'});_this4.tech_.trigger({type:'usage',name:'hls-fmp4'});_this4.triggeredFmp4Usage=!0}});this.audioSegmentLoader_.on('fmp4',function(){if(!_this4.triggeredFmp4Usage){_this4.tech_.trigger({type:'usage',name:'vhs-fmp4'});_this4.tech_.trigger({type:'usage',name:'hls-fmp4'});_this4.triggeredFmp4Usage=!0}});this.audioSegmentLoader_.on('ended',function(){_this4.logger_('audioSegmentLoader ended');_this4.onEndOfStream()})};_proto.mediaSecondsLoaded_=function mediaSecondsLoaded_(){return Math.max(this.audioSegmentLoader_.mediaSecondsLoaded+this.mainSegmentLoader_.mediaSecondsLoaded)};_proto.load=function load(){this.mainSegmentLoader_.load();if(this.mediaTypes_.AUDIO.activePlaylistLoader){this.audioSegmentLoader_.load()}
if(this.mediaTypes_.SUBTITLES.activePlaylistLoader){this.subtitleSegmentLoader_.load()}};_proto.smoothQualityChange_=function smoothQualityChange_(media){if(media===void 0){media=this.selectPlaylist()}
this.fastQualityChange_(media)};_proto.fastQualityChange_=function fastQualityChange_(media){var _this5=this;if(media===void 0){media=this.selectPlaylist()}
if(media===this.masterPlaylistLoader_.media()){this.logger_('skipping fastQualityChange because new media is same as old');return}
this.switchMedia_(media,'fast-quality');this.mainSegmentLoader_.resetEverything(function(){if(videojs__default["default"].browser.IE_VERSION||videojs__default["default"].browser.IS_EDGE){_this5.tech_.setCurrentTime(_this5.tech_.currentTime()+0.04)}else{_this5.tech_.setCurrentTime(_this5.tech_.currentTime())}})};_proto.play=function play(){if(this.setupFirstPlay()){return}
if(this.tech_.ended()){this.tech_.setCurrentTime(0)}
if(this.hasPlayed_){this.load()}
var seekable=this.tech_.seekable();if(this.tech_.duration()===Infinity){if(this.tech_.currentTime()<seekable.start(0)){return this.tech_.setCurrentTime(seekable.end(seekable.length-1))}}};_proto.setupFirstPlay=function setupFirstPlay(){var _this6=this;var media=this.masterPlaylistLoader_.media();if(!media||this.tech_.paused()||this.hasPlayed_){return!1}
if(!media.endList){var seekable=this.seekable();if(!seekable.length){return!1}
if(videojs__default["default"].browser.IE_VERSION&&this.tech_.readyState()===0){this.tech_.one('loadedmetadata',function(){_this6.trigger('firstplay');_this6.tech_.setCurrentTime(seekable.end(0));_this6.hasPlayed_=!0});return!1}
this.trigger('firstplay');this.tech_.setCurrentTime(seekable.end(0))}
this.hasPlayed_=!0;this.load();return!0};_proto.handleSourceOpen_=function handleSourceOpen_(){this.tryToCreateSourceBuffers_();if(this.tech_.autoplay()){var playPromise=this.tech_.play();if(typeof playPromise!=='undefined'&&typeof playPromise.then==='function'){playPromise.then(null,function(e){})}}
this.trigger('sourceopen')};_proto.handleSourceEnded_=function handleSourceEnded_(){if(!this.inbandTextTracks_.metadataTrack_){return}
var cues=this.inbandTextTracks_.metadataTrack_.cues;if(!cues||!cues.length){return}
var duration=this.duration();cues[cues.length-1].endTime=isNaN(duration)||Math.abs(duration)===Infinity?Number.MAX_VALUE:duration};_proto.handleDurationChange_=function handleDurationChange_(){this.tech_.trigger('durationchange')};_proto.onEndOfStream=function onEndOfStream(){var isEndOfStream=this.mainSegmentLoader_.ended_;if(this.mediaTypes_.AUDIO.activePlaylistLoader){var mainMediaInfo=this.mainSegmentLoader_.getCurrentMediaInfo_();if(!mainMediaInfo||mainMediaInfo.hasVideo){isEndOfStream=isEndOfStream&&this.audioSegmentLoader_.ended_}else{isEndOfStream=this.audioSegmentLoader_.ended_}}
if(!isEndOfStream){return}
this.stopABRTimer_();this.sourceUpdater_.endOfStream()};_proto.stuckAtPlaylistEnd_=function stuckAtPlaylistEnd_(playlist){var seekable=this.seekable();if(!seekable.length){return!1}
var expired=this.syncController_.getExpiredTime(playlist,this.duration());if(expired===null){return!1}
var absolutePlaylistEnd=Vhs$1.Playlist.playlistEnd(playlist,expired);var currentTime=this.tech_.currentTime();var buffered=this.tech_.buffered();if(!buffered.length){return absolutePlaylistEnd-currentTime<=SAFE_TIME_DELTA}
var bufferedEnd=buffered.end(buffered.length-1);return bufferedEnd-currentTime<=SAFE_TIME_DELTA&&absolutePlaylistEnd-bufferedEnd<=SAFE_TIME_DELTA};_proto.blacklistCurrentPlaylist=function blacklistCurrentPlaylist(error,blacklistDuration){if(error===void 0){error={}}
var currentPlaylist=error.playlist||this.masterPlaylistLoader_.media();blacklistDuration=blacklistDuration||error.blacklistDuration||this.blacklistDuration;if(!currentPlaylist){this.error=error;if(this.mediaSource.readyState!=='open'){this.trigger('error')}else{this.sourceUpdater_.endOfStream('network')}
return}
currentPlaylist.playlistErrors_++;var playlists=this.masterPlaylistLoader_.master.playlists;var enabledPlaylists=playlists.filter(isEnabled);var isFinalRendition=enabledPlaylists.length===1&&enabledPlaylists[0]===currentPlaylist;if(playlists.length===1&&blacklistDuration!==Infinity){videojs__default["default"].log.warn("Problem encountered with playlist "+currentPlaylist.id+". "+'Trying again since it is the only playlist.');this.tech_.trigger('retryplaylist');return this.masterPlaylistLoader_.load(isFinalRendition)}
if(isFinalRendition){var reincluded=!1;playlists.forEach(function(playlist){if(playlist===currentPlaylist){return}
var excludeUntil=playlist.excludeUntil;if(typeof excludeUntil!=='undefined'&&excludeUntil!==Infinity){reincluded=!0;delete playlist.excludeUntil}});if(reincluded){videojs__default["default"].log.warn('Removing other playlists from the exclusion list because the last '+'rendition is about to be excluded.');this.tech_.trigger('retryplaylist')}}
var excludeUntil;if(currentPlaylist.playlistErrors_>this.maxPlaylistRetries){excludeUntil=Infinity}else{excludeUntil=Date.now()+blacklistDuration*1000}
currentPlaylist.excludeUntil=excludeUntil;if(error.reason){currentPlaylist.lastExcludeReason_=error.reason}
this.tech_.trigger('blacklistplaylist');this.tech_.trigger({type:'usage',name:'vhs-rendition-blacklisted'});this.tech_.trigger({type:'usage',name:'hls-rendition-blacklisted'});var nextPlaylist=this.selectPlaylist();if(!nextPlaylist){this.error='Playback cannot continue. No available working or supported playlists.';this.trigger('error');return}
var logFn=error.internal?this.logger_:videojs__default["default"].log.warn;var errorMessage=error.message?' '+error.message:'';logFn((error.internal?'Internal problem':'Problem')+" encountered with playlist "+currentPlaylist.id+"."+(errorMessage+" Switching to playlist "+nextPlaylist.id+"."));if(nextPlaylist.attributes.AUDIO!==currentPlaylist.attributes.AUDIO){this.delegateLoaders_('audio',['abort','pause'])}
if(nextPlaylist.attributes.SUBTITLES!==currentPlaylist.attributes.SUBTITLES){this.delegateLoaders_('subtitle',['abort','pause'])}
this.delegateLoaders_('main',['abort','pause']);var delayDuration=nextPlaylist.targetDuration/2*1000||5*1000;var shouldDelay=typeof nextPlaylist.lastRequest==='number'&&Date.now()-nextPlaylist.lastRequest<=delayDuration;return this.switchMedia_(nextPlaylist,'exclude',isFinalRendition||shouldDelay)};_proto.pauseLoading=function pauseLoading(){this.delegateLoaders_('all',['abort','pause']);this.stopABRTimer_()};_proto.delegateLoaders_=function delegateLoaders_(filter,fnNames){var _this7=this;var loaders=[];var dontFilterPlaylist=filter==='all';if(dontFilterPlaylist||filter==='main'){loaders.push(this.masterPlaylistLoader_)}
var mediaTypes=[];if(dontFilterPlaylist||filter==='audio'){mediaTypes.push('AUDIO')}
if(dontFilterPlaylist||filter==='subtitle'){mediaTypes.push('CLOSED-CAPTIONS');mediaTypes.push('SUBTITLES')}
mediaTypes.forEach(function(mediaType){var loader=_this7.mediaTypes_[mediaType]&&_this7.mediaTypes_[mediaType].activePlaylistLoader;if(loader){loaders.push(loader)}});['main','audio','subtitle'].forEach(function(name){var loader=_this7[name+"SegmentLoader_"];if(loader&&(filter===name||filter==='all')){loaders.push(loader)}});loaders.forEach(function(loader){return fnNames.forEach(function(fnName){if(typeof loader[fnName]==='function'){loader[fnName]()}})})};_proto.setCurrentTime=function setCurrentTime(currentTime){var buffered=findRange(this.tech_.buffered(),currentTime);if(!(this.masterPlaylistLoader_&&this.masterPlaylistLoader_.media())){return 0}
if(!this.masterPlaylistLoader_.media().segments){return 0}
if(buffered&&buffered.length){return currentTime}
this.mainSegmentLoader_.resetEverything();this.mainSegmentLoader_.abort();if(this.mediaTypes_.AUDIO.activePlaylistLoader){this.audioSegmentLoader_.resetEverything();this.audioSegmentLoader_.abort()}
if(this.mediaTypes_.SUBTITLES.activePlaylistLoader){this.subtitleSegmentLoader_.resetEverything();this.subtitleSegmentLoader_.abort()}
this.load()};_proto.duration=function duration(){if(!this.masterPlaylistLoader_){return 0}
var media=this.masterPlaylistLoader_.media();if(!media){return 0}
if(!media.endList){return Infinity}
if(this.mediaSource){return this.mediaSource.duration}
return Vhs$1.Playlist.duration(media)};_proto.seekable=function seekable(){return this.seekable_};_proto.onSyncInfoUpdate_=function onSyncInfoUpdate_(){var audioSeekable;if(!this.masterPlaylistLoader_){return}
var media=this.masterPlaylistLoader_.media();if(!media){return}
var expired=this.syncController_.getExpiredTime(media,this.duration());if(expired===null){return}
var master=this.masterPlaylistLoader_.master;var mainSeekable=Vhs$1.Playlist.seekable(media,expired,Vhs$1.Playlist.liveEdgeDelay(master,media));if(mainSeekable.length===0){return}
if(this.mediaTypes_.AUDIO.activePlaylistLoader){media=this.mediaTypes_.AUDIO.activePlaylistLoader.media();expired=this.syncController_.getExpiredTime(media,this.duration());if(expired===null){return}
audioSeekable=Vhs$1.Playlist.seekable(media,expired,Vhs$1.Playlist.liveEdgeDelay(master,media));if(audioSeekable.length===0){return}}
var oldEnd;var oldStart;if(this.seekable_&&this.seekable_.length){oldEnd=this.seekable_.end(0);oldStart=this.seekable_.start(0)}
if(!audioSeekable){this.seekable_=mainSeekable}else if(audioSeekable.start(0)>mainSeekable.end(0)||mainSeekable.start(0)>audioSeekable.end(0)){this.seekable_=mainSeekable}else{this.seekable_=videojs__default["default"].createTimeRanges([[audioSeekable.start(0)>mainSeekable.start(0)?audioSeekable.start(0):mainSeekable.start(0),audioSeekable.end(0)<mainSeekable.end(0)?audioSeekable.end(0):mainSeekable.end(0)]])}
if(this.seekable_&&this.seekable_.length){if(this.seekable_.end(0)===oldEnd&&this.seekable_.start(0)===oldStart){return}}
this.logger_("seekable updated ["+printableRange(this.seekable_)+"]");this.tech_.trigger('seekablechanged')};_proto.updateDuration=function updateDuration(isLive){if(this.updateDuration_){this.mediaSource.removeEventListener('sourceopen',this.updateDuration_);this.updateDuration_=null}
if(this.mediaSource.readyState!=='open'){this.updateDuration_=this.updateDuration.bind(this,isLive);this.mediaSource.addEventListener('sourceopen',this.updateDuration_);return}
if(isLive){var seekable=this.seekable();if(!seekable.length){return}
if(isNaN(this.mediaSource.duration)||this.mediaSource.duration<seekable.end(seekable.length-1)){this.sourceUpdater_.setDuration(seekable.end(seekable.length-1))}
return}
var buffered=this.tech_.buffered();var duration=Vhs$1.Playlist.duration(this.masterPlaylistLoader_.media());if(buffered.length>0){duration=Math.max(duration,buffered.end(buffered.length-1))}
if(this.mediaSource.duration!==duration){this.sourceUpdater_.setDuration(duration)}};_proto.dispose=function dispose(){var _this8=this;this.trigger('dispose');this.decrypter_.terminate();this.masterPlaylistLoader_.dispose();this.mainSegmentLoader_.dispose();if(this.loadOnPlay_){this.tech_.off('play',this.loadOnPlay_)}['AUDIO','SUBTITLES'].forEach(function(type){var groups=_this8.mediaTypes_[type].groups;for(var id in groups){groups[id].forEach(function(group){if(group.playlistLoader){group.playlistLoader.dispose()}})}});this.audioSegmentLoader_.dispose();this.subtitleSegmentLoader_.dispose();this.sourceUpdater_.dispose();this.timelineChangeController_.dispose();this.stopABRTimer_();if(this.updateDuration_){this.mediaSource.removeEventListener('sourceopen',this.updateDuration_)}
this.mediaSource.removeEventListener('durationchange',this.handleDurationChange_);this.mediaSource.removeEventListener('sourceopen',this.handleSourceOpen_);this.mediaSource.removeEventListener('sourceended',this.handleSourceEnded_);this.off()};_proto.master=function master(){return this.masterPlaylistLoader_.master};_proto.media=function media(){return this.masterPlaylistLoader_.media()||this.initialMedia_};_proto.areMediaTypesKnown_=function areMediaTypesKnown_(){var usingAudioLoader=!!this.mediaTypes_.AUDIO.activePlaylistLoader;var hasMainMediaInfo=!!this.mainSegmentLoader_.getCurrentMediaInfo_();var hasAudioMediaInfo=!usingAudioLoader?!0:!!this.audioSegmentLoader_.getCurrentMediaInfo_();if(!hasMainMediaInfo||!hasAudioMediaInfo){return!1}
return!0};_proto.getCodecsOrExclude_=function getCodecsOrExclude_(){var _this9=this;var media={main:this.mainSegmentLoader_.getCurrentMediaInfo_()||{},audio:this.audioSegmentLoader_.getCurrentMediaInfo_()||{}};media.video=media.main;var playlistCodecs=codecsForPlaylist(this.master(),this.media());var codecs={};var usingAudioLoader=!!this.mediaTypes_.AUDIO.activePlaylistLoader;if(media.main.hasVideo){codecs.video=playlistCodecs.video||media.main.videoCodec||DEFAULT_VIDEO_CODEC}
if(media.main.isMuxed){codecs.video+=","+(playlistCodecs.audio||media.main.audioCodec||DEFAULT_AUDIO_CODEC)}
if(media.main.hasAudio&&!media.main.isMuxed||media.audio.hasAudio||usingAudioLoader){codecs.audio=playlistCodecs.audio||media.main.audioCodec||media.audio.audioCodec||DEFAULT_AUDIO_CODEC;media.audio.isFmp4=media.main.hasAudio&&!media.main.isMuxed?media.main.isFmp4:media.audio.isFmp4}
if(!codecs.audio&&!codecs.video){this.blacklistCurrentPlaylist({playlist:this.media(),message:'Could not determine codecs for playlist.',blacklistDuration:Infinity});return}
var supportFunction=function supportFunction(isFmp4,codec){return isFmp4?browserSupportsCodec(codec):muxerSupportsCodec(codec)};var unsupportedCodecs={};var unsupportedAudio;['video','audio'].forEach(function(type){if(codecs.hasOwnProperty(type)&&!supportFunction(media[type].isFmp4,codecs[type])){var supporter=media[type].isFmp4?'browser':'muxer';unsupportedCodecs[supporter]=unsupportedCodecs[supporter]||[];unsupportedCodecs[supporter].push(codecs[type]);if(type==='audio'){unsupportedAudio=supporter}}});if(usingAudioLoader&&unsupportedAudio&&this.media().attributes.AUDIO){var audioGroup=this.media().attributes.AUDIO;this.master().playlists.forEach(function(variant){var variantAudioGroup=variant.attributes&&variant.attributes.AUDIO;if(variantAudioGroup===audioGroup&&variant!==_this9.media()){variant.excludeUntil=Infinity}});this.logger_("excluding audio group "+audioGroup+" as "+unsupportedAudio+" does not support codec(s): \""+codecs.audio+"\"")}
if(Object.keys(unsupportedCodecs).length){var message=Object.keys(unsupportedCodecs).reduce(function(acc,supporter){if(acc){acc+=', '}
acc+=supporter+" does not support codec(s): \""+unsupportedCodecs[supporter].join(',')+"\"";return acc},'')+'.';this.blacklistCurrentPlaylist({playlist:this.media(),internal:!0,message:message,blacklistDuration:Infinity});return}
if(this.sourceUpdater_.hasCreatedSourceBuffers()&&!this.sourceUpdater_.canChangeType()){var switchMessages=[];['video','audio'].forEach(function(type){var newCodec=(parseCodecs(_this9.sourceUpdater_.codecs[type]||'')[0]||{}).type;var oldCodec=(parseCodecs(codecs[type]||'')[0]||{}).type;if(newCodec&&oldCodec&&newCodec.toLowerCase()!==oldCodec.toLowerCase()){switchMessages.push("\""+_this9.sourceUpdater_.codecs[type]+"\" -> \""+codecs[type]+"\"")}});if(switchMessages.length){this.blacklistCurrentPlaylist({playlist:this.media(),message:"Codec switching not supported: "+switchMessages.join(', ')+".",blacklistDuration:Infinity,internal:!0});return}}
return codecs};_proto.tryToCreateSourceBuffers_=function tryToCreateSourceBuffers_(){if(this.mediaSource.readyState!=='open'||this.sourceUpdater_.hasCreatedSourceBuffers()){return}
if(!this.areMediaTypesKnown_()){return}
var codecs=this.getCodecsOrExclude_();if(!codecs){return}
this.sourceUpdater_.createSourceBuffers(codecs);var codecString=[codecs.video,codecs.audio].filter(Boolean).join(',');this.excludeIncompatibleVariants_(codecString)};_proto.excludeUnsupportedVariants_=function excludeUnsupportedVariants_(){var _this10=this;var playlists=this.master().playlists;var ids=[];Object.keys(playlists).forEach(function(key){var variant=playlists[key];if(ids.indexOf(variant.id)!==-1){return}
ids.push(variant.id);var codecs=codecsForPlaylist(_this10.master,variant);var unsupported=[];if(codecs.audio&&!muxerSupportsCodec(codecs.audio)&&!browserSupportsCodec(codecs.audio)){unsupported.push("audio codec "+codecs.audio)}
if(codecs.video&&!muxerSupportsCodec(codecs.video)&&!browserSupportsCodec(codecs.video)){unsupported.push("video codec "+codecs.video)}
if(codecs.text&&codecs.text==='stpp.ttml.im1t'){unsupported.push("text codec "+codecs.text)}
if(unsupported.length){variant.excludeUntil=Infinity;_this10.logger_("excluding "+variant.id+" for unsupported: "+unsupported.join(', '))}})};_proto.excludeIncompatibleVariants_=function excludeIncompatibleVariants_(codecString){var _this11=this;var ids=[];var playlists=this.master().playlists;var codecs=unwrapCodecList(parseCodecs(codecString));var codecCount_=codecCount(codecs);var videoDetails=codecs.video&&parseCodecs(codecs.video)[0]||null;var audioDetails=codecs.audio&&parseCodecs(codecs.audio)[0]||null;Object.keys(playlists).forEach(function(key){var variant=playlists[key];if(ids.indexOf(variant.id)!==-1||variant.excludeUntil===Infinity){return}
ids.push(variant.id);var blacklistReasons=[];var variantCodecs=codecsForPlaylist(_this11.masterPlaylistLoader_.master,variant);var variantCodecCount=codecCount(variantCodecs);if(!variantCodecs.audio&&!variantCodecs.video){return}
if(variantCodecCount!==codecCount_){blacklistReasons.push("codec count \""+variantCodecCount+"\" !== \""+codecCount_+"\"")}
if(!_this11.sourceUpdater_.canChangeType()){var variantVideoDetails=variantCodecs.video&&parseCodecs(variantCodecs.video)[0]||null;var variantAudioDetails=variantCodecs.audio&&parseCodecs(variantCodecs.audio)[0]||null;if(variantVideoDetails&&videoDetails&&variantVideoDetails.type.toLowerCase()!==videoDetails.type.toLowerCase()){blacklistReasons.push("video codec \""+variantVideoDetails.type+"\" !== \""+videoDetails.type+"\"")}
if(variantAudioDetails&&audioDetails&&variantAudioDetails.type.toLowerCase()!==audioDetails.type.toLowerCase()){blacklistReasons.push("audio codec \""+variantAudioDetails.type+"\" !== \""+audioDetails.type+"\"")}}
if(blacklistReasons.length){variant.excludeUntil=Infinity;_this11.logger_("blacklisting "+variant.id+": "+blacklistReasons.join(' && '))}})};_proto.updateAdCues_=function updateAdCues_(media){var offset=0;var seekable=this.seekable();if(seekable.length){offset=seekable.start(0)}
updateAdCues(media,this.cueTagsTrack_,offset)};_proto.goalBufferLength=function goalBufferLength(){var currentTime=this.tech_.currentTime();var initial=Config.GOAL_BUFFER_LENGTH;var rate=Config.GOAL_BUFFER_LENGTH_RATE;var max=Math.max(initial,Config.MAX_GOAL_BUFFER_LENGTH);return Math.min(initial+currentTime*rate,max)};_proto.bufferLowWaterLine=function bufferLowWaterLine(){var currentTime=this.tech_.currentTime();var initial=Config.BUFFER_LOW_WATER_LINE;var rate=Config.BUFFER_LOW_WATER_LINE_RATE;var max=Math.max(initial,Config.MAX_BUFFER_LOW_WATER_LINE);var newMax=Math.max(initial,Config.EXPERIMENTAL_MAX_BUFFER_LOW_WATER_LINE);return Math.min(initial+currentTime*rate,this.experimentalBufferBasedABR?newMax:max)};_proto.bufferHighWaterLine=function bufferHighWaterLine(){return Config.BUFFER_HIGH_WATER_LINE};return MasterPlaylistController}(videojs__default["default"].EventTarget);var enableFunction=function enableFunction(loader,playlistID,changePlaylistFn){return function(enable){var playlist=loader.master.playlists[playlistID];var incompatible=isIncompatible(playlist);var currentlyEnabled=isEnabled(playlist);if(typeof enable==='undefined'){return currentlyEnabled}
if(enable){delete playlist.disabled}else{playlist.disabled=!0}
if(enable!==currentlyEnabled&&!incompatible){changePlaylistFn();if(enable){loader.trigger('renditionenabled')}else{loader.trigger('renditiondisabled')}}
return enable}};var Representation=function Representation(vhsHandler,playlist,id){var mpc=vhsHandler.masterPlaylistController_,smoothQualityChange=vhsHandler.options_.smoothQualityChange;var changeType=smoothQualityChange?'smooth':'fast';var qualityChangeFunction=mpc[changeType+"QualityChange_"].bind(mpc);if(playlist.attributes){var resolution=playlist.attributes.RESOLUTION;this.width=resolution&&resolution.width;this.height=resolution&&resolution.height;this.bandwidth=playlist.attributes.BANDWIDTH;this.frameRate=playlist.attributes['FRAME-RATE']}
this.codecs=codecsForPlaylist(mpc.master(),playlist);this.playlist=playlist;this.id=id;this.enabled=enableFunction(vhsHandler.playlists,playlist.id,qualityChangeFunction)};var renditionSelectionMixin=function renditionSelectionMixin(vhsHandler){vhsHandler.representations=function(){var master=vhsHandler.masterPlaylistController_.master();var playlists=isAudioOnly(master)?vhsHandler.masterPlaylistController_.getAudioTrackPlaylists_():master.playlists;if(!playlists){return[]}
return playlists.filter(function(media){return!isIncompatible(media)}).map(function(e,i){return new Representation(vhsHandler,e,e.id)})}};var timerCancelEvents=['seeking','seeked','pause','playing','error'];var PlaybackWatcher=function(){function PlaybackWatcher(options){var _this=this;this.masterPlaylistController_=options.masterPlaylistController;this.tech_=options.tech;this.seekable=options.seekable;this.allowSeeksWithinUnsafeLiveWindow=options.allowSeeksWithinUnsafeLiveWindow;this.liveRangeSafeTimeDelta=options.liveRangeSafeTimeDelta;this.media=options.media;this.consecutiveUpdates=0;this.lastRecordedTime=null;this.timer_=null;this.checkCurrentTimeTimeout_=null;this.logger_=logger('PlaybackWatcher');this.logger_('initialize');var playHandler=function playHandler(){return _this.monitorCurrentTime_()};var canPlayHandler=function canPlayHandler(){return _this.monitorCurrentTime_()};var waitingHandler=function waitingHandler(){return _this.techWaiting_()};var cancelTimerHandler=function cancelTimerHandler(){return _this.cancelTimer_()};var mpc=this.masterPlaylistController_;var loaderTypes=['main','subtitle','audio'];var loaderChecks={};loaderTypes.forEach(function(type){loaderChecks[type]={reset:function reset(){return _this.resetSegmentDownloads_(type)},updateend:function updateend(){return _this.checkSegmentDownloads_(type)}};mpc[type+"SegmentLoader_"].on('appendsdone',loaderChecks[type].updateend);mpc[type+"SegmentLoader_"].on('playlistupdate',loaderChecks[type].reset);_this.tech_.on(['seeked','seeking'],loaderChecks[type].reset)});var setSeekingHandlers=function setSeekingHandlers(fn){['main','audio'].forEach(function(type){mpc[type+"SegmentLoader_"][fn]('appended',_this.seekingAppendCheck_)})};this.seekingAppendCheck_=function(){if(_this.fixesBadSeeks_()){_this.consecutiveUpdates=0;_this.lastRecordedTime=_this.tech_.currentTime();setSeekingHandlers('off')}};this.clearSeekingAppendCheck_=function(){return setSeekingHandlers('off')};this.watchForBadSeeking_=function(){_this.clearSeekingAppendCheck_();setSeekingHandlers('on')};this.tech_.on('seeked',this.clearSeekingAppendCheck_);this.tech_.on('seeking',this.watchForBadSeeking_);this.tech_.on('waiting',waitingHandler);this.tech_.on(timerCancelEvents,cancelTimerHandler);this.tech_.on('canplay',canPlayHandler);this.tech_.one('play',playHandler);this.dispose=function(){_this.clearSeekingAppendCheck_();_this.logger_('dispose');_this.tech_.off('waiting',waitingHandler);_this.tech_.off(timerCancelEvents,cancelTimerHandler);_this.tech_.off('canplay',canPlayHandler);_this.tech_.off('play',playHandler);_this.tech_.off('seeking',_this.watchForBadSeeking_);_this.tech_.off('seeked',_this.clearSeekingAppendCheck_);loaderTypes.forEach(function(type){mpc[type+"SegmentLoader_"].off('appendsdone',loaderChecks[type].updateend);mpc[type+"SegmentLoader_"].off('playlistupdate',loaderChecks[type].reset);_this.tech_.off(['seeked','seeking'],loaderChecks[type].reset)});if(_this.checkCurrentTimeTimeout_){window.clearTimeout(_this.checkCurrentTimeTimeout_)}
_this.cancelTimer_()}}
var _proto=PlaybackWatcher.prototype;_proto.monitorCurrentTime_=function monitorCurrentTime_(){this.checkCurrentTime_();if(this.checkCurrentTimeTimeout_){window.clearTimeout(this.checkCurrentTimeTimeout_)}
this.checkCurrentTimeTimeout_=window.setTimeout(this.monitorCurrentTime_.bind(this),250)};_proto.resetSegmentDownloads_=function resetSegmentDownloads_(type){var loader=this.masterPlaylistController_[type+"SegmentLoader_"];if(this[type+"StalledDownloads_"]>0){this.logger_("resetting possible stalled download count for "+type+" loader")}
this[type+"StalledDownloads_"]=0;this[type+"Buffered_"]=loader.buffered_()};_proto.checkSegmentDownloads_=function checkSegmentDownloads_(type){var mpc=this.masterPlaylistController_;var loader=mpc[type+"SegmentLoader_"];var buffered=loader.buffered_();var isBufferedDifferent=isRangeDifferent(this[type+"Buffered_"],buffered);this[type+"Buffered_"]=buffered;if(isBufferedDifferent){this.resetSegmentDownloads_(type);return}
this[type+"StalledDownloads_"]++;this.logger_("found #"+this[type+"StalledDownloads_"]+" "+type+" appends that did not increase buffer (possible stalled download)",{playlistId:loader.playlist_&&loader.playlist_.id,buffered:timeRangesToArray(buffered)});if(this[type+"StalledDownloads_"]<10){return}
this.logger_(type+" loader stalled download exclusion");this.resetSegmentDownloads_(type);this.tech_.trigger({type:'usage',name:"vhs-"+type+"-download-exclusion"});if(type==='subtitle'){return}
mpc.blacklistCurrentPlaylist({message:"Excessive "+type+" segment downloading detected."},Infinity)};_proto.checkCurrentTime_=function checkCurrentTime_(){if(this.tech_.paused()||this.tech_.seeking()){return}
var currentTime=this.tech_.currentTime();var buffered=this.tech_.buffered();if(this.lastRecordedTime===currentTime&&(!buffered.length||currentTime+SAFE_TIME_DELTA>=buffered.end(buffered.length-1))){return this.techWaiting_()}
if(this.consecutiveUpdates>=5&&currentTime===this.lastRecordedTime){this.consecutiveUpdates++;this.waiting_()}else if(currentTime===this.lastRecordedTime){this.consecutiveUpdates++}else{this.consecutiveUpdates=0;this.lastRecordedTime=currentTime}};_proto.cancelTimer_=function cancelTimer_(){this.consecutiveUpdates=0;if(this.timer_){this.logger_('cancelTimer_');clearTimeout(this.timer_)}
this.timer_=null};_proto.fixesBadSeeks_=function fixesBadSeeks_(){var seeking=this.tech_.seeking();if(!seeking){return!1}
var seekable=this.seekable();var currentTime=this.tech_.currentTime();var isAfterSeekableRange=this.afterSeekableWindow_(seekable,currentTime,this.media(),this.allowSeeksWithinUnsafeLiveWindow);var seekTo;if(isAfterSeekableRange){var seekableEnd=seekable.end(seekable.length-1);seekTo=seekableEnd}
if(this.beforeSeekableWindow_(seekable,currentTime)){var seekableStart=seekable.start(0);seekTo=seekableStart+(seekableStart===seekable.end(0)?0:SAFE_TIME_DELTA)}
if(typeof seekTo!=='undefined'){this.logger_("Trying to seek outside of seekable at time "+currentTime+" with "+("seekable range "+printableRange(seekable)+". Seeking to ")+(seekTo+"."));this.tech_.setCurrentTime(seekTo);return!0}
var sourceUpdater=this.masterPlaylistController_.sourceUpdater_;var buffered=this.tech_.buffered();var audioBuffered=sourceUpdater.audioBuffer?sourceUpdater.audioBuffered():null;var videoBuffered=sourceUpdater.videoBuffer?sourceUpdater.videoBuffered():null;var media=this.media();var minAppendedDuration=media.partTargetDuration?media.partTargetDuration:(media.targetDuration-TIME_FUDGE_FACTOR)*2;var bufferedToCheck=[audioBuffered,videoBuffered];for(var i=0;i<bufferedToCheck.length;i++){if(!bufferedToCheck[i]){continue}
var timeAhead=timeAheadOf(bufferedToCheck[i],currentTime);if(timeAhead<minAppendedDuration){return!1}}
var nextRange=findNextRange(buffered,currentTime);if(nextRange.length===0){return!1}
seekTo=nextRange.start(0)+SAFE_TIME_DELTA;this.logger_("Buffered region starts ("+nextRange.start(0)+") "+(" just beyond seek point ("+currentTime+"). Seeking to "+seekTo+"."));this.tech_.setCurrentTime(seekTo);return!0};_proto.waiting_=function waiting_(){if(this.techWaiting_()){return}
var currentTime=this.tech_.currentTime();var buffered=this.tech_.buffered();var currentRange=findRange(buffered,currentTime);if(currentRange.length&&currentTime+3<=currentRange.end(0)){this.cancelTimer_();this.tech_.setCurrentTime(currentTime);this.logger_("Stopped at "+currentTime+" while inside a buffered region "+("["+currentRange.start(0)+" -> "+currentRange.end(0)+"]. Attempting to resume ")+'playback by seeking to the current time.');this.tech_.trigger({type:'usage',name:'vhs-unknown-waiting'});this.tech_.trigger({type:'usage',name:'hls-unknown-waiting'});return}};_proto.techWaiting_=function techWaiting_(){var seekable=this.seekable();var currentTime=this.tech_.currentTime();if(this.tech_.seeking()||this.timer_!==null){return!0}
if(this.beforeSeekableWindow_(seekable,currentTime)){var livePoint=seekable.end(seekable.length-1);this.logger_("Fell out of live window at time "+currentTime+". Seeking to "+("live point (seekable end) "+livePoint));this.cancelTimer_();this.tech_.setCurrentTime(livePoint);this.tech_.trigger({type:'usage',name:'vhs-live-resync'});this.tech_.trigger({type:'usage',name:'hls-live-resync'});return!0}
var sourceUpdater=this.tech_.vhs.masterPlaylistController_.sourceUpdater_;var buffered=this.tech_.buffered();var videoUnderflow=this.videoUnderflow_({audioBuffered:sourceUpdater.audioBuffered(),videoBuffered:sourceUpdater.videoBuffered(),currentTime:currentTime});if(videoUnderflow){this.cancelTimer_();this.tech_.setCurrentTime(currentTime);this.tech_.trigger({type:'usage',name:'vhs-video-underflow'});this.tech_.trigger({type:'usage',name:'hls-video-underflow'});return!0}
var nextRange=findNextRange(buffered,currentTime);if(nextRange.length>0){var difference=nextRange.start(0)-currentTime;this.logger_("Stopped at "+currentTime+", setting timer for "+difference+", seeking "+("to "+nextRange.start(0)));this.cancelTimer_();this.timer_=setTimeout(this.skipTheGap_.bind(this),difference*1000,currentTime);return!0}
return!1};_proto.afterSeekableWindow_=function afterSeekableWindow_(seekable,currentTime,playlist,allowSeeksWithinUnsafeLiveWindow){if(allowSeeksWithinUnsafeLiveWindow===void 0){allowSeeksWithinUnsafeLiveWindow=!1}
if(!seekable.length){return!1}
var allowedEnd=seekable.end(seekable.length-1)+SAFE_TIME_DELTA;var isLive=!playlist.endList;if(isLive&&allowSeeksWithinUnsafeLiveWindow){allowedEnd=seekable.end(seekable.length-1)+playlist.targetDuration*3}
if(currentTime>allowedEnd){return!0}
return!1};_proto.beforeSeekableWindow_=function beforeSeekableWindow_(seekable,currentTime){if(seekable.length&&seekable.start(0)>0&&currentTime<seekable.start(0)-this.liveRangeSafeTimeDelta){return!0}
return!1};_proto.videoUnderflow_=function videoUnderflow_(_ref){var videoBuffered=_ref.videoBuffered,audioBuffered=_ref.audioBuffered,currentTime=_ref.currentTime;if(!videoBuffered){return}
var gap;if(videoBuffered.length&&audioBuffered.length){var lastVideoRange=findRange(videoBuffered,currentTime-3);var videoRange=findRange(videoBuffered,currentTime);var audioRange=findRange(audioBuffered,currentTime);if(audioRange.length&&!videoRange.length&&lastVideoRange.length){gap={start:lastVideoRange.end(0),end:audioRange.end(0)}}}else{var nextRange=findNextRange(videoBuffered,currentTime);if(!nextRange.length){gap=this.gapFromVideoUnderflow_(videoBuffered,currentTime)}}
if(gap){this.logger_("Encountered a gap in video from "+gap.start+" to "+gap.end+". "+("Seeking to current time "+currentTime));return!0}
return!1};_proto.skipTheGap_=function skipTheGap_(scheduledCurrentTime){var buffered=this.tech_.buffered();var currentTime=this.tech_.currentTime();var nextRange=findNextRange(buffered,currentTime);this.cancelTimer_();if(nextRange.length===0||currentTime!==scheduledCurrentTime){return}
this.logger_('skipTheGap_:','currentTime:',currentTime,'scheduled currentTime:',scheduledCurrentTime,'nextRange start:',nextRange.start(0));this.tech_.setCurrentTime(nextRange.start(0)+TIME_FUDGE_FACTOR);this.tech_.trigger({type:'usage',name:'vhs-gap-skip'});this.tech_.trigger({type:'usage',name:'hls-gap-skip'})};_proto.gapFromVideoUnderflow_=function gapFromVideoUnderflow_(buffered,currentTime){var gaps=findGaps(buffered);for(var i=0;i<gaps.length;i++){var start=gaps.start(i);var end=gaps.end(i);if(currentTime-start<4&&currentTime-start>2){return{start:start,end:end}}}
return null};return PlaybackWatcher}();var defaultOptions={errorInterval:30,getSource:function getSource(next){var tech=this.tech({IWillNotUseThisInPlugins:!0});var sourceObj=tech.currentSource_||this.currentSource();return next(sourceObj)}};var initPlugin=function initPlugin(player,options){var lastCalled=0;var seekTo=0;var localOptions=videojs__default["default"].mergeOptions(defaultOptions,options);player.ready(function(){player.trigger({type:'usage',name:'vhs-error-reload-initialized'});player.trigger({type:'usage',name:'hls-error-reload-initialized'})});var loadedMetadataHandler=function loadedMetadataHandler(){if(seekTo){player.currentTime(seekTo)}};var setSource=function setSource(sourceObj){if(sourceObj===null||sourceObj===undefined){return}
seekTo=player.duration()!==Infinity&&player.currentTime()||0;player.one('loadedmetadata',loadedMetadataHandler);player.src(sourceObj);player.trigger({type:'usage',name:'vhs-error-reload'});player.trigger({type:'usage',name:'hls-error-reload'});player.play()};var errorHandler=function errorHandler(){if(Date.now()-lastCalled<localOptions.errorInterval*1000){player.trigger({type:'usage',name:'vhs-error-reload-canceled'});player.trigger({type:'usage',name:'hls-error-reload-canceled'});return}
if(!localOptions.getSource||typeof localOptions.getSource!=='function'){videojs__default["default"].log.error('ERROR: reloadSourceOnError - The option getSource must be a function!');return}
lastCalled=Date.now();return localOptions.getSource.call(player,setSource)};var cleanupEvents=function cleanupEvents(){player.off('loadedmetadata',loadedMetadataHandler);player.off('error',errorHandler);player.off('dispose',cleanupEvents)};var reinitPlugin=function reinitPlugin(newOptions){cleanupEvents();initPlugin(player,newOptions)};player.on('error',errorHandler);player.on('dispose',cleanupEvents);player.reloadSourceOnError=reinitPlugin};var reloadSourceOnError=function reloadSourceOnError(options){initPlugin(this,options)};var version$4="2.15.1";var version$3="6.0.1";var version$2="0.22.1";var version$1="4.8.0";var version="3.1.3";var Vhs={PlaylistLoader:PlaylistLoader,Playlist:Playlist,utils:utils,STANDARD_PLAYLIST_SELECTOR:lastBandwidthSelector,INITIAL_PLAYLIST_SELECTOR:lowestBitrateCompatibleVariantSelector,lastBandwidthSelector:lastBandwidthSelector,movingAverageBandwidthSelector:movingAverageBandwidthSelector,comparePlaylistBandwidth:comparePlaylistBandwidth,comparePlaylistResolution:comparePlaylistResolution,xhr:xhrFactory()};Object.keys(Config).forEach(function(prop){Object.defineProperty(Vhs,prop,{get:function get(){videojs__default["default"].log.warn("using Vhs."+prop+" is UNSAFE be sure you know what you are doing");return Config[prop]},set:function set(value){videojs__default["default"].log.warn("using Vhs."+prop+" is UNSAFE be sure you know what you are doing");if(typeof value!=='number'||value<0){videojs__default["default"].log.warn("value of Vhs."+prop+" must be greater than or equal to 0");return}
Config[prop]=value}})});var LOCAL_STORAGE_KEY='videojs-vhs';var handleVhsMediaChange=function handleVhsMediaChange(qualityLevels,playlistLoader){var newPlaylist=playlistLoader.media();var selectedIndex=-1;for(var i=0;i<qualityLevels.length;i++){if(qualityLevels[i].id===newPlaylist.id){selectedIndex=i;break}}
qualityLevels.selectedIndex_=selectedIndex;qualityLevels.trigger({selectedIndex:selectedIndex,type:'change'})};var handleVhsLoadedMetadata=function handleVhsLoadedMetadata(qualityLevels,vhs){vhs.representations().forEach(function(rep){qualityLevels.addQualityLevel(rep)});handleVhsMediaChange(qualityLevels,vhs.playlists)};Vhs.canPlaySource=function(){return videojs__default["default"].log.warn('HLS is no longer a tech. Please remove it from '+'your player\'s techOrder.')};var emeKeySystems=function emeKeySystems(keySystemOptions,mainPlaylist,audioPlaylist){if(!keySystemOptions){return keySystemOptions}
var codecs={};if(mainPlaylist&&mainPlaylist.attributes&&mainPlaylist.attributes.CODECS){codecs=unwrapCodecList(parseCodecs(mainPlaylist.attributes.CODECS))}
if(audioPlaylist&&audioPlaylist.attributes&&audioPlaylist.attributes.CODECS){codecs.audio=audioPlaylist.attributes.CODECS}
var videoContentType=getMimeForCodec(codecs.video);var audioContentType=getMimeForCodec(codecs.audio);var keySystemContentTypes={};for(var keySystem in keySystemOptions){keySystemContentTypes[keySystem]={};if(audioContentType){keySystemContentTypes[keySystem].audioContentType=audioContentType}
if(videoContentType){keySystemContentTypes[keySystem].videoContentType=videoContentType}
if(mainPlaylist.contentProtection&&mainPlaylist.contentProtection[keySystem]&&mainPlaylist.contentProtection[keySystem].pssh){keySystemContentTypes[keySystem].pssh=mainPlaylist.contentProtection[keySystem].pssh}
if(typeof keySystemOptions[keySystem]==='string'){keySystemContentTypes[keySystem].url=keySystemOptions[keySystem]}}
return videojs__default["default"].mergeOptions(keySystemOptions,keySystemContentTypes)};var getAllPsshKeySystemsOptions=function getAllPsshKeySystemsOptions(playlists,keySystems){return playlists.reduce(function(keySystemsArr,playlist){if(!playlist.contentProtection){return keySystemsArr}
var keySystemsOptions=keySystems.reduce(function(keySystemsObj,keySystem){var keySystemOptions=playlist.contentProtection[keySystem];if(keySystemOptions&&keySystemOptions.pssh){keySystemsObj[keySystem]={pssh:keySystemOptions.pssh}}
return keySystemsObj},{});if(Object.keys(keySystemsOptions).length){keySystemsArr.push(keySystemsOptions)}
return keySystemsArr},[])};var waitForKeySessionCreation=function waitForKeySessionCreation(_ref){var player=_ref.player,sourceKeySystems=_ref.sourceKeySystems,audioMedia=_ref.audioMedia,mainPlaylists=_ref.mainPlaylists;if(!player.eme.initializeMediaKeys){return Promise.resolve()}
var playlists=audioMedia?mainPlaylists.concat([audioMedia]):mainPlaylists;var keySystemsOptionsArr=getAllPsshKeySystemsOptions(playlists,Object.keys(sourceKeySystems));var initializationFinishedPromises=[];var keySessionCreatedPromises=[];keySystemsOptionsArr.forEach(function(keySystemsOptions){keySessionCreatedPromises.push(new Promise(function(resolve,reject){player.tech_.one('keysessioncreated',resolve)}));initializationFinishedPromises.push(new Promise(function(resolve,reject){player.eme.initializeMediaKeys({keySystems:keySystemsOptions},function(err){if(err){reject(err);return}
resolve()})}))});return Promise.race([Promise.all(initializationFinishedPromises),Promise.race(keySessionCreatedPromises)])};var setupEmeOptions=function setupEmeOptions(_ref2){var player=_ref2.player,sourceKeySystems=_ref2.sourceKeySystems,media=_ref2.media,audioMedia=_ref2.audioMedia;var sourceOptions=emeKeySystems(sourceKeySystems,media,audioMedia);if(!sourceOptions){return!1}
player.currentSource().keySystems=sourceOptions;if(sourceOptions&&!player.eme){videojs__default["default"].log.warn('DRM encrypted source cannot be decrypted without a DRM plugin');return!1}
return!0};var getVhsLocalStorage=function getVhsLocalStorage(){if(!window.localStorage){return null}
var storedObject=window.localStorage.getItem(LOCAL_STORAGE_KEY);if(!storedObject){return null}
try{return JSON.parse(storedObject)}catch(e){return null}};var updateVhsLocalStorage=function updateVhsLocalStorage(options){if(!window.localStorage){return!1}
var objectToStore=getVhsLocalStorage();objectToStore=objectToStore?videojs__default["default"].mergeOptions(objectToStore,options):options;try{window.localStorage.setItem(LOCAL_STORAGE_KEY,JSON.stringify(objectToStore))}catch(e){return!1}
return objectToStore};var expandDataUri=function expandDataUri(dataUri){if(dataUri.toLowerCase().indexOf('data:application/vnd.videojs.vhs+json,')===0){return JSON.parse(dataUri.substring(dataUri.indexOf(',')+1))}
return dataUri};Vhs.supportsNativeHls=function(){if(!document||!document.createElement){return!1}
var video=document.createElement('video');if(!videojs__default["default"].getTech('Html5').isSupported()){return!1}
var canPlay=['application/vnd.apple.mpegurl','audio/mpegurl','audio/x-mpegurl','application/x-mpegurl','video/x-mpegurl','video/mpegurl','application/mpegurl'];return canPlay.some(function(canItPlay){return/maybe|probably/i.test(video.canPlayType(canItPlay))})}();Vhs.supportsNativeDash=function(){if(!document||!document.createElement||!videojs__default["default"].getTech('Html5').isSupported()){return!1}
return/maybe|probably/i.test(document.createElement('video').canPlayType('application/dash+xml'))}();Vhs.supportsTypeNatively=function(type){if(type==='hls'){return Vhs.supportsNativeHls}
if(type==='dash'){return Vhs.supportsNativeDash}
return!1};Vhs.isSupported=function(){return videojs__default["default"].log.warn('HLS is no longer a tech. Please remove it from '+'your player\'s techOrder.')};var Component=videojs__default["default"].getComponent('Component');var VhsHandler=function(_Component){inheritsLoose(VhsHandler,_Component);function VhsHandler(source,tech,options){var _this;_this=_Component.call(this,tech,videojs__default["default"].mergeOptions(options.hls,options.vhs))||this;if(options.hls&&Object.keys(options.hls).length){videojs__default["default"].log.warn('Using hls options is deprecated. Please rename `hls` to `vhs` in your options object.')}
if(typeof options.initialBandwidth==='number'){_this.options_.bandwidth=options.initialBandwidth}
_this.logger_=logger('VhsHandler');if(tech.options_&&tech.options_.playerId){var _player=videojs__default["default"](tech.options_.playerId);if(!_player.hasOwnProperty('hls')){Object.defineProperty(_player,'hls',{get:function get(){videojs__default["default"].log.warn('player.hls is deprecated. Use player.tech().vhs instead.');tech.trigger({type:'usage',name:'hls-player-access'});return assertThisInitialized(_this)},configurable:!0})}
if(!_player.hasOwnProperty('vhs')){Object.defineProperty(_player,'vhs',{get:function get(){videojs__default["default"].log.warn('player.vhs is deprecated. Use player.tech().vhs instead.');tech.trigger({type:'usage',name:'vhs-player-access'});return assertThisInitialized(_this)},configurable:!0})}
if(!_player.hasOwnProperty('dash')){Object.defineProperty(_player,'dash',{get:function get(){videojs__default["default"].log.warn('player.dash is deprecated. Use player.tech().vhs instead.');return assertThisInitialized(_this)},configurable:!0})}
_this.player_=_player}
_this.tech_=tech;_this.source_=source;_this.stats={};_this.ignoreNextSeekingEvent_=!1;_this.setOptions_();if(_this.options_.overrideNative&&tech.overrideNativeAudioTracks&&tech.overrideNativeVideoTracks){tech.overrideNativeAudioTracks(!0);tech.overrideNativeVideoTracks(!0)}else if(_this.options_.overrideNative&&(tech.featuresNativeVideoTracks||tech.featuresNativeAudioTracks)){throw new Error('Overriding native HLS requires emulated tracks. '+'See https://git.io/vMpjB')}
_this.on(document,['fullscreenchange','webkitfullscreenchange','mozfullscreenchange','MSFullscreenChange'],function(event){var fullscreenElement=document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement;if(fullscreenElement&&fullscreenElement.contains(_this.tech_.el())){_this.masterPlaylistController_.fastQualityChange_()}else{_this.masterPlaylistController_.checkABR_()}});_this.on(_this.tech_,'seeking',function(){if(this.ignoreNextSeekingEvent_){this.ignoreNextSeekingEvent_=!1;return}
this.setCurrentTime(this.tech_.currentTime())});_this.on(_this.tech_,'error',function(){if(this.tech_.error()&&this.masterPlaylistController_){this.masterPlaylistController_.pauseLoading()}});_this.on(_this.tech_,'play',_this.play);return _this}
var _proto=VhsHandler.prototype;_proto.setOptions_=function setOptions_(){var _this2=this;this.options_.withCredentials=this.options_.withCredentials||!1;this.options_.handleManifestRedirects=this.options_.handleManifestRedirects===!1?!1:!0;this.options_.limitRenditionByPlayerDimensions=this.options_.limitRenditionByPlayerDimensions===!1?!1:!0;this.options_.useDevicePixelRatio=this.options_.useDevicePixelRatio||!1;this.options_.smoothQualityChange=this.options_.smoothQualityChange||!1;this.options_.useBandwidthFromLocalStorage=typeof this.source_.useBandwidthFromLocalStorage!=='undefined'?this.source_.useBandwidthFromLocalStorage:this.options_.useBandwidthFromLocalStorage||!1;this.options_.useNetworkInformationApi=this.options_.useNetworkInformationApi||!1;this.options_.useDtsForTimestampOffset=this.options_.useDtsForTimestampOffset||!1;this.options_.customTagParsers=this.options_.customTagParsers||[];this.options_.customTagMappers=this.options_.customTagMappers||[];this.options_.cacheEncryptionKeys=this.options_.cacheEncryptionKeys||!1;if(typeof this.options_.blacklistDuration!=='number'){this.options_.blacklistDuration=5*60}
if(typeof this.options_.bandwidth!=='number'){if(this.options_.useBandwidthFromLocalStorage){var storedObject=getVhsLocalStorage();if(storedObject&&storedObject.bandwidth){this.options_.bandwidth=storedObject.bandwidth;this.tech_.trigger({type:'usage',name:'vhs-bandwidth-from-local-storage'});this.tech_.trigger({type:'usage',name:'hls-bandwidth-from-local-storage'})}
if(storedObject&&storedObject.throughput){this.options_.throughput=storedObject.throughput;this.tech_.trigger({type:'usage',name:'vhs-throughput-from-local-storage'});this.tech_.trigger({type:'usage',name:'hls-throughput-from-local-storage'})}}}
if(typeof this.options_.bandwidth!=='number'){this.options_.bandwidth=Config.INITIAL_BANDWIDTH}
this.options_.enableLowInitialPlaylist=this.options_.enableLowInitialPlaylist&&this.options_.bandwidth===Config.INITIAL_BANDWIDTH;['withCredentials','useDevicePixelRatio','limitRenditionByPlayerDimensions','bandwidth','smoothQualityChange','customTagParsers','customTagMappers','handleManifestRedirects','cacheEncryptionKeys','playlistSelector','initialPlaylistSelector','experimentalBufferBasedABR','liveRangeSafeTimeDelta','experimentalLLHLS','useNetworkInformationApi','useDtsForTimestampOffset','experimentalExactManifestTimings','experimentalLeastPixelDiffSelector'].forEach(function(option){if(typeof _this2.source_[option]!=='undefined'){_this2.options_[option]=_this2.source_[option]}});this.limitRenditionByPlayerDimensions=this.options_.limitRenditionByPlayerDimensions;this.useDevicePixelRatio=this.options_.useDevicePixelRatio};_proto.src=function src(_src,type){var _this3=this;if(!_src){return}
this.setOptions_();this.options_.src=expandDataUri(this.source_.src);this.options_.tech=this.tech_;this.options_.externVhs=Vhs;this.options_.sourceType=simpleTypeFromSourceType(type);this.options_.seekTo=function(time){_this3.tech_.setCurrentTime(time)};if(this.options_.smoothQualityChange){videojs__default["default"].log.warn('smoothQualityChange is deprecated and will be removed in the next major version')}
this.masterPlaylistController_=new MasterPlaylistController(this.options_);var playbackWatcherOptions=videojs__default["default"].mergeOptions({liveRangeSafeTimeDelta:SAFE_TIME_DELTA},this.options_,{seekable:function seekable(){return _this3.seekable()},media:function media(){return _this3.masterPlaylistController_.media()},masterPlaylistController:this.masterPlaylistController_});this.playbackWatcher_=new PlaybackWatcher(playbackWatcherOptions);this.masterPlaylistController_.on('error',function(){var player=videojs__default["default"].players[_this3.tech_.options_.playerId];var error=_this3.masterPlaylistController_.error;if(typeof error==='object'&&!error.code){error.code=3}else if(typeof error==='string'){error={message:error,code:3}}
player.error(error)});var defaultSelector=this.options_.experimentalBufferBasedABR?Vhs.movingAverageBandwidthSelector(0.55):Vhs.STANDARD_PLAYLIST_SELECTOR;this.masterPlaylistController_.selectPlaylist=this.selectPlaylist?this.selectPlaylist.bind(this):defaultSelector.bind(this);this.masterPlaylistController_.selectInitialPlaylist=Vhs.INITIAL_PLAYLIST_SELECTOR.bind(this);this.playlists=this.masterPlaylistController_.masterPlaylistLoader_;this.mediaSource=this.masterPlaylistController_.mediaSource;Object.defineProperties(this,{selectPlaylist:{get:function get(){return this.masterPlaylistController_.selectPlaylist},set:function set(selectPlaylist){this.masterPlaylistController_.selectPlaylist=selectPlaylist.bind(this)}},throughput:{get:function get(){return this.masterPlaylistController_.mainSegmentLoader_.throughput.rate},set:function set(throughput){this.masterPlaylistController_.mainSegmentLoader_.throughput.rate=throughput;this.masterPlaylistController_.mainSegmentLoader_.throughput.count=1}},bandwidth:{get:function get(){var playerBandwidthEst=this.masterPlaylistController_.mainSegmentLoader_.bandwidth;var networkInformation=window.navigator.connection||window.navigator.mozConnection||window.navigator.webkitConnection;var tenMbpsAsBitsPerSecond=10e6;if(this.options_.useNetworkInformationApi&&networkInformation){var networkInfoBandwidthEstBitsPerSec=networkInformation.downlink*1000*1000;if(networkInfoBandwidthEstBitsPerSec>=tenMbpsAsBitsPerSecond&&playerBandwidthEst>=tenMbpsAsBitsPerSecond){playerBandwidthEst=Math.max(playerBandwidthEst,networkInfoBandwidthEstBitsPerSec)}else{playerBandwidthEst=networkInfoBandwidthEstBitsPerSec}}
return playerBandwidthEst},set:function set(bandwidth){this.masterPlaylistController_.mainSegmentLoader_.bandwidth=bandwidth;this.masterPlaylistController_.mainSegmentLoader_.throughput={rate:0,count:0}}},systemBandwidth:{get:function get(){var invBandwidth=1/(this.bandwidth||1);var invThroughput;if(this.throughput>0){invThroughput=1/this.throughput}else{invThroughput=0}
var systemBitrate=Math.floor(1/(invBandwidth+invThroughput));return systemBitrate},set:function set(){videojs__default["default"].log.error('The "systemBandwidth" property is read-only')}}});if(this.options_.bandwidth){this.bandwidth=this.options_.bandwidth}
if(this.options_.throughput){this.throughput=this.options_.throughput}
Object.defineProperties(this.stats,{bandwidth:{get:function get(){return _this3.bandwidth||0},enumerable:!0},mediaRequests:{get:function get(){return _this3.masterPlaylistController_.mediaRequests_()||0},enumerable:!0},mediaRequestsAborted:{get:function get(){return _this3.masterPlaylistController_.mediaRequestsAborted_()||0},enumerable:!0},mediaRequestsTimedout:{get:function get(){return _this3.masterPlaylistController_.mediaRequestsTimedout_()||0},enumerable:!0},mediaRequestsErrored:{get:function get(){return _this3.masterPlaylistController_.mediaRequestsErrored_()||0},enumerable:!0},mediaTransferDuration:{get:function get(){return _this3.masterPlaylistController_.mediaTransferDuration_()||0},enumerable:!0},mediaBytesTransferred:{get:function get(){return _this3.masterPlaylistController_.mediaBytesTransferred_()||0},enumerable:!0},mediaSecondsLoaded:{get:function get(){return _this3.masterPlaylistController_.mediaSecondsLoaded_()||0},enumerable:!0},mediaAppends:{get:function get(){return _this3.masterPlaylistController_.mediaAppends_()||0},enumerable:!0},mainAppendsToLoadedData:{get:function get(){return _this3.masterPlaylistController_.mainAppendsToLoadedData_()||0},enumerable:!0},audioAppendsToLoadedData:{get:function get(){return _this3.masterPlaylistController_.audioAppendsToLoadedData_()||0},enumerable:!0},appendsToLoadedData:{get:function get(){return _this3.masterPlaylistController_.appendsToLoadedData_()||0},enumerable:!0},timeToLoadedData:{get:function get(){return _this3.masterPlaylistController_.timeToLoadedData_()||0},enumerable:!0},buffered:{get:function get(){return timeRangesToArray(_this3.tech_.buffered())},enumerable:!0},currentTime:{get:function get(){return _this3.tech_.currentTime()},enumerable:!0},currentSource:{get:function get(){return _this3.tech_.currentSource_},enumerable:!0},currentTech:{get:function get(){return _this3.tech_.name_},enumerable:!0},duration:{get:function get(){return _this3.tech_.duration()},enumerable:!0},master:{get:function get(){return _this3.playlists.master},enumerable:!0},playerDimensions:{get:function get(){return _this3.tech_.currentDimensions()},enumerable:!0},seekable:{get:function get(){return timeRangesToArray(_this3.tech_.seekable())},enumerable:!0},timestamp:{get:function get(){return Date.now()},enumerable:!0},videoPlaybackQuality:{get:function get(){return _this3.tech_.getVideoPlaybackQuality()},enumerable:!0}});this.tech_.one('canplay',this.masterPlaylistController_.setupFirstPlay.bind(this.masterPlaylistController_));this.tech_.on('bandwidthupdate',function(){if(_this3.options_.useBandwidthFromLocalStorage){updateVhsLocalStorage({bandwidth:_this3.bandwidth,throughput:Math.round(_this3.throughput)})}});this.masterPlaylistController_.on('selectedinitialmedia',function(){renditionSelectionMixin(_this3)});this.masterPlaylistController_.sourceUpdater_.on('createdsourcebuffers',function(){_this3.setupEme_()});this.on(this.masterPlaylistController_,'progress',function(){this.tech_.trigger('progress')});this.on(this.masterPlaylistController_,'firstplay',function(){this.ignoreNextSeekingEvent_=!0});this.setupQualityLevels_();if(!this.tech_.el()){return}
this.mediaSourceUrl_=window.URL.createObjectURL(this.masterPlaylistController_.mediaSource);this.tech_.src(this.mediaSourceUrl_)};_proto.createKeySessions_=function createKeySessions_(){var _this4=this;var audioPlaylistLoader=this.masterPlaylistController_.mediaTypes_.AUDIO.activePlaylistLoader;this.logger_('waiting for EME key session creation');waitForKeySessionCreation({player:this.player_,sourceKeySystems:this.source_.keySystems,audioMedia:audioPlaylistLoader&&audioPlaylistLoader.media(),mainPlaylists:this.playlists.master.playlists}).then(function(){_this4.logger_('created EME key session');_this4.masterPlaylistController_.sourceUpdater_.initializedEme()}).catch(function(err){_this4.logger_('error while creating EME key session',err);_this4.player_.error({message:'Failed to initialize media keys for EME',code:3})})};_proto.handleWaitingForKey_=function handleWaitingForKey_(){this.logger_('waitingforkey fired, attempting to create any new key sessions');this.createKeySessions_()};_proto.setupEme_=function setupEme_(){var _this5=this;var audioPlaylistLoader=this.masterPlaylistController_.mediaTypes_.AUDIO.activePlaylistLoader;var didSetupEmeOptions=setupEmeOptions({player:this.player_,sourceKeySystems:this.source_.keySystems,media:this.playlists.media(),audioMedia:audioPlaylistLoader&&audioPlaylistLoader.media()});this.player_.tech_.on('keystatuschange',function(e){if(e.status!=='output-restricted'){return}
var masterPlaylist=_this5.masterPlaylistController_.master();if(!masterPlaylist||!masterPlaylist.playlists){return}
var excludedHDPlaylists=[];masterPlaylist.playlists.forEach(function(playlist){if(playlist&&playlist.attributes&&playlist.attributes.RESOLUTION&&playlist.attributes.RESOLUTION.height>=720){if(!playlist.excludeUntil||playlist.excludeUntil<Infinity){playlist.excludeUntil=Infinity;excludedHDPlaylists.push(playlist)}}});if(excludedHDPlaylists.length){var _videojs$log;(_videojs$log=videojs__default["default"].log).warn.apply(_videojs$log,['DRM keystatus changed to "output-restricted." Removing the following HD playlists '+'that will most likely fail to play and clearing the buffer. '+'This may be due to HDCP restrictions on the stream and the capabilities of the current device.'].concat(excludedHDPlaylists));_this5.masterPlaylistController_.fastQualityChange_()}});this.handleWaitingForKey_=this.handleWaitingForKey_.bind(this);this.player_.tech_.on('waitingforkey',this.handleWaitingForKey_);if(videojs__default["default"].browser.IE_VERSION===11||!didSetupEmeOptions){this.masterPlaylistController_.sourceUpdater_.initializedEme();return}
this.createKeySessions_()};_proto.setupQualityLevels_=function setupQualityLevels_(){var _this6=this;var player=videojs__default["default"].players[this.tech_.options_.playerId];if(!player||!player.qualityLevels||this.qualityLevels_){return}
this.qualityLevels_=player.qualityLevels();this.masterPlaylistController_.on('selectedinitialmedia',function(){handleVhsLoadedMetadata(_this6.qualityLevels_,_this6)});this.playlists.on('mediachange',function(){handleVhsMediaChange(_this6.qualityLevels_,_this6.playlists)})};VhsHandler.version=function version$5(){return{'@videojs/http-streaming':version$4,'mux.js':version$3,'mpd-parser':version$2,'m3u8-parser':version$1,'aes-decrypter':version}};_proto.version=function version(){return this.constructor.version()};_proto.canChangeType=function canChangeType(){return SourceUpdater.canChangeType()};_proto.play=function play(){this.masterPlaylistController_.play()};_proto.setCurrentTime=function setCurrentTime(currentTime){this.masterPlaylistController_.setCurrentTime(currentTime)};_proto.duration=function duration(){return this.masterPlaylistController_.duration()};_proto.seekable=function seekable(){return this.masterPlaylistController_.seekable()};_proto.dispose=function dispose(){if(this.playbackWatcher_){this.playbackWatcher_.dispose()}
if(this.masterPlaylistController_){this.masterPlaylistController_.dispose()}
if(this.qualityLevels_){this.qualityLevels_.dispose()}
if(this.player_){delete this.player_.vhs;delete this.player_.dash;delete this.player_.hls}
if(this.tech_&&this.tech_.vhs){delete this.tech_.vhs}
if(this.tech_){delete this.tech_.hls}
if(this.mediaSourceUrl_&&window.URL.revokeObjectURL){window.URL.revokeObjectURL(this.mediaSourceUrl_);this.mediaSourceUrl_=null}
if(this.tech_){this.tech_.off('waitingforkey',this.handleWaitingForKey_)}
_Component.prototype.dispose.call(this)};_proto.convertToProgramTime=function convertToProgramTime(time,callback){return getProgramTime({playlist:this.masterPlaylistController_.media(),time:time,callback:callback})};_proto.seekToProgramTime=function seekToProgramTime$1(programTime,callback,pauseAfterSeek,retryCount){if(pauseAfterSeek===void 0){pauseAfterSeek=!0}
if(retryCount===void 0){retryCount=2}
return seekToProgramTime({programTime:programTime,playlist:this.masterPlaylistController_.media(),retryCount:retryCount,pauseAfterSeek:pauseAfterSeek,seekTo:this.options_.seekTo,tech:this.options_.tech,callback:callback})};return VhsHandler}(Component);var VhsSourceHandler={name:'videojs-http-streaming',VERSION:version$4,canHandleSource:function canHandleSource(srcObj,options){if(options===void 0){options={}}
var localOptions=videojs__default["default"].mergeOptions(videojs__default["default"].options,options);return VhsSourceHandler.canPlayType(srcObj.type,localOptions)},handleSource:function handleSource(source,tech,options){if(options===void 0){options={}}
var localOptions=videojs__default["default"].mergeOptions(videojs__default["default"].options,options);tech.vhs=new VhsHandler(source,tech,localOptions);if(!videojs__default["default"].hasOwnProperty('hls')){Object.defineProperty(tech,'hls',{get:function get(){videojs__default["default"].log.warn('player.tech().hls is deprecated. Use player.tech().vhs instead.');return tech.vhs},configurable:!0})}
tech.vhs.xhr=xhrFactory();tech.vhs.src(source.src,source.type);return tech.vhs},canPlayType:function canPlayType(type,options){if(options===void 0){options={}}
var _videojs$mergeOptions=videojs__default["default"].mergeOptions(videojs__default["default"].options,options),_videojs$mergeOptions2=_videojs$mergeOptions.vhs;_videojs$mergeOptions2=_videojs$mergeOptions2===void 0?{}:_videojs$mergeOptions2;var _videojs$mergeOptions3=_videojs$mergeOptions2.overrideNative,overrideNative=_videojs$mergeOptions3===void 0?!videojs__default["default"].browser.IS_ANY_SAFARI:_videojs$mergeOptions3,_videojs$mergeOptions4=_videojs$mergeOptions.hls;_videojs$mergeOptions4=_videojs$mergeOptions4===void 0?{}:_videojs$mergeOptions4;var _videojs$mergeOptions5=_videojs$mergeOptions4.overrideNative,legacyOverrideNative=_videojs$mergeOptions5===void 0?!1:_videojs$mergeOptions5;var supportedType=simpleTypeFromSourceType(type);var canUseMsePlayback=supportedType&&(!Vhs.supportsTypeNatively(supportedType)||legacyOverrideNative||overrideNative);return canUseMsePlayback?'maybe':''}};var supportsNativeMediaSources=function supportsNativeMediaSources(){return browserSupportsCodec('avc1.4d400d,mp4a.40.2')};if(supportsNativeMediaSources()){videojs__default["default"].getTech('Html5').registerSourceHandler(VhsSourceHandler,0)}
videojs__default["default"].VhsHandler=VhsHandler;Object.defineProperty(videojs__default["default"],'HlsHandler',{get:function get(){videojs__default["default"].log.warn('videojs.HlsHandler is deprecated. Use videojs.VhsHandler instead.');return VhsHandler},configurable:!0});videojs__default["default"].VhsSourceHandler=VhsSourceHandler;Object.defineProperty(videojs__default["default"],'HlsSourceHandler',{get:function get(){videojs__default["default"].log.warn('videojs.HlsSourceHandler is deprecated. '+'Use videojs.VhsSourceHandler instead.');return VhsSourceHandler},configurable:!0});videojs__default["default"].Vhs=Vhs;Object.defineProperty(videojs__default["default"],'Hls',{get:function get(){videojs__default["default"].log.warn('videojs.Hls is deprecated. Use videojs.Vhs instead.');return Vhs},configurable:!0});if(!videojs__default["default"].use){videojs__default["default"].registerComponent('Hls',Vhs);videojs__default["default"].registerComponent('Vhs',Vhs)}
videojs__default["default"].options.vhs=videojs__default["default"].options.vhs||{};videojs__default["default"].options.hls=videojs__default["default"].options.hls||{};if(!videojs__default["default"].getPlugin||!videojs__default["default"].getPlugin('reloadSourceOnError')){var registerPlugin=videojs__default["default"].registerPlugin||videojs__default["default"].plugin;registerPlugin('reloadSourceOnError',reloadSourceOnError)}
exports.LOCAL_STORAGE_KEY=LOCAL_STORAGE_KEY;exports.Vhs=Vhs;exports.VhsHandler=VhsHandler;exports.VhsSourceHandler=VhsSourceHandler;exports.emeKeySystems=emeKeySystems;exports.expandDataUri=expandDataUri;exports.getAllPsshKeySystemsOptions=getAllPsshKeySystemsOptions;exports.setupEmeOptions=setupEmeOptions;exports.simpleTypeFromSourceType=simpleTypeFromSourceType;exports.waitForKeySessionCreation=waitForKeySessionCreation;Object.defineProperty(exports,'__esModule',{value:!0})}))